{% extends 'base.html' %}
{% load static %}

{% block title %}Contenu structuré - {{ document.title|default:'Document' }}{% endblock %}

{% block extra_css %}
<style>
  .doc-structured-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  .doc-structured-meta {
    font-size: .9rem;
    color: #6b7280; /* Tailwind slate-500 */
  }
  .doc-structured-wrapper {
    position: relative;
    background: #f8fafc; /* slate-50 */
    border: 1px solid #e5e7eb; /* slate-200 */
    border-radius: .5rem;
    padding: .75rem;
  }
  .doc-structured-canvas {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: .25rem;
    overflow: auto;
    min-height: 400px;
  }
  .toolbar-actions button {
    border: 1px solid #e5e7eb;
    background: white;
    padding: .4rem .65rem;
    border-radius: .5rem;
    font-size: .9rem;
    cursor: pointer;
  }
  .toolbar-actions button:hover {
    background: #f9fafb;
  }
  /* Floating zoom controls */
  .floating-zoom-controls {
    position: fixed;
    right: 20px;
    bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
    backdrop-filter: blur(8px);
    z-index: 1030;
  }
  .floating-zoom-controls .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    cursor: pointer;
  }
  .floating-zoom-controls .btn:hover { background: #f9fafb; }
  .floating-zoom-controls .divider { width: 1px; height: 22px; background: #e5e7eb; margin: 0 4px; }
  .floating-zoom-controls .zoom-label { min-width: 56px; text-align: center; font-variant-numeric: tabular-nums; color: #374151; }

  /* Zoom container */
  #zoomContainer {
    transform-origin: top center;
  }

  /* Edit mode */
  .edit-mode .pdf-text-element, .edit-mode .pdf-cell {
    outline: 1px dashed rgba(14,165,233,0.5) !important; /* cyan-500 */
    outline-offset: 0;
  }
  .edit-mode .pdf-text-element[contenteditable="true"], .edit-mode .pdf-cell[contenteditable="true"] {
    background: rgba(14,165,233,0.06);
  }
  /* Toast */
  #ds-toast { position: fixed; top: 16px; right: 16px; z-index: 2000; display: none; }
  #ds-toast .toast-box {
    background: rgba(17,24,39,0.95); color: #fff; padding: 10px 14px; border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2); font-weight: 600; min-width: 220px;
  }
  #ds-toast.success .toast-box { background: rgba(16,185,129,0.95); }
  #ds-toast.error .toast-box { background: rgba(239,68,68,0.95); }
/* Structured header (from rawdocs) */
  .structured-header { position: relative; overflow: hidden; border-radius: 24px; padding: 24px; color: #fff; background: linear-gradient(135deg, var(--primary, #3b82f6) 0%, var(--primary-light, #60a5fa) 40%, var(--secondary, #8b5cf6) 100%); box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05) inset; margin-bottom: 16px; border: none; backdrop-filter: blur(20px); }
  .structured-header::before { content:''; position:absolute; inset:0; background: radial-gradient(circle at 20% 50%, rgba(255,255,255,.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,.08) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(255,255,255,.06) 0%, transparent 50%); animation: float 20s ease-in-out infinite; pointer-events: none; }
  @keyframes float { 0%,100%{transform:translateY(0) rotate(0)} 33%{transform:translateY(-10px) rotate(1deg)} 66%{transform:translateY(5px) rotate(-1deg)} }
  .sh-content{ position:relative; z-index:2 }
  .sh-grid{ display:grid; grid-template-columns:1fr auto; gap:16px; align-items:flex-start; margin-bottom:12px; }
  .sh-main{ display:flex; align-items:flex-start; gap:16px; min-width:0 }
  .icon-chip{ width:56px; height:56px; border-radius:16px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); border:2px solid rgba(255,255,255,0.25) }
  .sh-title{ margin:0; font-size:1.6rem; line-height:1.2; font-weight:900; letter-spacing:-0.02em; color:#fff }
  .sh-meta{ display:flex; flex-wrap:wrap; gap:12px; opacity:.95 }
  .sh-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end }
  .sh-actions .btn{ border-color: rgba(255,255,255,0.35) }
  .meta-badge{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); font-weight:600; font-size:.85rem }
</style>
{% endblock %}

{% block content %}
<div class="structured-header">
  <div class="sh-content">
    <div class="sh-grid">
      <div class="sh-main">
        <div class="icon-chip"><i class="fas fa-layer-group"></i></div>
        <div>
          <h1 class="sh-title">{% if document.title %}{{ document.title }}{% elif document.file %}{{ document.file.name }}{% else %}Document{% endif %}</h1>
          <div class="sh-meta">
            <span>Doc #{{ document.id }}</span>
            {% if document.doc_type %}<span>{{ document.doc_type }}</span>{% endif %}
            {% if document.country %}<span>{{ document.country }}</span>{% endif %}
            {% if document.language %}<span>{{ document.language }}</span>{% endif %}
          </div>
        </div>
      </div>
      <div class="sh-actions">
        {% if document %}
          <a class="btn" href="{% url 'rawdocs:view_original_document' document.id %}" target="_blank" title="PDF original">
            <i class="fas fa-file-pdf" aria-hidden="true"></i>
          </a>
          <a class="btn" href="?regen=1" title="Régénérer">
            <i class="fas fa-rotate-right" aria-hidden="true"></i>
          </a>
        {% endif %}
        <button id="toggleEditBtn" class="btn" type="button" title="Mode édition">
          <i class="fas fa-pen" aria-hidden="true"></i>
        </button>
        <button id="saveEditsBtn" class="btn" type="button" title="Enregistrer les modifications">
          <i class="fas fa-floppy-disk" aria-hidden="true"></i>
        </button>
        <button id="copyHtmlBtn" class="btn" type="button" title="Copier le HTML">
          <i class="fas fa-copy" aria-hidden="true"></i>
        </button>
        <button id="downloadHtmlBtn" class="btn" type="button" title="Télécharger le HTML">
          <i class="fas fa-download" aria-hidden="true"></i>
        </button>
      </div>
    </div>
    <div class="details" style="display:flex;gap:8px;flex-wrap:wrap;">
      {% if structured_html_method %}
        <span class="meta-badge"><i class="fas fa-cogs"></i> Méthode: {{ structured_html_method }}</span>
      {% endif %}
      {% if structured_html_confidence %}
        <span class="meta-badge"><i class="fas fa-gauge-high"></i> Confiance: {{ structured_html_confidence }}</span>
      {% endif %}
      {% if document.structured_html_generated_at %}
        <span class="meta-badge"><i class="far fa-clock"></i> Généré le {{ document.structured_html_generated_at|date:'d/m/Y H:i' }}</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="doc-structured-wrapper">
  <div class="doc-structured-canvas">
    {% if structured_html %}
      <div id="zoomContainer">
        {{ structured_html|safe }}
      </div>
    {% else %}
      <div class="p-4 text-center" style="color:#6b7280;">
        <i class="fas fa-info-circle" aria-hidden="true"></i>
        Aucun contenu structuré disponible pour l’instant.
      </div>
    {% endif %}

    <!-- Floating Zoom Controls -->
    <div class="floating-zoom-controls">
      <button class="btn" type="button" id="zoomOutBtn" title="Zoom -">
        <i class="fas fa-search-minus" aria-hidden="true"></i>
      </button>
      <span class="zoom-label" id="zoomLabel">100%</span>
      <button class="btn" type="button" id="zoomInBtn" title="Zoom +">
        <i class="fas fa-search-plus" aria-hidden="true"></i>
      </button>
      <div class="divider"></div>
      <button class="btn" type="button" id="zoomResetBtn" title="Réinitialiser">
        <i class="fas fa-compress" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</div>
<div id="ds-toast"><div class="toast-box"></div></div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const zoomContainer = document.getElementById('zoomContainer');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomResetBtn = document.getElementById('zoomResetBtn');
  const zoomLabel = document.getElementById('zoomLabel');
  const toggleEditBtn = document.getElementById('toggleEditBtn');
  const copyHtmlBtn = document.getElementById('copyHtmlBtn');
  const downloadHtmlBtn = document.getElementById('downloadHtmlBtn');
  const saveEditsBtn = document.getElementById('saveEditsBtn');
  const saveUrl = "{% url 'rawdocs:save_structured_edits' document.id %}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrfToken = getCookie('csrftoken');

  function showToast(type, message) {
    const t = document.getElementById('ds-toast');
    if (!t) return; t.className = ''; t.classList.add(type); t.style.display = 'block';
    const box = t.querySelector('.toast-box'); if (box) box.textContent = message || '';
    setTimeout(() => { t.style.display = 'none'; }, 1800);
  }

  let zoom = 1.0;
  const Z_MIN = 0.25;
  const Z_MAX = 3.0;
  const Z_STEP = 0.1;
  let editMode = false;

  function applyZoom() {
    if (!zoomContainer) return;
    zoomContainer.style.transform = `scale(${zoom})`;
    zoomLabel.textContent = Math.round(zoom * 100) + '%';
  }

  function setZoom(val) {
    zoom = Math.min(Z_MAX, Math.max(Z_MIN, val));
    applyZoom();
  }

  if (zoomInBtn) zoomInBtn.addEventListener('click', () => setZoom(zoom + Z_STEP));
  if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => setZoom(zoom - Z_STEP));
  if (zoomResetBtn) zoomResetBtn.addEventListener('click', () => setZoom(1.0));

  // Keyboard shortcuts (Ctrl/Cmd + +/-, Ctrl/Cmd + 0)
  document.addEventListener('keydown', (e) => {
    const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
    const accel = isMac ? e.metaKey : e.ctrlKey;
    if (!accel) return;
    if (e.key === '+' || e.key === '=') { e.preventDefault(); setZoom(zoom + Z_STEP); }
    if (e.key === '-') { e.preventDefault(); setZoom(zoom - Z_STEP); }
    if (e.key === '0') { e.preventDefault(); setZoom(1.0); }
  });

  // Mouse wheel + Ctrl => zoom
  document.addEventListener('wheel', (e) => {
    const isMac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
    const accelKey = isMac ? e.metaKey : e.ctrlKey;
    if (accelKey) {
      e.preventDefault();
      const delta = Math.sign(e.deltaY);
      if (delta > 0) setZoom(zoom - Z_STEP); else setZoom(zoom + Z_STEP);
    }
  }, { passive: false });

  // Edit mode toggle: make structural text elements editable
  function setEditMode(on) {
    editMode = !!on;
    document.body.classList.toggle('edit-mode', editMode);
    if (!zoomContainer) return;
    const editableSelectors = ['.pdf-text-element', '.pdf-cell'];
    editableSelectors.forEach(sel => {
      zoomContainer.querySelectorAll(sel).forEach(el => {
        el.setAttribute('contenteditable', editMode ? 'true' : 'false');
        el.spellcheck = false;
      });
    });
    // Change button style
    if (toggleEditBtn) {
      if (editMode) {
        toggleEditBtn.style.borderColor = '#0ea5e9';
        toggleEditBtn.style.color = '#0ea5e9';
      } else {
        toggleEditBtn.style.borderColor = '#e5e7eb';
        toggleEditBtn.style.color = 'inherit';
      }
    }
  }

  if (toggleEditBtn) toggleEditBtn.addEventListener('click', () => setEditMode(!editMode));

  async function saveEdits() {
    if (!zoomContainer) return;
    const formatted_content = zoomContainer.innerHTML;
    const extracted_content = '';
    const payload = { formatted_content, extracted_content };

    try {
      const resp = await fetch(saveUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (data && data.success) {
        // Visual feedback
        saveEditsBtn.style.borderColor = '#10b981'; // green-500
        saveEditsBtn.style.color = '#10b981';
        saveEditsBtn.title = data.message || 'Modifications enregistrées';
        showToast('success', data.message || 'Modifications sauvegardées');
        setTimeout(() => {
          saveEditsBtn.style.borderColor = '#e5e7eb';
          saveEditsBtn.style.color = 'inherit';
          saveEditsBtn.title = 'Enregistrer les modifications';
        }, 1400);
      } else {
        showToast('error', (data && data.error) ? data.error : 'Erreur lors de la sauvegarde');
      }
    } catch (e) {
      showToast('error', 'Erreur réseau lors de la sauvegarde');
    }
  }
  if (saveEditsBtn) saveEditsBtn.addEventListener('click', saveEdits);

  // Copy current HTML to clipboard (content only)
  async function copyHtml() {
    if (!zoomContainer) return;
    const html = zoomContainer.innerHTML;
    try {
      await navigator.clipboard.writeText(html);
      toggleEditBtn && (toggleEditBtn.title = 'Copié!');
      setTimeout(() => { toggleEditBtn && (toggleEditBtn.title = 'Mode édition'); }, 1200);
    } catch (e) {
      console.log('Clipboard not available, creating a fallback textarea');
      const ta = document.createElement('textarea');
      ta.value = html; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); } catch(_){}
      document.body.removeChild(ta);
    }
  }
  if (copyHtmlBtn) copyHtmlBtn.addEventListener('click', copyHtml);

  // Download current HTML (content only)
  function downloadHtml() {
    if (!zoomContainer) return;
    const html = zoomContainer.innerHTML;
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const filename = ({{ document.id|default:'0' }}).toString() + '_structured.html';
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  if (downloadHtmlBtn) downloadHtmlBtn.addEventListener('click', downloadHtml);

  // Initial zoom
  applyZoom();
})();
</script>
{% endblock %}
