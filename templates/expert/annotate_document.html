{% extends "base.html" %}
{% load static %}
{% block title %}Annotation Expert - {{ document.title }}{% endblock %}
{% block content %}

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');

:root {
    --pharma-primary: #0ea5e9;
    --pharma-primary-dark: #0284c7;
    --pharma-primary-light: #38bdf8;
    --pharma-accent: #10b981;
    --pharma-accent-light: #34d399;
    --pharma-success: #059669;
    --pharma-warn: #f59e0b;
    --pharma-error: #dc2626;
    --pharma-text: #1f2937;
    --pharma-text-soft: #6b7280;
    --pharma-bg: #f8fafc;
    --pharma-card: #ffffff;
    --pharma-border: #e2e8f0;
    --pharma-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --pharma-radius: 16px;
    --pharma-radius-sm: 12px;
    --pharma-transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    min-height: 100vh;
    color: var(--pharma-text);
    margin: 0;
    padding: 0;
}

.annotation-container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
}

.card {
    background: var(--pharma-card);
    border-radius: var(--pharma-radius);
    box-shadow: var(--pharma-shadow);
    border: 1px solid var(--pharma-border);
    transition: var(--pharma-transition);
    margin-bottom: 2rem;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
}

/* Header stylisé */
.annotation-header {
    background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-accent));
    color: #fff;
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    border-radius: var(--pharma-radius);
    box-shadow: var(--pharma-shadow);
    margin-bottom: 2rem;
}

.header-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.header-info h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.document-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    opacity: 0.9;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.9rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.btn-outline {
    padding: 0.6rem 1.2rem;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 500;
    transition: var(--pharma-transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.btn-outline:hover {
    background: rgba(255, 255, 255, 0.25);
    color: #fff;
    text-decoration: none;
    transform: translateY(-1px);
}

/* Types d'annotations */
.annotation-types-panel {
    background: var(--pharma-card);
    border: 1px solid var(--pharma-border);
    border-radius: var(--pharma-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--pharma-shadow);
}

.annotation-types {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin: 1rem 0;
}

.annotation-type-btn {
    border: 2px solid transparent;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    position: relative;
    background: var(--pharma-primary);
    color: #fff;
}

.annotation-type-btn:hover {
    filter: brightness(1.05);
    transform: translateY(-2px);
}

.annotation-type-btn.active {
    outline: 3px solid var(--label-color);
    outline-offset: 2px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    transform: translateY(-2px) scale(1.02);
    filter: brightness(1.03);
    color: #ffffff;
}

/* Document Text */
.text-content-card {
    background: var(--pharma-card);
    border: 1px solid var(--pharma-border);
    border-radius: var(--pharma-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--pharma-shadow);
}

.text-content {
    background: #fafbfc;
    border: 1px solid #e5e7eb;
    border-radius: var(--pharma-radius-sm);
    padding: 2rem;
    line-height: 1.8;
    font-size: 1rem;
    color: var(--pharma-text);
    white-space: pre-wrap;
    min-height: 500px;
    cursor: text;
}

/* Page Navigation */
.page-navigation {
    background: var(--pharma-card);
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--pharma-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: var(--pharma-shadow);
}

.page-indicator-modern {
    background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-accent));
    color: #fff;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
}

.nav-btn {
    padding: 0.6rem 1.2rem;
    background: var(--pharma-primary);
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: var(--pharma-transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
    cursor: pointer;
}

.nav-btn:hover {
    background: var(--pharma-primary-dark);
    color: #fff;
    text-decoration: none;
    transform: translateY(-1px);
}

.nav-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.inline-annotation {
    background-color: #fff3cd;
    padding: 2px 4px;
    margin: 0 1px;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
}

.inline-annotation .ann-label {
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    white-space: nowrap;
}

/* Responsive header for mobile */
@media (max-width: 700px) {
    .annotation-header,
    .page-navigation {
        flex-direction: column !important;
        gap: 1rem !important;
    }
}
</style>

<div class="annotation-container">
    <div class="card">
        <!-- Header stylisé -->
        <div class="annotation-header">
            <div class="header-info">
                <h2><i class="fas fa-highlighter"></i> {{ document.title }}</h2>
                <div class="document-meta">
                    <span class="meta-item"><i class="fas fa-file-alt"></i> {{ total_pages }} pages</span>
                    <span class="meta-item"><i class="fas fa-calendar"></i> {{ document.created_at|date:"d/m/Y" }}</span>
                    <span class="meta-item"><i class="fas fa-tags"></i> Annotation manuelle avancée</span>
                </div>
                <p style="color: #e0e7ef; margin: 0.5rem 0 0 0;">Page {{ current_page.page_number }} / {{ total_pages }}</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'expert:review_document' document.id %}" class="btn-outline" title="Retour à la révision">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
            </div>
        </div>

        <!-- Annotation Types -->
        <div class="annotation-types-panel">
            <h3 style="color: var(--pharma-text); margin-bottom: 1rem;">
                <i class="fas fa-tags" style="color: var(--pharma-primary);"></i>
                Types d'Annotation
            </h3>
            <p style="color: var(--pharma-text-soft); font-size: 0.9rem; margin-bottom: 1rem;">
                Cliquez sur un type, puis surlignez le texte dans le document
            </p>
            <div class="annotation-types">
                {% for ann_type in annotation_types %}
                <button class="annotation-type-btn" 
                        data-id="{{ ann_type.id }}" 
                        data-name="{{ ann_type.name }}" 
                        data-color="{{ ann_type.color }}"
                        style="background: {{ ann_type.color }}; color: #ffffff; border-color: {{ ann_type.color }}; --label-color: {{ ann_type.color }};">
                    {{ ann_type.display_name }}
                </button>
                {% endfor %}
            </div>
        </div>

        <!-- Page Navigation -->
        <div class="page-navigation">
            {% if current_page.page_number > 1 %}
                <a href="?page={{ current_page.page_number|add:'-1' }}" class="nav-btn">
                    <i class="fas fa-chevron-left"></i> Page Précédente
                </a>
            {% else %}
                <button class="nav-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Page Précédente
                </button>
            {% endif %}
            
            <div class="page-indicator-modern">
                <i class="fas fa-file-text"></i>
                Page {{ current_page.page_number }} / {{ total_pages }}
            </div>
            
            {% if current_page.page_number < total_pages %}
                <a href="?page={{ current_page.page_number|add:'1' }}" class="nav-btn">
                    Page Suivante <i class="fas fa-chevron-right"></i>
                </a>
            {% else %}
                <button class="nav-btn" disabled style="background: var(--pharma-accent);">
                    <i class="fas fa-flag-checkered"></i> Dernière page
                </button>
            {% endif %}
        </div>

        <!-- Document Text -->
        <div class="text-content-card">
            <h3 style="color: var(--pharma-text); margin-bottom: 1rem;">
                <i class="fas fa-file-text"></i>
                Page {{ current_page.page_number }}
                {% if existing_annotations %}
                    <span style="color: var(--pharma-accent); font-size: 0.9rem;">
                        ({{ existing_annotations|length }} annotations)
                    </span>
                {% endif %}
            </h3>

            <div id="page-text" class="text-content" data-page-id="{{ current_page.id }}">
                <!-- Text will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
let currentLabel = null;
let annotationTypeMap = {};

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Build type mapping
    {% for ann_type in annotation_types %}
    annotationTypeMap['{{ ann_type.name|escapejs }}'] = {{ ann_type.id }};
    {% endfor %}

    initializeAnnotationInterface();
    loadAndRenderAnnotations();
});

function initializeAnnotationInterface() {
    // Activate annotation type buttons
    document.querySelectorAll('.annotation-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active from all
            document.querySelectorAll('.annotation-type-btn').forEach(b => b.classList.remove('active'));
            
            // Activate selected and give clear visual feedback
            this.classList.add('active');
            // Update current label for saving annotations
            currentLabel = {
                id: this.dataset.id,
                name: this.dataset.name,
                color: this.dataset.color
            };
        });
    });

    // Text selection for annotation
    document.getElementById('page-text').addEventListener('mouseup', handleTextSelection);
}

function loadAndRenderAnnotations() {
    const pageEl = document.getElementById('page-text');
    const pageId = pageEl.dataset.pageId;
    const originalText = `{{ current_page.cleaned_text|escapejs }}`;
    
    // Load annotations from backend
    fetch(`/expert/api/get-annotations/${pageId}/`)
        .then(response => response.json())
        .then(data => {
            console.log('Annotation data received:', data);
            if (data.success && data.annotations && data.annotations.length > 0) {
                console.log('Rendering', data.annotations.length, 'annotations');
                renderInlineAnnotations(originalText, data.annotations);
            } else {
                console.log('No annotations found, showing clean text');
                pageEl.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error loading annotations:', error);
            pageEl.textContent = originalText;
        });
}

function renderInlineAnnotations(originalText, annotations) {
    const pageEl = document.getElementById('page-text');
    
    if (!annotations || annotations.length === 0) {
        pageEl.textContent = originalText;
        return;
    }
    
    let workingText = originalText;
    const sortedAnnotations = [...annotations].sort((a, b) => b.selected_text.length - a.selected_text.length);
    
    for (let ann of sortedAnnotations) {
        const searchText = ann.selected_text.trim();
        const searchTextLower = searchText.toLowerCase();
        const workingTextLower = workingText.toLowerCase();
        
        let startIndex = workingTextLower.indexOf(searchTextLower);
        
        if (startIndex !== -1) {
            const actualText = workingText.slice(startIndex, startIndex + searchText.length);
            const annotationHtml = `<span class="inline-annotation" data-annotation-id="${ann.id}" style="background:${ann.color}; padding: 2px 4px; margin: 0 1px; border-radius: 3px; cursor: pointer;">${actualText}<span class="ann-label">${ann.type_display}</span></span>`;
            
            workingText = workingText.slice(0, startIndex) + annotationHtml + workingText.slice(startIndex + searchText.length);
        }
    }
    
    pageEl.innerHTML = workingText;

    // Add click events for deletion
    pageEl.querySelectorAll('.inline-annotation').forEach(annotation => {
        annotation.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (confirm('Supprimer cette annotation?')) {
                const annotationId = this.dataset.annotationId;
                deleteAnnotation(annotationId);
            }
        });
    });
}

function handleTextSelection() {
    const selection = window.getSelection();
    
    if (!selection.rangeCount || !selection.toString().trim()) {
        return;
    }

    if (!currentLabel) {
        alert('Veuillez d\'abord sélectionner un type d\'annotation');
        return;
    }

    const selectedText = selection.toString().trim();
    const pageEl = document.getElementById('page-text');
    const cleanText = pageEl.textContent || pageEl.innerText;
    
    let startPos = cleanText.toLowerCase().indexOf(selectedText.toLowerCase());
    
    if (startPos === -1) {
        alert('Impossible de localiser le texte sélectionné.');
        return;
    }
    
    const endPos = startPos + selectedText.length;

    // Save annotation
    saveManualAnnotation({
        page_id: pageEl.dataset.pageId,
        entity_type: currentLabel.name,
        selected_text: selectedText,
        start_pos: startPos,
        end_pos: endPos
    });

    // Clear selection
    selection.removeAllRanges();
}

function saveManualAnnotation(data) {
    fetch('/expert/api/save-annotation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Reload annotations to show the new one
            loadAndRenderAnnotations();
        } else {
            alert('Erreur: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la sauvegarde');
    });
}

function deleteAnnotation(annotationId) {
    fetch(`/expert/api/delete-annotation/${annotationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadAndRenderAnnotations();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting annotation:', error);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}