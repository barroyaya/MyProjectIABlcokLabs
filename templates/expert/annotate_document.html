{% extends "base.html" %}
{% load rawdocs_extras %}
{% load static %}
{% block title %}Annotation Expert {{ document.file.name|basename }} – RegExpert{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<style>
/* Variables de couleurs pharmaceutiques */
:root {
  --pharma-primary: #0ea5e9;
  --pharma-primary-dark: #0284c7;
  --pharma-accent: #10b981;
  --pharma-bg: #f8fafc;
  --pharma-bg-card: rgba(255,255,255,0.95);
  --pharma-glass: rgba(14,165,233,0.10);
  --pharma-border: #cbd5e1;
  --pharma-shadow: 0 8px 32px 0 rgba(14, 165, 233, 0.07);
  --pharma-text: #1e293b;
  --pharma-text-soft: #64748b;
  --pharma-valid: #22c55e;
  --pharma-warn: #f59e0b;
  --pharma-error: #ef4444;
  --pharma-info: #38bdf8;
  --pharma-radius: 18px;
  --pharma-radius-sm: 12px;
  --pharma-font: 'Inter', sans-serif;
  --pharma-transition: all 0.28s cubic-bezier(.4,0,.2,1);
}

/* Reset and base */
body {
  background: linear-gradient(135deg, var(--pharma-bg) 70%, #e0f2fe 100%);
  color: var(--pharma-text);
  font-family: var(--pharma-font);
}

.main-content {
  max-width: 850px;
  margin: auto;
}

/* Annotation header */
.annotation-header {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem 2rem;
  margin-bottom: 2.2rem;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1.5rem;
  animation: fadeInUp 0.5s;
}

.header-info h2 {
  color: var(--pharma-primary-dark);
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.header-info h2 i {
  color: var(--pharma-primary);
}

.document-meta {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
  color: var(--pharma-text-soft);
}

.meta-item i {
  color: var(--pharma-primary);
  width: 18px;
  text-align: center;
}

/* Navigation */
.page-navigation {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nav-btn {
  background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-primary-dark));
  color: white;
  border: none;
  border-radius: var(--pharma-radius-sm);
  padding: 0.75rem 1.5rem;
  font-weight: 600;
  transition: var(--pharma-transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.nav-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(14, 165, 233, 0.3);
  color: white;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.page-info {
  font-weight: 600;
  color: var(--pharma-text);
}

/* Types d'annotations */
.annotation-types-panel {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.annotation-types-panel h3 {
  color: var(--pharma-text);
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.annotation-types-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
}

.annotation-type-btn {
  background: linear-gradient(135deg, var(--pharma-glass), rgba(255,255,255,0.5));
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  padding: 1rem;
  cursor: pointer;
  transition: var(--pharma-transition);
  text-align: center;
  font-weight: 500;
  color: var(--pharma-text);
}

.annotation-type-btn:hover {
  background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-accent));
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
}

/* Contenu de la page */
.text-content-card {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 2rem;
  margin-bottom: 2rem;
  line-height: 1.8;
  font-size: 1.05rem;
}

.text-content-card h3 {
  color: var(--pharma-text);
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.text-content {
  color: var(--pharma-text);
  line-height: 1.8;
  user-select: text;
  cursor: text;
}

/* Annotations existantes */
.annotations-list {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.annotations-list h3 {
  color: var(--pharma-text);
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.annotation-item {
  background: var(--pharma-glass);
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  padding: 1rem;
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.annotation-text {
  font-weight: 600;
  color: var(--pharma-text);
}

.annotation-type {
  background: var(--pharma-primary);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
}

.annotation-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-validate {
  background: var(--pharma-valid);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: var(--pharma-transition);
}

.btn-validate:hover {
  background: #16a34a;
  transform: translateY(-1px);
}

.btn-reject {
  background: var(--pharma-error);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: var(--pharma-transition);
}

.btn-reject:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-delete {
  background: var(--pharma-warn);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
  cursor: pointer;
  transition: var(--pharma-transition);
}

.btn-delete:hover {
  background: #ea580c;
  transform: translateY(-1px);
}

/* Actions rapides */
.quick-actions {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.quick-actions h3 {
  color: var(--pharma-text);
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.action-btn {
  background: linear-gradient(135deg, var(--pharma-accent), var(--pharma-primary));
  color: white;
  border: none;
  border-radius: var(--pharma-radius-sm);
  padding: 1rem 1.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--pharma-transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  text-decoration: none;
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
  color: white;
}

.action-btn i {
  font-size: 1.1rem;
}

/* Responsive */
@media (max-width: 768px) {
  .annotation-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .page-navigation {
    flex-direction: column;
    gap: 1rem;
  }
  
  .annotation-types-grid {
    grid-template-columns: 1fr;
  }
  
  .actions-grid {
    grid-template-columns: 1fr;
  }
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fadeInUp 0.5s ease-out;
}

/* Highlight pour texte sélectionné */
.text-highlight {
  background-color: rgba(14, 165, 233, 0.2);
  border-radius: 3px;
  padding: 1px 3px;
}

/* Context menu */
.context-menu {
  position: absolute;
  background: white;
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  box-shadow: var(--pharma-shadow);
  z-index: 10000;
  padding: 0.5rem 0;
  min-width: 180px;
}

.context-menu-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  font-size: 0.95rem;
  color: var(--pharma-text);
  transition: var(--pharma-transition);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.context-menu-item:hover {
  background-color: var(--pharma-glass);
}

.context-menu-item.danger {
  color: var(--pharma-error);
}

.context-menu-item.danger:hover {
  background-color: rgba(239, 68, 68, 0.1);
}

.context-menu.hidden {
  display: none;
}
</style>

<!-- Header -->
<section class="annotation-header">
  <div class="header-info">
    <h2><i class="fas fa-highlighter"></i> Annotation Expert - {{ document.title }}</h2>
    <div class="document-meta">
      <span class="meta-item">
        <i class="fas fa-file-alt"></i>
        {{ document.total_pages }} page(s)
      </span>
      <span class="meta-item">
        <i class="fas fa-user"></i>
        Annotateur: {{ document.owner.username }}
      </span>
      <span class="meta-item">
        <i class="fas fa-calendar-alt"></i>
        {{ document.created_at|date:"d/m/Y" }}
      </span>
    </div>
  </div>
  
  <div class="header-actions">
    <a href="{% url 'expert:annotation_dashboard' %}" class="nav-btn">
      <i class="fas fa-arrow-left"></i> Retour
    </a>
  </div>
</section>

<!-- Navigation entre pages -->
<section class="page-navigation">
  <div>
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="nav-btn">
        <i class="fas fa-chevron-left"></i> Page précédente
      </a>
    {% else %}
      <button class="nav-btn" disabled>
        <i class="fas fa-chevron-left"></i> Page précédente
      </button>
    {% endif %}
  </div>
  
  <div class="page-info">
    Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
  </div>
  
  <div>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="nav-btn">
        Page suivante <i class="fas fa-chevron-right"></i>
      </a>
    {% else %}
      <button class="nav-btn" disabled>
        Page suivante <i class="fas fa-chevron-right"></i>
      </button>
    {% endif %}
  </div>
</section>

<!-- Types d'annotations disponibles -->
<section class="annotation-types-panel">
  <h3><i class="fas fa-tags"></i> Types d'Annotations Disponibles</h3>
  <div class="annotation-types-grid">
    {% for annotation_type in annotation_types %}
    <button class="annotation-type-btn" onclick="selectAnnotationType('{{ annotation_type.name }}', '{{ annotation_type.display_name }}')">
      <i class="fas fa-tag"></i>
      {{ annotation_type.display_name }}
    </button>
    {% endfor %}
  </div>
</section>

<!-- Actions rapides -->
<section class="quick-actions">
  <h3><i class="fas fa-bolt"></i> Actions Rapides Expert</h3>
  <div class="actions-grid">
    <button class="action-btn" onclick="aiAnnotatePage()">
      <i class="fas fa-robot"></i>
      Annotation IA Automatique
    </button>
    <button class="action-btn" onclick="validateAllAnnotations()">
      <i class="fas fa-check-double"></i>
      Valider Toutes les Annotations
    </button>
    <a href="{% url 'expert:generate_page_annotation_summary' current_page.id %}" class="action-btn" onclick="generateSummary(event)">
      <i class="fas fa-file-text"></i>
      Générer Résumé & JSON
    </a>
    <a href="{% url 'expert:view_page_annotation_json' current_page.id %}" class="action-btn">
      <i class="fas fa-code"></i>
      Voir JSON & Résumé
    </a>
  </div>
</section>

<!-- Contenu de la page -->
{% if current_page %}
<section class="text-content-card">
  <h3><i class="fas fa-file-text"></i> Contenu de la Page {{ current_page.page_number }}</h3>
  <div class="text-content" id="page-text" data-page-id="{{ current_page.id }}">
    {{ current_page.text_content|linebreaks }}
  </div>
</section>

<!-- Annotations existantes -->
<section class="annotations-list">
  <h3><i class="fas fa-list"></i> Annotations Existantes ({{ existing_annotations|length }})</h3>
  {% if existing_annotations %}
    <div id="annotations-container">
      {% for annotation in existing_annotations %}
      <div class="annotation-item" data-annotation-id="{{ annotation.id }}">
        <div>
          <div class="annotation-text">"{{ annotation.selected_text }}"</div>
          <span class="annotation-type">{{ annotation.annotation_type.display_name }}</span>
        </div>
        <div class="annotation-actions">
          {% if annotation.validation_status == 'pending' %}
            <button class="btn-validate" onclick="validateAnnotation({{ annotation.id }})">
              <i class="fas fa-check"></i> Valider
            </button>
            <button class="btn-reject" onclick="rejectAnnotation({{ annotation.id }})">
              <i class="fas fa-times"></i> Rejeter
            </button>
          {% endif %}
          <button class="btn-delete" onclick="deleteAnnotation({{ annotation.id }})">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-8">
      <i class="fas fa-tags text-6xl text-gray-300 mb-4"></i>
      <p class="text-gray-500">Aucune annotation sur cette page. Sélectionnez du texte pour commencer.</p>
    </div>
  {% endif %}
</section>
{% endif %}

<!-- Context Menu -->
<div id="context-menu" class="context-menu hidden">
  <div class="context-menu-item" onclick="annotateSelection()">
    <i class="fas fa-plus"></i> Annoter la sélection
  </div>
  <div class="context-menu-item danger" onclick="hideContextMenu()">
    <i class="fas fa-times"></i> Annuler
  </div>
</div>

<script>
let selectedText = '';
let selectedRange = null;
let currentAnnotationType = null;
let currentAnnotationDisplayName = null;

// Sélection de type d'annotation
function selectAnnotationType(name, displayName) {
  currentAnnotationType = name;
  currentAnnotationDisplayName = displayName;
  
  // Mettre à jour l'interface
  document.querySelectorAll('.annotation-type-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  alert(`Type d'annotation sélectionné: ${displayName}`);
}

// Gestion de la sélection de texte
document.addEventListener('mouseup', function(e) {
  const selection = window.getSelection();
  if (selection.toString().trim().length > 0) {
    selectedText = selection.toString().trim();
    selectedRange = selection.getRangeAt(0);
    showContextMenu(e.pageX, e.pageY);
  } else {
    hideContextMenu();
  }
});

// Afficher le menu contextuel
function showContextMenu(x, y) {
  const contextMenu = document.getElementById('context-menu');
  contextMenu.style.left = x + 'px';
  contextMenu.style.top = y + 'px';
  contextMenu.classList.remove('hidden');
}

// Cacher le menu contextuel
function hideContextMenu() {
  document.getElementById('context-menu').classList.add('hidden');
}

// Annoter la sélection
function annotateSelection() {
  if (!selectedText || !currentAnnotationType) {
    alert('Veuillez sélectionner un type d\'annotation d\'abord');
    return;
  }
  
  const pageId = document.getElementById('page-text').dataset.pageId;
  
  fetch('{% url "expert:save_manual_annotation" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      page_id: pageId,
      selected_text: selectedText,
      entity_type: currentAnnotationType,
      start_pos: 0,
      end_pos: selectedText.length
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Annotation sauvegardée avec succès!');
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la sauvegarde');
  });
  
  hideContextMenu();
}

// Annotation IA automatique
function aiAnnotatePage() {
  const pageId = document.getElementById('page-text').dataset.pageId;
  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Annotation en cours...';
  
  fetch(`{% url "expert:ai_annotate_page_groq" 0 %}`.replace('0', pageId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`${data.annotations.length} annotations créées automatiquement!`);
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de l\'annotation IA');
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> Annotation IA Automatique';
  });
}

// Valider toutes les annotations
function validateAllAnnotations() {
  const pageId = document.getElementById('page-text').dataset.pageId;
  
  fetch(`{% url "expert:validate_page_annotations" 0 %}`.replace('0', pageId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(`${data.validated_count} annotations validées!`);
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la validation');
  });
}

// Valider une annotation
function validateAnnotation(annotationId) {
  fetch(`{% url "expert:validate_annotation" 0 %}`.replace('0', annotationId), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({action: 'validate'})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Annotation validée!');
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la validation');
  });
}

// Rejeter une annotation
function rejectAnnotation(annotationId) {
  fetch(`{% url "expert:validate_annotation" 0 %}`.replace('0', annotationId), {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({action: 'reject'})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Annotation rejetée!');
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors du rejet');
  });
}

// Supprimer une annotation
function deleteAnnotation(annotationId) {
  if (!confirm('Êtes-vous sûr de vouloir supprimer cette annotation?')) {
    return;
  }
  
  fetch(`{% url "expert:delete_annotation_expert" 0 %}`.replace('0', annotationId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Annotation supprimée!');
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la suppression');
  });
}

// Générer résumé
function generateSummary(event) {
  event.preventDefault();
  const pageId = document.getElementById('page-text').dataset.pageId;
  
  fetch(`{% url "expert:generate_page_annotation_summary" 0 %}`.replace('0', pageId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Résumé et JSON générés avec succès!');
      // Rediriger vers la page de visualisation
      window.location.href = `{% url "expert:view_page_annotation_json" 0 %}`.replace('0', pageId);
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Erreur lors de la génération');
  });
}

// Cacher le menu contextuel en cliquant ailleurs
document.addEventListener('click', function(e) {
  if (!e.target.closest('#context-menu')) {
    hideContextMenu();
  }
});
</script>

{% endblock %}