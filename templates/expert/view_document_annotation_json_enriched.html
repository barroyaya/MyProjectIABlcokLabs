{#template/expert/view_document_json_enriched.html#}
{#{% extends "base.html" %}#}
{#{% load static %}#}
{#{% load expert_extras %}#}
{#{% block title %}JSON Sémantique Expert - {{ document.title }} – RegExpert{% endblock %}#}
{##}
{#{% block content %}#}
{#<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">#}
{#<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">#}
{#<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">#}
{##}
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>#}
{##}
{# --- JSON DATA SAFE PASSING --- #}
{#{{ global_annotations_json|json_script:"basic-json-data" }}#}
{#{{ enriched_annotations_json|default:"{}"|json_script:"enriched-json-data" }}#}
{#{{ display_json|default:"{}"|json_script:"display-json-data" }}#}
{##}
{#<style>#}
{#:root{#}
{#  --pharma-primary:#3b82f6;--pharma-accent:#10b981;--pharma-info:#06b6d4;#}
{#  --pharma-success:#059669;--pharma-warning:#f59e0b;#}
{#  --pharma-bg-card:#fff;--pharma-bg:#f8fafc;--pharma-text:#1e293b;--pharma-text-soft:#64748b;#}
{#  --pharma-border:#e2e8f0;--pharma-radius:12px;--pharma-radius-sm:8px;--pharma-shadow:0 4px 16px rgba(15,23,42,.08);#}
{#  --pharma-transition:.3s cubic-bezier(.4,0,.2,1);#}
{#  --ai-color:#3b82f6;--expert-color:#10b981;--diff-bg:#f8fafc;--improvement-bg:#ecfdf5;--correction-bg:#fef2f2;#}
{#}#}
{#body{background:var(--pharma-bg);color:var(--pharma-text);font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif}#}
{##}
{#/* Tabs */#}
{#.mode-tabs{display:flex;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:var(--pharma-radius);padding:.75rem;margin-bottom:2rem;box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border)}#}
{#.mode-tab{flex:1;padding:1rem 1.5rem;text-align:center;border-radius:var(--pharma-radius-sm);background:transparent;border:1px solid transparent;color:var(--pharma-text-soft);cursor:pointer;transition:var(--pharma-transition);font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}#}
{#.mode-tab:hover{background:rgba(59,130,246,.1);color:var(--pharma-primary)}#}
{#.mode-tab.active{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;border-color:var(--pharma-primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}#}
{##}
{#/* Cards */#}
{#.semantic-card{background:var(--pharma-bg-card);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);margin-bottom:1.5rem;overflow:hidden;transition:var(--pharma-transition)}#}
{#.semantic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,23,42,.12)}#}
{#.semantic-card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));padding:1.5rem;border-bottom:1px solid var(--pharma-border)}#}
{#.semantic-card-header h3{font-size:1.25rem;font-weight:600;color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.75rem}#}
{#.semantic-card-body{padding:1.5rem}#}
{##}
{#/* Relations */#}
{#.relations-container{display:flex;flex-direction:column;gap:1rem}#}
{#.relation-item{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));border:1px solid rgba(59,130,246,.2);border-radius:var(--pharma-radius-sm);padding:1rem;display:flex;align-items:center;gap:1rem;transition:var(--pharma-transition)}#}
{#.relation-item:hover{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));border-color:var(--pharma-primary)}#}
{#.entity-node{background:var(--pharma-primary);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.9rem;font-weight:500;white-space:nowrap}#}
{#.relation-arrow{color:var(--pharma-accent);font-size:1.2rem;font-weight:bold}#}
{#.relation-type{background:var(--pharma-accent);color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:500}#}
{##}
{#/* Q&A */#}
{#.qa-container{display:flex;flex-direction:column;gap:1rem}#}
{#.qa-item{background:linear-gradient(135deg,rgba(6,182,212,.05),rgba(139,92,246,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--pharma-radius-sm);padding:1.5rem}#}
{#.qa-question{font-weight:600;color:var(--pharma-text);margin-bottom:.75rem;display:flex;gap:.5rem}#}
{#.qa-question::before{content:"Q:";color:var(--pharma-info);font-weight:700}#}
{#.qa-answer{color:var(--pharma-text-soft);line-height:1.6;margin-left:1.75rem;display:flex;gap:.5rem}#}
{#.qa-answer::before{content:"R:";color:var(--pharma-accent);font-weight:700}#}
{##}
{#/* QA test */#}
{#.qa-test-interface{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));border:1px solid rgba(245,158,11,.3);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.qa-input-group{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem}#}
{#.qa-input{flex:1;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}#}
{#.qa-input:focus{outline:none;border-color:var(--pharma-warning);box-shadow:0 0 0 3px rgba(245,158,11,.1)}#}
{#.qa-test-btn{padding:.75rem 1.5rem;background:var(--pharma-warning);color:#fff;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}#}
{#.qa-test-btn:hover{background:#d97706;transform:translateY(-1px)}#}
{#.qa-result{background:#fff;border-radius:8px;padding:1rem;border-left:4px solid var(--pharma-success);margin-top:1rem;display:none}#}
{##}
{#/* JSON panels */#}
{#.json-comparison{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}#}
{#.json-panel{background:#fff;border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);padding:1.5rem}#}
{#.json-panel h4{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--pharma-text);display:flex;align-items:center;gap:.5rem}#}
{##}
{#/* Learning Section */#}
{#.learning-section{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(59,130,246,.05));border:2px solid var(--pharma-accent);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.learning-header{display:flex;justify-content:between;align-items:center;margin-bottom:1.5rem}#}
{#.learning-header h4{color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.5rem}#}
{#.learning-actions{display:flex;gap:.75rem;flex-wrap:wrap}#}
{#.learning-btn{padding:.5rem 1rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.4rem;align-items:center;transition:var(--pharma-transition)}#}
{#.learning-btn.primary{background:linear-gradient(135deg,var(--expert-color),#059669);color:#fff}#}
{#.learning-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{#.learning-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}#}
{##}
{#/* Comparison cards */#}
{#.comparison-card{border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.08);margin-bottom:1rem;overflow:hidden;background:white;position:relative}#}
{#.delta-header{background:linear-gradient(135deg,var(--diff-bg),#e2e8f0);padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}#}
{#.delta-type-badge{padding:.4rem 1rem;border-radius:20px;font-size:.85rem;font-weight:600}#}
{#.delta-type-relation_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-relation_modified{background:#fef3c7;color:#d97706}#}
{#.delta-type-qa_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-qa_corrected{background:#fef3c7;color:#d97706}#}
{#.version-comparison{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}#}
{#.ai-version,.expert-version{padding:1rem;border-radius:8px;border:2px solid}#}
{#.ai-version{border-color:var(--ai-color);background:rgba(59,130,246,.05)}#}
{#.expert-version{border-color:var(--expert-color);background:rgba(16,185,129,.05)}#}
{#.version-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-weight:600}#}
{#.ai-version .version-header{color:var(--ai-color)}#}
{#.expert-version .version-header{color:var(--expert-color)}#}
{#.relation-display{background:#f8fafc;padding:.75rem;border-radius:6px;font-family:'Courier New',monospace;margin-bottom:.5rem}#}
{#.description-text{font-style:italic;color:#64748b;margin-top:.5rem}#}
{#.improvement-indicator{position:absolute;top:-5px;right:-5px;background:var(--expert-color);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px}#}
{#.learning-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}#}
{#.learning-stat{background:white;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)}#}
{#.learning-stat-value{font-size:1.5rem;font-weight:800;color:var(--expert-color);margin-bottom:.25rem}#}
{#.learning-stat-label{font-size:.8rem;color:var(--pharma-text-soft)}#}
{##}
{#/* Actions */#}
{#.enrichment-actions{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}#}
{#.enrichment-btn{padding:.75rem 1.5rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}#}
{#.enrichment-btn.primary{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff}#}
{#.enrichment-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{##}
{#/* Modales */#}
{#.semantic-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;display:none;align-items:center;justify-content:center}#}
{#.semantic-modal.show{display:flex;animation:fadeIn .3s ease-out}#}
{#.modal-content-semantic{background:#fff;border-radius:var(--pharma-radius);box-shadow:0 20px 60px rgba(0,0,0,.3);width:90%;max-width:700px;max-height:80vh;overflow-y:auto}#}
{#.modal-header-semantic{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:1.5rem 2rem;border-radius:var(--pharma-radius) var(--pharma-radius) 0 0;display:flex;justify-content:space-between;align-items:center}#}
{#.modal-body-semantic{padding:2rem}#}
{#.form-group{margin-bottom:1.5rem}.form-label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--pharma-text)}#}
{#.form-control{width:100%;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}#}
{#.form-control:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}#}
{##}
{#@media (max-width:768px){.json-comparison{grid-template-columns:1fr}.enrichment-actions{flex-direction:column}.mode-tabs{flex-direction:column}.qa-input-group{flex-direction:column}.version-comparison{grid-template-columns:1fr}}#}
{#@keyframes fadeIn{from{opacity:0}to{opacity:1}}#}
{##}
{#/* Stats (Overview) */#}
{#.stats-grid{#}
{#  display:grid;#}
{#  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));#}
{#  gap:1rem;#}
{#  margin-bottom:1rem;#}
{#}#}
{#.stat-card{#}
{#  display:flex;align-items:center;gap:12px;#}
{#  background:var(--pharma-bg-card);#}
{#  border:1px solid var(--pharma-border);#}
{#  border-radius:var(--pharma-radius);#}
{#  box-shadow:var(--pharma-shadow);#}
{#  padding:1rem 1.25rem;#}
{#}#}
{#.stat-icon{#}
{#  width:44px;height:44px;border-radius:50%;#}
{#  display:grid;place-items:center;#}
{#  background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(16,185,129,.12));#}
{#  color:var(--pharma-primary);#}
{#  flex:0 0 44px;#}
{#}#}
{#.stat-content{display:flex;flex-direction:column;line-height:1.1}#}
{#.stat-value{#}
{#  font-size:1.6rem;font-weight:800;color:var(--pharma-primary);#}
{#}#}
{#.stat-label{#}
{#  font-size:.95rem;color:var(--pharma-text-soft);margin-top:2px#}
{#}#}
{#</style>#}
{##}
{#<section class="semantic-card">#}
{#  <div class="semantic-card-header">#}
{#    <h2><i class="fas fa-brain"></i> JSON Sémantique Expert - {{ document.title|truncatechars:50 }}</h2>#}
{#  </div>#}
{#  <div class="semantic-card-body">#}
{#    <div class="mode-tabs">#}
{#      <div class="mode-tab active" data-mode="overview"><i class="fas fa-chart-pie"></i>Vue d'ensemble</div>#}
{#      <div class="mode-tab" data-mode="relations"><i class="fas fa-project-diagram"></i>Relations ({{ enriched_stats.relations_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="qa"><i class="fas fa-question-circle"></i>Q&A ({{ enriched_stats.qa_pairs_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="json"><i class="fas fa-graduation-cap"></i>JSON & Apprentissage</div>#}
{#    </div>#}
{##}
{#    <div class="enrichment-actions">#}
{#      {% if not has_enriched %}#}
{#        <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#      {% else %}#}
{#        <button class="enrichment-btn secondary" onclick="regenerateEnrichment()"><i class="fas fa-sync-alt"></i>Régénérer</button>#}
{#      {% endif %}#}
{#      <button class="enrichment-btn primary" onclick="showAddRelationModal()"><i class="fas fa-plus"></i>Ajouter Relation</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddQAModal()"><i class="fas fa-question"></i>Ajouter Q&A</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddTextModal()"><i class="fas fa-file-alt"></i> Depuis un paragraphe</button>#}
{#      <a href="{% url 'expert:annotation_dashboard' %}" class="enrichment-btn secondary"><i class="fas fa-arrow-left"></i>Retour Dashboard</a>#}
{#    </div>#}
{#  </div>#}
{#</section>#}
{##}
{# --- OVERVIEW --- #}
{#<div id="overview-tab" class="tab-content">#}
{#  {% if has_enriched %}#}
{#  <div class="stats-grid">#}
{#  <div class="stat-card">#}
{#    <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>#}
{#    <div class="stat-content">#}
{#      <div class="stat-value">{{ enriched_stats.relations_count|default:0 }}</div>#}
{#      <div class="stat-label">Relations identifiées</div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  <div class="stat-card">#}
{#    <div class="stat-icon"><i class="fas fa-question-circle"></i></div>#}
{#    <div class="stat-content">#}
{#      <div class="stat-value">{{ enriched_stats.qa_pairs_count|default:0 }}</div>#}
{#      <div class="stat-label">Questions-Réponses</div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  <div class="stat-card">#}
{#    <div class="stat-icon"><i class="fas fa-layer-group"></i></div>#}
{#    <div class="stat-content">#}
{#      <div class="stat-value">{{ enriched_stats.contexts_count|default:0 }}</div>#}
{#      <div class="stat-label">Contextes sémantiques</div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  <div class="stat-card">#}
{#    <div class="stat-icon"><i class="fas fa-list-check"></i></div>#}
{#    <div class="stat-content">#}
{#      <div class="stat-value">{{ total_annotations|default:0 }}</div>#}
{#      <div class="stat-label">Annotations totales</div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#  {% if enriched_annotations_json.semantic_summary %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-lightbulb"></i> Résumé Sémantique Intelligent</h3></div>#}
{#    <div class="semantic-card-body"><p style="font-size:1.1rem;line-height:1.8">{{ enriched_annotations_json.semantic_summary }}</p></div>#}
{#  </div>#}
{#  {% endif %}#}
{##}
{#  <div class="qa-test-interface">#}
{#    <h4><i class="fas fa-vial"></i> Tester le Système de Questions-Réponses</h4>#}
{#    <div style="display:flex;gap:1rem;align-items:center;margin:.25rem 0 1rem">#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="basic"> JSON basique</label>#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="enriched" checked> JSON enrichi</label>#}
{#    </div>#}
{#    <div class="qa-input-group">#}
{#      <input type="text" id="test-question" class="qa-input" placeholder="ex: Quel est le dosage du produit ?">#}
{#      <button class="qa-test-btn" onclick="testQASystem()"><i class="fas fa-search"></i>Tester</button>#}
{#    </div>#}
{#    <div id="qa-test-result" class="qa-result"></div>#}
{#    <div id="qa-correction" class="qa-result" style="display:none;border-left-color:#f59e0b">#}
{#      <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b"><i class="fas fa-edit"></i> Corriger la réponse</div>#}
{#      <textarea id="qa-corrected" class="form-control" rows="4" placeholder="Proposez la meilleure réponse..."></textarea>#}
{#      <div style="text-align:right;margin-top:.5rem">#}
{#        <button class="enrichment-btn secondary" onclick="sendQACorrection()"><i class="fas fa-save"></i>Enregistrer la correction</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#  {% else %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-body" style="text-align:center;padding:3rem">#}
{#      <i class="fas fa-brain" style="font-size:4rem;color:var(--pharma-text-soft);margin-bottom:1rem"></i>#}
{#      <h3>JSON Non Enrichi</h3>#}
{#      <p>Ce document possède un JSON basique mais pas encore d'enrichissement sémantique.</p>#}
{#      <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#    </div>#}
{#  </div>#}
{#  {% endif %}#}
{#</div>#}
{##}
{# --- RELATIONS --- #}
{#<div id="relations-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-project-diagram"></i> Relations Entre Entités</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="relations-container" class="relations-container">#}
{#        {% if enriched_annotations_json.relations %}#}
{#          {% for relation in enriched_annotations_json.relations %}#}
{#          <div class="relation-item">#}
{#            <div class="entity-node">{{ relation.source.value }}</div>#}
{#            <div class="relation-type">{{ relation.type|default:"relation" }}</div>#}
{#            <div class="relation-arrow">→</div>#}
{#            <div class="entity-node">{{ relation.target.value }}</div>#}
{#            {% if relation.description %}<small style="color:var(--pharma-text-soft);margin-left:auto">{{ relation.description }}</small>{% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">#}
{#            <i class="fas fa-project-diagram" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune relation identifiée. Utilisez "Ajouter Relation".</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- Q&A --- #}
{#<div id="qa-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-question-circle"></i> Questions-Réponses Automatiques</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="qa-container" class="qa-container">#}
{#        {% if enriched_annotations_json.questions_answers %}#}
{#          {% for qa in enriched_annotations_json.questions_answers %}#}
{#          <div class="qa-item">#}
{#            <div class="qa-question">{{ qa.question }}</div>#}
{#            <div class="qa-answer">{{ qa.answer }}</div>#}
{#            {% if qa.created_by == "expert" %}#}
{#              <div style="margin-top:.5rem">#}
{#                <span style="background:var(--pharma-success);color:#fff;padding:.2rem .5rem;border-radius:10px;font-size:.7rem"><i class="fas fa-user-check"></i> Expert</span>#}
{#              </div>#}
{#            {% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">#}
{#            <i class="fas fa-question-circle" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune Q&A générée. Utilisez "Ajouter Q&A".</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- JSON & APPRENTISSAGE --- #}
{#<div id="json-tab" class="tab-content" style="display:none">#}
{##}
  {# Section Apprentissage Expert #}
{#  <div class="learning-section">#}
{#    <div class="learning-header">#}
{#      <h4><i class="fas fa-graduation-cap"></i> Apprentissage Expert IA</h4>#}
{#      <div class="learning-actions">#}
{#        <button class="learning-btn primary" onclick="compareWithFreshAI()">#}
{#          <i class="fas fa-balance-scale"></i>Comparer avec IA#}
{#        </button>#}
{#        <button class="learning-btn primary" onclick="regenerateWithLearning()">#}
{#          <i class="fas fa-magic"></i>Régénérer +Apprentissage#}
{#        </button>#}
{#        <button class="learning-btn secondary" onclick="viewDetailedHistory()">#}
{#          <i class="fas fa-history"></i>Historique détaillé#}
{#        </button>#}
{#      </div>#}
{#    </div>#}
{##}
{#    <div class="learning-stats" id="learning-stats">#}
{#      <div class="learning-stat">#}
{#        <div class="learning-stat-value" id="corrections-count">-</div>#}
{#        <div class="learning-stat-label">Corrections totales</div>#}
{#      </div>#}
{#      <div class="learning-stat">#}
{#        <div class="learning-stat-value" id="relations-improved">-</div>#}
{#        <div class="learning-stat-label">Relations améliorées</div>#}
{#      </div>#}
{#      <div class="learning-stat">#}
{#        <div class="learning-stat-value" id="qa-improved">-</div>#}
{#        <div class="learning-stat-label">Q&A améliorées</div>#}
{#      </div>#}
{#      <div class="learning-stat">#}
{#        <div class="learning-stat-value" id="patterns-reused">-</div>#}
{#        <div class="learning-stat-label">Patterns réutilisés</div>#}
{#      </div>#}
{#    </div>#}
{##}
{#    <div id="comparison-results" style="display:none">#}
{#      <h5><i class="fas fa-microscope"></i> Dernière comparaison IA vs Expert</h5>#}
{#      <div id="comparison-cards-container"></div>#}
{#    </div>#}
{#  </div>#}
{##}
  {# JSON Editors #}
{#  <div class="json-comparison">#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-file-code"></i> JSON Basique</h4>#}
{#      <div id="basic-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{##}
{#    {% if has_enriched %}#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-brain"></i> JSON Enrichi</h4>#}
{#      <div id="enriched-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{#    {% else %}#}
{#    <div class="json-panel" style="display:flex;align-items:center;justify-content:center;background:var(--pharma-bg)">#}
{#      <div style="text-align:center;color:var(--pharma-text-soft)">#}
{#        <i class="fas fa-brain" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#        <p>JSON enrichi disponible après enrichissement</p>#}
{#      </div>#}
{#    </div>#}
{#    {% endif %}#}
{#  </div>#}
{##}
{#  <div style="text-align:center;margin-top:1rem">#}
{#    <button class="enrichment-btn primary" onclick="saveJSONChanges()"><i class="fas fa-save"></i>Sauvegarder les Modifications</button>#}
{#  </div>#}
{#</div>#}
{##}
{# --- MODALES --- #}
{#<div id="add-relation-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-plus"></i> Ajouter une Relation</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-relation-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group">#}
{#        <label class="form-label">Entité Source</label>#}
{#        <select id="relation-source" class="form-control"><option value="">Sélectionner...</option></select>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Type de Relation</label>#}
{#        <select id="relation-type" class="form-control">#}
{#          <option value="contains">contient</option>#}
{#          <option value="manufactured_by">fabriqué par</option>#}
{#          <option value="has_dosage">a pour dosage</option>#}
{#          <option value="used_for">utilisé pour</option>#}
{#          <option value="contraindicated_with">contre-indiqué avec</option>#}
{#          <option value="interacts_with">interagit avec</option>#}
{#        </select>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Entité Cible</label>#}
{#        <select id="relation-target" class="form-control"><option value="">Sélectionner...</option></select>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Description (optionnelle)</label>#}
{#        <input type="text" id="relation-description" class="form-control" placeholder="Description de la relation...">#}
{#      </div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-relation-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addRelation()"><i class="fas fa-plus"></i>Ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<div id="add-qa-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-question"></i> Ajouter Question-Réponse</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-qa-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group"><label class="form-label">Question</label><input type="text" id="qa-question" class="form-control" placeholder="ex: Quel est le dosage du produit ?"></div>#}
{#      <div class="form-group"><label class="form-label">Réponse</label><textarea id="qa-answer" class="form-control" rows="3" placeholder="Réponse complète..."></textarea></div>#}
{#      <div class="form-group"><label class="form-label">Tags (optionnel)</label><input type="text" id="qa-tags" class="form-control" placeholder="dosage, posologie, administration"></div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-qa-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addQAPair()"><i class="fas fa-plus"></i>Ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<div id="add-text-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-file-alt"></i> Extraire des relations depuis un paragraphe</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-text-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group">#}
{#        <label class="form-label">Paragraphe</label>#}
{#        <textarea id="free-text" class="form-control" rows="6" placeholder="Collez ici un extrait du document (procédures, obligations, interactions, etc.)"></textarea>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Aide (optionnelle)</label>#}
{#        <input id="free-text-hint" class="form-control" placeholder="ex: réglementation, posologie, interactions...">#}
{#      </div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-text-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addFromParagraph()">#}
{#          <i class="fas fa-magic"></i> Analyser & ajouter#}
{#        </button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<script>#}
{#(function () {#}
{#  /* ========== Utils (exportés) ========== */#}
{#  function fromJsonScript(id, fallback) {#}
{#    const n = document.getElementById(id);#}
{#    if (!n) return fallback;#}
{#    try { return JSON.parse(n.textContent.trim() || '{}'); }#}
{#    catch (e) { console.warn('JSON invalide pour', id, e); return fallback; }#}
{#  }#}
{##}
{#  function getCookie(name) {#}
{#    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));#}
{#    return m ? decodeURIComponent(m[1]) : '';#}
{#  }#}
{#  window.getCookie = getCookie;#}
{##}
{#  function notify(msg, type) {#}
{#    const el = document.createElement('div');#}
{#    el.className = `expert-notification ${type || 'info'}`;#}
{#    el.innerHTML = `<div class="notification-content">#}
{#      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>#}
{#      <span>${msg}</span>#}
{#    </div>`;#}
{#    if (!document.getElementById('expert-notification-styles')) {#}
{#      const css = document.createElement('style'); css.id = 'expert-notification-styles';#}
{#      css.textContent =#}
{#        `.expert-notification{position:fixed;top:20px;right:20px;z-index:10000;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);animation:slideIn .25s ease-out;max-width:400px}#}
{#         .expert-notification.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(34,197,94,.9));color:#fff}#}
{#         .expert-notification.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}#}
{#         .expert-notification.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(16,185,129,.9));color:#fff}#}
{#         .notification-content{display:flex;align-items:center;gap:.75rem;font-weight:500;font-size:.9rem}#}
{#         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}#}
{#         @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;#}
{#      document.head.appendChild(css);#}
{#    }#}
{#    document.body.appendChild(el);#}
{#    setTimeout(() => { el.style.animation = 'slideOut .25s ease-in'; setTimeout(() => el.remove(), 280); }, 3000);#}
{#  }#}
{#  window.notify = notify;#}
{##}
{#  /* ========== Données depuis les balises <script type="application/json"> ========== */#}
{#  const BASIC    = fromJsonScript('basic-json-data',   {});#}
{#  const ENRICHED = fromJsonScript('enriched-json-data',{});#}
{#  const DISPLAY  = fromJsonScript('display-json-data', {});#}
{##}
{#  /* ========== Monaco ========== */#}
{#  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });#}
{##}
{#  function makeEditor(id, val, readOnly) {#}
{#    const el = document.getElementById(id); if (!el) return null;#}
{#    return monaco.editor.create(el, {#}
{#      value: JSON.stringify(val ?? {}, null, 2),#}
{#      language: 'json', theme: 'vs', readOnly: !!readOnly,#}
{#      automaticLayout: true, minimap: { enabled: false }, wordWrap: 'on', scrollBeyondLastLine: false#}
{#    });#}
{#  }#}
{##}
{#  let basicEditor = null, enrichedEditor = null;#}
{##}
{#  document.addEventListener('DOMContentLoaded', function () {#}
{#    // Tabs#}
{#    document.querySelectorAll('.mode-tab').forEach(tab => {#}
{#      tab.addEventListener('click', () => {#}
{#        const mode = tab.dataset.mode;#}
{#        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t === tab));#}
{#        document.querySelectorAll('.tab-content').forEach(c => c.style.display = (c.id === mode + '-tab') ? 'block' : 'none');#}
{#        [basicEditor, enrichedEditor].forEach(ed => ed && ed.layout());#}
{#      });#}
{#    });#}
{##}
{#    // Monaco init#}
{#    require(['vs/editor/editor.main'], function () {#}
{#      basicEditor    = makeEditor('basic-json-editor',    BASIC,    true);#}
{#      enrichedEditor = makeEditor('enriched-json-editor', ENRICHED, false);#}
{##}
{#      if (enrichedEditor && (!ENRICHED || Object.keys(ENRICHED).length === 0)) {#}
{#        enrichedEditor.setValue('// Pas encore enrichi. Cliquez sur « Régénérer » pour créer le JSON enrichi.');#}
{#      }#}
{##}
{#      // Validation simple#}
{#      let decorations = [];#}
{#      function validate(ed) {#}
{#        if (!ed || ed.getRawOptions().readOnly) return;#}
{#        try { JSON.parse(ed.getValue()); decorations = ed.deltaDecorations(decorations, []); }#}
{#        catch (e) {#}
{#          const model = ed.getModel(); const m = String(e.message).match(/position\s+(\d+)/i); if (!m) return;#}
{#          const pos = model.getPositionAt(+m[1]);#}
{#          decorations = ed.deltaDecorations(decorations, [{#}
{#            range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column + 1),#}
{#            options: { inlineClassName: 'squiggly-error', hoverMessage: { value: e.message } }#}
{#          }]);#}
{#        }#}
{#      }#}
{#      enrichedEditor && enrichedEditor.onDidChangeModelContent(() => validate(enrichedEditor));#}
{#    });#}
{##}
{#    populateEntitySelectors(BASIC);#}
{#    loadLearningStats();#}
{#  });#}
{##}
{#  function populateEntitySelectors(basicJson) {#}
{#    const src = document.getElementById('relation-source');#}
{#    const tgt = document.getElementById('relation-target');#}
{#    if (!(src && tgt)) return;#}
{#    src.innerHTML = '<option value="">Sélectionner...</option>';#}
{#    tgt.innerHTML = '<option value="">Sélectionner...</option>';#}
{#    const entities = (basicJson && basicJson.entities) || {};#}
{#    Object.entries(entities).forEach(([type, items]) => {#}
{#      const list = Array.isArray(items) ? items : ((items && items.items) || []);#}
{#      list.forEach(it => {#}
{#        const val = (typeof it === 'string') ? it : ((it && it.value) || '');#}
{#        if (!val) return;#}
{#        src.add(new Option(`${type}: ${val}`, JSON.stringify({ type, value: val })));#}
{#        tgt.add(new Option(`${type}: ${val}`, JSON.stringify({ type, value: val })));#}
{#      });#}
{#    });#}
{#  }#}
{##}
{#  /* ========== Actions principales (exportées) ========== */#}
{#  async function enrichDocumentJSON(force = false) {#}
{#    notify('Enrichissement en cours...', 'info');#}
{#    try {#}
{#      const url = `/expert/annotation/document/{{ document.id }}/enrich-json/` + (force ? `?force=1` : ``);#}
{#      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' } });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify(`✅ JSON enrichi. ${data.relations_count} relations, ${data.qa_pairs_count} Q&A.`, 'success'); setTimeout(() => location.reload(), 900); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.enrichDocumentJSON = enrichDocumentJSON;#}
{#  window.regenerateEnrichment = () => enrichDocumentJSON(true);#}
{##}
{#  async function saveJSONChanges() {#}
{#    if (!enrichedEditor) { notify('Aucun éditeur enrichi', 'error'); return; }#}
{#    try {#}
{#      const payload = JSON.parse(enrichedEditor.getValue());#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/save-enriched-edits/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ manual_edits: payload })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) notify('✅ Modifications sauvegardées', 'success');#}
{#      else notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');#}
{#    } catch (e) { notify('❌ JSON invalide : ' + e.message, 'error'); }#}
{#  }#}
{#  window.saveJSONChanges = saveJSONChanges;#}
{##}
{#  async function addRelation() {#}
{#    const s = document.getElementById('relation-source'), t = document.getElementById('relation-target');#}
{#    const r = document.getElementById('relation-type'), d = document.getElementById('relation-description');#}
{#    if (!(s && t && r) || !s.value || !t.value || !r.value) { alert('Veuillez remplir tous les champs'); return; }#}
{#    try {#}
{#      const src = JSON.parse(s.value), tgt = JSON.parse(t.value);#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-relation/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({#}
{#          source_type: src.type, source_value: src.value,#}
{#          target_type: tgt.type, target_value: tgt.value,#}
{#          relation_type: r.value, description: (d && d.value) || ''#}
{#        })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify('✅ Relation ajoutée', 'success'); hideModal('add-relation-modal'); setTimeout(() => location.reload(), 700); }#}
{#      else notify('❌ ' + data.error, 'error');#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addRelation = addRelation;#}
{##}
{#  async function addQAPair() {#}
{#    const q = (document.getElementById('qa-question') || {}).value?.trim();#}
{#    const a = (document.getElementById('qa-answer')   || {}).value?.trim();#}
{#    const tags = (document.getElementById('qa-tags')   || {}).value?.split(',').map(s => s.trim()).filter(Boolean) || [];#}
{#    if (!q || !a) { alert('Question et réponse requises'); return; }#}
{#    try {#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-qa/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ question: q, answer: a, tags, entity_refs: [] })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify('✅ Q&A ajoutée', 'success'); hideModal('add-qa-modal'); setTimeout(() => location.reload(), 700); }#}
{#      else notify('❌ ' + data.error, 'error');#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addQAPair = addQAPair;#}
{##}
{#  async function testQASystem() {#}
{#    const qEl = document.getElementById('test-question');#}
{#    const resEl = document.getElementById('qa-test-result');#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const source = (document.querySelector('input[name="qa-source"]:checked') || {}).value || 'enriched';#}
{#    const question = (qEl && qEl.value || '').trim();#}
{#    if (!question) { alert('Veuillez saisir une question'); return; }#}
{##}
{#    resEl.style.display = 'block';#}
{#    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche de la réponse...';#}
{#    corrBox.style.display = 'none';#}
{##}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/test-qa/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question, source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) {#}
{#        const conf = data.confidence || 0;#}
{#        const color = conf > 0.8 ? '#10b981' : (conf > 0.5 ? '#f59e0b' : '#64748b');#}
{#        resEl.innerHTML =#}
{#          `<div style="display:flex;align-items:flex-start;gap:1rem;">#}
{#            <div style="flex:1;">#}
{#              <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b;"><i class="fas fa-robot"></i> Réponse (${source}) :</div>#}
{#              <div id="qa-answer-text" style="color:#64748b;line-height:1.6;">${data.answer}</div>#}
{#            </div>#}
{#            <div style="background:${color};color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:600;white-space:nowrap;">#}
{#              ${Math.round(conf*100)}% confiance#}
{#            </div>#}
{#          </div>#}
{#          ${data.answer_type === 'no_match' ? `<div style="margin-top:1rem;padding:1rem;background:rgba(245,158,11,.1);border-radius:8px;border-left:4px solid #f59e0b;"><strong>💡 Suggestion :</strong> ${data.suggestion || ''}</div>` : ''}#}
{#          <div style="margin-top:.75rem;text-align:right;">#}
{#            <button class="enrichment-btn secondary" onclick="openCorrection('${source}')"><i class="fas fa-edit"></i> Corriger cette réponse</button>#}
{#          </div>`;#}
{#        window.__lastQA__ = { question, source, answer: data.answer };#}
{#      } else {#}
{#        resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;#}
{#      }#}
{#    } catch (e) {#}
{#      resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-times-circle"></i> Erreur: ${e.message}</div>`;#}
{#    }#}
{#  }#}
{#  window.testQASystem = testQASystem;#}
{##}
{#  function openCorrection(source) {#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const ta = document.getElementById('qa-corrected');#}
{#    const ans = (window.__lastQA__ || {}).answer || '';#}
{#    if (ta) ta.value = ans;#}
{#    corrBox.style.display = 'block';#}
{#  }#}
{#  window.openCorrection = openCorrection;#}
{##}
{#  async function sendQACorrection() {#}
{#    const ctx = window.__lastQA__ || {};#}
{#    const corrected = (document.getElementById('qa-corrected') || {}).value?.trim();#}
{#    if (!ctx.question || !corrected) { alert('Question ou correction manquante.'); return; }#}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/qa-feedback/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question: ctx.question, corrected_answer: corrected, source: ctx.source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) { notify('✅ Correction enregistrée. Merci !', 'success'); document.getElementById('qa-correction').style.display = 'none'; loadLearningStats(); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.sendQACorrection = sendQACorrection;#}
{##}
{#  /* ========== Fonctions d'apprentissage ========== */#}
{#  async function loadLearningStats() {#}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/learning-history/`);#}
{#      const data = await response.json();#}
{#      if (data.success) {#}
{#        document.getElementById('corrections-count').textContent = data.history.total_corrections || 0;#}
{#        document.getElementById('relations-improved').textContent = data.history.history?.filter(h => h.type.includes('relation')).length || 0;#}
{#        document.getElementById('qa-improved').textContent = data.history.history?.filter(h => h.type.includes('Q&A')).length || 0;#}
{#        document.getElementById('patterns-reused').textContent = data.history.history?.reduce((sum, h) => sum + (h.reused_count || 0), 0) || 0;#}
{#      }#}
{#    } catch (e) {#}
{#      console.warn('Could not load learning stats:', e);#}
{#    }#}
{#  }#}
{##}
{#  async function compareWithFreshAI() {#}
{#    const btn = document.querySelector('button[onclick="compareWithFreshAI()"]');#}
{#    btn.disabled = true;#}
{#    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Comparaison...';#}
{##}
{#    try {#}
{#      const expertJson = enrichedEditor ? JSON.parse(enrichedEditor.getValue()) : ENRICHED;#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/compare-and-learn/`, {#}
{#        method: 'POST',#}
{#        headers: {#}
{#          'Content-Type': 'application/json',#}
{#          'X-CSRFToken': getCookie('csrftoken')#}
{#        },#}
{#        body: JSON.stringify({#}
{#          expert_json: expertJson,#}
{#          context: {#}
{#            document_title: "{{ document.title }}",#}
{#            doc_type: "{{ document.doc_type }}"#}
{#          }#}
{#        })#}
{#      });#}
{##}
{#      const data = await response.json();#}
{#      if (data.success) {#}
{#        notify(`✅ ${data.message}`, 'success');#}
{#        displayComparisonResults(data.comparison);#}
{#        loadLearningStats();#}
{#      } else {#}
{#        notify(`❌ ${data.error}`, 'error');#}
{#      }#}
{#    } catch (e) {#}
{#      notify('❌ Erreur lors de la comparaison', 'error');#}
{#    } finally {#}
{#      btn.disabled = false;#}
{#      btn.innerHTML = '<i class="fas fa-balance-scale"></i>Comparer avec IA';#}
{#    }#}
{#  }#}
{#  window.compareWithFreshAI = compareWithFreshAI;#}
{##}
{#  async function regenerateWithLearning() {#}
{#    const btn = document.querySelector('button[onclick="regenerateWithLearning()"]');#}
{#    btn.disabled = true;#}
{#    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Régénération...';#}
{##}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/regenerate-with-learning/`, {#}
{#        method: 'POST',#}
{#        headers: { 'X-CSRFToken': getCookie('csrftoken') }#}
{#      });#}
{##}
{#      const data = await response.json();#}
{#      if (data.success) {#}
{#        notify(data.message, 'success');#}
{#        setTimeout(() => location.reload(), 1500);#}
{#      } else {#}
{#        notify(data.error, 'error');#}
{#      }#}
{#    } catch (e) {#}
{#      notify('❌ Erreur lors de la régénération', 'error');#}
{#    } finally {#}
{#      btn.disabled = false;#}
{#      btn.innerHTML = '<i class="fas fa-magic"></i>Régénérer +Apprentissage';#}
{#    }#}
{#  }#}
{#  window.regenerateWithLearning = regenerateWithLearning;#}
{##}
{#  function viewDetailedHistory() {#}
{#    window.open(`/expert/document/{{ document.id }}/view-expert-deltas/`, '_blank');#}
{#  }#}
{#  window.viewDetailedHistory = viewDetailedHistory;#}
{##}
{#  function displayComparisonResults(comparison) {#}
{#    const container = document.getElementById('comparison-cards-container');#}
{#    const resultsSection = document.getElementById('comparison-results');#}
{##}
{#    if (!comparison || !comparison.summary) {#}
{#      return;#}
{#    }#}
{##}
{#    let html = '';#}
{#    const summary = comparison.summary;#}
{##}
{#    if (summary.key_improvements && summary.key_improvements.length > 0) {#}
{#      html += '<div style="margin-bottom:1rem">';#}
{#      summary.key_improvements.forEach(improvement => {#}
{#        html += `#}
{#          <div class="comparison-card">#}
{#            <div class="delta-header">#}
{#              <span class="delta-type-badge delta-type-relation_added">Amélioration détectée</span>#}
{#            </div>#}
{#            <div style="padding:1rem">#}
{#              <div class="description-text">${improvement}</div>#}
{#            </div>#}
{#          </div>#}
{#        `;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{##}
{#    if (summary.changes_by_type) {#}
{#      html += '<div class="learning-stats">';#}
{#      Object.entries(summary.changes_by_type).forEach(([type, count]) => {#}
{#        const displayType = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());#}
{#        html += `#}
{#          <div class="learning-stat">#}
{#            <div class="learning-stat-value">${count}</div>#}
{#            <div class="learning-stat-label">${displayType}</div>#}
{#          </div>#}
{#        `;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{##}
{#    container.innerHTML = html;#}
{#    resultsSection.style.display = 'block';#}
{#  }#}
{##}
{#  /* ========== Modales (exportées) ========== */#}
{#  function showModal(id){ document.getElementById(id)?.classList.add('show'); }#}
{#  function hideModal(id){ document.getElementById(id)?.classList.remove('show'); }#}
{#  window.showModal = showModal;#}
{#  window.hideModal = hideModal;#}
{#  window.showAddRelationModal = () => showModal('add-relation-modal');#}
{#  window.showAddQAModal      = () => showModal('add-qa-modal');#}
{#  window.showAddTextModal    = () => showModal('add-text-modal');#}
{##}
{#  document.addEventListener('click', e => {#}
{#    if (e.target.classList?.contains('semantic-modal')) e.target.classList.remove('show');#}
{#  });#}
{##}
{#  /* ========== Extraction depuis un paragraphe (exportée) ========== */#}
{#  async function addFromParagraph() {#}
{#    const text = (document.getElementById('free-text') || {}).value?.trim();#}
{#    const hint = (document.getElementById('free-text-hint') || {}).value?.trim();#}
{#    if (!text) { alert('Collez un paragraphe.'); return; }#}
{#    try {#}
{#      notify('Analyse du paragraphe...', 'info');#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/from-paragraph/`, {#}
{#        method: 'POST',#}
{#        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ text, hint })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) {#}
{#        notify(`✅ Ajouté: ${data.added_relations} relations, ${data.added_entities} entités.`, 'success');#}
{#        hideModal('add-text-modal');#}
{#        setTimeout(() => location.reload(), 800);#}
{#      } else {#}
{#        notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');#}
{#      }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addFromParagraph = addFromParagraph;#}
{##}
{#})();#}
{#</script>#}
{##}
{#{% endblock %}#}







{#template/expert/view_document_json_enriched.html#}
{#{% extends "base.html" %}#}
{#{% load static %}#}
{#{% load expert_extras %}#}
{#{% block title %}JSON Sémantique Expert - {{ document.title }} – RegExpert{% endblock %}#}
{##}
{#{% block content %}#}
{#<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">#}
{#<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">#}
{#<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">#}
{##}
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>#}
{##}
{# --- JSON DATA SAFE PASSING --- #}
{#{{ global_annotations_json|json_script:"basic-json-data" }}#}
{#{{ enriched_annotations_json|default:"{}"|json_script:"enriched-json-data" }}#}
{#{{ display_json|default:"{}"|json_script:"display-json-data" }}#}
{##}
{#<style>#}
{#:root{#}
{#  --pharma-primary:#3b82f6;--pharma-accent:#10b981;--pharma-info:#06b6d4;#}
{#  --pharma-success:#059669;--pharma-warning:#f59e0b;#}
{#  --pharma-bg-card:#fff;--pharma-bg:#f8fafc;--pharma-text:#1e293b;--pharma-text-soft:#64748b;#}
{#  --pharma-border:#e2e8f0;--pharma-radius:12px;--pharma-radius-sm:8px;--pharma-shadow:0 4px 16px rgba(15,23,42,.08);#}
{#  --pharma-transition:.3s cubic-bezier(.4,0,.2,1);#}
{#  --ai-color:#3b82f6;--expert-color:#10b981;--diff-bg:#f8fafc;--improvement-bg:#ecfdf5;--correction-bg:#fef2f2;#}
{#}#}
{#body{background:var(--pharma-bg);color:var(--pharma-text);font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif}#}
{##}
{#/* Tabs */#}
{#.mode-tabs{display:flex;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:var(--pharma-radius);padding:.75rem;margin-bottom:2rem;box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border)}#}
{#.mode-tab{flex:1;padding:1rem 1.5rem;text-align:center;border-radius:var(--pharma-radius-sm);background:transparent;border:1px solid transparent;color:var(--pharma-text-soft);cursor:pointer;transition:var(--pharma-transition);font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}#}
{#.mode-tab:hover{background:rgba(59,130,246,.1);color:var(--pharma-primary)}#}
{#.mode-tab.active{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;border-color:var(--pharma-primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}#}
{##}
{#/* Cards */#}
{#.semantic-card{background:var(--pharma-bg-card);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);margin-bottom:1.5rem;overflow:hidden;transition:var(--pharma-transition)}#}
{#.semantic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,23,42,.12)}#}
{#.semantic-card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));padding:1.5rem;border-bottom:1px solid var(--pharma-border)}#}
{#.semantic-card-header h3{font-size:1.25rem;font-weight:600;color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.75rem}#}
{#.semantic-card-body{padding:1.5rem}#}
{##}
{#/* Relations */#}
{#.relations-container{display:flex;flex-direction:column;gap:1rem}#}
{#.relation-item{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));border:1px solid rgba(59,130,246,.2);border-radius:var(--pharma-radius-sm);padding:1rem;display:flex;align-items:center;gap:1rem;transition:var(--pharma-transition);flex-wrap:wrap}#}
{#.relation-item:hover{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));border-color:var(--pharma-primary)}#}
{#.entity-node{background:var(--pharma-primary);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.9rem;font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative}#}
{#.entity-node:hover{max-width:none;white-space:normal;word-break:break-word;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.15)}#}
{#.relation-arrow{color:var(--pharma-accent);font-size:1.2rem;font-weight:bold}#}
{#.relation-type{background:var(--pharma-accent);color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:500;white-space:nowrap}#}
{##}
{#/* Q&A */#}
{#.qa-container{display:flex;flex-direction:column;gap:1rem}#}
{#.qa-item{background:linear-gradient(135deg,rgba(6,182,212,.05),rgba(139,92,246,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--pharma-radius-sm);padding:1.5rem}#}
{#.qa-question{font-weight:600;color:var(--pharma-text);margin-bottom:.75rem;display:flex;gap:.5rem}#}
{#.qa-question::before{content:"Q:";color:var(--pharma-info);font-weight:700}#}
{#.qa-answer{color:var(--pharma-text-soft);line-height:1.6;margin-left:1.75rem;display:flex;gap:.5rem}#}
{#.qa-answer::before{content:"R:";color:var(--pharma-accent);font-weight:700}#}
{##}
{#/* QA test */#}
{#.qa-test-interface{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));border:1px solid rgba(245,158,11,.3);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.qa-input-group{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem}#}
{#.qa-input{flex:1;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}#}
{#.qa-input:focus{outline:none;border-color:var(--pharma-warning);box-shadow:0 0 0 3px rgba(245,158,11,.1)}#}
{#.qa-test-btn{padding:.75rem 1.5rem;background:var(--pharma-warning);color:#fff;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}#}
{#.qa-test-btn:hover{background:#d97706;transform:translateY(-1px)}#}
{#.qa-result{background:#fff;border-radius:8px;padding:1rem;border-left:4px solid var(--pharma-success);margin-top:1rem;display:none}#}
{##}
{#/* JSON panels */#}
{#.json-comparison{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}#}
{#.json-panel{background:#fff;border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);padding:1.5rem}#}
{#.json-panel h4{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--pharma-text);display:flex;align-items:center;gap:.5rem}#}
{##}
{#/* Learning Section */#}
{#.learning-section{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(59,130,246,.05));border:2px solid var(--pharma-accent);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.learning-header{display:flex;justify-content:between;align-items:center;margin-bottom:1.5rem}#}
{#.learning-header h4{color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.5rem}#}
{#.learning-actions{display:flex;gap:.75rem;flex-wrap:wrap}#}
{#.learning-btn{padding:.5rem 1rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.4rem;align-items:center;transition:var(--pharma-transition)}#}
{#.learning-btn.primary{background:linear-gradient(135deg,var(--expert-color),#059669);color:#fff}#}
{#.learning-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{#.learning-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}#}
{##}
{#/* Comparison cards */#}
{#.comparison-card{border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.08);margin-bottom:1rem;overflow:hidden;background:white;position:relative}#}
{#.delta-header{background:linear-gradient(135deg,var(--diff-bg),#e2e8f0);padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}#}
{#.delta-type-badge{padding:.4rem 1rem;border-radius:20px;font-size:.85rem;font-weight:600}#}
{#.delta-type-relation_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-relation_modified{background:#fef3c7;color:#d97706}#}
{#.delta-type-qa_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-qa_corrected{background:#fef3c7;color:#d97706}#}
{#.version-comparison{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}#}
{#.ai-version,.expert-version{padding:1rem;border-radius:8px;border:2px solid}#}
{#.ai-version{border-color:var(--ai-color);background:rgba(59,130,246,.05)}#}
{#.expert-version{border-color:var(--expert-color);background:rgba(16,185,129,.05)}#}
{#.version-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-weight:600}#}
{#.ai-version .version-header{color:var(--ai-color)}#}
{#.expert-version .version-header{color:var(--expert-color)}#}
{#.relation-display{background:#f8fafc;padding:.75rem;border-radius:6px;font-family:'Courier New',monospace;margin-bottom:.5rem}#}
{#.description-text{font-style:italic;color:#64748b;margin-top:.5rem}#}
{#.improvement-indicator{position:absolute;top:-5px;right:-5px;background:var(--expert-color);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px}#}
{#.learning-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}#}
{#.learning-stat{background:white;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)}#}
{#.learning-stat-value{font-size:1.5rem;font-weight:800;color:var(--expert-color);margin-bottom:.25rem}#}
{#.learning-stat-label{font-size:.8rem;color:var(--pharma-text-soft)}#}
{##}
{#/* Actions */#}
{#.enrichment-actions{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}#}
{#.enrichment-btn{padding:.75rem 1.5rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem;transition:var(--pharma-transition)}#}
{#.enrichment-btn.primary{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff}#}
{#.enrichment-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{#.enrichment-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15)}#}
{##}
{#/* Modales améliorées */#}
{#.semantic-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}#}
{#.semantic-modal.show{display:flex;animation:fadeInModal .4s ease-out}#}
{#.modal-content-semantic{background:#fff;border-radius:var(--pharma-radius);box-shadow:0 25px 80px rgba(0,0,0,.4);width:95%;max-width:1200px;max-height:90vh;overflow:hidden}#}
{#.modal-header-semantic{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center}#}
{#.modal-body-semantic{padding:2rem;max-height:calc(90vh - 100px);overflow-y:auto}#}
{##}
{#/* Interface avancée de création de relations multiples */#}
{#.visual-relation-builder{#}
{#  position:relative;background:linear-gradient(135deg,#f8fafc,#ffffff);#}
{#  border:2px solid var(--pharma-border);border-radius:var(--pharma-radius);#}
{#  min-height:500px;margin:2rem 0;overflow:hidden;padding-right:280px; /* réserve pour palette */#}
{#}#}
{##}
{#.builder-toolbar{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));padding:1rem 1.5rem;border-bottom:1px solid var(--pharma-border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}#}
{##}
{#.builder-modes{display:flex;gap:.5rem}#}
{#.mode-switch{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;transition:var(--pharma-transition);font-size:.9rem;display:flex;align-items:center;gap:.5rem}#}
{#.mode-switch.active{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}#}
{#.mode-switch:hover:not(.active){background:rgba(59,130,246,.1)}#}
{##}
{#.builder-actions{display:flex;gap:.75rem;align-items:center}#}
{#.builder-btn{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.85rem;display:flex;align-items:center;gap:.4rem}#}
{#.builder-btn.primary{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}#}
{#.builder-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}#}
{##}
{#.visual-canvas{position:relative;height:400px;overflow:hidden}#}
{##}
{#/* Canvas SVG pour les liaisons */#}
{#.connection-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}#}
{##}
{#/* Entités dans le canvas */#}
{#.canvas-entity{position:absolute;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:.8rem 1.2rem;border-radius:25px;cursor:move;transition:var(--pharma-transition);box-shadow:0 4px 16px rgba(59,130,246,.3);z-index:10;min-width:120px;text-align:center;font-weight:600;font-size:.9rem;user-select:none;word-break:break-word}#}
{#.canvas-entity:hover{transform:scale(1.05);box-shadow:0 8px 24px rgba(59,130,246,.4)}#}
{#.canvas-entity.dragging{z-index:20;transform:scale(1.1);box-shadow:0 12px 32px rgba(59,130,246,.5)}#}
{#.canvas-entity.connecting{animation:pulse 1.5s infinite}#}
{##}
{#/* Points de connexion */#}
{#.connection-point{position:absolute;width:16px;height:16px;background:var(--pharma-accent);border:3px solid #fff;border-radius:50%;cursor:crosshair;transform:translate(-50%,-50%);transition:var(--pharma-transition);box-shadow:0 2px 8px rgba(16,185,129,.4)}#}
{#.connection-point:hover{transform:translate(-50%,-50%) scale(1.3);background:var(--pharma-warning)}#}
{#.connection-point.right{right:-8px;top:50%}#}
{#.connection-point.left{left:-8px;top:50%}#}
{##}
{#/* Panneau latéral pour les entités */#}
{#.entity-palette{position:absolute;right:0;top:0;width:280px;height:100%;background:linear-gradient(180deg,#ffffff,#f8fafc);border-left:1px solid var(--pharma-border);padding:1rem;overflow-y:auto;z-index:15}#}
{#.entity-palette h4{font-size:1rem;font-weight:600;color:var(--pharma-text);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}#}
{##}
{#.entity-search{width:100%;padding:.75rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);margin-bottom:1rem;font-size:.9rem}#}
{#.entity-search:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}#}
{##}
{#.entity-list{display:flex;flex-direction:column;gap:.5rem}#}
{#.entity-item{background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.75rem;cursor:grab;transition:var(--pharma-transition);display:flex;justify-content:space-between;align-items:center}#}
{#.entity-item:hover{border-color:var(--pharma-primary);transform:translateX(-2px);box-shadow:0 4px 12px rgba(59,130,246,.15)}#}
{#.entity-item:active{cursor:grabbing}#}
{#.entity-type-label{background:var(--pharma-primary);color:#fff;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:600}#}
{##}
{#.create-entity-form{background:rgba(16,185,129,.05);border:1px dashed var(--pharma-accent);border-radius:var(--pharma-radius-sm);padding:1rem;margin-bottom:1rem}#}
{#.create-entity-input{width:100%;padding:.5rem;border:1px solid var(--pharma-border);border-radius:6px;margin-bottom:.5rem;font-size:.85rem}#}
{#.create-entity-btn{width:100%;padding:.5rem;background:var(--pharma-accent);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer}#}
{##}
{#/* Relation types floating panel */#}
{#.relation-types-panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);box-shadow:0 8px 32px rgba(0,0,0,.15);padding:1rem;display:none;z-index:25;min-width:320px}#}
{#.relation-types-panel.show{display:block;animation:slideUp .3s ease-out}#}
{#.relation-type-option{padding:.5rem .75rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;margin:.25rem;display:inline-block;font-size:.8rem;transition:var(--pharma-transition)}#}
{#.relation-type-option:hover{background:var(--pharma-primary);color:#fff;transform:translateY(-1px)}#}
{#.relation-type-option.custom{border-style:dashed;color:var(--pharma-warning)}#}
{##}
{#/* Résumé des relations créées */#}
{#.relations-summary{position:absolute;bottom:0;left:0;right:280px;background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(248,250,252,.95));border-top:1px solid var(--pharma-border);padding:1rem;backdrop-filter:blur(10px)}#}
{#.summary-title{font-weight:600;color:var(--pharma-text);margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}#}
{#.relations-count{background:var(--pharma-accent);color:#fff;padding:.2rem .6rem;border-radius:12px;font-size:.75rem;font-weight:600}#}
{#.relation-preview-item{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.2);border-radius:20px;padding:.4rem .8rem;margin:.25rem;display:inline-block;font-size:.8rem}#}
{##}
{#/* Monaco error underline */#}
{#.squiggly-error{border-bottom:2px wavy #ef4444}#}
{##}
{#/* Animations */#}
{#@keyframes fadeInModal{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}#}
{#@keyframes slideUp{from{transform:translate(-50%,-30%);opacity:0}to{transform:translate(-50%,-50%);opacity:1}}#}
{#@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}#}
{##}
{#.form-group{margin-bottom:1.5rem}#}
{#.form-label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--pharma-text)}#}
{#.form-control{width:100%;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}#}
{#.form-control:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}#}
{##}
{#/* Quick actions */#}
{#.quick-actions{display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}#}
{#.quick-action-btn{padding:.5rem 1rem;background:rgba(59,130,246,.1);color:var(--pharma-primary);border:1px solid rgba(59,130,246,.3);border-radius:20px;font-size:.85rem;cursor:pointer;transition:var(--pharma-transition);display:flex;align-items:center;gap:.4rem}#}
{#.quick-action-btn:hover{background:rgba(59,130,246,.2);transform:translateY(-1px)}#}
{##}
{#@media (max-width:1024px){#}
{#  .entity-palette{position:relative;width:100%;height:auto;border-left:none;border-top:1px solid var(--pharma-border)}#}
{#  .visual-relation-builder{padding-right:0}#}
{#  .visual-canvas{height:300px}#}
{#  .relations-summary{right:0}#}
{#}#}
{##}
{#@media (max-width:768px){#}
{#  .json-comparison{grid-template-columns:1fr}#}
{#  .enrichment-actions{flex-direction:column}#}
{#  .mode-tabs{flex-direction:column}#}
{#  .qa-input-group{flex-direction:column}#}
{#  .version-comparison{grid-template-columns:1fr}#}
{#  .modal-content-semantic{width:98%;margin:1%}#}
{#  .builder-toolbar{flex-direction:column;align-items:stretch}#}
{#}#}
{##}
{#/* Stats (Overview) */#}
{#.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-bottom:1rem}#}
{#.stat-card{display:flex;align-items:center;gap:12px;background:var(--pharma-bg-card);border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);padding:1rem 1.25rem}#}
{#.stat-icon{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(16,185,129,.12));color:var(--pharma-primary);flex:0 0 44px}#}
{#.stat-content{display:flex;flex-direction:column;line-height:1.1}#}
{#.stat-value{font-size:1.6rem;font-weight:800;color:var(--pharma-primary)}#}
{#.stat-label{font-size:.95rem;color:var(--pharma-text-soft);margin-top:2px}#}
{#</style>#}
{##}
{#<section class="semantic-card">#}
{#  <div class="semantic-card-header">#}
{#    <h2><i class="fas fa-brain"></i> JSON Sémantique Expert - {{ document.title|truncatechars:50 }}</h2>#}
{#  </div>#}
{#  <div class="semantic-card-body">#}
{#    <div class="mode-tabs">#}
{#      <div class="mode-tab active" data-mode="overview"><i class="fas fa-chart-pie"></i>Vue d'ensemble</div>#}
{#      <div class="mode-tab" data-mode="relations"><i class="fas fa-project-diagram"></i>Relations ({{ enriched_stats.relations_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="qa"><i class="fas fa-question-circle"></i>Q&A ({{ enriched_stats.qa_pairs_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="json"><i class="fas fa-graduation-cap"></i>JSON & Apprentissage</div>#}
{#    </div>#}
{##}
{#    <div class="enrichment-actions">#}
{#      {% if not has_enriched %}#}
{#        <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#      {% else %}#}
{#        <button class="enrichment-btn secondary" onclick="regenerateEnrichment()"><i class="fas fa-sync-alt"></i>Régénérer</button>#}
{#      {% endif %}#}
{#      <button class="enrichment-btn primary" onclick="showVisualRelationBuilder()"><i class="fas fa-project-diagram"></i>Créateur Visuel de Relations</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddQAModal()"><i class="fas fa-question"></i>Ajouter Q&A</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddTextModal()"><i class="fas fa-file-alt"></i> Depuis un paragraphe</button>#}
{#      <a href="{% url 'expert:annotation_dashboard' %}" class="enrichment-btn secondary"><i class="fas fa-arrow-left"></i>Retour Dashboard</a>#}
{#    </div>#}
{#  </div>#}
{#</section>#}
{##}
{# --- OVERVIEW --- #}
{#<div id="overview-tab" class="tab-content">#}
{#  {% if has_enriched %}#}
{#  <div class="stats-grid">#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.relations_count|default:0 }}</div>#}
{#        <div class="stat-label">Relations identifiées</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-question-circle"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.qa_pairs_count|default:0 }}</div>#}
{#        <div class="stat-label">Questions-Réponses</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-layer-group"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.contexts_count|default:0 }}</div>#}
{#        <div class="stat-label">Contextes sémantiques</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-list-check"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ total_annotations|default:0 }}</div>#}
{#        <div class="stat-label">Annotations totales</div>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  {% if enriched_annotations_json.semantic_summary %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-lightbulb"></i> Résumé Sémantique Intelligent</h3></div>#}
{#    <div class="semantic-card-body"><p style="font-size:1.1rem;line-height:1.8">{{ enriched_annotations_json.semantic_summary }}</p></div>#}
{#  </div>#}
{#  {% endif %}#}
{##}
{#  <div class="qa-test-interface">#}
{#    <h4><i class="fas fa-vial"></i> Tester le Système de Questions-Réponses</h4>#}
{#    <div style="display:flex;gap:1rem;align-items:center;margin:.25rem 0 1rem">#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="basic"> JSON basique</label>#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="enriched" checked> JSON enrichi</label>#}
{#    </div>#}
{#    <div class="qa-input-group">#}
{#      <input type="text" id="test-question" class="qa-input" placeholder="ex: Quel est le dosage du produit ?">#}
{#      <button class="qa-test-btn" onclick="testQASystem()"><i class="fas fa-search"></i>Tester</button>#}
{#    </div>#}
{#    <div id="qa-test-result" class="qa-result"></div>#}
{#    <div id="qa-correction" class="qa-result" style="display:none;border-left-color:#f59e0b">#}
{#      <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b"><i class="fas fa-edit"></i> Corriger la réponse</div>#}
{#      <textarea id="qa-corrected" class="form-control" rows="4" placeholder="Proposez la meilleure réponse..."></textarea>#}
{#      <div style="text-align:right;margin-top:.5rem">#}
{#        <button class="enrichment-btn secondary" onclick="sendQACorrection()"><i class="fas fa-save"></i>Enregistrer la correction</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#  {% else %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-body" style="text-align:center;padding:3rem">#}
{#      <i class="fas fa-brain" style="font-size:4rem;color:var(--pharma-text-soft);margin-bottom:1rem"></i>#}
{#      <h3>JSON Non Enrichi</h3>#}
{#      <p>Ce document possède un JSON basique mais pas encore d'enrichissement sémantique.</p>#}
{#      <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#    </div>#}
{#  </div>#}
{#  {% endif %}#}
{#</div>#}
{##}
{# --- RELATIONS --- #}
{#<div id="relations-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-project-diagram"></i> Relations Entre Entités</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="relations-container" class="relations-container">#}
{#        {% if enriched_annotations_json.relations %}#}
{#          {% for relation in enriched_annotations_json.relations %}#}
{#          <div class="relation-item">#}
{#            <div class="entity-node">{{ relation.source.value }}</div>#}
{#            <div class="relation-type">{{ relation.type|default:"relation" }}</div>#}
{#            <div class="relation-arrow">→</div>#}
{#            <div class="entity-node">{{ relation.target.value }}</div>#}
{#            {% if relation.description %}<small style="color:var(--pharma-text-soft);margin-left:auto">{{ relation.description }}</small>{% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)"><i class="fas fa-project-diagram" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune relation identifiée. Utilisez le créateur visuel de relations.</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- Q&A --- #}
{#<div id="qa-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-question-circle"></i> Questions-Réponses Automatiques</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="qa-container" class="qa-container">#}
{#        {% if enriched_annotations_json.questions_answers %}#}
{#          {% for qa in enriched_annotations_json.questions_answers %}#}
{#          <div class="qa-item">#}
{#            <div class="qa-question">{{ qa.question }}</div>#}
{#            <div class="qa-answer">{{ qa.answer }}</div>#}
{#            {% if qa.created_by == "expert" %}#}
{#              <div style="margin-top:.5rem">#}
{#                <span style="background:var(--pharma-success);color:#fff;padding:.2rem .5rem;border-radius:10px;font-size:.7rem"><i class="fas fa-user-check"></i> Expert</span>#}
{#              </div>#}
{#            {% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">#}
{#            <i class="fas fa-question-circle" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune Q&A générée. Utilisez "Ajouter Q&A".</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- JSON & APPRENTISSAGE --- #}
{#<div id="json-tab" class="tab-content" style="display:none">#}
{#  <div class="learning-section">#}
{#    <div class="learning-header">#}
{#      <h4><i class="fas fa-graduation-cap"></i> Apprentissage Expert IA</h4>#}
{#      <div class="learning-actions">#}
{#        <button class="learning-btn primary" onclick="compareWithFreshAI()"><i class="fas fa-balance-scale"></i>Comparer avec IA</button>#}
{#        <button class="learning-btn primary" onclick="regenerateWithLearning()"><i class="fas fa-magic"></i>Régénérer +Apprentissage</button>#}
{#        <button class="learning-btn secondary" onclick="viewDetailedHistory()"><i class="fas fa-history"></i>Historique détaillé</button>#}
{#      </div>#}
{#    </div>#}
{#    <div class="learning-stats" id="learning-stats">#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="corrections-count">-</div><div class="learning-stat-label">Corrections totales</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="relations-improved">-</div><div class="learning-stat-label">Relations améliorées</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="qa-improved">-</div><div class="learning-stat-label">Q&A améliorées</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="patterns-reused">-</div><div class="learning-stat-label">Patterns réutilisés</div></div>#}
{#    </div>#}
{#    <div id="comparison-results" style="display:none">#}
{#      <h5><i class="fas fa-microscope"></i> Dernière comparaison IA vs Expert</h5>#}
{#      <div id="comparison-cards-container"></div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  <div class="json-comparison">#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-file-code"></i> JSON Basique</h4>#}
{#      <div id="basic-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{#    {% if has_enriched %}#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-brain"></i> JSON Enrichi</h4>#}
{#      <div id="enriched-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{#    {% else %}#}
{#    <div class="json-panel" style="display:flex;align-items:center;justify-content:center;background:var(--pharma-bg)">#}
{#      <div style="text-align:center;color:var(--pharma-text-soft)">#}
{#        <i class="fas fa-brain" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#        <p>JSON enrichi disponible après enrichissement</p>#}
{#      </div>#}
{#    </div>#}
{#    {% endif %}#}
{#  </div>#}
{##}
{#  <div style="text-align:center;margin-top:1rem">#}
{#    <button class="enrichment-btn primary" onclick="saveJSONChanges()"><i class="fas fa-save"></i>Sauvegarder les Modifications</button>#}
{#  </div>#}
{#</div>#}
{##}
{# --- MODAL CRÉATEUR VISUEL DE RELATIONS --- #}
{#<div id="visual-relation-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-project-diagram"></i> Créateur Visuel de Relations</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('visual-relation-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic" style="padding:0">#}
{#      <div class="visual-relation-builder">#}
{##}
{#        <!-- Barre d'outils -->#}
{#        <div class="builder-toolbar">#}
{#          <div class="builder-modes">#}
{#            <div class="mode-switch active" data-mode="connect"><i class="fas fa-link"></i> Mode Connexion</div>#}
{#            <div class="mode-switch" data-mode="move"><i class="fas fa-arrows-alt"></i> Mode Déplacement</div>#}
{#          </div>#}
{#          <div class="builder-actions">#}
{#            <button class="builder-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> Effacer</button>#}
{#            <button class="builder-btn" onclick="autoArrange()"><i class="fas fa-magic"></i> Auto-organiser</button>#}
{#            <button class="builder-btn primary" onclick="saveAllRelations()"><i class="fas fa-save"></i> Sauvegarder tout</button>#}
{#          </div>#}
{#        </div>#}
{##}
{#        <!-- Canvas principal -->#}
{#        <div class="visual-canvas" id="visual-canvas">#}
{#          <svg class="connection-svg" id="connection-svg"></svg>#}
{#        </div>#}
{##}
{#        <!-- Panneau latéral des entités -->#}
{#        <div class="entity-palette">#}
{#          <h4><i class="fas fa-cubes"></i> Entités disponibles</h4>#}
{#          <input type="text" class="entity-search" id="entity-search" placeholder="Rechercher une entité...">#}
{#          <div class="create-entity-form">#}
{#            <input type="text" class="create-entity-input" id="new-entity-name" placeholder="Nom de la nouvelle entité">#}
{#            <select class="create-entity-input" id="new-entity-type">#}
{#              <option value="product">Produit</option>#}
{#              <option value="ingredient">Ingrédient</option>#}
{#              <option value="dosage">Dosage</option>#}
{#              <option value="indication">Indication</option>#}
{#              <option value="contraindication">Contre-indication</option>#}
{#              <option value="custom">Personnalisé</option>#}
{#            </select>#}
{#            <button class="create-entity-btn" onclick="createNewCanvasEntity()"><i class="fas fa-plus"></i> Créer</button>#}
{#          </div>#}
{#          <div class="entity-list" id="entity-list"></div>#}
{#        </div>#}
{##}
{#        <!-- Panel flottant pour les types de relation -->#}
{#        <div class="relation-types-panel" id="relation-types-panel">#}
{#          <div style="font-weight:600;margin-bottom:.5rem;text-align:center">Choisir le type de relation :</div>#}
{#          <div class="relation-type-option" data-type="contains">contient</div>#}
{#          <div class="relation-type-option" data-type="manufactured_by">fabriqué par</div>#}
{#          <div class="relation-type-option" data-type="has_dosage">dosage</div>#}
{#          <div class="relation-type-option" data-type="used_for">utilisé pour</div>#}
{#          <div class="relation-type-option" data-type="contraindicated_with">contre-indiqué</div>#}
{#          <div class="relation-type-option" data-type="interacts_with">interagit avec</div>#}
{#          <div class="relation-type-option" data-type="composed_of">composé de</div>#}
{#          <div class="relation-type-option" data-type="has_side_effect">effet secondaire</div>#}
{#          <div class="relation-type-option custom" data-type="__custom__"><i class="fas fa-plus"></i> Personnalisé</div>#}
{#        </div>#}
{##}
{#        <!-- Résumé des relations créées -->#}
{#        <div class="relations-summary">#}
{#          <div class="summary-title"><i class="fas fa-list"></i> Relations créées <span class="relations-count" id="relations-count">0</span></div>#}
{#          <div id="relations-preview"></div>#}
{#        </div>#}
{##}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<div id="add-qa-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-question"></i> Ajouter Question-Réponse</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-qa-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group"><label class="form-label">Question</label><input type="text" id="qa-question" class="form-control" placeholder="ex: Quel est le dosage du produit ?"></div>#}
{#      <div class="form-group"><label class="form-label">Réponse</label><textarea id="qa-answer" class="form-control" rows="3" placeholder="Réponse complète..."></textarea></div>#}
{#      <div class="form-group"><label class="form-label">Tags (optionnel)</label><input type="text" id="qa-tags" class="form-control" placeholder="dosage, posologie, administration"></div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-qa-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addQAPair()"><i class="fas fa-plus"></i>Ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<div id="add-text-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-file-alt"></i> Extraire des relations depuis un paragraphe</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-text-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group">#}
{#        <label class="form-label">Paragraphe</label>#}
{#        <textarea id="free-text" class="form-control" rows="6" placeholder="Collez ici un extrait du document (procédures, obligations, interactions, etc.)"></textarea>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Aide (optionnelle)</label>#}
{#        <input id="free-text-hint" class="form-control" placeholder="ex: réglementation, posologie, interactions...">#}
{#      </div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-text-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addFromParagraph()"><i class="fas fa-magic"></i> Analyser & ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<script>#}
{##}
{#(function () {#}
{#  /* ========== Utils (exportés) ========== */#}
{#  function fromJsonScript(id, fallback) {#}
{#    const n = document.getElementById(id);#}
{#    if (!n) return fallback;#}
{#    try { return JSON.parse(n.textContent.trim() || '{}'); }#}
{#    catch (e) { console.warn('JSON invalide pour', id, e); return fallback; }#}
{#  }#}
{##}
{#  function getCookie(name) {#}
{#    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));#}
{#    return m ? decodeURIComponent(m[1]) : '';#}
{#  }#}
{#  window.getCookie = getCookie;#}
{##}
{#  function notify(msg, type) {#}
{#    const el = document.createElement('div');#}
{#    el.className = `expert-notification ${type || 'info'}`;#}
{#    el.innerHTML = `<div class="notification-content">#}
{#      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-triangle-exclamation' : 'fa-info-circle'}"></i>#}
{#      <span>${msg}</span>#}
{#    </div>`;#}
{#    if (!document.getElementById('expert-notification-styles')) {#}
{#      const css = document.createElement('style'); css.id = 'expert-notification-styles';#}
{#      css.textContent =#}
{#        `.expert-notification{position:fixed;top:20px;right:20px;z-index:10000;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);animation:slideIn .25s ease-out;max-width:400px}#}
{#         .expert-notification.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(34,197,94,.9));color:#fff}#}
{#         .expert-notification.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}#}
{#         .expert-notification.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(16,185,129,.9));color:#fff}#}
{#         .expert-notification.warning{background:linear-gradient(135deg,rgba(245,158,11,.95),rgba(217,119,6,.95));color:#fff}#}
{#         .notification-content{display:flex;align-items:center;gap:.75rem;font-weight:500;font-size:.9rem}#}
{#         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}#}
{#         @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;#}
{#      document.head.appendChild(css);#}
{#    }#}
{#    document.body.appendChild(el);#}
{#    setTimeout(() => { el.style.animation = 'slideOut .25s ease-in'; setTimeout(() => el.remove(), 280); }, 3000);#}
{#  }#}
{#  window.notify = notify;#}
{##}
{#  /* ========== Données depuis les balises JSON ========== */#}
{#  const BASIC    = fromJsonScript('basic-json-data',   {});#}
{#  const ENRICHED = fromJsonScript('enriched-json-data',{});#}
{#  const DISPLAY  = fromJsonScript('display-json-data', {});#}
{##}
{#  /* ========== Variables globales pour le créateur visuel ========== */#}
{#  let allEntities = [];#}
{#  let canvasEntities = [];#}
{#  let canvasRelations = [];#}
{#  let currentMode = 'connect';#}
{#  let connectionState = { from: null, to: null };#}
{#  let edgesLayer = null, labelsLayer = null;#}
{##}
{#  /* ========== Monaco ========== */#}
{#  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });#}
{##}
{#  function makeEditor(id, val, readOnly) {#}
{#    const el = document.getElementById(id); if (!el) return null;#}
{#    return monaco.editor.create(el, {#}
{#      value: JSON.stringify(val ?? {}, null, 2),#}
{#      language: 'json', theme: 'vs', readOnly: !!readOnly,#}
{#      automaticLayout: true, minimap: { enabled: false }, wordWrap: 'on', scrollBeyondLastLine: false#}
{#    });#}
{#  }#}
{##}
{#  let basicEditor = null, enrichedEditor = null;#}
{##}
{#  document.addEventListener('DOMContentLoaded', function () {#}
{#    // Tabs#}
{#    document.querySelectorAll('.mode-tab').forEach(tab => {#}
{#      tab.addEventListener('click', () => {#}
{#        const mode = tab.dataset.mode;#}
{#        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t === tab));#}
{#        document.querySelectorAll('.tab-content').forEach(c => c.style.display = (c.id === mode + '-tab') ? 'block' : 'none');#}
{#        [basicEditor, enrichedEditor].forEach(ed => ed && ed.layout());#}
{#      });#}
{#    });#}
{##}
{#    // Monaco init#}
{#    require(['vs/editor/editor.main'], function () {#}
{#      basicEditor    = makeEditor('basic-json-editor',    BASIC,    true);#}
{#      enrichedEditor = makeEditor('enriched-json-editor', ENRICHED, false);#}
{##}
{#      if (enrichedEditor && (!ENRICHED || Object.keys(ENRICHED).length === 0)) {#}
{#        enrichedEditor.setValue('// Pas encore enrichi. Cliquez sur « Régénérer » pour créer le JSON enrichi.');#}
{#      }#}
{##}
{#      // Validation simple#}
{#      let decorations = [];#}
{#      function validate(ed) {#}
{#        if (!ed || ed.getRawOptions().readOnly) return;#}
{#        try { JSON.parse(ed.getValue()); decorations = ed.deltaDecorations(decorations, []); }#}
{#        catch (e) {#}
{#          const model = ed.getModel(); const m = String(e.message).match(/position\s+(\d+)/i); if (!m) return;#}
{#          const pos = model.getPositionAt(+m[1]);#}
{#          decorations = ed.deltaDecorations(decorations, [{#}
{#            range: new monaco.Range(pos.lineNumber, pos.column, pos.lineNumber, pos.column + 1),#}
{#            options: { inlineClassName: 'squiggly-error', hoverMessage: { value: e.message } }#}
{#          }]);#}
{#        }#}
{#      }#}
{#      enrichedEditor && enrichedEditor.onDidChangeModelContent(() => validate(enrichedEditor));#}
{#    });#}
{##}
{#    // Initialiser#}
{#    extractAllEntities(BASIC);#}
{#    loadLearningStats();#}
{#  });#}
{##}
{#  /* ========== Extraction des entités ========== */#}
{#  function extractAllEntities(basicJson) {#}
{#    allEntities = [];#}
{#    const entities = (basicJson && basicJson.entities) || {};#}
{#    Object.entries(entities).forEach(([type, items]) => {#}
{#      const list = Array.isArray(items) ? items : ((items && items.items) || []);#}
{#      list.forEach(item => {#}
{#        const value = (typeof item === 'string') ? item : ((item && item.value) || '');#}
{#        if (value) {#}
{#          allEntities.push({ id: generateId(), type, value, x: 0, y: 0 });#}
{#        }#}
{#      });#}
{#    });#}
{#  }#}
{##}
{#  function generateId() { return 'entity_' + Math.random().toString(36).slice(2, 11); }#}
{##}
{#  /* ========== Créateur visuel de relations ========== */#}
{#  function showVisualRelationBuilder() {#}
{#    showModal('visual-relation-modal');#}
{#    setTimeout(() => initializeVisualBuilder(), 50);#}
{#  }#}
{#  window.showVisualRelationBuilder = showVisualRelationBuilder;#}
{##}
{#  function initializeVisualBuilder() {#}
{#    setupBuilderModes();#}
{#    populateEntityList();#}
{#    setupCanvasBase();#}
{#    setupCanvasInteractions();#}
{#    renderConnections();#}
{#    window.addEventListener('resize', renderConnections);#}
{#  }#}
{##}
{#  function setupBuilderModes() {#}
{#    document.querySelectorAll('.mode-switch').forEach(btn => {#}
{#      btn.addEventListener('click', () => {#}
{#        document.querySelectorAll('.mode-switch').forEach(b => b.classList.remove('active'));#}
{#        btn.classList.add('active');#}
{#        currentMode = btn.dataset.mode;#}
{#        updateCanvasCursor();#}
{#      });#}
{#    });#}
{#    updateCanvasCursor();#}
{#  }#}
{##}
{#  function updateCanvasCursor() {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    if (!canvas) return;#}
{#    canvas.style.cursor = currentMode === 'connect' ? 'crosshair' : 'default';#}
{#  }#}
{##}
{#  function populateEntityList() {#}
{#    const list = document.getElementById('entity-list');#}
{#    list.innerHTML = '';#}
{##}
{#    allEntities.forEach(entity => {#}
{#      const item = document.createElement('div');#}
{#      item.className = 'entity-item';#}
{#      item.draggable = true;#}
{#      item.title = `${entity.type}: ${entity.value}`;#}
{#      item.innerHTML = `<span>${entity.value}</span><span class="entity-type-label">${entity.type}</span>`;#}
{#      item.addEventListener('dragstart', (e) => {#}
{#        e.dataTransfer.effectAllowed = 'copy';#}
{#        e.dataTransfer.setData('text/plain', JSON.stringify(entity));#}
{#      });#}
{#      list.appendChild(item);#}
{#    });#}
{##}
{#    const search = document.getElementById('entity-search');#}
{#    search.oninput = (e) => {#}
{#      const q = e.target.value.toLowerCase();#}
{#      [...list.children].forEach(item => {#}
{#        item.style.display = item.textContent.toLowerCase().includes(q) ? 'flex' : 'none';#}
{#      });#}
{#    };#}
{#  }#}
{##}
{#  function createNewCanvasEntity() {#}
{#    const nameInput = document.getElementById('new-entity-name');#}
{#    const typeSelect = document.getElementById('new-entity-type');#}
{#    const name = (nameInput.value || '').trim();#}
{#    const type = typeSelect.value;#}
{#    if (!name) { nameInput.focus(); return; }#}
{#    const entity = { id: generateId(), type, value: name, x: 0, y: 0 };#}
{#    allEntities.push(entity);#}
{#    populateEntityList();#}
{#    nameInput.value = '';#}
{#    notify(`Entité "${name}" créée`, 'success');#}
{#  }#}
{#  window.createNewCanvasEntity = createNewCanvasEntity;#}
{##}
{#  function setupCanvasBase() {#}
{#    const svg = document.getElementById('connection-svg');#}
{#    svg.innerHTML = '';#}
{#    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');#}
{#    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');#}
{#    marker.setAttribute('id','arrowhead');#}
{#    marker.setAttribute('markerWidth','10');#}
{#    marker.setAttribute('markerHeight','7');#}
{#    marker.setAttribute('refX','9');#}
{#    marker.setAttribute('refY','3.5');#}
{#    marker.setAttribute('orient','auto');#}
{#    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');#}
{#    poly.setAttribute('points','0 0, 10 3.5, 0 7');#}
{#    poly.setAttribute('fill','var(--pharma-accent)');#}
{#    marker.appendChild(poly);#}
{#    defs.appendChild(marker);#}
{#    edgesLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');#}
{#    edgesLayer.setAttribute('id','edges-layer');#}
{#    labelsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');#}
{#    labelsLayer.setAttribute('id','labels-layer');#}
{#    svg.appendChild(defs);#}
{#    svg.appendChild(edgesLayer);#}
{#    svg.appendChild(labelsLayer);#}
{#  }#}
{##}
{#  function setupCanvasInteractions() {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{##}
{#    // Drag & Drop: ajout d'entités#}
{#    canvas.addEventListener('dragover', (e) => e.preventDefault());#}
{#    canvas.addEventListener('drop', (e) => {#}
{#      e.preventDefault();#}
{#      const rect = canvas.getBoundingClientRect();#}
{#      const x = e.clientX - rect.left - 60; // approx demi-largeur#}
{#      const y = e.clientY - rect.top  - 20; // approx demi-hauteur#}
{#      try {#}
{#        const entityData = JSON.parse(e.dataTransfer.getData('text/plain'));#}
{#        addEntityToCanvas(entityData, x, y);#}
{#      } catch (err) {#}
{#        console.warn('Erreur lors du drop:', err);#}
{#      }#}
{#    });#}
{#  }#}
{##}
{#  function addEntityToCanvas(entity, x, y) {#}
{#    if (canvasEntities.find(e => e.id === entity.id)) {#}
{#      notify('Cette entité est déjà sur le canvas', 'warning');#}
{#      return;#}
{#    }#}
{#    const canvasEntity = { ...entity, x: Math.max(0,x), y: Math.max(0,y) };#}
{#    canvasEntities.push(canvasEntity);#}
{#    renderEntityOnCanvas(canvasEntity);#}
{#    renderConnections();#}
{#  }#}
{##}
{#  function renderEntityOnCanvas(entity) {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    const element = document.createElement('div');#}
{#    element.className = 'canvas-entity';#}
{#    element.id = entity.id;#}
{#    element.textContent = entity.value;#}
{#    element.title = `${entity.type}: ${entity.value}`;#}
{#    element.style.left = entity.x + 'px';#}
{#    element.style.top  = entity.y + 'px';#}
{##}
{#    // Points de connexion#}
{#    const rightPoint = document.createElement('div');#}
{#    rightPoint.className = 'connection-point right';#}
{#    rightPoint.dataset.entityId = entity.id;#}
{##}
{#    const leftPoint = document.createElement('div');#}
{#    leftPoint.className = 'connection-point left';#}
{#    leftPoint.dataset.entityId = entity.id;#}
{##}
{#    element.appendChild(rightPoint);#}
{#    element.appendChild(leftPoint);#}
{##}
{#    // Drag mouvement (mode move)#}
{#    makeDraggable(element, entity);#}
{##}
{#    // Clic sur l'entité (mode connect) — pas seulement les points#}
{#    element.addEventListener('click', (e) => {#}
{#      if (currentMode !== 'connect') return;#}
{#      e.stopPropagation();#}
{#      handleEntityClick(entity);#}
{#    });#}
{##}
{#    // Clic direct sur un point (sur-cible)#}
{#    element.addEventListener('click', (e) => {#}
{#      const point = e.target.closest('.connection-point');#}
{#      if (!point || currentMode !== 'connect') return;#}
{#      e.stopPropagation();#}
{#      handleEntityClick(entity);#}
{#    });#}
{##}
{#    canvas.appendChild(element);#}
{#  }#}
{##}
{#  function makeDraggable(element, entity) {#}
{#    let isDragging = false, startX = 0, startY = 0;#}
{#    element.addEventListener('mousedown', (e) => {#}
{#      if (currentMode !== 'move') return;#}
{#      isDragging = true;#}
{#      element.classList.add('dragging');#}
{#      startX = e.clientX - entity.x;#}
{#      startY = e.clientY - entity.y;#}
{#      e.preventDefault();#}
{#    });#}
{##}
{#    document.addEventListener('mousemove', (e) => {#}
{#      if (!isDragging) return;#}
{#      const canvas = document.getElementById('visual-canvas');#}
{#      const maxX = canvas.clientWidth - element.clientWidth;#}
{#      const maxY = canvas.clientHeight - element.clientHeight;#}
{#      entity.x = Math.max(0, Math.min(e.clientX - startX, maxX));#}
{#      entity.y = Math.max(0, Math.min(e.clientY - startY, maxY));#}
{#      element.style.left = entity.x + 'px';#}
{#      element.style.top  = entity.y + 'px';#}
{#      renderConnections();#}
{#    });#}
{##}
{#    document.addEventListener('mouseup', () => {#}
{#      if (!isDragging) return;#}
{#      isDragging = false;#}
{#      element.classList.remove('dragging');#}
{#    });#}
{#  }#}
{##}
{#  /* === Connexions === */#}
{#  function handleEntityClick(entity) {#}
{#    if (!connectionState.from) {#}
{#      connectionState.from = entity;#}
{#      document.getElementById(entity.id)?.classList.add('connecting');#}
{#      notify('Sélectionnez la cible...', 'info');#}
{#      return;#}
{#    }#}
{#    if (connectionState.from.id === entity.id) {#}
{#      clearConnectionState();#}
{#      return;#}
{#    }#}
{#    connectionState.to = entity;#}
{#    showRelationTypesPanelNear(connectionState.from, connectionState.to);#}
{#  }#}
{##}
{#  function showRelationTypesPanelNear(source, target) {#}
{#    const panel = document.getElementById('relation-types-panel');#}
{#    const sEl = document.getElementById(source.id);#}
{#    const tEl = document.getElementById(target.id);#}
{#    const canvasRect = document.getElementById('visual-canvas').getBoundingClientRect();#}
{#    const sRect = sEl.getBoundingClientRect();#}
{#    const tRect = tEl.getBoundingClientRect();#}
{##}
{#    const midX = (sRect.left + tRect.left + tRect.width) / 2 - canvasRect.left;#}
{#    const midY = (sRect.top + sRect.height/2 + tRect.top + tRect.height/2)/2 - canvasRect.top;#}
{##}
{#    panel.style.left = midX + 'px';#}
{#    panel.style.top  = midY + 'px';#}
{#    panel.style.transform = 'translate(-50%,-50%)';#}
{#    panel.classList.add('show');#}
{#  }#}
{##}
{#  // Écouteur unique sur le panel (évite multiples listeners)#}
{#  document.addEventListener('click', (e) => {#}
{#    const panel = document.getElementById('relation-types-panel');#}
{#    if (!panel.classList.contains('show')) return;#}
{#    const opt = e.target.closest('.relation-type-option');#}
{#    if (!opt) return;#}
{#    const type = opt.dataset.type;#}
{#    if (type === '__custom__') {#}
{#      const custom = prompt('Saisissez le type de relation personnalisé :');#}
{#      if (custom && custom.trim()) createRelation(custom.trim().toLowerCase().replace(/\s+/g,'_'));#}
{#    } else {#}
{#      createRelation(type);#}
{#    }#}
{#    hideRelationTypesPanel();#}
{#  });#}
{##}
{#  function hideRelationTypesPanel(){ document.getElementById('relation-types-panel').classList.remove('show'); }#}
{##}
{#  function createRelation(type) {#}
{#    if (!connectionState.from || !connectionState.to) return;#}
{#    // Déduplication#}
{#    const key = (r) => [r.source.id, r.type, r.target.id].join('|');#}
{#    const newRel = { id: generateId(), source: connectionState.from, target: connectionState.to, type };#}
{#    if (!canvasRelations.some(r => key(r) === key(newRel))) {#}
{#      canvasRelations.push(newRel);#}
{#      notify(`Relation "${type}" créée`, 'success');#}
{#    } else {#}
{#      notify('Relation déjà existante', 'warning');#}
{#    }#}
{#    clearConnectionState();#}
{#    renderConnections();#}
{#    updateRelationsSummary();#}
{#  }#}
{##}
{#  function clearConnectionState() {#}
{#    document.querySelectorAll('.canvas-entity').forEach(el => el.classList.remove('connecting'));#}
{#    connectionState = { from: null, to: null };#}
{#  }#}
{##}
{#  function renderConnections() {#}
{#    if (!edgesLayer || !labelsLayer) return;#}
{#    // Clear layers#}
{#    while (edgesLayer.firstChild) edgesLayer.removeChild(edgesLayer.firstChild);#}
{#    while (labelsLayer.firstChild) labelsLayer.removeChild(labelsLayer.firstChild);#}
{##}
{#    canvasRelations.forEach(relation => {#}
{#      const sEl = document.getElementById(relation.source.id);#}
{#      const tEl = document.getElementById(relation.target.id);#}
{#      if (!sEl || !tEl) return;#}
{##}
{#      // Points dans le repère du canvas#}
{#      const startX = relation.source.x + sEl.clientWidth;#}
{#      const startY = relation.source.y + sEl.clientHeight/2;#}
{#      const endX   = relation.target.x;#}
{#      const endY   = relation.target.y + tEl.clientHeight/2;#}
{##}
{#      const cx1 = startX + (endX - startX) * 0.5;#}
{#      const cy1 = startY;#}
{#      const cx2 = startX + (endX - startX) * 0.5;#}
{#      const cy2 = endY;#}
{##}
{#      const path = document.createElementNS('http://www.w3.org/2000/svg','path');#}
{#      path.setAttribute('d', `M ${startX} ${startY} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${endX} ${endY}`);#}
{#      path.setAttribute('stroke', 'var(--pharma-accent)');#}
{#      path.setAttribute('stroke-width', '3');#}
{#      path.setAttribute('fill', 'none');#}
{#      path.setAttribute('marker-end', 'url(#arrowhead)');#}
{#      path.style.filter = 'drop-shadow(0 2px 4px rgba(16,185,129,.3))';#}
{#      edgesLayer.appendChild(path);#}
{##}
{#      const label = document.createElementNS('http://www.w3.org/2000/svg','text');#}
{#      label.setAttribute('x', (startX + endX)/2);#}
{#      label.setAttribute('y', (startY + endY)/2 - 10);#}
{#      label.setAttribute('text-anchor','middle');#}
{#      label.setAttribute('fill','var(--pharma-text)');#}
{#      label.setAttribute('font-size','12');#}
{#      label.setAttribute('font-weight','600');#}
{#      label.textContent = relation.type.replace(/_/g,' ');#}
{#      labelsLayer.appendChild(label);#}
{#    });#}
{#  }#}
{##}
{#  function updateRelationsSummary() {#}
{#    const count = document.getElementById('relations-count');#}
{#    const preview = document.getElementById('relations-preview');#}
{#    count.textContent = canvasRelations.length;#}
{#    preview.innerHTML = canvasRelations.map(rel =>#}
{#      `<div class="relation-preview-item">${rel.source.value} → ${rel.type.replace(/_/g,' ')} → ${rel.target.value}</div>`#}
{#    ).join('');#}
{#  }#}
{##}
{#  function clearCanvas() {#}
{#    if (!confirm('Êtes-vous sûr de vouloir effacer toutes les entités et relations ?')) return;#}
{#    canvasEntities = [];#}
{#    canvasRelations = [];#}
{#    document.getElementById('visual-canvas').innerHTML =#}
{#      '<svg class="connection-svg" id="connection-svg"></svg>';#}
{#    setupCanvasBase();#}
{#    updateRelationsSummary();#}
{#    notify('Canvas effacé', 'success');#}
{#  }#}
{#  window.clearCanvas = clearCanvas;#}
{##}
{#  function autoArrange() {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    const cw = canvas.clientWidth, ch = canvas.clientHeight;#}
{#    const cols = Math.max(1, Math.ceil(Math.sqrt(canvasEntities.length)));#}
{#    const rows = Math.max(1, Math.ceil(canvasEntities.length / cols));#}
{#    const cellW = cw/cols, cellH = ch/rows;#}
{##}
{#    canvasEntities.forEach((e, i) => {#}
{#      const col = i % cols, row = Math.floor(i/cols);#}
{#      e.x = Math.max(0, Math.min(col*cellW + cellW/2 - 60, cw - 120));#}
{#      e.y = Math.max(0, Math.min(row*cellH + cellH/2 - 20, ch - 40));#}
{#      const el = document.getElementById(e.id);#}
{#      if (el) { el.style.left = e.x + 'px'; el.style.top = e.y + 'px'; }#}
{#      else { renderEntityOnCanvas(e); }#}
{#    });#}
{##}
{#    renderConnections();#}
{#    notify('Entités réorganisées automatiquement', 'success');#}
{#  }#}
{#  window.autoArrange = autoArrange;#}
{##}
{#  async function saveAllRelations() {#}
{#    if (canvasRelations.length === 0) { notify('Aucune relation à sauvegarder', 'warning'); return; }#}
{#    // Nettoyage/dédup#}
{#    const unique = [];#}
{#    const seen = new Set();#}
{#    for (const r of canvasRelations) {#}
{#      const k = [r.source.type,r.source.value,r.type,r.target.type,r.target.value].join('|');#}
{#      if (!seen.has(k)) { seen.add(k); unique.push(r); }#}
{#    }#}
{#    const relations = unique.map(rel => ({#}
{#      source_type: rel.source.type,#}
{#      source_value: rel.source.value,#}
{#      target_type: rel.target.type,#}
{#      target_value: rel.target.value,#}
{#      relation_type: rel.type,#}
{#      description: ''#}
{#    }));#}
{##}
{#    try {#}
{#      notify('Sauvegarde en cours...', 'info');#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-relations-batch/`, {#}
{#        method: 'POST',#}
{#        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ relations })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) {#}
{#        notify(`✅ ${relations.length} relations sauvegardées`, 'success');#}
{#        hideModal('visual-relation-modal');#}
{#        setTimeout(() => location.reload(), 1000);#}
{#      } else {#}
{#        notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');#}
{#      }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.saveAllRelations = saveAllRelations;#}
{##}
{#  /* ========== Actions principales (exportées) ========== */#}
{#  async function enrichDocumentJSON(force = false) {#}
{#    notify('Enrichissement en cours...', 'info');#}
{#    try {#}
{#      const url = `/expert/annotation/document/{{ document.id }}/enrich-json/` + (force ? `?force=1` : ``);#}
{#      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' } });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify(`✅ JSON enrichi. ${data.relations_count} relations, ${data.qa_pairs_count} Q&A.`, 'success'); setTimeout(() => location.reload(), 900); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.enrichDocumentJSON = enrichDocumentJSON;#}
{#  window.regenerateEnrichment = () => enrichDocumentJSON(true);#}
{##}
{#  async function saveJSONChanges() {#}
{#    if (!enrichedEditor) { notify('Aucun éditeur enrichi', 'error'); return; }#}
{#    try {#}
{#      const payload = JSON.parse(enrichedEditor.getValue());#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/save-enriched-edits/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ manual_edits: payload })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) notify('✅ Modifications sauvegardées', 'success');#}
{#      else notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');#}
{#    } catch (e) { notify('❌ JSON invalide : ' + e.message, 'error'); }#}
{#  }#}
{#  window.saveJSONChanges = saveJSONChanges;#}
{##}
{#  async function addQAPair() {#}
{#    const q = (document.getElementById('qa-question') || {}).value?.trim();#}
{#    const a = (document.getElementById('qa-answer')   || {}).value?.trim();#}
{#    const tags = (document.getElementById('qa-tags')   || {}).value?.split(',').map(s => s.trim()).filter(Boolean) || [];#}
{#    if (!q || !a) { alert('Question et réponse requises'); return; }#}
{#    try {#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-qa/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ question: q, answer: a, tags, entity_refs: [] })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify('✅ Q&A ajoutée', 'success'); hideModal('add-qa-modal'); setTimeout(() => location.reload(), 700); }#}
{#      else notify('❌ ' + data.error, 'error');#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addQAPair = addQAPair;#}
{##}
{#  async function testQASystem() {#}
{#    const qEl = document.getElementById('test-question');#}
{#    const resEl = document.getElementById('qa-test-result');#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const source = (document.querySelector('input[name="qa-source"]:checked') || {}).value || 'enriched';#}
{#    const question = (qEl && qEl.value || '').trim();#}
{#    if (!question) { alert('Veuillez saisir une question'); return; }#}
{##}
{#    resEl.style.display = 'block';#}
{#    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche de la réponse...';#}
{#    corrBox.style.display = 'none';#}
{##}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/test-qa/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question, source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) {#}
{#        const conf = data.confidence || 0;#}
{#        const color = conf > 0.8 ? '#10b981' : (conf > 0.5 ? '#f59e0b' : '#64748b');#}
{#        resEl.innerHTML =#}
{#          `<div style="display:flex;align-items:flex-start;gap:1rem;">#}
{#            <div style="flex:1;">#}
{#              <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b;"><i class="fas fa-robot"></i> Réponse (${source}) :</div>#}
{#              <div id="qa-answer-text" style="color:#64748b;line-height:1.6;">${data.answer}</div>#}
{#            </div>#}
{#            <div style="background:${color};color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:600;white-space:nowrap;">#}
{#              ${Math.round(conf*100)}% confiance#}
{#            </div>#}
{#          </div>#}
{#          ${data.answer_type === 'no_match' ? `<div style="margin-top:1rem;padding:1rem;background:rgba(245,158,11,.1);border-radius:8px;border-left:4px solid #f59e0b;"><strong>💡 Suggestion :</strong> ${data.suggestion || ''}</div>` : ''}#}
{#          <div style="margin-top:.75rem;text-align:right;">#}
{#            <button class="enrichment-btn secondary" onclick="openCorrection()"><i class="fas fa-edit"></i> Corriger cette réponse</button>#}
{#          </div>`;#}
{#        window.__lastQA__ = { question, source, answer: data.answer };#}
{#      } else {#}
{#        resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;#}
{#      }#}
{#    } catch (e) {#}
{#      resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-times-circle"></i> Erreur: ${e.message}</div>`;#}
{#    }#}
{#  }#}
{#  window.testQASystem = testQASystem;#}
{##}
{#  function openCorrection() {#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const ta = document.getElementById('qa-corrected');#}
{#    const ans = (window.__lastQA__ || {}).answer || '';#}
{#    if (ta) ta.value = ans;#}
{#    corrBox.style.display = 'block';#}
{#  }#}
{#  window.openCorrection = openCorrection;#}
{##}
{#  async function sendQACorrection() {#}
{#    const ctx = window.__lastQA__ || {};#}
{#    const corrected = (document.getElementById('qa-corrected') || {}).value?.trim();#}
{#    if (!ctx.question || !corrected) { alert('Question ou correction manquante.'); return; }#}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/qa-feedback/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question: ctx.question, corrected_answer: corrected, source: ctx.source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) { notify('✅ Correction enregistrée. Merci !', 'success'); document.getElementById('qa-correction').style.display = 'none'; loadLearningStats(); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.sendQACorrection = sendQACorrection;#}
{##}
{#  /* ========== Fonctions d'apprentissage ========== */#}
{#  async function loadLearningStats() {#}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/learning-history/`);#}
{#      const data = await response.json();#}
{#      if (data.success) {#}
{#        document.getElementById('corrections-count').textContent = data.history.total_corrections || 0;#}
{#        document.getElementById('relations-improved').textContent = data.history.history?.filter(h => h.type.includes('relation')).length || 0;#}
{#        document.getElementById('qa-improved').textContent = data.history.history?.filter(h => h.type.includes('Q&A')).length || 0;#}
{#        document.getElementById('patterns-reused').textContent = data.history.history?.reduce((sum, h) => sum + (h.reused_count || 0), 0) || 0;#}
{#      }#}
{#    } catch (e) { console.warn('Could not load learning stats:', e); }#}
{#  }#}
{##}
{#  async function compareWithFreshAI() {#}
{#    const btn = document.querySelector('button[onclick="compareWithFreshAI()"]');#}
{#    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Comparaison...';#}
{#    try {#}
{#      const expertJson = enrichedEditor ? JSON.parse(enrichedEditor.getValue()) : ENRICHED;#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/compare-and-learn/`, {#}
{#        method: 'POST',#}
{#        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ expert_json: expertJson, context: { document_title: "{{ document.title }}", doc_type: "{{ document.doc_type }}" } })#}
{#      });#}
{#      const data = await response.json();#}
{#      if (data.success) { notify(`✅ ${data.message}`, 'success'); displayComparisonResults(data.comparison); loadLearningStats(); }#}
{#      else { notify(`❌ ${data.error}`, 'error'); }#}
{#    } catch (e) { notify('❌ Erreur lors de la comparaison', 'error'); }#}
{#    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-balance-scale"></i>Comparer avec IA'; }#}
{#  }#}
{#  window.compareWithFreshAI = compareWithFreshAI;#}
{##}
{#  async function regenerateWithLearning() {#}
{#    const btn = document.querySelector('button[onclick="regenerateWithLearning()"]');#}
{#    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Régénération...';#}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/regenerate-with-learning/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }#}
{#      });#}
{#      const data = await response.json();#}
{#      if (data.success) { notify(data.message, 'success'); setTimeout(() => location.reload(), 1500); }#}
{#      else { notify(data.error, 'error'); }#}
{#    } catch (e) { notify('❌ Erreur lors de la régénération', 'error'); }#}
{#    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i>Régénérer +Apprentissage'; }#}
{#  }#}
{#  window.regenerateWithLearning = regenerateWithLearning;#}
{##}
{#  function viewDetailedHistory() { window.open(`/expert/document/{{ document.id }}/view-expert-deltas/`, '_blank'); }#}
{#  window.viewDetailedHistory = viewDetailedHistory;#}
{##}
{#  function displayComparisonResults(comparison) {#}
{#    const container = document.getElementById('comparison-cards-container');#}
{#    const resultsSection = document.getElementById('comparison-results');#}
{#    if (!comparison || !comparison.summary) return;#}
{##}
{#    let html = '';#}
{#    const summary = comparison.summary;#}
{##}
{#    if (summary.key_improvements && summary.key_improvements.length > 0) {#}
{#      html += '<div style="margin-bottom:1rem">';#}
{#      summary.key_improvements.forEach(improvement => {#}
{#        html += `<div class="comparison-card"><div class="delta-header">#}
{#          <span class="delta-type-badge delta-type-relation_added">Amélioration détectée</span>#}
{#        </div><div style="padding:1rem"><div class="description-text">${improvement}</div></div></div>`;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{##}
{#    if (summary.changes_by_type) {#}
{#      html += '<div class="learning-stats">';#}
{#      Object.entries(summary.changes_by_type).forEach(([type, count]) => {#}
{#        const displayType = type.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());#}
{#        html += `<div class="learning-stat"><div class="learning-stat-value">${count}</div><div class="learning-stat-label">${displayType}</div></div>`;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{##}
{#    container.innerHTML = html;#}
{#    resultsSection.style.display = 'block';#}
{#  }#}
{##}
{#  /* ========== Modales (exportées) ========== */#}
{#  function showModal(id){ const m = document.getElementById(id); if (m){ m.classList.add('show'); } }#}
{#  function hideModal(id){#}
{#    const m = document.getElementById(id); if (!m) return;#}
{#    m.classList.remove('show');#}
{#    if (id === 'visual-relation-modal') {#}
{#      clearConnectionState();#}
{#      hideRelationTypesPanel();#}
{#      window.removeEventListener('resize', renderConnections);#}
{#    }#}
{#  }#}
{#  window.showModal = showModal;#}
{#  window.hideModal = hideModal;#}
{#  window.showAddQAModal = () => showModal('add-qa-modal');#}
{#  window.showAddTextModal = () => showModal('add-text-modal');#}
{##}
{#  document.addEventListener('click', e => {#}
{#    if (e.target.classList?.contains('semantic-modal')) e.target.classList.remove('show');#}
{#  });#}
{##}
{#  /* ========== Extraction depuis un paragraphe (exportée) ========== */#}
{#  async function addFromParagraph() {#}
{#    const text = (document.getElementById('free-text') || {}).value?.trim();#}
{#    const hint = (document.getElementById('free-text-hint') || {}).value?.trim();#}
{#    if (!text) { alert('Collez un paragraphe.'); return; }#}
{#    try {#}
{#      notify('Analyse du paragraphe...', 'info');#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/from-paragraph/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ text, hint })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) {#}
{#        notify(`✅ Ajouté: ${data.added_relations} relations, ${data.added_entities} entités.`, 'success');#}
{#        hideModal('add-text-modal');#}
{#        setTimeout(() => location.reload(), 800);#}
{#      } else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addFromParagraph = addFromParagraph;#}
{##}
{#})();#}
{##}
{##}
{##}
{##}
{#</script>#}
{##}
{#{% endblock %}#}


{# template/expert/view_document_json_enriched.html #}
{#{% extends "base.html" %}#}
{#{% load static %}#}
{#{% load expert_extras %}#}
{#{% block title %}JSON Sémantique Expert - {{ document.title }} – RegExpert{% endblock %}#}
{##}
{#{% block content %}#}
{#<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">#}
{#<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">#}
{#<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">#}
{##}
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>#}
{##}
{# --- JSON DATA SAFE PASSING --- #}
{#{{ global_annotations_json|json_script:"basic-json-data" }}#}
{#{{ enriched_annotations_json|default:"{}"|json_script:"enriched-json-data" }}#}
{#{{ display_json|default:"{}"|json_script:"display-json-data" }}#}
{##}
{#<style>#}
{#:root{#}
{#  --pharma-primary:#3b82f6;--pharma-accent:#10b981;--pharma-info:#06b6d4;#}
{#  --pharma-success:#059669;--pharma-warning:#f59e0b;#}
{#  --pharma-bg-card:#fff;--pharma-bg:#f8fafc;--pharma-text:#1e293b;--pharma-text-soft:#64748b;#}
{#  --pharma-border:#e2e8f0;--pharma-radius:12px;--pharma-radius-sm:8px;--pharma-shadow:0 4px 16px rgba(15,23,42,.08);#}
{#  --pharma-transition:.3s cubic-bezier(.4,0,.2,1);#}
{#  --ai-color:#3b82f6;--expert-color:#10b981;--diff-bg:#f8fafc;--improvement-bg:#ecfdf5;--correction-bg:#fef2f2;#}
{#}#}
{#body{background:var(--pharma-bg);color:var(--pharma-text);font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif}#}
{##}
{#/* Tabs */#}
{#.mode-tabs{display:flex;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:var(--pharma-radius);padding:.75rem;margin-bottom:2rem;box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border)}#}
{#.mode-tab{flex:1;padding:1rem 1.5rem;text-align:center;border-radius:var(--pharma-radius-sm);background:transparent;border:1px solid transparent;color:var(--pharma-text-soft);cursor:pointer;transition:var(--pharma-transition);font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}#}
{#.mode-tab:hover{background:rgba(59,130,246,.1);color:var(--pharma-primary)}#}
{#.mode-tab.active{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;border-color:var(--pharma-primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}#}
{##}
{#/* Cards */#}
{#.semantic-card{background:var(--pharma-bg-card);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);margin-bottom:1.5rem;overflow:hidden;transition:var(--pharma-transition)}#}
{#.semantic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,23,42,.12)}#}
{#.semantic-card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));padding:1.5rem;border-bottom:1px solid var(--pharma-border)}#}
{#.semantic-card-header h3{font-size:1.25rem;font-weight:600;color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.75rem}#}
{#.semantic-card-body{padding:1.5rem}#}
{##}
{#/* Relations list */#}
{#.relations-container{display:flex;flex-direction:column;gap:1rem}#}
{#.relation-item{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));border:1px solid rgba(59,130,246,.2);border-radius:var(--pharma-radius-sm);padding:1rem;display:flex;align-items:center;gap:1rem;transition:var(--pharma-transition);flex-wrap:wrap}#}
{#.relation-item:hover{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));border-color:var(--pharma-primary)}#}
{#.entity-node{background:var(--pharma-primary);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.9rem;font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative}#}
{#.entity-node:hover{max-width:none;white-space:normal;word-break:break-word;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.15)}#}
{#.relation-arrow{color:var(--pharma-accent);font-size:1.2rem;font-weight:bold}#}
{#.relation-type{background:var(--pharma-accent);color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:500;white-space:nowrap}#}
{##}
{#/* Q&A */#}
{#.qa-container{display:flex;flex-direction:column;gap:1rem}#}
{#.qa-item{background:linear-gradient(135deg,rgba(6,182,212,.05),rgba(139,92,246,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--pharma-radius-sm);padding:1.5rem}#}
{#.qa-question{font-weight:600;color:var(--pharma-text);margin-bottom:.75rem;display:flex;gap:.5rem}#}
{#.qa-question::before{content:"Q:";color:var(--pharma-info);font-weight:700}#}
{#.qa-answer{color:var(--pharma-text-soft);line-height:1.6;margin-left:1.75rem;display:flex;gap:.5rem}#}
{#.qa-answer::before{content:"R:";color:var(--pharma-accent);font-weight:700}#}
{##}
{#/* QA test */#}
{#.qa-test-interface{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));border:1px solid rgba(245,158,11,.3);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.qa-input-group{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem}#}
{#.qa-input{flex:1;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}#}
{#.qa-input:focus{outline:none;border-color:var(--pharma-warning);box-shadow:0 0 0 3px rgba(245,158,11,.1)}#}
{#.qa-test-btn{padding:.75rem 1.5rem;background:var(--pharma-warning);color:#fff;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}#}
{#.qa-test-btn:hover{background:#d97706;transform:translateY(-1px)}#}
{#.qa-result{background:#fff;border-radius:8px;padding:1rem;border-left:4px solid var(--pharma-success);margin-top:1rem;display:none}#}
{##}
{#/* JSON panels */#}
{#.json-comparison{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}#}
{#.json-panel{background:#fff;border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);padding:1.5rem}#}
{#.json-panel h4{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--pharma-text);display:flex;align-items:center;gap:.5rem}#}
{##}
{#/* Learning Section */#}
{#.learning-section{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(59,130,246,.05));border:2px solid var(--pharma-accent);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}#}
{#.learning-header{display:flex;justify-content:between;align-items:center;margin-bottom:1.5rem}#}
{#.learning-header h4{color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.5rem}#}
{#.learning-actions{display:flex;gap:.75rem;flex-wrap:wrap}#}
{#.learning-btn{padding:.5rem 1rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.4rem;align-items:center;transition:var(--pharma-transition)}#}
{#.learning-btn.primary{background:linear-gradient(135deg,var(--expert-color),#059669);color:#fff}#}
{#.learning-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{#.learning-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}#}
{##}
{#/* Comparison cards */#}
{#.comparison-card{border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.08);margin-bottom:1rem;overflow:hidden;background:white;position:relative}#}
{#.delta-header{background:linear-gradient(135deg,var(--diff-bg),#e2e8f0);padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}#}
{#.delta-type-badge{padding:.4rem 1rem;border-radius:20px;font-size:.85rem;font-weight:600}#}
{#.delta-type-relation_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-relation_modified{background:#fef3c7;color:#d97706}#}
{#.delta-type-qa_added{background:var(--improvement-bg);color:var(--expert-color)}#}
{#.delta-type-qa_corrected{background:#fef3c7;color:#d97706}#}
{#.version-comparison{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}#}
{#.ai-version,.expert-version{padding:1rem;border-radius:8px;border:2px solid}#}
{#.ai-version{border-color:var(--ai-color);background:rgba(59,130,246,.05)}#}
{#.expert-version{border-color:var(--expert-color);background:rgba(16,185,129,.05)}#}
{#.version-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-weight:600}#}
{#.ai-version .version-header{color:var(--ai-color)}#}
{#.expert-version .version-header{color:var(--expert-color)}#}
{#.relation-display{background:#f8fafc;padding:.75rem;border-radius:6px;font-family:'Courier New',monospace;margin-bottom:.5rem}#}
{#.description-text{font-style:italic;color:#64748b;margin-top:.5rem}#}
{#.improvement-indicator{position:absolute;top:-5px;right:-5px;background:var(--expert-color);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px}#}
{#.learning-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}#}
{#.learning-stat{background:white;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)}#}
{#.learning-stat-value{font-size:1.5rem;font-weight:800;color:var(--expert-color);margin-bottom:.25rem}#}
{#.learning-stat-label{font-size:.8rem;color:var(--pharma-text-soft)}#}
{##}
{#/* Actions */#}
{#.enrichment-actions{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}#}
{#.enrichment-btn{padding:.75rem 1.5rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem;transition:var(--pharma-transition)}#}
{#.enrichment-btn.primary{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff}#}
{#.enrichment-btn.secondary{background:var(--pharma-text-soft);color:#fff}#}
{#.enrichment-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15)}#}
{##}
{#/* ===== Modales (plein écran & corps fluide) ===== */#}
{#.semantic-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}#}
{#.semantic-modal.show{display:flex;animation:fadeInModal .4s ease-out}#}
{#.modal-content-semantic{background:#fff;border-radius:var(--pharma-radius);box-shadow:0 25px 80px rgba(0,0,0,.4);width:98vw;max-width:98vw;height:92vh;max-height:92vh;overflow:hidden}#}
{#.modal-content-semantic.fullscreen{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0}#}
{#.modal-header-semantic{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:1.25rem 1.75rem;display:flex;justify-content:space-between;align-items:center}#}
{#.modal-body-semantic{padding:0;height:calc(92vh - 64px);overflow:hidden}#}
{#.modal-content-semantic.fullscreen .modal-body-semantic{height:calc(100vh - 64px)}#}
{##}
{#/* ===== VRB en grille pleine hauteur ===== */#}
{#.visual-relation-builder{#}
{#  position:relative;background:linear-gradient(135deg,#f8fafc,#ffffff);#}
{#  border:2px solid var(--pharma-border);border-radius:var(--pharma-radius);#}
{#  height:100%;min-height:620px;overflow:hidden;#}
{#  display:grid;grid-template-rows:auto 1fr auto;#}
{#  padding-right:320px; /* réserve palette */#}
{#}#}
{##}
{#/* Barre d’outils */#}
{#.builder-toolbar{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));padding:1rem 1.25rem;border-bottom:1px solid var(--pharma-border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}#}
{#.builder-modes{display:flex;gap:.5rem}#}
{#.mode-switch{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;transition:var(--pharma-transition);font-size:.9rem;display:flex;align-items:center;gap:.5rem}#}
{#.mode-switch.active{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}#}
{#.mode-switch:hover:not(.active){background:rgba(59,130,246,.1)}#}
{#.builder-actions{display:flex;gap:.75rem;align-items:center}#}
{#.builder-btn{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.85rem;display:flex;align-items:center;gap:.4rem}#}
{#.builder-btn.primary{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}#}
{#.builder-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}#}
{##}
{#/* Canvas */#}
{#.visual-canvas{position:relative;min-height:420px;height:auto;overflow:hidden}#}
{#.connection-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}#}
{##}
{#/* Entités */#}
{#.canvas-entity{position:absolute;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:.8rem 1.2rem;border-radius:25px;cursor:move;transition:var(--pharma-transition);box-shadow:0 4px 16px rgba(59,130,246,.3);z-index:10;min-width:120px;text-align:center;font-weight:600;font-size:.9rem;user-select:none;word-break:break-word}#}
{#.canvas-entity:hover{transform:scale(1.05);box-shadow:0 8px 24px rgba(59,130,246,.4)}#}
{#.canvas-entity.dragging{z-index:20;transform:scale(1.1);box-shadow:0 12px 32px rgba(59,130,246,.5)}#}
{#.canvas-entity.source{background:linear-gradient(135deg,#3b82f6,#6366f1)}#}
{#.canvas-entity.target{background:linear-gradient(135deg,#10b981,#059669)}#}
{#.canvas-entity.connecting{animation:pulse 1.5s infinite}#}
{##}
{#/* Points de connexion */#}
{#.connection-point{position:absolute;width:16px;height:16px;background:var(--pharma-accent);border:3px solid #fff;border-radius:50%;cursor:crosshair;transform:translate(-50%,-50%);transition:var(--pharma-transition);box-shadow:0 2px 8px rgba(16,185,129,.4)}#}
{#.connection-point:hover{transform:translate(-50%,-50%) scale(1.3);background:var(--pharma-warning)}#}
{#.connection-point.right{right:-8px;top:50%}#}
{#.connection-point.left{left:-8px;top:50%}#}
{##}
{#/* Palette */#}
{#.entity-palette{position:absolute;right:0;top:0;width:320px;height:100%;background:linear-gradient(180deg,#ffffff,#f8fafc);border-left:1px solid var(--pharma-border);padding:1rem;overflow-y:auto;z-index:15}#}
{#.entity-palette h4{font-size:1rem;font-weight:600;color:var(--pharma-text);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}#}
{#.entity-search{width:100%;padding:.75rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);margin-bottom:1rem;font-size:.9rem}#}
{#.entity-search:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}#}
{#.entity-list{display:flex;flex-direction:column;gap:.5rem}#}
{#.entity-item{background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.75rem;cursor:grab;transition:var(--pharma-transition);display:flex;justify-content:space-between;align-items:center}#}
{#.entity-item:hover{border-color:var(--pharma-primary);transform:translateX(-2px);box-shadow:0 4px 12px rgba(59,130,246,.15)}#}
{#.entity-item:active{cursor:grabbing}#}
{#.entity-type-label{background:var(--pharma-primary);color:#fff;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:600}#}
{##}
{#/* Form création entité */#}
{#.create-entity-form{background:rgba(16,185,129,.05);border:1px dashed var(--pharma-accent);border-radius:var(--pharma-radius-sm);padding:1rem;margin-bottom:1rem}#}
{#.create-entity-input{width:100%;padding:.5rem;border:1px solid var(--pharma-border);border-radius:6px;margin-bottom:.5rem;font-size:.85rem}#}
{#.create-entity-btn{width:100%;padding:.5rem;background:var(--pharma-accent);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer}#}
{##}
{#/* Panel types de relation – visible et centré (grand écran) */#}
{#.relation-types-panel{#}
{#  position:absolute;bottom:calc(16px + var(--vrb-summary-h, 72px));#}
{#  left:50%;transform:translateX(-50%);#}
{#  background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);#}
{#  box-shadow:0 12px 36px rgba(0,0,0,.15);padding:1rem;display:none;z-index:1000;#}
{#  max-width:min(720px, calc(100% - 360px)); /* ne pas passer sous la palette */#}
{#}#}
{#.relation-types-panel.show{display:block;animation:slideUp .25s ease-out}#}
{#.relation-type-option{padding:.5rem .75rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;margin:.25rem;display:inline-block;font-size:.8rem;transition:var(--pharma-transition)}#}
{#.relation-type-option:hover{background:var(--pharma-primary);color:#fff;transform:translateY(-1px)}#}
{#.relation-type-option.custom{border-style:dashed;color:var(--pharma-warning)}#}
{##}
{#/* Résumé */#}
{#.relations-summary{grid-row:3;position:relative;background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(248,250,252,.95));border-top:1px solid var(--pharma-border);padding:1rem;backdrop-filter:blur(10px)}#}
{#.summary-title{font-weight:600;color:var(--pharma-text);margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}#}
{#.relations-count{background:var(--pharma-accent);color:#fff;padding:.2rem .6rem;border-radius:12px;font-size:.75rem;font-weight:600}#}
{#.relation-preview-item{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.2);border-radius:20px;padding:.4rem .8rem;margin:.25rem;display:inline-flex;align-items:center;gap:.5rem;font-size:.8rem}#}
{#.relation-preview-item .edit{cursor:pointer}#}
{##}
{#/* Dialog de description */#}
{#.relation-desc-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);display:none;z-index:900}#}
{#.relation-desc-backdrop.show{display:block}#}
{#.relation-desc-dialog{#}
{#  position:absolute;left:50%;top:35%;transform:translate(-50%,-35%);#}
{#  background:#fff;border:1px solid var(--pharma-border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);#}
{#  width:min(720px, calc(100% - 360px)); max-width:720px;padding:1rem;display:none;z-index:1100#}
{#}#}
{#.relation-desc-dialog.show{display:block}#}
{#.relation-desc-dialog h5{margin:0 0 .5rem 0}#}
{#.relation-desc-dialog textarea{width:100%;min-height:90px;border:2px solid var(--pharma-border);border-radius:8px;padding:.75rem}#}
{#.relation-desc-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem}#}
{##}
{#/* Responsive */#}
{#@media (max-width:1200px){#}
{#  .entity-palette{width:300px}#}
{#  .visual-relation-builder{padding-right:300px}#}
{#}#}
{#@media (max-width:1024px){#}
{#  .visual-relation-builder{display:block;padding-right:0}#}
{#  .entity-palette{position:relative;width:100%;height:auto;border-left:none;border-top:1px solid var(--pharma-border)}#}
{#  .relations-summary{position:relative}#}
{#  .visual-canvas{min-height:360px}#}
{#  .relation-types-panel{max-width:100%;left:50%;transform:translateX(-50%)}#}
{#  .relation-desc-dialog{width:96%;max-width:96%}#}
{#}#}
{#@media (max-width:768px){#}
{#  .json-comparison{grid-template-columns:1fr}#}
{#  .enrichment-actions{flex-direction:column}#}
{#  .mode-tabs{flex-direction:column}#}
{#  .qa-input-group{flex-direction:column}#}
{#  .version-comparison{grid-template-columns:1fr}#}
{#  .modal-content-semantic{width:98vw;height:92vh}#}
{#  .builder-toolbar{flex-direction:column;align-items:stretch}#}
{#}#}
{##}
{#/* Stats (Overview) */#}
{#.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-bottom:1rem}#}
{#.stat-card{display:flex;align-items:center;gap:12px;background:var(--pharma-bg-card);border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);padding:1rem 1.25rem}#}
{#.stat-icon{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(16,185,129,.12));color:var(--pharma-primary);flex:0 0 44px}#}
{#.stat-content{display:flex;flex-direction:column;line-height:1.1}#}
{#.stat-value{font-size:1.6rem;font-weight:800;color:var(--pharma-primary)}#}
{#.stat-label{font-size:.95rem;color:var(--pharma-text-soft);margin-top:2px}#}
{##}
{#/* Animations */#}
{#@keyframes fadeInModal{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}#}
{#@keyframes slideUp{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}#}
{#@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}#}
{#</style>#}
{##}
{#<section class="semantic-card">#}
{#  <div class="semantic-card-header">#}
{#    <h2><i class="fas fa-brain"></i> JSON Sémantique Expert - {{ document.title|truncatechars:50 }}</h2>#}
{#  </div>#}
{#  <div class="semantic-card-body">#}
{#    <div class="mode-tabs">#}
{#      <div class="mode-tab active" data-mode="overview"><i class="fas fa-chart-pie"></i>Vue d'ensemble</div>#}
{#      <div class="mode-tab" data-mode="relations"><i class="fas fa-project-diagram"></i>Relations ({{ enriched_stats.relations_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="qa"><i class="fas fa-question-circle"></i>Q&A ({{ enriched_stats.qa_pairs_count|default:0 }})</div>#}
{#      <div class="mode-tab" data-mode="json"><i class="fas fa-graduation-cap"></i>JSON & Apprentissage</div>#}
{#    </div>#}
{##}
{#    <div class="enrichment-actions">#}
{#      {% if not has_enriched %}#}
{#        <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#      {% else %}#}
{#        <button class="enrichment-btn secondary" onclick="regenerateEnrichment()"><i class="fas fa-sync-alt"></i>Régénérer</button>#}
{#      {% endif %}#}
{#      <button class="enrichment-btn primary" onclick="showVisualRelationBuilder()"><i class="fas fa-project-diagram"></i>Créateur Visuel de Relations</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddQAModal()"><i class="fas fa-question"></i>Ajouter Q&A</button>#}
{#      <button class="enrichment-btn primary" onclick="showAddTextModal()"><i class="fas fa-file-alt"></i> Depuis un paragraphe</button>#}
{#      <a href="{% url 'expert:annotation_dashboard' %}" class="enrichment-btn secondary"><i class="fas fa-arrow-left"></i>Retour Dashboard</a>#}
{#    </div>#}
{#  </div>#}
{#</section>#}
{##}
{# --- OVERVIEW --- #}
{#<div id="overview-tab" class="tab-content">#}
{#  {% if has_enriched %}#}
{#  <div class="stats-grid">#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.relations_count|default:0 }}</div>#}
{#        <div class="stat-label">Relations identifiées</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-question-circle"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.qa_pairs_count|default:0 }}</div>#}
{#        <div class="stat-label">Questions-Réponses</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-layer-group"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ enriched_stats.contexts_count|default:0 }}</div>#}
{#        <div class="stat-label">Contextes sémantiques</div>#}
{#      </div>#}
{#    </div>#}
{#    <div class="stat-card">#}
{#      <div class="stat-icon"><i class="fas fa-list-check"></i></div>#}
{#      <div class="stat-content">#}
{#        <div class="stat-value">{{ total_annotations|default:0 }}</div>#}
{#        <div class="stat-label">Annotations totales</div>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  {% if enriched_annotations_json.semantic_summary %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-lightbulb"></i> Résumé Sémantique Intelligent</h3></div>#}
{#    <div class="semantic-card-body"><p style="font-size:1.1rem;line-height:1.8">{{ enriched_annotations_json.semantic_summary }}</p></div>#}
{#  </div>#}
{#  {% endif %}#}
{##}
{#  <div class="qa-test-interface">#}
{#    <h4><i class="fas fa-vial"></i> Tester le Système de Questions-Réponses</h4>#}
{#    <div style="display:flex;gap:1rem;align-items:center;margin:.25rem 0 1rem">#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="basic"> JSON basique</label>#}
{#      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="enriched" checked> JSON enrichi</label>#}
{#    </div>#}
{#    <div class="qa-input-group">#}
{#      <input type="text" id="test-question" class="qa-input" placeholder="ex: Quel est le dosage du produit ?">#}
{#      <button class="qa-test-btn" onclick="testQASystem()"><i class="fas fa-search"></i>Tester</button>#}
{#    </div>#}
{#    <div id="qa-test-result" class="qa-result"></div>#}
{#    <div id="qa-correction" class="qa-result" style="display:none;border-left-color:#f59e0b">#}
{#      <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b"><i class="fas fa-edit"></i> Corriger la réponse</div>#}
{#      <textarea id="qa-corrected" class="form-control" rows="4" placeholder="Proposez la meilleure réponse..."></textarea>#}
{#      <div style="text-align:right;margin-top:.5rem">#}
{#        <button class="enrichment-btn secondary" onclick="sendQACorrection()"><i class="fas fa-save"></i>Enregistrer la correction</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#  {% else %}#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-body" style="text-align:center;padding:3rem">#}
{#      <i class="fas fa-brain" style="font-size:4rem;color:var(--pharma-text-soft);margin-bottom:1rem"></i>#}
{#      <h3>JSON Non Enrichi</h3>#}
{#      <p>Ce document possède un JSON basique mais pas encore d'enrichissement sémantique.</p>#}
{#      <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>#}
{#    </div>#}
{#  </div>#}
{#  {% endif %}#}
{#</div>#}
{##}
{# --- RELATIONS --- #}
{#<div id="relations-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-project-diagram"></i> Relations Entre Entités</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="relations-container" class="relations-container">#}
{#        {% if enriched_annotations_json.relations %}#}
{#          {% for relation in enriched_annotations_json.relations %}#}
{#          <div class="relation-item">#}
{#            <div class="entity-node">{{ relation.source.value }}</div>#}
{#            <div class="relation-type">{{ relation.type|default:"relation" }}</div>#}
{#            <div class="relation-arrow">→</div>#}
{#            <div class="entity-node">{{ relation.target.value }}</div>#}
{#            {% if relation.description %}<small style="color:var(--pharma-text-soft);margin-left:auto">{{ relation.description }}</small>{% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">#}
{#            <i class="fas fa-project-diagram" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune relation identifiée. Utilisez le créateur visuel de relations.</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- Q&A --- #}
{#<div id="qa-tab" class="tab-content" style="display:none">#}
{#  <div class="semantic-card">#}
{#    <div class="semantic-card-header"><h3><i class="fas fa-question-circle"></i> Questions-Réponses Automatiques</h3></div>#}
{#    <div class="semantic-card-body">#}
{#      <div id="qa-container" class="qa-container">#}
{#        {% if enriched_annotations_json.questions_answers %}#}
{#          {% for qa in enriched_annotations_json.questions_answers %}#}
{#          <div class="qa-item">#}
{#            <div class="qa-question">{{ qa.question }}</div>#}
{#            <div class="qa-answer">{{ qa.answer }}</div>#}
{#            {% if qa.created_by == "expert" %}#}
{#              <div style="margin-top:.5rem">#}
{#                <span style="background:var(--pharma-success);color:#fff;padding:.2rem .5rem;border-radius:10px;font-size:.7rem"><i class="fas fa-user-check"></i> Expert</span>#}
{#              </div>#}
{#            {% endif %}#}
{#          </div>#}
{#          {% endfor %}#}
{#        {% else %}#}
{#          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">#}
{#            <i class="fas fa-question-circle" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#            <p>Aucune Q&A générée. Utilisez "Ajouter Q&A".</p>#}
{#          </div>#}
{#        {% endif %}#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# --- JSON & APPRENTISSAGE --- #}
{#<div id="json-tab" class="tab-content" style="display:none">#}
{#  <div class="learning-section">#}
{#    <div class="learning-header">#}
{#      <h4><i class="fas fa-graduation-cap"></i> Apprentissage Expert IA</h4>#}
{#      <div class="learning-actions">#}
{#        <button class="learning-btn primary" onclick="compareWithFreshAI()">#}
{#          <i class="fas fa-balance-scale"></i>Comparer avec IA#}
{#        </button>#}
{#        <button class="learning-btn primary" onclick="regenerateWithLearning()">#}
{#          <i class="fas fa-magic"></i>Régénérer +Apprentissage#}
{#        </button>#}
{#        <button class="learning-btn secondary" onclick="viewDetailedHistory()">#}
{#          <i class="fas fa-history"></i>Historique détaillé#}
{#        </button>#}
{#      </div>#}
{#    </div>#}
{#    <div class="learning-stats" id="learning-stats">#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="corrections-count">-</div><div class="learning-stat-label">Corrections totales</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="relations-improved">-</div><div class="learning-stat-label">Relations améliorées</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="qa-improved">-</div><div class="learning-stat-label">Q&A améliorées</div></div>#}
{#      <div class="learning-stat"><div class="learning-stat-value" id="patterns-reused">-</div><div class="learning-stat-label">Patterns réutilisés</div></div>#}
{#    </div>#}
{#    <div id="comparison-results" style="display:none">#}
{#      <h5><i class="fas fa-microscope"></i> Dernière comparaison IA vs Expert</h5>#}
{#      <div id="comparison-cards-container"></div>#}
{#    </div>#}
{#  </div>#}
{##}
{#  <div class="json-comparison">#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-file-code"></i> JSON Basique</h4>#}
{#      <div id="basic-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{#    {% if has_enriched %}#}
{#    <div class="json-panel">#}
{#      <h4><i class="fas fa-brain"></i> JSON Enrichi</h4>#}
{#      <div id="enriched-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>#}
{#    </div>#}
{#    {% else %}#}
{#    <div class="json-panel" style="display:flex;align-items:center;justify-content:center;background:var(--pharma-bg)">#}
{#      <div style="text-align:center;color:var(--pharma-text-soft)">#}
{#        <i class="fas fa-brain" style="font-size:3rem;margin-bottom:1rem"></i>#}
{#        <p>JSON enrichi disponible après enrichissement</p>#}
{#      </div>#}
{#    </div>#}
{#    {% endif %}#}
{#  </div>#}
{##}
{#  <div style="text-align:center;margin-top:1rem">#}
{#    <button class="enrichment-btn primary" onclick="saveJSONChanges()"><i class="fas fa-save"></i>Sauvegarder les Modifications</button>#}
{#  </div>#}
{#</div>#}
{##}
{# --- MODAL CRÉATEUR VISUEL DE RELATIONS --- #}
{#<div id="visual-relation-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-project-diagram"></i> Créateur Visuel de Relations</h3>#}
{#      <div>#}
{#        <button id="vrb-fullscreen-btn" class="builder-btn" onclick="toggleVRBFullscreen()"><i class="fas fa-expand"></i> Plein écran</button>#}
{#        <button style="background:none;border:none;color:#fff;font-size:1.5rem;margin-left:.5rem" onclick="hideModal('visual-relation-modal')">×</button>#}
{#      </div>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="visual-relation-builder">#}
{#        <!-- Barre d'outils -->#}
{#        <div class="builder-toolbar">#}
{#          <div class="builder-modes">#}
{#            <div class="mode-switch active" data-mode="connect"><i class="fas fa-link"></i> Mode Connexion</div>#}
{#            <div class="mode-switch" data-mode="move"><i class="fas fa-arrows-alt"></i> Mode Déplacement</div>#}
{#          </div>#}
{#          <div class="builder-actions">#}
{#            <button class="builder-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> Effacer</button>#}
{#            <button class="builder-btn" onclick="autoArrange()"><i class="fas fa-magic"></i> Auto-organiser</button>#}
{#            <button class="builder-btn primary" onclick="saveAllRelations()"><i class="fas fa-save"></i> Sauvegarder tout</button>#}
{#          </div>#}
{#        </div>#}
{##}
{#        <!-- Canvas -->#}
{#        <div class="visual-canvas" id="visual-canvas">#}
{#          <svg class="connection-svg" id="connection-svg" preserveAspectRatio="none">#}
{#            <defs>#}
{#              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">#}
{#                <polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" />#}
{#              </marker>#}
{#            </defs>#}
{#          </svg>#}
{#        </div>#}
{##}
{#        <!-- Palette -->#}
{#        <div class="entity-palette">#}
{#          <h4><i class="fas fa-cubes"></i> Entités disponibles</h4>#}
{#          <input type="text" class="entity-search" id="entity-search" placeholder="Rechercher une entité...">#}
{#          <div class="create-entity-form">#}
{#            <input type="text" class="create-entity-input" id="new-entity-name" placeholder="Nom de la nouvelle entité">#}
{#            <select class="create-entity-input" id="new-entity-type">#}
{#              <option value="product">Produit</option>#}
{#              <option value="ingredient">Ingrédient</option>#}
{#              <option value="dosage">Dosage</option>#}
{#              <option value="indication">Indication</option>#}
{#              <option value="contraindication">Contre-indication</option>#}
{#              <option value="custom">Personnalisé</option>#}
{#            </select>#}
{#            <button class="create-entity-btn" onclick="createNewCanvasEntity()"><i class="fas fa-plus"></i> Créer</button>#}
{#          </div>#}
{#          <div class="entity-list" id="entity-list"></div>#}
{#        </div>#}
{##}
{#        <!-- Panel types relation -->#}
{#        <div class="relation-types-panel" id="relation-types-panel">#}
{#          <div style="font-weight:600;margin-bottom:.5rem;text-align:center">Choisir le type de relation :</div>#}
{#          <div class="relation-type-option" data-type="contains">contient</div>#}
{#          <div class="relation-type-option" data-type="manufactured_by">fabriqué par</div>#}
{#          <div class="relation-type-option" data-type="has_dosage">dosage</div>#}
{#          <div class="relation-type-option" data-type="used_for">utilisé pour</div>#}
{#          <div class="relation-type-option" data-type="contraindicated_with">contre-indiqué</div>#}
{#          <div class="relation-type-option" data-type="interacts_with">interagit avec</div>#}
{#          <div class="relation-type-option" data-type="composed_of">composé de</div>#}
{#          <div class="relation-type-option" data-type="has_side_effect">effet secondaire</div>#}
{#          <div class="relation-type-option custom" data-type="__custom"><i class="fas fa-plus"></i> Personnalisé</div>#}
{#        </div>#}
{##}
{#        <!-- Dialog description -->#}
{#        <div id="rel-desc-backdrop" class="relation-desc-backdrop"></div>#}
{#        <div id="rel-desc-dialog" class="relation-desc-dialog" role="dialog" aria-modal="true">#}
{#          <h5><i class="fas fa-align-left"></i> Décrire la relation</h5>#}
{#          <div id="rel-desc-context" style="font-size:.9rem;color:#475569;margin-bottom:.5rem"></div>#}
{#          <textarea id="rel-desc-text" placeholder="Saisissez une description précise de la relation (optionnel)"></textarea>#}
{#          <div class="relation-desc-actions">#}
{#            <button class="builder-btn" id="rel-desc-cancel">Annuler</button>#}
{#            <button class="builder-btn" id="rel-desc-ai">Laisser l’IA</button>#}
{#            <button class="builder-btn primary" id="rel-desc-ok"><i class="fas fa-check"></i> Valider</button>#}
{#          </div>#}
{#        </div>#}
{##}
{#        <!-- Résumé -->#}
{#        <div class="relations-summary" id="relations-summary">#}
{#          <div class="summary-title"><i class="fas fa-list"></i> Relations créées <span class="relations-count" id="relations-count">0</span></div>#}
{#          <div id="relations-preview"></div>#}
{#        </div>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{# Modales Q&A & paragraphe (inchangées) #}
{#<div id="add-qa-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-question"></i> Ajouter Question-Réponse</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-qa-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group"><label class="form-label">Question</label><input type="text" id="qa-question" class="form-control" placeholder="ex: Quel est le dosage du produit ?"></div>#}
{#      <div class="form-group"><label class="form-label">Réponse</label><textarea id="qa-answer" class="form-control" rows="3" placeholder="Réponse complète..."></textarea></div>#}
{#      <div class="form-group"><label class="form-label">Tags (optionnel)</label><input type="text" id="qa-tags" class="form-control" placeholder="dosage, posologie, administration"></div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-qa-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addQAPair()"><i class="fas fa-plus"></i>Ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<div id="add-text-modal" class="semantic-modal">#}
{#  <div class="modal-content-semantic">#}
{#    <div class="modal-header-semantic">#}
{#      <h3><i class="fas fa-file-alt"></i> Extraire des relations depuis un paragraphe</h3>#}
{#      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-text-modal')">×</button>#}
{#    </div>#}
{#    <div class="modal-body-semantic">#}
{#      <div class="form-group">#}
{#        <label class="form-label">Paragraphe</label>#}
{#        <textarea id="free-text" class="form-control" rows="6" placeholder="Collez ici un extrait du document"></textarea>#}
{#      </div>#}
{#      <div class="form-group">#}
{#        <label class="form-label">Aide (optionnelle)</label>#}
{#        <input id="free-text-hint" class="form-control" placeholder="ex: réglementation, posologie, interactions...">#}
{#      </div>#}
{#      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">#}
{#        <button class="enrichment-btn secondary" onclick="hideModal('add-text-modal')">Annuler</button>#}
{#        <button class="enrichment-btn primary" onclick="addFromParagraph()"><i class="fas fa-magic"></i> Analyser & ajouter</button>#}
{#      </div>#}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<script>#}
{#(function () {#}
{#  /* =================== Utils =================== */#}
{#  function fromJsonScript(id, fallback) {#}
{#    const n = document.getElementById(id);#}
{#    if (!n) return fallback;#}
{#    try { return JSON.parse(n.textContent.trim() || '{}'); }#}
{#    catch (e) { console.warn('JSON invalide pour', id, e); return fallback; }#}
{#  }#}
{##}
{#  function getCookie(name) {#}
{#    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));#}
{#    return m ? decodeURIComponent(m[1]) : '';#}
{#  }#}
{#  window.getCookie = getCookie;#}
{##}
{#  function notify(msg, type) {#}
{#    const el = document.createElement('div');#}
{#    el.className = `expert-notification ${type || 'info'}`;#}
{#    el.innerHTML = `<div class="notification-content">#}
{#      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>#}
{#      <span>${msg}</span>#}
{#    </div>`;#}
{#    if (!document.getElementById('expert-notification-styles')) {#}
{#      const css = document.createElement('style'); css.id = 'expert-notification-styles';#}
{#      css.textContent =#}
{#        `.expert-notification{position:fixed;top:20px;right:20px;z-index:10000;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);animation:slideIn .25s ease-out;max-width:400px}#}
{#         .expert-notification.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(34,197,94,.9));color:#fff}#}
{#         .expert-notification.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}#}
{#         .expert-notification.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(16,185,129,.9));color:#fff}#}
{#         .notification-content{display:flex;align-items:center;gap:.75rem;font-weight:500;font-size:.9rem}#}
{#         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}#}
{#         @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;#}
{#      document.head.appendChild(css);#}
{#    }#}
{#    document.body.appendChild(el);#}
{#    setTimeout(() => { el.style.animation = 'slideOut .25s ease-in'; setTimeout(() => el.remove(), 280); }, 3000);#}
{#  }#}
{#  window.notify = notify;#}
{##}
{#  /* =================== Données =================== */#}
{#  const BASIC    = fromJsonScript('basic-json-data',   {});#}
{#  const ENRICHED = fromJsonScript('enriched-json-data',{});#}
{#  const DISPLAY  = fromJsonScript('display-json-data', {});#}
{##}
{#  /* =================== Visual builder state =================== */#}
{#  let allEntities = [];#}
{#  let canvasEntities = [];#}
{#  let canvasRelations = [];#}
{#  let currentMode = 'connect';#}
{#  let connectionState = { from: null, to: null };#}
{#  let pendingRelation = null; // pour le dialogue de description#}
{##}
{#  const RELATION_LABELS = {#}
{#    contains: 'contient',#}
{#    manufactured_by: 'est fabriqué par',#}
{#    has_dosage: 'a pour dosage',#}
{#    used_for: 'est utilisé pour',#}
{#    contraindicated_with: 'est contre-indiqué avec',#}
{#    interacts_with: 'interagit avec',#}
{#    composed_of: 'est composé de',#}
{#    has_side_effect: 'a pour effet secondaire'#}
{#  };#}
{##}
{#  /* =================== Monaco =================== */#}
{#  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });#}
{##}
{#  function makeEditor(id, val, readOnly) {#}
{#    const el = document.getElementById(id); if (!el) return null;#}
{#    return monaco.editor.create(el, {#}
{#      value: JSON.stringify(val ?? {}, null, 2),#}
{#      language: 'json', theme: 'vs', readOnly: !!readOnly,#}
{#      automaticLayout: true, minimap: { enabled: false }, wordWrap: 'on', scrollBeyondLastLine: false#}
{#    });#}
{#  }#}
{#  let basicEditor = null, enrichedEditor = null;#}
{##}
{#  document.addEventListener('DOMContentLoaded', function () {#}
{#    // Tabs#}
{#    document.querySelectorAll('.mode-tab').forEach(tab => {#}
{#      tab.addEventListener('click', () => {#}
{#        const mode = tab.dataset.mode;#}
{#        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t === tab));#}
{#        document.querySelectorAll('.tab-content').forEach(c => c.style.display = (c.id === mode + '-tab') ? 'block' : 'none');#}
{#        [basicEditor, enrichedEditor].forEach(ed => ed && ed.layout && ed.layout());#}
{#      });#}
{#    });#}
{##}
{#    // Monaco init#}
{#    require(['vs/editor/editor.main'], function () {#}
{#      basicEditor    = makeEditor('basic-json-editor',    BASIC,    true);#}
{#      enrichedEditor = makeEditor('enriched-json-editor', ENRICHED, false);#}
{#      if (enrichedEditor && (!ENRICHED || Object.keys(ENRICHED).length === 0)) {#}
{#        enrichedEditor.setValue('// Pas encore enrichi. Cliquez sur « Régénérer » pour créer le JSON enrichi.');#}
{#      }#}
{#    });#}
{##}
{#    // Init entités & stats#}
{#    extractAllEntities(BASIC);#}
{#    loadLearningStats();#}
{#  });#}
{##}
{#  /* =================== Entités =================== */#}
{#  function extractAllEntities(basicJson) {#}
{#    allEntities = [];#}
{#    const entities = (basicJson && basicJson.entities) || {};#}
{#    Object.entries(entities).forEach(([type, items]) => {#}
{#      const list = Array.isArray(items) ? items : ((items && items.items) || []);#}
{#      list.forEach(item => {#}
{#        const value = (typeof item === 'string') ? item : ((item && item.value) || '');#}
{#        if (value) allEntities.push({ id: genId(), type, value, x: 0, y: 0 });#}
{#      });#}
{#    });#}
{#  }#}
{#  function genId(){ return 'ent_' + Math.random().toString(36).slice(2,10); }#}
{##}
{#  /* =================== Builder =================== */#}
{#  function showVisualRelationBuilder() {#}
{#    showModal('visual-relation-modal');#}
{#    setTimeout(() => initializeVisualBuilder(), 50);#}
{#  }#}
{#  window.showVisualRelationBuilder = showVisualRelationBuilder;#}
{##}
{#  function initializeVisualBuilder() {#}
{#    setupBuilderModes();#}
{#    populateEntityList();#}
{#    setupCanvasInteractions();#}
{#    renderConnections();#}
{#    wireRelationTypePanel(); // set once#}
{#    wireDescriptionDialog();#}
{#    resizeVisualBuilder(); // première mesure + position panel si visible#}
{#  }#}
{##}
{#  function setupBuilderModes() {#}
{#    document.querySelectorAll('.mode-switch').forEach(btn => {#}
{#      btn.addEventListener('click', () => {#}
{#        document.querySelectorAll('.mode-switch').forEach(b => b.classList.remove('active'));#}
{#        btn.classList.add('active');#}
{#        currentMode = btn.dataset.mode;#}
{#        updateCanvasCursor();#}
{#      });#}
{#    });#}
{#    updateCanvasCursor();#}
{#  }#}
{#  function updateCanvasCursor() {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    canvas.style.cursor = currentMode === 'connect' ? 'crosshair' : 'default';#}
{#  }#}
{##}
{#  function populateEntityList() {#}
{#    const list = document.getElementById('entity-list');#}
{#    list.innerHTML = '';#}
{#    allEntities.forEach(entity => {#}
{#      const item = document.createElement('div');#}
{#      item.className = 'entity-item';#}
{#      item.draggable = true;#}
{#      item.innerHTML = `<span>${entity.value}</span><span class="entity-type-label">${entity.type}</span>`;#}
{#      item.addEventListener('dragstart', (e) => {#}
{#        e.dataTransfer.setData('text/plain', JSON.stringify(entity));#}
{#      });#}
{#      list.appendChild(item);#}
{#    });#}
{##}
{#    // Recherche#}
{#    const search = document.getElementById('entity-search');#}
{#    search.oninput = (e) => {#}
{#      const q = e.target.value.toLowerCase();#}
{#      Array.from(list.children).forEach(it => it.style.display = it.textContent.toLowerCase().includes(q) ? 'flex' : 'none');#}
{#    };#}
{#  }#}
{##}
{#  window.createNewCanvasEntity = function createNewCanvasEntity() {#}
{#    const nameInput = document.getElementById('new-entity-name');#}
{#    const typeSelect = document.getElementById('new-entity-type');#}
{#    const name = nameInput.value.trim();#}
{#    const type = typeSelect.value;#}
{#    if (!name) { nameInput.focus(); return; }#}
{#    const entity = { id: genId(), type, value: name, x: 0, y: 0 };#}
{#    allEntities.push(entity);#}
{#    populateEntityList();#}
{#    nameInput.value = '';#}
{#    notify(`Entité « ${name} » créée`, 'success');#}
{#  };#}
{##}
{#  function setupCanvasInteractions() {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{##}
{#    // Drop pour ajouter une entité#}
{#    canvas.addEventListener('dragover', e => e.preventDefault());#}
{#    canvas.addEventListener('drop', (e) => {#}
{#      e.preventDefault();#}
{#      const rect = canvas.getBoundingClientRect();#}
{#      const x = e.clientX - rect.left;#}
{#      const y = e.clientY - rect.top;#}
{#      try {#}
{#        const entityData = JSON.parse(e.dataTransfer.getData('text/plain'));#}
{#        addEntityToCanvas(entityData, x, y);#}
{#      } catch (err) { console.warn('Drop error:', err); }#}
{#    });#}
{##}
{#    // Click de connexion#}
{#    canvas.addEventListener('click', (e) => {#}
{#      if (currentMode !== 'connect') return;#}
{#      const point = e.target.closest('.connection-point');#}
{#      if (!point) return;#}
{#      const entityId = point.dataset.entityId;#}
{#      const entity = canvasEntities.find(en => en.id === entityId);#}
{#      if (!entity) return;#}
{##}
{#      if (!connectionState.from) {#}
{#        connectionState.from = entity;#}
{#        document.getElementById(entity.id)?.classList.add('connecting');#}
{#        notify('Cliquez sur une autre entité pour choisir la cible', 'info');#}
{#      } else if (connectionState.from.id === entityId) {#}
{#        clearConnectionState();#}
{#      } else {#}
{#        connectionState.to = entity;#}
{#        showRelationTypesPanel();#}
{#      }#}
{#    });#}
{#  }#}
{##}
{#  function addEntityToCanvas(entity, x, y) {#}
{#    if (canvasEntities.find(e => e.id === entity.id)) {#}
{#      notify('Cette entité est déjà sur le canvas', 'warning');#}
{#      return;#}
{#    }#}
{#    const canvasEntity = { ...entity, x, y };#}
{#    canvasEntities.push(canvasEntity);#}
{#    renderEntityOnCanvas(canvasEntity);#}
{#  }#}
{##}
{#  function renderEntityOnCanvas(entity) {#}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    const element = document.createElement('div');#}
{#    element.className = 'canvas-entity';#}
{#    element.id = entity.id;#}
{#    element.textContent = entity.value;#}
{#    element.title = `${entity.type}: ${entity.value}`;#}
{#    element.style.left = entity.x + 'px';#}
{#    element.style.top  = entity.y + 'px';#}
{##}
{#    const rightPoint = document.createElement('div');#}
{#    rightPoint.className = 'connection-point right';#}
{#    rightPoint.dataset.entityId = entity.id;#}
{#    rightPoint.dataset.side = 'right';#}
{##}
{#    const leftPoint = document.createElement('div');#}
{#    leftPoint.className = 'connection-point left';#}
{#    leftPoint.dataset.entityId = entity.id;#}
{#    leftPoint.dataset.side = 'left';#}
{##}
{#    element.appendChild(rightPoint);#}
{#    element.appendChild(leftPoint);#}
{##}
{#    makeDraggable(element, entity);#}
{#    canvas.appendChild(element);#}
{#  }#}
{##}
{#  function makeDraggable(element, entity) {#}
{#    let isDragging = false;#}
{#    let startX, startY;#}
{##}
{#    element.addEventListener('mousedown', (e) => {#}
{#      if (currentMode !== 'move') return;#}
{#      isDragging = true;#}
{#      startX = e.clientX - entity.x;#}
{#      startY = e.clientY - entity.y;#}
{#      element.classList.add('dragging');#}
{#      e.preventDefault();#}
{#    });#}
{##}
{#    document.addEventListener('mousemove', (e) => {#}
{#      if (!isDragging) return;#}
{#      entity.x = e.clientX - startX;#}
{#      entity.y = e.clientY - startY;#}
{#      const canvas = document.getElementById('visual-canvas');#}
{#      const maxX = canvas.offsetWidth  - element.offsetWidth;#}
{#      const maxY = canvas.offsetHeight - element.offsetHeight;#}
{#      entity.x = Math.max(0, Math.min(entity.x, maxX));#}
{#      entity.y = Math.max(0, Math.min(entity.y, maxY));#}
{#      element.style.left = entity.x + 'px';#}
{#      element.style.top  = entity.y + 'px';#}
{#      renderConnections();#}
{#    });#}
{##}
{#    document.addEventListener('mouseup', () => {#}
{#      if (isDragging) { isDragging = false; element.classList.remove('dragging'); }#}
{#    });#}
{#  }#}
{##}
{#  /* ========= Panneau types de relation ========= */#}
{#  function wireRelationTypePanel() {#}
{#    const panel = document.getElementById('relation-types-panel');#}
{#    if (panel.__wired) return; panel.__wired = true;#}
{#    panel.addEventListener('click', (e) => {#}
{#      const opt = e.target.closest('.relation-type-option');#}
{#      if (!opt) return;#}
{#      let relType = opt.dataset.type;#}
{#      if (relType === '__custom') {#}
{#        const customType = prompt('Saisissez le type de relation personnalisé:');#}
{#        if (!customType || !customType.trim()) return;#}
{#        relType = customType.trim().toLowerCase().replace(/\s+/g, '_');#}
{#      }#}
{#      // On ouvre le dialogue de description#}
{#      openDescriptionDialog(relType);#}
{#      hideRelationTypesPanel();#}
{#    });#}
{#  }#}
{##}
{#  function centerRelationPanel() {#}
{#    const panel   = document.getElementById('relation-types-panel');#}
{#    const builder = document.querySelector('.visual-relation-builder');#}
{#    const palette = document.querySelector('.entity-palette');#}
{#    const summary = document.getElementById('relations-summary');#}
{#    if (!panel || !builder) return;#}
{##}
{#    // hauteur du résumé pour éviter le chevauchement#}
{#    const sumH = summary ? summary.offsetHeight : 72;#}
{#    builder.style.setProperty('--vrb-summary-h', sumH + 'px');#}
{##}
{#    // Centre sur la zone canvas (builder total - palette)#}
{#    const bRect = builder.getBoundingClientRect();#}
{#    const pRect = palette ? palette.getBoundingClientRect() : { width:0, left:bRect.right };#}
{#    const usableWidth = (pRect.left - bRect.left) - 32; // marge#}
{#    const centerX = bRect.left + usableWidth/2;#}
{#    panel.style.left = centerX + 'px';#}
{#    panel.style.transform = 'translateX(-50%)';#}
{#  }#}
{##}
{#  function showRelationTypesPanel(){#}
{#    const panel = document.getElementById('relation-types-panel');#}
{#    panel.classList.add('show');#}
{#    centerRelationPanel();#}
{#  }#}
{#  function hideRelationTypesPanel(){ document.getElementById('relation-types-panel').classList.remove('show'); }#}
{##}
{#  /* ========= Description par l’utilisateur ========= */#}
{#  function wireDescriptionDialog(){#}
{#    const dlg = document.getElementById('rel-desc-dialog');#}
{#    const bg  = document.getElementById('rel-desc-backdrop');#}
{#    const ok  = document.getElementById('rel-desc-ok');#}
{#    const ai  = document.getElementById('rel-desc-ai');#}
{#    const cancel = document.getElementById('rel-desc-cancel');#}
{#    ok.onclick = () => {#}
{#      const txt = (document.getElementById('rel-desc-text').value || '').trim();#}
{#      if (pendingRelation) pendingRelation.description = txt || undefined;#}
{#      closeDescriptionDialog(true);#}
{#      finalizeCreateRelation();#}
{#    };#}
{#    // Dans wireDescriptionDialog(), remplacer le bouton "Laisser l'IA" par :#}
{#ai.onclick = async () => {#}
{#  if (!pendingRelation) return;#}
{##}
{#  // Générer immédiatement la description via l'IA#}
{#  ai.disabled = true;#}
{#  ai.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';#}
{##}
{#  try {#}
{#    const aiDescription = await generateSingleRelationDescription(pendingRelation);#}
{#    if (aiDescription) {#}
{#      document.getElementById('rel-desc-text').value = aiDescription;#}
{#      notify('Description générée par l\'IA', 'success');#}
{#    } else {#}
{#      // Fallback : laisser l'IA générer à la sauvegarde#}
{#      pendingRelation.description = undefined;#}
{#      closeDescriptionDialog(true);#}
{#      finalizeCreateRelation();#}
{#    }#}
{#  } catch (e) {#}
{#    console.warn('Erreur génération IA:', e);#}
{#    pendingRelation.description = undefined;#}
{#    closeDescriptionDialog(true);#}
{#    finalizeCreateRelation();#}
{#  } finally {#}
{#    ai.disabled = false;#}
{#    ai.innerHTML = '<i class="fas fa-magic"></i> Laisser l\'IA';#}
{#  }#}
{#};#}
{#    cancel.onclick = () => { pendingRelation = null; closeDescriptionDialog(false); clearConnectionState(); };#}
{#    bg.onclick = cancel.onclick;#}
{#  }#}
{##}
{#  // Ajouter cette nouvelle fonction#}
{#async function generateSingleRelationDescription(relation) {#}
{#  try {#}
{#    const response = await fetch(`/expert/annotation/document/{{ document.id }}/describe-relation/`, {#}
{#      method: 'POST',#}
{#      headers: {#}
{#        'X-CSRFToken': getCookie('csrftoken'),#}
{#        'Content-Type': 'application/json'#}
{#      },#}
{#      body: JSON.stringify({#}
{#        source_type: relation.source.type,#}
{#        source_value: relation.source.value,#}
{#        relation_type: relation.type,#}
{#        target_type: relation.target.type,#}
{#        target_value: relation.target.value,#}
{#        context: 'visual_builder'#}
{#      })#}
{#    });#}
{##}
{#    if (response.ok) {#}
{#      const data = await response.json();#}
{#      return data.success ? data.description : null;#}
{#    }#}
{#  } catch (e) {#}
{#    console.warn('Erreur API description:', e);#}
{#  }#}
{#  return null;#}
{#}#}
{##}
{#  function openDescriptionDialog(relType){#}
{#    if (!connectionState.from || !connectionState.to) return;#}
{#    pendingRelation = { id: genId(), source: connectionState.from, target: connectionState.to, type: relType, description: undefined };#}
{#    const dlg = document.getElementById('rel-desc-dialog');#}
{#    const bg  = document.getElementById('rel-desc-backdrop');#}
{#    const ctx = document.getElementById('rel-desc-context');#}
{#    const txt = document.getElementById('rel-desc-text');#}
{#    ctx.textContent = `${connectionState.from.value} — ${(RELATION_LABELS[relType]||relType).replace(/_/g,' ')} — ${connectionState.to.value}`;#}
{#    txt.value = '';#}
{#    dlg.classList.add('show'); bg.classList.add('show');#}
{#  }#}
{#  function closeDescriptionDialog(){#}
{#    document.getElementById('rel-desc-dialog').classList.remove('show');#}
{#    document.getElementById('rel-desc-backdrop').classList.remove('show');#}
{#  }#}
{#  function finalizeCreateRelation(){#}
{#    if (!pendingRelation) return;#}
{#    canvasRelations.push(pendingRelation);#}
{#    clearConnectionState();#}
{#    renderConnections();#}
{#    updateRelationsSummary();#}
{#    const verb = (RELATION_LABELS[pendingRelation.type]||pendingRelation.type).replace(/_/g,' ');#}
{#    notify(`Relation « ${verb} » créée`, 'success');#}
{#    pendingRelation = null;#}
{#  }#}
{##}
{#  function clearConnectionState() {#}
{#    document.querySelectorAll('.canvas-entity').forEach(el => el.classList.remove('connecting'));#}
{#    connectionState = { from: null, to: null };#}
{#  }#}
{##}
{#  /* =================== Rendu des connexions =================== */#}
{#  function clearSVGExceptDefs(svg) {#}
{#    Array.from(svg.childNodes).forEach(n => {#}
{#      if (!(n.nodeName && n.nodeName.toLowerCase() === 'defs')) svg.removeChild(n);#}
{#    });#}
{#  }#}
{##}
{#  function renderConnections() {#}
{#    const svg = document.getElementById('connection-svg');#}
{#    if (!svg) return;#}
{#    clearSVGExceptDefs(svg);#}
{##}
{#    canvasRelations.forEach(relation => {#}
{#      const sEl = document.getElementById(relation.source.id);#}
{#      const tEl = document.getElementById(relation.target.id);#}
{#      if (!(sEl && tEl)) return;#}
{##}
{#      const sRect = sEl.getBoundingClientRect();#}
{#      const tRect = tEl.getBoundingClientRect();#}
{#      const svgRect = svg.getBoundingClientRect();#}
{##}
{#      const startX = sRect.right - svgRect.left;#}
{#      const startY = sRect.top + sRect.height/2 - svgRect.top;#}
{#      const endX   = tRect.left  - svgRect.left;#}
{#      const endY   = tRect.top + tRect.height/2 - svgRect.top;#}
{##}
{#      const c1x = startX + (endX - startX) * 0.5;#}
{#      const c1y = startY;#}
{#      const c2x = startX + (endX - startX) * 0.5;#}
{#      const c2y = endY;#}
{##}
{#      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');#}
{#      path.setAttribute('d', `M ${startX} ${startY} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${endX} ${endY}`);#}
{#      path.setAttribute('stroke', 'var(--pharma-accent)');#}
{#      path.setAttribute('stroke-width', '3');#}
{#      path.setAttribute('fill', 'none');#}
{#      path.setAttribute('marker-end', 'url(#arrowhead)');#}
{#      path.style.filter = 'drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3))';#}
{#      svg.appendChild(path);#}
{##}
{#      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');#}
{#      label.setAttribute('x', (startX + endX)/2);#}
{#      label.setAttribute('y', (startY + endY)/2 - 10);#}
{#      label.setAttribute('text-anchor', 'middle');#}
{#      label.setAttribute('fill', 'var(--pharma-text)');#}
{#      label.setAttribute('font-size', '12');#}
{#      label.setAttribute('font-weight', '600');#}
{#      label.textContent = (RELATION_LABELS[relation.type] || relation.type).replace(/_/g,' ');#}
{#      svg.appendChild(label);#}
{#    });#}
{#  }#}
{##}
{#  // Dans updateRelationsSummary(), améliorer l'affichage :#}
{#function updateRelationsSummary() {#}
{#  document.getElementById('relations-count').textContent = canvasRelations.length;#}
{#  const preview = document.getElementById('relations-preview');#}
{#  preview.innerHTML = canvasRelations.map((rel, idx) => {#}
{#    const t = (RELATION_LABELS[rel.type]||rel.type).replace(/_/g,' ');#}
{##}
{#    // Meilleur feedback selon le statut de la description#}
{#    let descIcon, descTitle;#}
{#    if (rel.description) {#}
{#      descIcon = '✏️';#}
{#      descTitle = `Description fournie: "${rel.description.substring(0, 50)}..."`;#}
{#    } else {#}
{#      descIcon = '🤖';#}
{#      descTitle = 'Description sera générée automatiquement par l\'IA lors de la sauvegarde';#}
{#    }#}
{##}
{#    return `<div class="relation-preview-item" data-index="${idx}">#}
{#              <span>${rel.source.value} → ${t} → ${rel.target.value}</span>#}
{#              <span title="${descTitle}">${descIcon}</span>#}
{#              <span class="edit" title="Modifier la description" onclick="editRelationDescription(${idx})">#}
{#                <i class="fas fa-pen"></i>#}
{#              </span>#}
{#            </div>`;#}
{#  }).join('');#}
{#}#}
{#  window.editRelationDescription = function(idx){#}
{#    const rel = canvasRelations[idx]; if(!rel) return;#}
{#    connectionState = {from: rel.source, to: rel.target};#}
{#    openDescriptionDialog(rel.type);#}
{#    document.getElementById('rel-desc-text').value = rel.description || '';#}
{#    // à la validation, finalizeCreateRelation ajouterait une nouvelle relation : on remplace plutôt#}
{#    const okBtn = document.getElementById('rel-desc-ok');#}
{#    const aiBtn = document.getElementById('rel-desc-ai');#}
{#    const origOk = okBtn.onclick, origAi = aiBtn.onclick;#}
{#    okBtn.onclick = () => {#}
{#      const txt = (document.getElementById('rel-desc-text').value || '').trim();#}
{#      rel.description = txt || undefined;#}
{#      closeDescriptionDialog(true); clearConnectionState();#}
{#      updateRelationsSummary();#}
{#      notify('Description mise à jour', 'success');#}
{#      okBtn.onclick = origOk; aiBtn.onclick = origAi;#}
{#    };#}
{#    aiBtn.onclick = () => {#}
{#      rel.description = undefined;#}
{#      closeDescriptionDialog(true); clearConnectionState();#}
{#      updateRelationsSummary();#}
{#      notify('Cette relation sera décrite par l’IA à la sauvegarde', 'info');#}
{#      okBtn.onclick = origOk; aiBtn.onclick = origAi;#}
{#    };#}
{#  };#}
{##}
{#  /* =================== Sauvegarde relations =================== */#}
{#  // Remplacer getAIDescriptionsForRelations par :#}
{#async function getAIDescriptionsForRelations(relations) {#}
{#  try {#}
{#    const r = await fetch(`/expert/annotation/document/{{ document.id }}/describe-relations-batch/`, {#}
{#      method: 'POST',#}
{#      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#      body: JSON.stringify({#}
{#        relations: relations.map(rel => ({#}
{#          source_type: rel.source.type,#}
{#          source_value: rel.source.value,#}
{#          target_type: rel.target.type,#}
{#          target_value: rel.target.value,#}
{#          relation_type: rel.type#}
{#        })),#}
{#        context: 'visual_builder_batch'#}
{#      })#}
{#    });#}
{##}
{#    if (r.ok) {#}
{#      const data = await r.json();#}
{#      if (data.success && Array.isArray(data.descriptions)) {#}
{#        return data.descriptions;#}
{#      }#}
{#    }#}
{#  } catch (e) {#}
{#    console.warn('Batch description API indisponible:', e);#}
{#  }#}
{##}
{#  // Fallback : génération individuelle#}
{#  const descriptions = [];#}
{#  for (const rel of relations) {#}
{#    const desc = await generateSingleRelationDescription(rel);#}
{#    descriptions.push(desc || simpleAutodescribe(rel));#}
{#  }#}
{#  return descriptions;#}
{#}#}
{##}
{#  function simpleAutodescribe(rel) {#}
{#    const verb = RELATION_LABELS[rel.type] || rel.type.replace(/_/g, ' ');#}
{#    return `${rel.source.value} ${verb} ${rel.target.value}.`;#}
{#  }#}
{##}
{#  async function postBatchRelations(relationsPayload) {#}
{#    const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-relations-batch/`, {#}
{#      method: 'POST',#}
{#      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#      body: JSON.stringify({ relations: relationsPayload, write_to_enriched: true, origin: 'visual_builder' })#}
{#    });#}
{#    return res;#}
{#  }#}
{##}
{#  async function postOneByOne(relationsPayload) {#}
{#    let ok = 0, errors = [];#}
{#    for (const rel of relationsPayload) {#}
{#      try {#}
{#        const r = await fetch(`/expert/annotation/document/{{ document.id }}/add-relation/`, {#}
{#          method: 'POST',#}
{#          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#          body: JSON.stringify({#}
{#            source_type: rel.source_type, source_value: rel.source_value,#}
{#            target_type: rel.target_type, target_value: rel.target_value,#}
{#            relation_type: rel.relation_type, description: rel.description,#}
{#            write_to_enriched: true, origin: 'visual_builder'#}
{#          })#}
{#        });#}
{#        const data = await r.json();#}
{#        if (r.ok && data.success) ok++; else errors.push(data.error || 'Erreur inconnue');#}
{#      } catch (e) { errors.push(e.message); }#}
{#    }#}
{#    return { ok, errors };#}
{#  }#}
{##}
{#  window.saveAllRelations = async function saveAllRelations() {#}
{#    if (canvasRelations.length === 0) { notify('Aucune relation à sauvegarder', 'warning'); return; }#}
{##}
{#    // 1) Préparer la liste de celles qui manquent de description#}
{#    const needAI = canvasRelations#}
{#      .map((r, i) => ({ r, i }))#}
{#      .filter(x => !x.r.description)#}
{#      .map(x => x.r);#}
{##}
{#    let aiDescriptions = [];#}
{#    if (needAI.length) {#}
{#      notify('Génération des descriptions manquantes…', 'info');#}
{#      aiDescriptions = await getAIDescriptionsForRelations(needAI);#}
{#    }#}
{##}
{#    // 2) construire le payload en fusionnant#}
{#    let aiIdx = 0;#}
{#    const relationsPayload = canvasRelations.map(rel => {#}
{#      const desc = rel.description || aiDescriptions[aiIdx++] || simpleAutodescribe(rel);#}
{#      if (!rel.description) rel.description = desc;#}
{#      return {#}
{#        source_type: rel.source.type,#}
{#        source_value: rel.source.value,#}
{#        target_type: rel.target.type,#}
{#        target_value: rel.target.value,#}
{#        relation_type: rel.type,#}
{#        description: desc#}
{#      };#}
{#    });#}
{##}
{#    // 3) batch si possible#}
{#    try {#}
{#      notify('Sauvegarde des relations…', 'info');#}
{#      const res = await postBatchRelations(relationsPayload);#}
{#      if (res.status === 404) {#}
{#        const { ok, errors } = await postOneByOne(relationsPayload);#}
{#        if (ok > 0 && errors.length === 0) {#}
{#          notify(`✅ ${ok} relations sauvegardées`, 'success');#}
{#          hideModal('visual-relation-modal'); setTimeout(() => location.reload(), 800);#}
{#        } else if (ok > 0) {#}
{#          notify(`⚠️ ${ok} relations sauvegardées, ${errors.length} échecs`, 'error');#}
{#        } else {#}
{#          notify('❌ Impossible d’enregistrer les relations', 'error');#}
{#        }#}
{#        return;#}
{#      }#}
{##}
{#      const data = await res.json();#}
{#      if (res.ok && data.success) {#}
{#        notify(`✅ ${relationsPayload.length} relations sauvegardées`, 'success');#}
{#        hideModal('visual-relation-modal'); setTimeout(() => location.reload(), 900);#}
{#      } else {#}
{#        notify('❌ ' + (data.error || 'Erreur inconnue lors de la sauvegarde'), 'error');#}
{#      }#}
{#    } catch (e) {#}
{#      notify('❌ ' + e.message, 'error');#}
{#    }#}
{#  };#}
{##}
{#  /* =================== Actions principales =================== */#}
{#  async function enrichDocumentJSON(force = false) {#}
{#    notify('Enrichissement en cours…', 'info');#}
{#    try {#}
{#      const url = `/expert/annotation/document/{{ document.id }}/enrich-json/` + (force ? `?force=1` : ``);#}
{#      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' } });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify(`✅ JSON enrichi. ${data.relations_count} relations, ${data.qa_pairs_count} Q&A.`, 'success'); setTimeout(() => location.reload(), 900); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.enrichDocumentJSON = enrichDocumentJSON;#}
{#  window.regenerateEnrichment = () => enrichDocumentJSON(true);#}
{##}
{#  async function saveJSONChanges() {#}
{#    if (!enrichedEditor) { notify('Aucun éditeur enrichi', 'error'); return; }#}
{#    try {#}
{#      const payload = JSON.parse(enrichedEditor.getValue());#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/save-enriched-edits/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ manual_edits: payload })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) notify('✅ Modifications sauvegardées', 'success');#}
{#      else notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');#}
{#    } catch (e) { notify('❌ JSON invalide : ' + e.message, 'error'); }#}
{#  }#}
{#  window.saveJSONChanges = saveJSONChanges;#}
{##}
{#  async function addQAPair() {#}
{#    const q = (document.getElementById('qa-question') || {}).value?.trim();#}
{#    const a = (document.getElementById('qa-answer')   || {}).value?.trim();#}
{#    const tags = (document.getElementById('qa-tags')   || {}).value?.split(',').map(s => s.trim()).filter(Boolean) || [];#}
{#    if (!q || !a) { alert('Question et réponse requises'); return; }#}
{#    try {#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-qa/`, {#}
{#        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },#}
{#        body: JSON.stringify({ question: q, answer: a, tags, entity_refs: [] })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify('✅ Q&A ajoutée', 'success'); hideModal('add-qa-modal'); setTimeout(() => location.reload(), 700); }#}
{#      else notify('❌ ' + data.error, 'error');#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addQAPair = addQAPair;#}
{##}
{#  async function testQASystem() {#}
{#    const qEl = document.getElementById('test-question');#}
{#    const resEl = document.getElementById('qa-test-result');#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const source = (document.querySelector('input[name="qa-source"]:checked') || {}).value || 'enriched';#}
{#    const question = (qEl && qEl.value || '').trim();#}
{#    if (!question) { alert('Veuillez saisir une question'); return; }#}
{##}
{#    resEl.style.display = 'block';#}
{#    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche de la réponse...';#}
{#    corrBox.style.display = 'none';#}
{##}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/test-qa/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question, source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) {#}
{#        const conf = data.confidence || 0;#}
{#        const color = conf > 0.8 ? '#10b981' : (conf > 0.5 ? '#f59e0b' : '#64748b');#}
{#        resEl.innerHTML =#}
{#          `<div style="display:flex;align-items:flex-start;gap:1rem;">#}
{#            <div style="flex:1;">#}
{#              <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b;"><i class="fas fa-robot"></i> Réponse (${source}) :</div>#}
{#              <div id="qa-answer-text" style="color:#64748b;line-height:1.6;">${data.answer}</div>#}
{#            </div>#}
{#            <div style="background:${color};color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:600;white-space:nowrap;">#}
{#              ${Math.round(conf*100)}% confiance#}
{#            </div>#}
{#          </div>#}
{#          ${data.answer_type === 'no_match' ? `<div style="margin-top:1rem;padding:1rem;background:rgba(245,158,11,.1);border-radius:8px;border-left:4px solid #f59e0b;"><strong>💡 Suggestion :</strong> ${data.suggestion || ''}</div>` : ''}#}
{#          <div style="margin-top:.75rem;text-align:right;">#}
{#            <button class="enrichment-btn secondary" onclick="openCorrection('${source}')"><i class="fas fa-edit"></i> Corriger cette réponse</button>#}
{#          </div>`;#}
{#        window.__lastQA__ = { question, source, answer: data.answer };#}
{#      } else {#}
{#        resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;#}
{#      }#}
{#    } catch (e) {#}
{#           resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-times-circle"></i> Erreur: ${e.message}</div>`;#}
{#    }#}
{#  }#}
{#  window.testQASystem = testQASystem;#}
{##}
{#  function openCorrection() {#}
{#    const corrBox = document.getElementById('qa-correction');#}
{#    const ta = document.getElementById('qa-corrected');#}
{#    const ans = (window.__lastQA__ || {}).answer || '';#}
{#    if (ta) ta.value = ans;#}
{#    corrBox.style.display = 'block';#}
{#  }#}
{#  window.openCorrection = openCorrection;#}
{##}
{#  async function sendQACorrection() {#}
{#    const ctx = window.__lastQA__ || {};#}
{#    const corrected = (document.getElementById('qa-corrected') || {}).value?.trim();#}
{#    if (!ctx.question || !corrected) { alert('Question ou correction manquante.'); return; }#}
{#    try {#}
{#      const r = await fetch(`/expert/annotation/document/{{ document.id }}/qa-feedback/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ question: ctx.question, corrected_answer: corrected, source: ctx.source })#}
{#      });#}
{#      const data = await r.json();#}
{#      if (data.success) { notify('✅ Correction enregistrée. Merci !', 'success'); document.getElementById('qa-correction').style.display = 'none'; loadLearningStats(); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.sendQACorrection = sendQACorrection;#}
{##}
{#  /* =================== Apprentissage =================== */#}
{#  async function loadLearningStats() {#}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/learning-history/`);#}
{#      const data = await response.json();#}
{#      if (data.success) {#}
{#        document.getElementById('corrections-count').textContent = data.history.total_corrections || 0;#}
{#        document.getElementById('relations-improved').textContent = data.history.history?.filter(h => h.type.includes('relation')).length || 0;#}
{#        document.getElementById('qa-improved').textContent = data.history.history?.filter(h => h.type.includes('Q&A')).length || 0;#}
{#        document.getElementById('patterns-reused').textContent = data.history.history?.reduce((sum, h) => sum + (h.reused_count || 0), 0) || 0;#}
{#      }#}
{#    } catch (e) { console.warn('Could not load learning stats:', e); }#}
{#  }#}
{##}
{#  async function compareWithFreshAI() {#}
{#    const btn = document.querySelector('button[onclick="compareWithFreshAI()"]');#}
{#    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Comparaison...';#}
{#    try {#}
{#      const expertJson = enrichedEditor ? JSON.parse(enrichedEditor.getValue()) : ENRICHED;#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/compare-and-learn/`, {#}
{#        method: 'POST',#}
{#        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ expert_json: expertJson, context: { document_title: "{{ document.title }}", doc_type: "{{ document.doc_type }}" } })#}
{#      });#}
{#      const data = await response.json();#}
{#      if (data.success) { notify(`✅ ${data.message}`, 'success'); displayComparisonResults(data.comparison); loadLearningStats(); }#}
{#      else { notify(`❌ ${data.error}`, 'error'); }#}
{#    } catch (e) { notify('❌ Erreur lors de la comparaison', 'error'); }#}
{#    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-balance-scale"></i>Comparer avec IA'; }#}
{#  }#}
{#  window.compareWithFreshAI = compareWithFreshAI;#}
{##}
{#  async function regenerateWithLearning() {#}
{#    const btn = document.querySelector('button[onclick="regenerateWithLearning()"]');#}
{#    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Régénération...';#}
{#    try {#}
{#      const response = await fetch(`/expert/document/{{ document.id }}/regenerate-with-learning/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });#}
{#      const data = await response.json();#}
{#      if (data.success) { notify(data.message, 'success'); setTimeout(() => location.reload(), 1500); }#}
{#      else { notify(data.error, 'error'); }#}
{#    } catch (e) { notify('❌ Erreur lors de la régénération', 'error'); }#}
{#    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i>Régénérer +Apprentissage'; }#}
{#  }#}
{#  window.regenerateWithLearning = regenerateWithLearning;#}
{##}
{#  function viewDetailedHistory() { window.open(`/expert/document/{{ document.id }}/view-expert-deltas/`, '_blank'); }#}
{#  window.viewDetailedHistory = viewDetailedHistory;#}
{##}
{#  function displayComparisonResults(comparison) {#}
{#    const container = document.getElementById('comparison-cards-container');#}
{#    const resultsSection = document.getElementById('comparison-results');#}
{#    if (!comparison || !comparison.summary) return;#}
{#    let html = '';#}
{#    const summary = comparison.summary;#}
{##}
{#    if (summary.key_improvements?.length) {#}
{#      html += '<div style="margin-bottom:1rem">';#}
{#      summary.key_improvements.forEach(improvement => {#}
{#        html += `<div class="comparison-card"><div class="delta-header"><span class="delta-type-badge delta-type-relation_added">Amélioration détectée</span></div><div style="padding:1rem"><div class="description-text">${improvement}</div></div></div>`;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{#    if (summary.changes_by_type) {#}
{#      html += '<div class="learning-stats">';#}
{#      Object.entries(summary.changes_by_type).forEach(([type, count]) => {#}
{#        const label = type.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());#}
{#        html += `<div class="learning-stat"><div class="learning-stat-value">${count}</div><div class="learning-stat-label">${label}</div></div>`;#}
{#      });#}
{#      html += '</div>';#}
{#    }#}
{#    container.innerHTML = html;#}
{#    resultsSection.style.display = 'block';#}
{#  }#}
{##}
{#  /* =================== Modales =================== */#}
{#  function showModal(id){ const m = document.getElementById(id); if (m) m.classList.add('show'); }#}
{#  function hideModal(id){#}
{#    const m = document.getElementById(id); if (m) m.classList.remove('show');#}
{#    if (id === 'visual-relation-modal') { clearConnectionState(); hideRelationTypesPanel(); }#}
{#  }#}
{#  window.showModal = showModal;#}
{#  window.hideModal = hideModal;#}
{#  window.showAddQAModal = () => showModal('add-qa-modal');#}
{#  window.showAddTextModal = () => showModal('add-text-modal');#}
{##}
{#  document.addEventListener('click', e => {#}
{#    if (e.target.classList?.contains('semantic-modal')) e.target.classList.remove('show');#}
{#  });#}
{##}
{#  /* =================== Paragraphe =================== */#}
{#  async function addFromParagraph() {#}
{#    const text = (document.getElementById('free-text') || {}).value?.trim();#}
{#    const hint = (document.getElementById('free-text-hint') || {}).value?.trim();#}
{#    if (!text) { alert('Collez un paragraphe.'); return; }#}
{#    try {#}
{#      notify('Analyse du paragraphe...', 'info');#}
{#      const res = await fetch(`/expert/annotation/document/{{ document.id }}/from-paragraph/`, {#}
{#        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },#}
{#        body: JSON.stringify({ text, hint })#}
{#      });#}
{#      const data = await res.json();#}
{#      if (data.success) { notify(`✅ Ajouté: ${data.added_relations} relations, ${data.added_entities} entités.`, 'success'); hideModal('add-text-modal'); setTimeout(() => location.reload(), 800); }#}
{#      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }#}
{#    } catch (e) { notify('❌ ' + e.message, 'error'); }#}
{#  }#}
{#  window.addFromParagraph = addFromParagraph;#}
{##}
{#  /* ======= Layout & plein écran ======= */#}
{#  function resizeVisualBuilder(){#}
{#    const modal   = document.getElementById('visual-relation-modal');#}
{#    if(!modal || !modal.classList.contains('show')) return;#}
{##}
{#    const content = modal.querySelector('.modal-content-semantic');#}
{#    const header  = content.querySelector('.modal-header-semantic');#}
{#    const body    = content.querySelector('.modal-body-semantic');#}
{#    const builder = body.querySelector('.visual-relation-builder');#}
{#    const toolbar = builder.querySelector('.builder-toolbar');#}
{#    const summary = builder.querySelector('.relations-summary');#}
{#    const canvas  = document.getElementById('visual-canvas');#}
{##}
{#    const bodyH = content.clientHeight - header.offsetHeight;#}
{#    body.style.height = bodyH + 'px';#}
{##}
{#    const canvasH = Math.max(360, bodyH - toolbar.offsetHeight - summary.offsetHeight - 16);#}
{#    canvas.style.height = canvasH + 'px';#}
{##}
{#    // Met à jour la variable CSS pour la position du panel#}
{#    builder.style.setProperty('--vrb-summary-h', summary.offsetHeight + 'px');#}
{##}
{#    // Repositionne le panel et redessine les courbes#}
{#    centerRelationPanel();#}
{#    requestAnimationFrame(() => { try { renderConnections && renderConnections(); } catch(_){} });#}
{#  }#}
{#  window.resizeVisualBuilder = resizeVisualBuilder;#}
{##}
{#  function toggleVRBFullscreen(){#}
{#    const modal   = document.getElementById('visual-relation-modal');#}
{#    const content = modal.querySelector('.modal-content-semantic');#}
{#    const btn     = document.getElementById('vrb-fullscreen-btn');#}
{#    content.classList.toggle('fullscreen');#}
{#    if(btn){#}
{#      const isFS = content.classList.contains('fullscreen');#}
{#      btn.innerHTML = isFS ? '<i class="fas fa-compress"></i> Réduire' : '<i class="fas fa-expand"></i> Plein écran';#}
{#    }#}
{#    setTimeout(resizeVisualBuilder, 50);#}
{#  }#}
{#  window.toggleVRBFullscreen = toggleVRBFullscreen;#}
{##}
{#  window.addEventListener('resize', () => resizeVisualBuilder());#}
{#  const _oldShowVRB = window.showVisualRelationBuilder;#}
{#  window.showVisualRelationBuilder = function(){#}
{#    _oldShowVRB();#}
{#    setTimeout(resizeVisualBuilder, 150);#}
{#  };#}
{##}
{#  /* ======= Fonctions utilitaires pour le builder ======= */#}
{#  window.clearCanvas = function() {#}
{#    if (confirm('Voulez-vous vraiment effacer toutes les relations et entités du canvas?')) {#}
{#      canvasEntities = [];#}
{#      canvasRelations = [];#}
{#      document.getElementById('visual-canvas').innerHTML = '<svg class="connection-svg" id="connection-svg" preserveAspectRatio="none"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" /></marker></defs></svg>';#}
{#      updateRelationsSummary();#}
{#      notify('Canvas effacé', 'info');#}
{#    }#}
{#  };#}
{##}
{#  window.autoArrange = function() {#}
{#    if (canvasEntities.length === 0) return;#}
{##}
{#    const canvas = document.getElementById('visual-canvas');#}
{#    const width = canvas.offsetWidth;#}
{#    const height = canvas.offsetHeight;#}
{##}
{#    // Simple arrangement circulaire#}
{#    const centerX = width / 2;#}
{#    const centerY = height / 2;#}
{#    const radius = Math.min(width, height) * 0.35;#}
{#    const angleStep = (2 * Math.PI) / canvasEntities.length;#}
{##}
{#    canvasEntities.forEach((entity, index) => {#}
{#      const angle = index * angleStep;#}
{#      entity.x = centerX + radius * Math.cos(angle) - 60; // Ajustement pour centrer l'entité#}
{#      entity.y = centerY + radius * Math.sin(angle) - 25;#}
{##}
{#      const element = document.getElementById(entity.id);#}
{#      if (element) {#}
{#        element.style.left = entity.x + 'px';#}
{#        element.style.top = entity.y + 'px';#}
{#      }#}
{#    });#}
{##}
{#    renderConnections();#}
{#    notify('Entités arrangées automatiquement', 'success');#}
{#  };#}
{#})();#}
{#</script>#}
{##}
{#{% endblock %}#}



{# template/expert/view_document_json_enriched.html #}
{% extends "base.html" %}
{% load static %}
{% load expert_extras %}
{% block title %}JSON Sémantique Expert - {{ document.title }} – RegExpert{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>

{# --- JSON DATA SAFE PASSING --- #}
{{ global_annotations_json|json_script:"basic-json-data" }}
{{ enriched_annotations_json|default:"{}"|json_script:"enriched-json-data" }}
{{ display_json|default:"{}"|json_script:"display-json-data" }}

<style>
:root{
  --pharma-primary:#3b82f6;--pharma-accent:#10b981;--pharma-info:#06b6d4;
  --pharma-success:#059669;--pharma-warning:#f59e0b;
  --pharma-bg-card:#fff;--pharma-bg:#f8fafc;--pharma-text:#1e293b;--pharma-text-soft:#64748b;
  --pharma-border:#e2e8f0;--pharma-radius:12px;--pharma-radius-sm:8px;--pharma-shadow:0 4px 16px rgba(15,23,42,.08);
  --pharma-transition:.3s cubic-bezier(.4,0,.2,1);
  --ai-color:#3b82f6;--expert-color:#10b981;--diff-bg:#f8fafc;--improvement-bg:#ecfdf5;--correction-bg:#fef2f2;
}
body{background:var(--pharma-bg);color:var(--pharma-text);font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif}

/* Tabs */
.mode-tabs{display:flex;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:var(--pharma-radius);padding:.75rem;margin-bottom:2rem;box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border)}
.mode-tab{flex:1;padding:1rem 1.5rem;text-align:center;border-radius:var(--pharma-radius-sm);background:transparent;border:1px solid transparent;color:var(--pharma-text-soft);cursor:pointer;transition:var(--pharma-transition);font-weight:600;display:flex;align-items:center;justify-content:center;gap:.5rem}
.mode-tab:hover{background:rgba(59,130,246,.1);color:var(--pharma-primary)}
.mode-tab.active{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;border-color:var(--pharma-primary);box-shadow:0 4px 12px rgba(59,130,246,.3)}

/* Cards */
.semantic-card{background:var(--pharma-bg-card);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);margin-bottom:1.5rem;overflow:hidden;transition:var(--pharma-transition)}
.semantic-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(15,23,42,.12)}
.semantic-card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));padding:1.5rem;border-bottom:1px solid var(--pharma-border)}
.semantic-card-header h3{font-size:1.25rem;font-weight:600;color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.75rem}
.semantic-card-body{padding:1.5rem}

/* Relations list */
.relations-container{display:flex;flex-direction:column;gap:1rem}
.relation-item{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));border:1px solid rgba(59,130,246,.2);border-radius:var(--pharma-radius-sm);padding:1rem;display:flex;align-items:center;gap:1rem;transition:var(--pharma-transition);flex-wrap:wrap}
.relation-item:hover{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(16,185,129,.1));border-color:var(--pharma-primary)}
.entity-node{background:var(--pharma-primary);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.9rem;font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative}
.entity-node:hover{max-width:none;white-space:normal;word-break:break-word;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.15)}
.relation-arrow{color:var(--pharma-accent);font-size:1.2rem;font-weight:bold}
.relation-type{background:var(--pharma-accent);color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:500;white-space:nowrap}

/* Q&A */
.qa-container{display:flex;flex-direction:column;gap:1rem}
.qa-item{background:linear-gradient(135deg,rgba(6,182,212,.05),rgba(139,92,246,.05));border:1px solid rgba(6,182,212,.2);border-radius:var(--pharma-radius-sm);padding:1.5rem}
.qa-question{font-weight:600;color:var(--pharma-text);margin-bottom:.75rem;display:flex;gap:.5rem}
.qa-question::before{content:"Q:";color:var(--pharma-info);font-weight:700}
.qa-answer{color:var(--pharma-text-soft);line-height:1.6;margin-left:1.75rem;display:flex;gap:.5rem}
.qa-answer::before{content:"R:";color:var(--pharma-accent);font-weight:700}

/* QA test */
.qa-test-interface{background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));border:1px solid rgba(245,158,11,.3);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}
.qa-input-group{display:flex;gap:1rem;align-items:flex-end;margin-bottom:1rem}
.qa-input{flex:1;padding:.75rem 1rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);font-size:1rem}
.qa-input:focus{outline:none;border-color:var(--pharma-warning);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
.qa-test-btn{padding:.75rem 1.5rem;background:var(--pharma-warning);color:#fff;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem}
.qa-test-btn:hover{background:#d97706;transform:translateY(-1px)}
.qa-result{background:#fff;border-radius:8px;padding:1rem;border-left:4px solid var(--pharma-success);margin-top:1rem;display:none}

/* JSON panels */
.json-comparison{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}
.json-panel{background:#fff;border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);border:1px solid var(--pharma-border);padding:1.5rem}
.json-panel h4{font-size:1.1rem;font-weight:600;margin-bottom:1rem;color:var(--pharma-text);display:flex;align-items:center;gap:.5rem}

/* Learning Section */
.learning-section{background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(59,130,246,.05));border:2px solid var(--pharma-accent);border-radius:var(--pharma-radius);padding:1.5rem;margin-bottom:2rem}
.learning-header{display:flex;justify-content:between;align-items:center;margin-bottom:1.5rem}
.learning-header h4{color:var(--pharma-text);margin:0;display:flex;align-items:center;gap:.5rem}
.learning-actions{display:flex;gap:.75rem;flex-wrap:wrap}
.learning-btn{padding:.5rem 1rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.4rem;align-items:center;transition:var(--pharma-transition)}
.learning-btn.primary{background:linear-gradient(135deg,var(--expert-color),#059669);color:#fff}
.learning-btn.secondary{background:var(--pharma-text-soft);color:#fff}
.learning-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}

/* Comparison cards */
.comparison-card{border-radius:12px;box-shadow:0 4px 16px rgba(15,23,42,.08);margin-bottom:1rem;overflow:hidden;background:white;position:relative}
.delta-header{background:linear-gradient(135deg,var(--diff-bg),#e2e8f0);padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.delta-type-badge{padding:.4rem 1rem;border-radius:20px;font-size:.85rem;font-weight:600}
.delta-type-relation_added{background:var(--improvement-bg);color:var(--expert-color)}
.delta-type-relation_modified{background:#fef3c7;color:#d97706}
.delta-type-qa_added{background:var(--improvement-bg);color:var(--expert-color)}
.delta-type-qa_corrected{background:#fef3c7;color:#d97706}
.version-comparison{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem}
.ai-version,.expert-version{padding:1rem;border-radius:8px;border:2px solid}
.ai-version{border-color:var(--ai-color);background:rgba(59,130,246,.05)}
.expert-version{border-color:var(--expert-color);background:rgba(16,185,129,.05)}
.version-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;font-weight:600}
.ai-version .version-header{color:var(--ai-color)}
.expert-version .version-header{color:var(--expert-color)}
.relation-display{background:#f8fafc;padding:.75rem;border-radius:6px;font-family:'Courier New',monospace;margin-bottom:.5rem}
.description-text{font-style:italic;color:#64748b;margin-top:.5rem}
.improvement-indicator{position:absolute;top:-5px;right:-5px;background:var(--expert-color);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px}
.learning-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem}
.learning-stat{background:white;padding:1rem;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.learning-stat-value{font-size:1.5rem;font-weight:800;color:var(--expert-color);margin-bottom:.25rem}
.learning-stat-label{font-size:.8rem;color:var(--pharma-text-soft)}

/* Actions */
.enrichment-actions{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
.enrichment-btn{padding:.75rem 1.5rem;border:none;border-radius:var(--pharma-radius-sm);font-weight:600;cursor:pointer;display:flex;gap:.5rem;transition:var(--pharma-transition)}
.enrichment-btn.primary{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff}
.enrichment-btn.secondary{background:var(--pharma-text-soft);color:#fff}
.enrichment-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.15)}

/* ===== Modales (plein écran & corps fluide) ===== */
.semantic-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
.semantic-modal.show{display:flex;animation:fadeInModal .4s ease-out}
.modal-content-semantic{background:#fff;border-radius:var(--pharma-radius);box-shadow:0 25px 80px rgba(0,0,0,.4);width:98vw;max-width:98vw;height:92vh;max-height:92vh;overflow:hidden}
.modal-content-semantic.fullscreen{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0}
.modal-header-semantic{background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:1.25rem 1.75rem;display:flex;justify-content:space-between;align-items:center}
.modal-body-semantic{padding:0;height:calc(92vh - 64px);overflow:hidden}
.modal-content-semantic.fullscreen .modal-body-semantic{height:calc(100vh - 64px)}

/* ===== VRB en grille pleine hauteur ===== */
.visual-relation-builder{
  position:relative;background:linear-gradient(135deg,#f8fafc,#ffffff);
  border:2px solid var(--pharma-border);border-radius:var(--pharma-radius);
  height:100%;min-height:620px;overflow:hidden;
  display:grid;grid-template-rows:auto 1fr auto;
  padding-right:320px; /* réserve palette */
}

/* Barre d’outils */
.builder-toolbar{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(16,185,129,.05));padding:1rem 1.25rem;border-bottom:1px solid var(--pharma-border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.builder-modes{display:flex;gap:.5rem}
.mode-switch{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;transition:var(--pharma-transition);font-size:.9rem;display:flex;align-items:center;gap:.5rem}
.mode-switch.active{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}
.mode-switch:hover:not(.active){background:rgba(59,130,246,.1)}
.builder-actions{display:flex;gap:.75rem;align-items:center}
.builder-btn{padding:.5rem 1rem;border:1px solid var(--pharma-border);background:#fff;border-radius:var(--pharma-radius-sm);cursor:pointer;transition:var(--pharma-transition);font-size:.85rem;display:flex;align-items:center;gap:.4rem}
.builder-btn.primary{background:var(--pharma-primary);color:#fff;border-color:var(--pharma-primary)}
.builder-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}

/* Canvas */
.visual-canvas{position:relative;min-height:420px;height:auto;overflow:hidden}
.connection-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}

/* Entités */
.canvas-entity{position:absolute;background:linear-gradient(135deg,var(--pharma-primary),var(--pharma-accent));color:#fff;padding:.8rem 1.2rem;border-radius:25px;cursor:move;transition:var(--pharma-transition);box-shadow:0 4px 16px rgba(59,130,246,.3);z-index:10;min-width:120px;text-align:center;font-weight:600;font-size:.9rem;user-select:none;word-break:break-word}
.canvas-entity:hover{transform:scale(1.05);box-shadow:0 8px 24px rgba(59,130,246,.4)}
.canvas-entity.dragging{z-index:20;transform:scale(1.1);box-shadow:0 12px 32px rgba(59,130,246,.5)}
.canvas-entity.source{background:linear-gradient(135deg,#3b82f6,#6366f1)}
.canvas-entity.target{background:linear-gradient(135deg,#10b981,#059669)}
.canvas-entity.connecting{animation:pulse 1.5s infinite}

/* Points de connexion */
.connection-point{position:absolute;width:16px;height:16px;background:var(--pharma-accent);border:3px solid #fff;border-radius:50%;cursor:crosshair;transform:translate(-50%,-50%);transition:var(--pharma-transition);box-shadow:0 2px 8px rgba(16,185,129,.4)}
.connection-point:hover{transform:translate(-50%,-50%) scale(1.3);background:var(--pharma-warning)}
.connection-point.right{right:-8px;top:50%}
.connection-point.left{left:-8px;top:50%}

/* Palette */
.entity-palette{position:absolute;right:0;top:0;width:320px;height:100%;background:linear-gradient(180deg,#ffffff,#f8fafc);border-left:1px solid var(--pharma-border);padding:1rem;overflow-y:auto;z-index:15}
.entity-palette h4{font-size:1rem;font-weight:600;color:var(--pharma-text);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.entity-search{width:100%;padding:.75rem;border:2px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);margin-bottom:1rem;font-size:.9rem}
.entity-search:focus{outline:none;border-color:var(--pharma-primary);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
.entity-list{display:flex;flex-direction:column;gap:.5rem}
.entity-item{background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius-sm);padding:.75rem;cursor:grab;transition:var(--pharma-transition);display:flex;justify-content:space-between;align-items:center}
.entity-item:hover{border-color:var(--pharma-primary);transform:translateX(-2px);box-shadow:0 4px 12px rgba(59,130,246,.15)}
.entity-item:active{cursor:grabbing}
.entity-type-label{background:var(--pharma-primary);color:#fff;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:600}

/* Form création entité */
.create-entity-form{background:rgba(16,185,129,.05);border:1px dashed var(--pharma-accent);border-radius:var(--pharma-radius-sm);padding:1rem;margin-bottom:1rem}
.create-entity-input{width:100%;padding:.5rem;border:1px solid var(--pharma-border);border-radius:6px;margin-bottom:.5rem;font-size:.85rem}
.create-entity-btn{width:100%;padding:.5rem;background:var(--pharma-accent);color:#fff;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer}

/* Panel types de relation – visible et centré (grand écran) */
.relation-types-panel{
  position:absolute;bottom:calc(16px + var(--vrb-summary-h, 72px));
  left:50%;transform:translateX(-50%);
  background:#fff;border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);
  box-shadow:0 12px 36px rgba(0,0,0,.15);padding:1rem;display:none;z-index:1000;
  max-width:min(720px, calc(100% - 360px)); /* ne pas passer sous la palette */
}
.relation-types-panel.show{display:block;animation:slideUp .25s ease-out}
.relation-type-option{padding:.5rem .75rem;border:1px solid var(--pharma-border);background:#fff;border-radius:20px;cursor:pointer;margin:.25rem;display:inline-block;font-size:.8rem;transition:var(--pharma-transition)}
.relation-type-option:hover{background:var(--pharma-primary);color:#fff;transform:translateY(-1px)}
.relation-type-option.custom{border-style:dashed;color:var(--pharma-warning)}

/* Résumé */
.relations-summary{grid-row:3;position:relative;background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(248,250,252,.95));border-top:1px solid var(--pharma-border);padding:1rem;backdrop-filter:blur(10px)}
.summary-title{font-weight:600;color:var(--pharma-text);margin-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
.relations-count{background:var(--pharma-accent);color:#fff;padding:.2rem .6rem;border-radius:12px;font-size:.75rem;font-weight:600}
.relation-preview-item{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.2);border-radius:20px;padding:.4rem .8rem;margin:.25rem;display:inline-flex;align-items:center;gap:.5rem;font-size:.8rem}
.relation-preview-item .edit{cursor:pointer}

/* Dialog de description */
.relation-desc-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);display:none;z-index:900}
.relation-desc-backdrop.show{display:block}
.relation-desc-dialog{
  position:absolute;left:50%;top:35%;transform:translate(-50%,-35%);
  background:#fff;border:1px solid var(--pharma-border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.2);
  width:min(720px, calc(100% - 360px)); max-width:720px;padding:1rem;display:none;z-index:1100
}
.relation-desc-dialog.show{display:block}
.relation-desc-dialog h5{margin:0 0 .5rem 0}
.relation-desc-dialog textarea{width:100%;min-height:90px;border:2px solid var(--pharma-border);border-radius:8px;padding:.75rem}
.relation-desc-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem}

/* Responsive */
@media (max-width:1200px){
  .entity-palette{width:300px}
  .visual-relation-builder{padding-right:300px}
}
@media (max-width:1024px){
  .visual-relation-builder{display:block;padding-right:0}
  .entity-palette{position:relative;width:100%;height:auto;border-left:none;border-top:1px solid var(--pharma-border)}
  .relations-summary{position:relative}
  .visual-canvas{min-height:360px}
  .relation-types-panel{max-width:100%;left:50%;transform:translateX(-50%)}
  .relation-desc-dialog{width:96%;max-width:96%}
}
@media (max-width:768px){
  .json-comparison{grid-template-columns:1fr}
  .enrichment-actions{flex-direction:column}
  .mode-tabs{flex-direction:column}
  .qa-input-group{flex-direction:column}
  .version-comparison{grid-template-columns:1fr}
  .modal-content-semantic{width:98vw;height:92vh}
  .builder-toolbar{flex-direction:column;align-items:stretch}
}

/* Stats (Overview) */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-bottom:1rem}
.stat-card{display:flex;align-items:center;gap:12px;background:var(--pharma-bg-card);border:1px solid var(--pharma-border);border-radius:var(--pharma-radius);box-shadow:var(--pharma-shadow);padding:1rem 1.25rem}
.stat-icon{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(16,185,129,.12));color:var(--pharma-primary);flex:0 0 44px}
.stat-content{display:flex;flex-direction:column;line-height:1.1}
.stat-value{font-size:1.6rem;font-weight:800;color:var(--pharma-primary)}
.stat-label{font-size:.95rem;color:var(--pharma-text-soft);margin-top:2px}

/* Animations */
@keyframes fadeInModal{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.7)}50%{box-shadow:0 0 0 10px rgba(59,130,246,0)}}


/* Ajouter dans le style CSS */
.canvas-entity.has-existing-relations {
  border: 2px solid var(--expert-color);
  box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
}

.canvas-entity.has-existing-relations::after {
  content: '●';
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--expert-color);
  color: white;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
}


/* Ajouter dans le style CSS */
.found-relation-item {
  background: rgba(59,130,246,.05);
  border: 1px solid rgba(59,130,246,.2);
  border-radius: 8px;
  padding: 1rem;
  margin: 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 1rem;
  transition: var(--pharma-transition);
}

.found-relation-item:hover {
  background: rgba(59,130,246,.1);
  border-color: var(--pharma-primary);
}

.found-relation-content {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.found-entity-node {
  background: var(--pharma-primary);
  color: #fff;
  padding: 0.3rem 0.8rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 500;
}

.found-relation-type {
  background: var(--pharma-accent);
  color: #fff;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 500;
}

.found-relation-description {
  font-style: italic;
  color: var(--pharma-text-soft);
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.found-relation-actions {
  display: flex;
  gap: 0.5rem;
}

.found-relation-btn {
  padding: 0.3rem 0.6rem;
  border: 1px solid var(--pharma-border);
  background: #fff;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.75rem;
  transition: var(--pharma-transition);
}

.found-relation-btn:hover {
  background: var(--pharma-primary);
  color: #fff;
  border-color: var(--pharma-primary);
}

.found-relation-btn.delete {
  color: #dc2626;
  border-color: #dc2626;
}

.found-relation-btn.delete:hover {
  background: #dc2626;
  color: #fff;
}
</style>

<section class="semantic-card">
  <div class="semantic-card-header">
    <h2><i class="fas fa-brain"></i> JSON Sémantique Expert - {{ document.title|truncatechars:50 }}</h2>
  </div>
  <div class="semantic-card-body">
    <div class="mode-tabs">
      <div class="mode-tab active" data-mode="overview"><i class="fas fa-chart-pie"></i>Vue d'ensemble</div>
      <div class="mode-tab" data-mode="relations"><i class="fas fa-project-diagram"></i>Relations ({{ enriched_stats.relations_count|default:0 }})</div>
      <div class="mode-tab" data-mode="qa"><i class="fas fa-question-circle"></i>Q&A ({{ enriched_stats.qa_pairs_count|default:0 }})</div>
      <div class="mode-tab" data-mode="json"><i class="fas fa-graduation-cap"></i>JSON & Apprentissage</div>
    </div>

    <div class="enrichment-actions">
      {% if not has_enriched %}
        <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>
      {% else %}
        <button class="enrichment-btn secondary" onclick="regenerateEnrichment()"><i class="fas fa-sync-alt"></i>Régénérer</button>
      {% endif %}
      <button class="enrichment-btn primary" onclick="showVisualRelationBuilder()"><i class="fas fa-project-diagram"></i>Créateur Visuel de Relations</button>
      <button class="enrichment-btn primary" onclick="showAddQAModal()"><i class="fas fa-question"></i>Ajouter Q&A</button>
      <button class="enrichment-btn primary" onclick="showAddTextModal()"><i class="fas fa-file-alt"></i> Depuis un paragraphe</button>
      <a href="{% url 'expert:annotation_dashboard' %}" class="enrichment-btn secondary"><i class="fas fa-arrow-left"></i>Retour Dashboard</a>
    </div>
  </div>
</section>

{# --- OVERVIEW --- #}
<div id="overview-tab" class="tab-content">
  {% if has_enriched %}
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.relations_count|default:0 }}</div>
        <div class="stat-label">Relations identifiées</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.qa_pairs_count|default:0 }}</div>
        <div class="stat-label">Questions-Réponses</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ enriched_stats.contexts_count|default:0 }}</div>
        <div class="stat-label">Contextes sémantiques</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-list-check"></i></div>
      <div class="stat-content">
        <div class="stat-value">{{ total_annotations|default:0 }}</div>
        <div class="stat-label">Annotations totales</div>
      </div>
    </div>
  </div>

  {% if enriched_annotations_json.semantic_summary %}
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-lightbulb"></i> Résumé Sémantique Intelligent</h3></div>
    <div class="semantic-card-body"><p style="font-size:1.1rem;line-height:1.8">{{ enriched_annotations_json.semantic_summary }}</p></div>
  </div>
  {% endif %}

  <div class="qa-test-interface">
    <h4><i class="fas fa-vial"></i> Tester le Système de Questions-Réponses</h4>
    <div style="display:flex;gap:1rem;align-items:center;margin:.25rem 0 1rem">
      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="basic"> JSON basique</label>
      <label style="display:flex;gap:.4rem;align-items:center"><input type="radio" name="qa-source" value="enriched" checked> JSON enrichi</label>
    </div>
    <div class="qa-input-group">
      <input type="text" id="test-question" class="qa-input" placeholder="ex: Quel est le dosage du produit ?">
      <button class="qa-test-btn" onclick="testQASystem()"><i class="fas fa-search"></i>Tester</button>
    </div>
    <div id="qa-test-result" class="qa-result"></div>
    <div id="qa-correction" class="qa-result" style="display:none;border-left-color:#f59e0b">
      <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b"><i class="fas fa-edit"></i> Corriger la réponse</div>
      <textarea id="qa-corrected" class="form-control" rows="4" placeholder="Proposez la meilleure réponse..."></textarea>
      <div style="text-align:right;margin-top:.5rem">
        <button class="enrichment-btn secondary" onclick="sendQACorrection()"><i class="fas fa-save"></i>Enregistrer la correction</button>
      </div>
    </div>
  </div>
  {% else %}
  <div class="semantic-card">
    <div class="semantic-card-body" style="text-align:center;padding:3rem">
      <i class="fas fa-brain" style="font-size:4rem;color:var(--pharma-text-soft);margin-bottom:1rem"></i>
      <h3>JSON Non Enrichi</h3>
      <p>Ce document possède un JSON basique mais pas encore d'enrichissement sémantique.</p>
      <button class="enrichment-btn primary" onclick="enrichDocumentJSON()"><i class="fas fa-magic"></i>Enrichir Automatiquement</button>
    </div>
  </div>
  {% endif %}
</div>

{# --- RELATIONS --- #}
<div id="relations-tab" class="tab-content" style="display:none">
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-project-diagram"></i> Relations Entre Entités</h3></div>
    <div class="semantic-card-body">
      <div id="relations-container" class="relations-container">
        {% if enriched_annotations_json.relations %}
          {% for relation in enriched_annotations_json.relations %}
          <div class="relation-item">
            <div class="entity-node">{{ relation.source.value }}</div>
            <div class="relation-type">{{ relation.type|default:"relation" }}</div>
            <div class="relation-arrow">→</div>
            <div class="entity-node">{{ relation.target.value }}</div>
            {% if relation.description %}<small style="color:var(--pharma-text-soft);margin-left:auto">{{ relation.description }}</small>{% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">
            <i class="fas fa-project-diagram" style="font-size:3rem;margin-bottom:1rem"></i>
            <p>Aucune relation identifiée. Utilisez le créateur visuel de relations.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- Q&A --- #}
<div id="qa-tab" class="tab-content" style="display:none">
  <div class="semantic-card">
    <div class="semantic-card-header"><h3><i class="fas fa-question-circle"></i> Questions-Réponses Automatiques</h3></div>
    <div class="semantic-card-body">
      <div id="qa-container" class="qa-container">
        {% if enriched_annotations_json.questions_answers %}
          {% for qa in enriched_annotations_json.questions_answers %}
          <div class="qa-item">
            <div class="qa-question">{{ qa.question }}</div>
            <div class="qa-answer">{{ qa.answer }}</div>
            {% if qa.created_by == "expert" %}
              <div style="margin-top:.5rem">
                <span style="background:var(--pharma-success);color:#fff;padding:.2rem .5rem;border-radius:10px;font-size:.7rem"><i class="fas fa-user-check"></i> Expert</span>
              </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align:center;padding:2rem;color:var(--pharma-text-soft)">
            <i class="fas fa-question-circle" style="font-size:3rem;margin-bottom:1rem"></i>
            <p>Aucune Q&A générée. Utilisez "Ajouter Q&A".</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- JSON & APPRENTISSAGE --- #}
<div id="json-tab" class="tab-content" style="display:none">
  <div class="learning-section">
    <div class="learning-header">
      <h4><i class="fas fa-graduation-cap"></i> Apprentissage Expert IA</h4>
      <div class="learning-actions">
        <button class="learning-btn primary" onclick="compareWithFreshAI()">
          <i class="fas fa-balance-scale"></i>Comparer avec IA
        </button>
        <button class="learning-btn primary" onclick="regenerateWithLearning()">
          <i class="fas fa-magic"></i>Régénérer +Apprentissage
        </button>
        <button class="learning-btn secondary" onclick="viewDetailedHistory()">
          <i class="fas fa-history"></i>Historique détaillé
        </button>
      </div>
    </div>
    <div class="learning-stats" id="learning-stats">
      <div class="learning-stat"><div class="learning-stat-value" id="corrections-count">-</div><div class="learning-stat-label">Corrections totales</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="relations-improved">-</div><div class="learning-stat-label">Relations améliorées</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="qa-improved">-</div><div class="learning-stat-label">Q&A améliorées</div></div>
      <div class="learning-stat"><div class="learning-stat-value" id="patterns-reused">-</div><div class="learning-stat-label">Patterns réutilisés</div></div>
    </div>
    <div id="comparison-results" style="display:none">
      <h5><i class="fas fa-microscope"></i> Dernière comparaison IA vs Expert</h5>
      <div id="comparison-cards-container"></div>
    </div>
  </div>

  <div class="json-comparison">
    <div class="json-panel">
      <h4><i class="fas fa-file-code"></i> JSON Basique</h4>
      <div id="basic-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>
    </div>
    {% if has_enriched %}
    <div class="json-panel">
      <h4><i class="fas fa-brain"></i> JSON Enrichi</h4>
      <div id="enriched-json-editor" style="height:500px;border:1px solid var(--pharma-border);border-radius:8px"></div>
    </div>
    {% else %}
    <div class="json-panel" style="display:flex;align-items:center;justify-content:center;background:var(--pharma-bg)">
      <div style="text-align:center;color:var(--pharma-text-soft)">
        <i class="fas fa-brain" style="font-size:3rem;margin-bottom:1rem"></i>
        <p>JSON enrichi disponible après enrichissement</p>
      </div>
    </div>
    {% endif %}
  </div>

  <div style="text-align:center;margin-top:1rem">
    <button class="enrichment-btn primary" onclick="saveJSONChanges()"><i class="fas fa-save"></i>Sauvegarder les Modifications</button>
  </div>
</div>

{# --- MODAL CRÉATEUR VISUEL DE RELATIONS --- #}
<div id="visual-relation-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-project-diagram"></i> Créateur Visuel de Relations</h3>
      <div>
        <button id="vrb-fullscreen-btn" class="builder-btn" onclick="toggleVRBFullscreen()"><i class="fas fa-expand"></i> Plein écran</button>
        <button style="background:none;border:none;color:#fff;font-size:1.5rem;margin-left:.5rem" onclick="hideModal('visual-relation-modal')">×</button>
      </div>
    </div>
    <div class="modal-body-semantic">
      <div class="visual-relation-builder">
        <!-- Barre d'outils -->
        <div class="builder-toolbar">
          <div class="builder-modes">
            <div class="mode-switch active" data-mode="connect"><i class="fas fa-link"></i> Mode Connexion</div>
            <div class="mode-switch" data-mode="move"><i class="fas fa-arrows-alt"></i> Mode Déplacement</div>
          </div>
          <div class="builder-actions">
            <button class="builder-btn" onclick="clearCanvas()"><i class="fas fa-trash"></i> Effacer</button>
            <button class="builder-btn" onclick="autoArrange()"><i class="fas fa-magic"></i> Auto-organiser</button>
            <button class="builder-btn primary" onclick="saveAllRelations()"><i class="fas fa-save"></i> Sauvegarder tout</button>
          </div>
        </div>

        <!-- Canvas -->
        <div class="visual-canvas" id="visual-canvas">
          <svg class="connection-svg" id="connection-svg" preserveAspectRatio="none">
            <defs>
              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" />
              </marker>
            </defs>
          </svg>
        </div>

        <!-- Palette -->
        <div class="entity-palette">
          <h4><i class="fas fa-cubes"></i> Entités disponibles</h4>
          <input type="text" class="entity-search" id="entity-search" placeholder="Rechercher une entité...">
          <div class="create-entity-form">
            <input type="text" class="create-entity-input" id="new-entity-name" placeholder="Nom de la nouvelle entité">
            <select class="create-entity-input" id="new-entity-type">
              <option value="product">Produit</option>
              <option value="ingredient">Ingrédient</option>
              <option value="dosage">Dosage</option>
              <option value="indication">Indication</option>
              <option value="contraindication">Contre-indication</option>
              <option value="custom">Personnalisé</option>
            </select>
            <button class="create-entity-btn" onclick="createNewCanvasEntity()"><i class="fas fa-plus"></i> Créer</button>
          </div>
          <div class="entity-list" id="entity-list"></div>
        </div>

        <!-- Panel types relation -->
        <div class="relation-types-panel" id="relation-types-panel">
          <div style="font-weight:600;margin-bottom:.5rem;text-align:center">Choisir le type de relation :</div>
          <div class="relation-type-option" data-type="contains">contient</div>
          <div class="relation-type-option" data-type="manufactured_by">fabriqué par</div>
          <div class="relation-type-option" data-type="has_dosage">dosage</div>
          <div class="relation-type-option" data-type="used_for">utilisé pour</div>
          <div class="relation-type-option" data-type="contraindicated_with">contre-indiqué</div>
          <div class="relation-type-option" data-type="interacts_with">interagit avec</div>
          <div class="relation-type-option" data-type="composed_of">composé de</div>
          <div class="relation-type-option" data-type="has_side_effect">effet secondaire</div>
          <div class="relation-type-option custom" data-type="__custom"><i class="fas fa-plus"></i> Personnalisé</div>
        </div>

        <!-- Dialog description -->
        <div id="rel-desc-backdrop" class="relation-desc-backdrop"></div>
        <div id="rel-desc-dialog" class="relation-desc-dialog" role="dialog" aria-modal="true">
          <h5><i class="fas fa-align-left"></i> Décrire la relation</h5>
          <div id="rel-desc-context" style="font-size:.9rem;color:#475569;margin-bottom:.5rem"></div>
          <textarea id="rel-desc-text" placeholder="Saisissez une description précise de la relation (optionnel)"></textarea>
          <div class="relation-desc-actions">
            <button class="builder-btn" id="rel-desc-cancel">Annuler</button>
            <button class="builder-btn" id="rel-desc-ai">Laisser l’IA</button>
            <button class="builder-btn primary" id="rel-desc-ok"><i class="fas fa-check"></i> Valider</button>
          </div>
        </div>

        <!-- Résumé -->
        <div class="relations-summary" id="relations-summary">
          <div class="summary-title"><i class="fas fa-list"></i> Relations créées <span class="relations-count" id="relations-count">0</span></div>
          <div id="relations-preview"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{# Modales Q&A & paragraphe (inchangées) #}
<div id="add-qa-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-question"></i> Ajouter Question-Réponse</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-qa-modal')">×</button>
    </div>
    <div class="modal-body-semantic">
      <div class="form-group"><label class="form-label">Question</label><input type="text" id="qa-question" class="form-control" placeholder="ex: Quel est le dosage du produit ?"></div>
      <div class="form-group"><label class="form-label">Réponse</label><textarea id="qa-answer" class="form-control" rows="3" placeholder="Réponse complète..."></textarea></div>
      <div class="form-group"><label class="form-label">Tags (optionnel)</label><input type="text" id="qa-tags" class="form-control" placeholder="dosage, posologie, administration"></div>
      <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">
        <button class="enrichment-btn secondary" onclick="hideModal('add-qa-modal')">Annuler</button>
        <button class="enrichment-btn primary" onclick="addQAPair()"><i class="fas fa-plus"></i>Ajouter</button>
      </div>
    </div>
  </div>
</div>

<div id="add-text-modal" class="semantic-modal">
  <div class="modal-content-semantic">
    <div class="modal-header-semantic">
      <h3><i class="fas fa-file-alt"></i> Extraire des relations depuis un paragraphe</h3>
      <button style="background:none;border:none;color:#fff;font-size:1.5rem" onclick="hideModal('add-text-modal')">×</button>
    </div>
    <div class="modal-body-semantic" style="max-height:80vh;overflow-y:auto;">
      <div class="form-group">
        <label class="form-label">Paragraphe</label>
        <textarea id="free-text" class="form-control" rows="6" placeholder="Collez ici un extrait du document"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Aide (optionnelle)</label>
        <input id="free-text-hint" class="form-control" placeholder="ex: réglementation, posologie, interactions...">
      </div>

      <!-- Section d'aperçu des relations trouvées -->
      <div id="paragraph-relations-preview" style="display:none;margin-top:2rem;">
        <h4><i class="fas fa-search"></i> Relations trouvées par l'IA</h4>
        <div style="background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:1rem;margin:1rem 0;">
          <div id="found-relations-count" style="font-weight:600;margin-bottom:1rem;color:var(--expert-color)"></div>
          <div id="found-relations-list"></div>
        </div>

        <div style="text-align:right;display:flex;gap:1rem;justify-content:flex-end;margin-top:1rem;">
          <button class="enrichment-btn secondary" onclick="clearParagraphAnalysis()">
            <i class="fas fa-times"></i> Annuler
          </button>
          <button class="enrichment-btn" onclick="reAnalyzeParagraph()" style="background:var(--pharma-warning)">
            <i class="fas fa-sync"></i> Re-analyser
          </button>
          <button class="enrichment-btn primary" onclick="saveParagraphRelations()">
            <i class="fas fa-save"></i> Sauvegarder les relations
          </button>
        </div>
      </div>

      <!-- Boutons initiaux -->
      <div id="paragraph-initial-actions" style="text-align:right;display:flex;gap:1rem;justify-content:flex-end">
        <button class="enrichment-btn secondary" onclick="hideModal('add-text-modal')">Annuler</button>
        <button class="enrichment-btn primary" onclick="analyzeParagraph()">
          <i class="fas fa-magic"></i> Analyser & prévisualiser
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  /* =================== Utils =================== */
  function fromJsonScript(id, fallback) {
    const n = document.getElementById(id);
    if (!n) return fallback;
    try { return JSON.parse(n.textContent.trim() || '{}'); }
    catch (e) { console.warn('JSON invalide pour', id, e); return fallback; }
  }

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  window.getCookie = getCookie;

  function notify(msg, type) {
    const el = document.createElement('div');
    el.className = `expert-notification ${type || 'info'}`;
    el.innerHTML = `<div class="notification-content">
      <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
      <span>${msg}</span>
    </div>`;
    if (!document.getElementById('expert-notification-styles')) {
      const css = document.createElement('style'); css.id = 'expert-notification-styles';
      css.textContent =
        `.expert-notification{position:fixed;top:20px;right:20px;z-index:10000;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);animation:slideIn .25s ease-out;max-width:400px}
         .expert-notification.success{background:linear-gradient(135deg,rgba(16,185,129,.9),rgba(34,197,94,.9));color:#fff}
         .expert-notification.error{background:linear-gradient(135deg,rgba(239,68,68,.9),rgba(220,38,38,.9));color:#fff}
         .expert-notification.info{background:linear-gradient(135deg,rgba(59,130,246,.9),rgba(16,185,129,.9));color:#fff}
         .notification-content{display:flex;align-items:center;gap:.75rem;font-weight:500;font-size:.9rem}
         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
         @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;
      document.head.appendChild(css);
    }
    document.body.appendChild(el);
    setTimeout(() => { el.style.animation = 'slideOut .25s ease-in'; setTimeout(() => el.remove(), 280); }, 3000);
  }
  window.notify = notify;

  /* =================== Données =================== */
  const BASIC    = fromJsonScript('basic-json-data',   {});
  const ENRICHED = fromJsonScript('enriched-json-data',{});
  const DISPLAY  = fromJsonScript('display-json-data', {});

  /* =================== Visual builder state =================== */
  let allEntities = [];
  let canvasEntities = [];
  let canvasRelations = [];
  let currentMode = 'connect';
  let connectionState = { from: null, to: null };
  let pendingRelation = null; // pour le dialogue de description

  const RELATION_LABELS = {
    contains: 'contient',
    manufactured_by: 'est fabriqué par',
    has_dosage: 'a pour dosage',
    used_for: 'est utilisé pour',
    contraindicated_with: 'est contre-indiqué avec',
    interacts_with: 'interagit avec',
    composed_of: 'est composé de',
    has_side_effect: 'a pour effet secondaire'
  };

  /* =================== Monaco =================== */
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });

  function makeEditor(id, val, readOnly) {
    const el = document.getElementById(id); if (!el) return null;
    return monaco.editor.create(el, {
      value: JSON.stringify(val ?? {}, null, 2),
      language: 'json', theme: 'vs', readOnly: !!readOnly,
      automaticLayout: true, minimap: { enabled: false }, wordWrap: 'on', scrollBeyondLastLine: false
    });
  }
  let basicEditor = null, enrichedEditor = null;

  document.addEventListener('DOMContentLoaded', function () {
    // Tabs
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t === tab));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = (c.id === mode + '-tab') ? 'block' : 'none');
        [basicEditor, enrichedEditor].forEach(ed => ed && ed.layout && ed.layout());
      });
    });

    // Monaco init
    require(['vs/editor/editor.main'], function () {
      basicEditor    = makeEditor('basic-json-editor',    BASIC,    true);
      enrichedEditor = makeEditor('enriched-json-editor', ENRICHED, false);
      if (enrichedEditor && (!ENRICHED || Object.keys(ENRICHED).length === 0)) {
        enrichedEditor.setValue('// Pas encore enrichi. Cliquez sur « Régénérer » pour créer le JSON enrichi.');
      }
    });

    // Init entités & stats
    extractAllEntities(BASIC);
    loadLearningStats();
  });

  /* =================== Entités =================== */
  function extractAllEntities(basicJson) {
    allEntities = [];
    const entities = (basicJson && basicJson.entities) || {};
    Object.entries(entities).forEach(([type, items]) => {
      const list = Array.isArray(items) ? items : ((items && items.items) || []);
      list.forEach(item => {
        const value = (typeof item === 'string') ? item : ((item && item.value) || '');
        if (value) allEntities.push({ id: genId(), type, value, x: 0, y: 0 });
      });
    });
  }
  function genId(){ return 'ent_' + Math.random().toString(36).slice(2,10); }

  /* =================== Builder =================== */
  function showVisualRelationBuilder() {
    showModal('visual-relation-modal');
    setTimeout(() => initializeVisualBuilder(), 50);
  }
  window.showVisualRelationBuilder = showVisualRelationBuilder;

  // Remplacer la fonction initializeVisualBuilder()
function initializeVisualBuilder() {
  setupBuilderModes();
  populateEntityList();
  loadExistingRelations(); // ← NOUVEAU : Charger les relations existantes
  setupCanvasInteractions();
  renderConnections();
  wireRelationTypePanel();
  wireDescriptionDialog();
  resizeVisualBuilder();
}

// NOUVELLE fonction pour charger les relations du JSON enrichi
// Modifier loadExistingRelations pour éviter les doublons
function loadExistingRelations() {
  const enrichedData = ENRICHED || {};
  const existingRelations = enrichedData.relations || [];

  if (existingRelations.length === 0) return;

  // Vider d'abord les relations canvas pour éviter les doublons
  canvasRelations = [];

  // Convertir les relations JSON en format canvas
  existingRelations.forEach(relationData => {
    const sourceEntity = findOrCreateEntityForRelation(relationData.source);
    const targetEntity = findOrCreateEntityForRelation(relationData.target);

    if (sourceEntity && targetEntity) {
      // Vérifier qu'on n'a pas déjà cette relation
      const exists = canvasRelations.some(existing =>
        existing.source.id === sourceEntity.id &&
        existing.target.id === targetEntity.id &&
        existing.type === relationData.type
      );

      if (!exists) {
        const canvasRelation = {
          id: relationData.id || genId(),
          source: sourceEntity,
          target: targetEntity,
          type: relationData.type,
          description: relationData.description,
          isExisting: true,
          createdBy: relationData.created_by || 'ai'
        };

        canvasRelations.push(canvasRelation);
      }
    }
  });

  // Auto-positionner seulement s'il y a de nouvelles relations
  if (canvasRelations.length > 0) {
    autoArrangeWithRelations();
    updateRelationsSummary();
    notify(`${canvasRelations.length} relations existantes chargées`, 'success');
  }
}

// NOUVELLE fonction pour trouver ou créer une entité pour une relation
function findOrCreateEntityForRelation(entityData) {
  // Chercher d'abord dans les entités existantes
  let entity = allEntities.find(e =>
    e.type === entityData.type && e.value === entityData.value
  );

  if (!entity) {
    // Créer l'entité si elle n'existe pas
    entity = {
      id: genId(),
      type: entityData.type,
      value: entityData.value,
      x: 0,
      y: 0
    };
    allEntities.push(entity);
  }

  // Ajouter au canvas si pas déjà présente
  let canvasEntity = canvasEntities.find(e => e.id === entity.id);
  if (!canvasEntity) {
    canvasEntity = { ...entity };
    canvasEntities.push(canvasEntity);
    // Positionner aléatoirement pour l'instant (sera réorganisé)
    canvasEntity.x = Math.random() * 400 + 50;
    canvasEntity.y = Math.random() * 300 + 50;
    renderEntityOnCanvas(canvasEntity);
  }

  return canvasEntity;
}

  function setupBuilderModes() {
    document.querySelectorAll('.mode-switch').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-switch').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        updateCanvasCursor();
      });
    });
    updateCanvasCursor();
  }
  function updateCanvasCursor() {
    const canvas = document.getElementById('visual-canvas');
    canvas.style.cursor = currentMode === 'connect' ? 'crosshair' : 'default';
  }

  function populateEntityList() {
    const list = document.getElementById('entity-list');
    list.innerHTML = '';
    allEntities.forEach(entity => {
      const item = document.createElement('div');
      item.className = 'entity-item';
      item.draggable = true;
      item.innerHTML = `<span>${entity.value}</span><span class="entity-type-label">${entity.type}</span>`;
      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify(entity));
      });
      list.appendChild(item);
    });

    // Recherche
    const search = document.getElementById('entity-search');
    search.oninput = (e) => {
      const q = e.target.value.toLowerCase();
      Array.from(list.children).forEach(it => it.style.display = it.textContent.toLowerCase().includes(q) ? 'flex' : 'none');
    };
  }

  // Modifier createNewCanvasEntity pour synchroniser avec allEntities
window.createNewCanvasEntity = function createNewCanvasEntity() {
  const nameInput = document.getElementById('new-entity-name');
  const typeSelect = document.getElementById('new-entity-type');
  const name = nameInput.value.trim();
  const type = typeSelect.value;

  if (!name) {
    nameInput.focus();
    return;
  }

  // Vérifier si l'entité existe déjà
  const existingEntity = allEntities.find(e =>
    e.type === type && e.value.toLowerCase() === name.toLowerCase()
  );

  if (existingEntity) {
    notify(`L'entité "${name}" existe déjà`, 'warning');
    nameInput.value = '';
    return;
  }

  const entity = {
    id: genId(),
    type,
    value: name,
    x: 0,
    y: 0
  };

  // Ajouter à la liste globale ET repeupler la liste visuelle
  allEntities.push(entity);
  populateEntityList(); // ← IMPORTANT : Rafraîchir la liste

  nameInput.value = '';
  notify(`Entité « ${name} » créée et disponible`, 'success');
};

  function setupCanvasInteractions() {
    const canvas = document.getElementById('visual-canvas');

    // Drop pour ajouter une entité
    canvas.addEventListener('dragover', e => e.preventDefault());
    canvas.addEventListener('drop', (e) => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      try {
        const entityData = JSON.parse(e.dataTransfer.getData('text/plain'));
        addEntityToCanvas(entityData, x, y);
      } catch (err) { console.warn('Drop error:', err); }
    });

    // Click de connexion
    canvas.addEventListener('click', (e) => {
      if (currentMode !== 'connect') return;
      const point = e.target.closest('.connection-point');
      if (!point) return;
      const entityId = point.dataset.entityId;
      const entity = canvasEntities.find(en => en.id === entityId);
      if (!entity) return;

      if (!connectionState.from) {
        connectionState.from = entity;
        document.getElementById(entity.id)?.classList.add('connecting');
        notify('Cliquez sur une autre entité pour choisir la cible', 'info');
      } else if (connectionState.from.id === entityId) {
        clearConnectionState();
      } else {
        connectionState.to = entity;
        showRelationTypesPanel();
      }
    });
  }

  // Remplacer la fonction autoArrange par autoArrangeWithRelations
function autoArrangeWithRelations() {
  if (canvasEntities.length === 0) return;

  const canvas = document.getElementById('visual-canvas');
  const width = canvas.offsetWidth - 200; // Marge pour éviter la palette
  const height = canvas.offsetHeight - 100;

  // Si on a des relations, utiliser un layout basé sur les forces
  if (canvasRelations.length > 0) {
    layoutWithForces(width, height);
  } else {
    // Sinon, arrangement circulaire simple
    layoutCircular(width, height);
  }

  renderConnections();
}

// NOUVEAU layout basé sur les forces pour les relations
function layoutWithForces(width, height) {
  const centerX = width / 2;
  const centerY = height / 2;

  // Placer les entités connectées plus proches les unes des autres
  const processedEntities = new Set();

  canvasRelations.forEach((relation, index) => {
    const source = relation.source;
    const target = relation.target;

    if (!processedEntities.has(source.id)) {
      // Position de base pour la source
      const angle = (index / canvasRelations.length) * 2 * Math.PI;
      source.x = centerX + Math.cos(angle) * 150;
      source.y = centerY + Math.sin(angle) * 150;
      processedEntities.add(source.id);
    }

    if (!processedEntities.has(target.id)) {
      // Position de la cible relative à la source
      const offsetAngle = Math.random() * Math.PI / 2 - Math.PI / 4; // ±45°
      const distance = 120;
      target.x = source.x + Math.cos(offsetAngle) * distance;
      target.y = source.y + Math.sin(offsetAngle) * distance;
      processedEntities.add(target.id);
    }

    // Contraindre dans les limites
    [source, target].forEach(entity => {
      entity.x = Math.max(60, Math.min(entity.x, width - 60));
      entity.y = Math.max(30, Math.min(entity.y, height - 30));
    });
  });

  // Positionner les entités isolées
  canvasEntities.forEach(entity => {
    if (!processedEntities.has(entity.id)) {
      entity.x = Math.random() * (width - 120) + 60;
      entity.y = Math.random() * (height - 60) + 30;
    }

    // Mettre à jour visuellement
    const element = document.getElementById(entity.id);
    if (element) {
      element.style.left = entity.x + 'px';
      element.style.top = entity.y + 'px';
    }
  });
}

function layoutCircular(width, height) {
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) * 0.35;
  const angleStep = (2 * Math.PI) / canvasEntities.length;

  canvasEntities.forEach((entity, index) => {
    const angle = index * angleStep;
    entity.x = centerX + radius * Math.cos(angle) - 60;
    entity.y = centerY + radius * Math.sin(angle) - 25;

    const element = document.getElementById(entity.id);
    if (element) {
      element.style.left = entity.x + 'px';
      element.style.top = entity.y + 'px';
    }
  });
}

// Mettre à jour la fonction window.autoArrange
window.autoArrange = function() {
  if (canvasEntities.length === 0) return;
  autoArrangeWithRelations();
  notify('Entités arrangées automatiquement', 'success');
};

  function addEntityToCanvas(entity, x, y) {
    if (canvasEntities.find(e => e.id === entity.id)) {
      notify('Cette entité est déjà sur le canvas', 'warning');
      return;
    }
    const canvasEntity = { ...entity, x, y };
    canvasEntities.push(canvasEntity);
    renderEntityOnCanvas(canvasEntity);
  }

  function renderEntityOnCanvas(entity) {
  const canvas = document.getElementById('visual-canvas');
  const element = document.createElement('div');
  element.className = 'canvas-entity';

  // Ajouter une classe si l'entité a des relations existantes
  const hasExistingRelations = canvasRelations.some(rel =>
    (rel.source.id === entity.id || rel.target.id === entity.id) && rel.isExisting
  );
  if (hasExistingRelations) {
    element.classList.add('has-existing-relations');
  }

  element.id = entity.id;
  element.textContent = entity.value;
  element.title = `${entity.type}: ${entity.value}`;
  element.style.left = entity.x + 'px';
  element.style.top  = entity.y + 'px';

    const rightPoint = document.createElement('div');
    rightPoint.className = 'connection-point right';
    rightPoint.dataset.entityId = entity.id;
    rightPoint.dataset.side = 'right';

    const leftPoint = document.createElement('div');
    leftPoint.className = 'connection-point left';
    leftPoint.dataset.entityId = entity.id;
    leftPoint.dataset.side = 'left';

    element.appendChild(rightPoint);
    element.appendChild(leftPoint);

    makeDraggable(element, entity);
    canvas.appendChild(element);
  }

  function makeDraggable(element, entity) {
    let isDragging = false;
    let startX, startY;

    element.addEventListener('mousedown', (e) => {
      if (currentMode !== 'move') return;
      isDragging = true;
      startX = e.clientX - entity.x;
      startY = e.clientY - entity.y;
      element.classList.add('dragging');
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      entity.x = e.clientX - startX;
      entity.y = e.clientY - startY;
      const canvas = document.getElementById('visual-canvas');
      const maxX = canvas.offsetWidth  - element.offsetWidth;
      const maxY = canvas.offsetHeight - element.offsetHeight;
      entity.x = Math.max(0, Math.min(entity.x, maxX));
      entity.y = Math.max(0, Math.min(entity.y, maxY));
      element.style.left = entity.x + 'px';
      element.style.top  = entity.y + 'px';
      renderConnections();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) { isDragging = false; element.classList.remove('dragging'); }
    });
  }

  /* ========= Panneau types de relation ========= */
  function wireRelationTypePanel() {
    const panel = document.getElementById('relation-types-panel');
    if (panel.__wired) return; panel.__wired = true;
    panel.addEventListener('click', (e) => {
      const opt = e.target.closest('.relation-type-option');
      if (!opt) return;
      let relType = opt.dataset.type;
      if (relType === '__custom') {
        const customType = prompt('Saisissez le type de relation personnalisé:');
        if (!customType || !customType.trim()) return;
        relType = customType.trim().toLowerCase().replace(/\s+/g, '_');
      }
      // On ouvre le dialogue de description
      openDescriptionDialog(relType);
      hideRelationTypesPanel();
    });
  }

  function centerRelationPanel() {
    const panel   = document.getElementById('relation-types-panel');
    const builder = document.querySelector('.visual-relation-builder');
    const palette = document.querySelector('.entity-palette');
    const summary = document.getElementById('relations-summary');
    if (!panel || !builder) return;

    // hauteur du résumé pour éviter le chevauchement
    const sumH = summary ? summary.offsetHeight : 72;
    builder.style.setProperty('--vrb-summary-h', sumH + 'px');

    // Centre sur la zone canvas (builder total - palette)
    const bRect = builder.getBoundingClientRect();
    const pRect = palette ? palette.getBoundingClientRect() : { width:0, left:bRect.right };
    const usableWidth = (pRect.left - bRect.left) - 32; // marge
    const centerX = bRect.left + usableWidth/2;
    panel.style.left = centerX + 'px';
    panel.style.transform = 'translateX(-50%)';
  }

  function showRelationTypesPanel(){
    const panel = document.getElementById('relation-types-panel');
    panel.classList.add('show');
    centerRelationPanel();
  }
  function hideRelationTypesPanel(){ document.getElementById('relation-types-panel').classList.remove('show'); }

  /* ========= Description par l’utilisateur ========= */
  function wireDescriptionDialog(){
    const dlg = document.getElementById('rel-desc-dialog');
    const bg  = document.getElementById('rel-desc-backdrop');
    const ok  = document.getElementById('rel-desc-ok');
    const ai  = document.getElementById('rel-desc-ai');
    const cancel = document.getElementById('rel-desc-cancel');
    ok.onclick = () => {
      const txt = (document.getElementById('rel-desc-text').value || '').trim();
      if (pendingRelation) pendingRelation.description = txt || undefined;
      closeDescriptionDialog(true);
      finalizeCreateRelation();
    };
    // Dans wireDescriptionDialog(), remplacer le bouton "Laisser l'IA" par :
ai.onclick = async () => {
  if (!pendingRelation) return;

  // Générer immédiatement la description via l'IA
  ai.disabled = true;
  ai.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';

  try {
    const aiDescription = await generateSingleRelationDescription(pendingRelation);
    if (aiDescription) {
      document.getElementById('rel-desc-text').value = aiDescription;
      notify('Description générée par l\'IA', 'success');
    } else {
      // Fallback : laisser l'IA générer à la sauvegarde
      pendingRelation.description = undefined;
      closeDescriptionDialog(true);
      finalizeCreateRelation();
    }
  } catch (e) {
    console.warn('Erreur génération IA:', e);
    pendingRelation.description = undefined;
    closeDescriptionDialog(true);
    finalizeCreateRelation();
  } finally {
    ai.disabled = false;
    ai.innerHTML = '<i class="fas fa-magic"></i> Laisser l\'IA';
  }
};
    cancel.onclick = () => { pendingRelation = null; closeDescriptionDialog(false); clearConnectionState(); };
    bg.onclick = cancel.onclick;
  }

  // Ajouter cette nouvelle fonction
async function generateSingleRelationDescription(relation) {
  try {
    const response = await fetch(`/expert/annotation/document/{{ document.id }}/describe-relation/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        source_type: relation.source.type,
        source_value: relation.source.value,
        relation_type: relation.type,
        target_type: relation.target.type,
        target_value: relation.target.value,
        context: 'visual_builder'
      })
    });

    if (response.ok) {
      const data = await response.json();
      return data.success ? data.description : null;
    }
  } catch (e) {
    console.warn('Erreur API description:', e);
  }
  return null;
}

  function openDescriptionDialog(relType){
    if (!connectionState.from || !connectionState.to) return;
    pendingRelation = { id: genId(), source: connectionState.from, target: connectionState.to, type: relType, description: undefined };
    const dlg = document.getElementById('rel-desc-dialog');
    const bg  = document.getElementById('rel-desc-backdrop');
    const ctx = document.getElementById('rel-desc-context');
    const txt = document.getElementById('rel-desc-text');
    ctx.textContent = `${connectionState.from.value} — ${(RELATION_LABELS[relType]||relType).replace(/_/g,' ')} — ${connectionState.to.value}`;
    txt.value = '';
    dlg.classList.add('show'); bg.classList.add('show');
  }
  function closeDescriptionDialog(){
    document.getElementById('rel-desc-dialog').classList.remove('show');
    document.getElementById('rel-desc-backdrop').classList.remove('show');
  }
  function finalizeCreateRelation(){
    if (!pendingRelation) return;
    canvasRelations.push(pendingRelation);
    clearConnectionState();
    renderConnections();
    updateRelationsSummary();
    const verb = (RELATION_LABELS[pendingRelation.type]||pendingRelation.type).replace(/_/g,' ');
    notify(`Relation « ${verb} » créée`, 'success');
    pendingRelation = null;
  }

  function clearConnectionState() {
    document.querySelectorAll('.canvas-entity').forEach(el => el.classList.remove('connecting'));
    connectionState = { from: null, to: null };
  }

  /* =================== Rendu des connexions =================== */
  function clearSVGExceptDefs(svg) {
    Array.from(svg.childNodes).forEach(n => {
      if (!(n.nodeName && n.nodeName.toLowerCase() === 'defs')) svg.removeChild(n);
    });
  }

  function renderConnections() {
    const svg = document.getElementById('connection-svg');
    if (!svg) return;
    clearSVGExceptDefs(svg);

    canvasRelations.forEach(relation => {
      const sEl = document.getElementById(relation.source.id);
      const tEl = document.getElementById(relation.target.id);
      if (!(sEl && tEl)) return;

      const sRect = sEl.getBoundingClientRect();
      const tRect = tEl.getBoundingClientRect();
      const svgRect = svg.getBoundingClientRect();

      const startX = sRect.right - svgRect.left;
      const startY = sRect.top + sRect.height/2 - svgRect.top;
      const endX   = tRect.left  - svgRect.left;
      const endY   = tRect.top + tRect.height/2 - svgRect.top;

      const c1x = startX + (endX - startX) * 0.5;
      const c1y = startY;
      const c2x = startX + (endX - startX) * 0.5;
      const c2y = endY;

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${startX} ${startY} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${endX} ${endY}`);
      path.setAttribute('stroke', 'var(--pharma-accent)');
      path.setAttribute('stroke-width', '3');
      path.setAttribute('fill', 'none');
      path.setAttribute('marker-end', 'url(#arrowhead)');
      path.style.filter = 'drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3))';
      svg.appendChild(path);

      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', (startX + endX)/2);
      label.setAttribute('y', (startY + endY)/2 - 10);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('fill', 'var(--pharma-text)');
      label.setAttribute('font-size', '12');
      label.setAttribute('font-weight', '600');
      label.textContent = (RELATION_LABELS[relation.type] || relation.type).replace(/_/g,' ');
      svg.appendChild(label);
    });
  }

  // Dans updateRelationsSummary(), améliorer l'affichage :
// Modifier updateRelationsSummary pour distinguer les sources
function updateRelationsSummary() {
  document.getElementById('relations-count').textContent = canvasRelations.length;
  const preview = document.getElementById('relations-preview');

  preview.innerHTML = canvasRelations.map((rel, idx) => {
    const t = (RELATION_LABELS[rel.type]||rel.type).replace(/_/g,' ');

    // Feedback selon le statut et la source
    let descIcon, descTitle, sourceIcon = '';

    if (rel.description) {
      descIcon = '✏️';
      descTitle = `Description: "${rel.description.substring(0, 50)}..."`;
    } else {
      descIcon = '🤖';
      descTitle = 'Description sera générée automatiquement par l\'IA';
    }

    // Icône de source
    if (rel.isExisting) {
      if (rel.createdBy === 'expert') {
        sourceIcon = '<span title="Créée par expert" style="color:var(--expert-color)">👨‍💼</span>';
      } else {
        sourceIcon = '<span title="Générée par IA" style="color:var(--ai-color)">🤖</span>';
      }
    } else {
      sourceIcon = '<span title="Nouvelle relation" style="color:var(--pharma-warning)">✨</span>';
    }

    return `<div class="relation-preview-item" data-index="${idx}">
              <span>${rel.source.value} → ${t} → ${rel.target.value}</span>
              <span title="${descTitle}">${descIcon}</span>
              ${sourceIcon}
              <span class="edit" title="Modifier la description" onclick="editRelationDescription(${idx})">
                <i class="fas fa-pen"></i>
              </span>
            </div>`;
  }).join('');
}
  window.editRelationDescription = function(idx){
    const rel = canvasRelations[idx]; if(!rel) return;
    connectionState = {from: rel.source, to: rel.target};
    openDescriptionDialog(rel.type);
    document.getElementById('rel-desc-text').value = rel.description || '';
    // à la validation, finalizeCreateRelation ajouterait une nouvelle relation : on remplace plutôt
    const okBtn = document.getElementById('rel-desc-ok');
    const aiBtn = document.getElementById('rel-desc-ai');
    const origOk = okBtn.onclick, origAi = aiBtn.onclick;
    okBtn.onclick = () => {
      const txt = (document.getElementById('rel-desc-text').value || '').trim();
      rel.description = txt || undefined;
      closeDescriptionDialog(true); clearConnectionState();
      updateRelationsSummary();
      notify('Description mise à jour', 'success');
      okBtn.onclick = origOk; aiBtn.onclick = origAi;
    };
    aiBtn.onclick = () => {
      rel.description = undefined;
      closeDescriptionDialog(true); clearConnectionState();
      updateRelationsSummary();
      notify('Cette relation sera décrite par l’IA à la sauvegarde', 'info');
      okBtn.onclick = origOk; aiBtn.onclick = origAi;
    };
  };

  /* =================== Sauvegarde relations =================== */
  // Remplacer getAIDescriptionsForRelations par :
async function getAIDescriptionsForRelations(relations) {
  try {
    const r = await fetch(`/expert/annotation/document/{{ document.id }}/describe-relations-batch/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        relations: relations.map(rel => ({
          source_type: rel.source.type,
          source_value: rel.source.value,
          target_type: rel.target.type,
          target_value: rel.target.value,
          relation_type: rel.type
        })),
        context: 'visual_builder_batch'
      })
    });

    if (r.ok) {
      const data = await r.json();
      if (data.success && Array.isArray(data.descriptions)) {
        return data.descriptions;
      }
    }
  } catch (e) {
    console.warn('Batch description API indisponible:', e);
  }

  // Fallback : génération individuelle
  const descriptions = [];
  for (const rel of relations) {
    const desc = await generateSingleRelationDescription(rel);
    descriptions.push(desc || simpleAutodescribe(rel));
  }
  return descriptions;
}

  function simpleAutodescribe(rel) {
    const verb = RELATION_LABELS[rel.type] || rel.type.replace(/_/g, ' ');
    return `${rel.source.value} ${verb} ${rel.target.value}.`;
  }

  async function postBatchRelations(relationsPayload) {
    const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-relations-batch/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
      body: JSON.stringify({ relations: relationsPayload, write_to_enriched: true, origin: 'visual_builder' })
    });
    return res;
  }

  async function postOneByOne(relationsPayload) {
    let ok = 0, errors = [];
    for (const rel of relationsPayload) {
      try {
        const r = await fetch(`/expert/annotation/document/{{ document.id }}/add-relation/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
          body: JSON.stringify({
            source_type: rel.source_type, source_value: rel.source_value,
            target_type: rel.target_type, target_value: rel.target_value,
            relation_type: rel.relation_type, description: rel.description,
            write_to_enriched: true, origin: 'visual_builder'
          })
        });
        const data = await r.json();
        if (r.ok && data.success) ok++; else errors.push(data.error || 'Erreur inconnue');
      } catch (e) { errors.push(e.message); }
    }
    return { ok, errors };
  }

  // Modifier saveAllRelations pour gérer les relations existantes
// Modifier saveAllRelations avec meilleure gestion des doublons
window.saveAllRelations = async function saveAllRelations() {
  if (canvasRelations.length === 0) {
    notify('Aucune relation à sauvegarder', 'warning');
    return;
  }

  // Séparer les nouvelles relations des existantes
  const newRelations = canvasRelations.filter(rel => !rel.isExisting);

  if (newRelations.length === 0) {
    notify('Aucune nouvelle relation à sauvegarder', 'warning');
    return;
  }

  notify(`Préparation de ${newRelations.length} nouvelles relations...`, 'info');

  // Générer descriptions pour les relations sans description
  const needAI = newRelations.filter(r => !r.description);
  let aiDescriptions = [];

  if (needAI.length) {
    notify('Génération des descriptions manquantes…', 'info');
    aiDescriptions = await getAIDescriptionsForRelations(needAI);
  }

  // Construire le payload
  let aiIdx = 0;
  const relationsPayload = newRelations.map(rel => {
    const desc = rel.description || aiDescriptions[aiIdx++] || simpleAutodescribe(rel);
    return {
      source_type: rel.source.type,
      source_value: rel.source.value,
      target_type: rel.target.type,
      target_value: rel.target.value,
      relation_type: rel.type,
      description: desc
    };
  });

  // Sauvegarder via batch
  try {
    notify('Sauvegarde des nouvelles relations…', 'info');
    const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-relations-batch/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
      body: JSON.stringify({ relations: relationsPayload })
    });

    const data = await res.json();
    if (res.ok && data.success) {
      notify(`✅ ${data.added_count} nouvelles relations sauvegardées`, 'success');
      hideModal('visual-relation-modal');
      setTimeout(() => location.reload(), 900);
    } else {
      notify('❌ ' + (data.error || 'Erreur lors de la sauvegarde'), 'error');
    }
  } catch (e) {
    notify('❌ ' + e.message, 'error');
  }
};

  /* =================== Actions principales =================== */
  async function enrichDocumentJSON(force = false) {
    notify('Enrichissement en cours…', 'info');
    try {
      const url = `/expert/annotation/document/{{ document.id }}/enrich-json/` + (force ? `?force=1` : ``);
      const res = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' } });
      const data = await res.json();
      if (data.success) { notify(`✅ JSON enrichi. ${data.relations_count} relations, ${data.qa_pairs_count} Q&A.`, 'success'); setTimeout(() => location.reload(), 900); }
      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }
    } catch (e) { notify('❌ ' + e.message, 'error'); }
  }
  window.enrichDocumentJSON = enrichDocumentJSON;
  window.regenerateEnrichment = () => enrichDocumentJSON(true);

  async function saveJSONChanges() {
    if (!enrichedEditor) { notify('Aucun éditeur enrichi', 'error'); return; }
    try {
      const payload = JSON.parse(enrichedEditor.getValue());
      const res = await fetch(`/expert/annotation/document/{{ document.id }}/save-enriched-edits/`, {
        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ manual_edits: payload })
      });
      const data = await res.json();
      if (data.success) notify('✅ Modifications sauvegardées', 'success');
      else notify('❌ ' + (data.error || 'Erreur inconnue'), 'error');
    } catch (e) { notify('❌ JSON invalide : ' + e.message, 'error'); }
  }
  window.saveJSONChanges = saveJSONChanges;

  async function addQAPair() {
    const q = (document.getElementById('qa-question') || {}).value?.trim();
    const a = (document.getElementById('qa-answer')   || {}).value?.trim();
    const tags = (document.getElementById('qa-tags')   || {}).value?.split(',').map(s => s.trim()).filter(Boolean) || [];
    if (!q || !a) { alert('Question et réponse requises'); return; }
    try {
      const res = await fetch(`/expert/annotation/document/{{ document.id }}/add-qa/`, {
        method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: q, answer: a, tags, entity_refs: [] })
      });
      const data = await res.json();
      if (data.success) { notify('✅ Q&A ajoutée', 'success'); hideModal('add-qa-modal'); setTimeout(() => location.reload(), 700); }
      else notify('❌ ' + data.error, 'error');
    } catch (e) { notify('❌ ' + e.message, 'error'); }
  }
  window.addQAPair = addQAPair;

  async function testQASystem() {
    const qEl = document.getElementById('test-question');
    const resEl = document.getElementById('qa-test-result');
    const corrBox = document.getElementById('qa-correction');
    const source = (document.querySelector('input[name="qa-source"]:checked') || {}).value || 'enriched';
    const question = (qEl && qEl.value || '').trim();
    if (!question) { alert('Veuillez saisir une question'); return; }

    resEl.style.display = 'block';
    resEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche de la réponse...';
    corrBox.style.display = 'none';

    try {
      const r = await fetch(`/expert/annotation/document/{{ document.id }}/test-qa/`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ question, source })
      });
      const data = await r.json();
      if (data.success) {
        const conf = data.confidence || 0;
        const color = conf > 0.8 ? '#10b981' : (conf > 0.5 ? '#f59e0b' : '#64748b');
        resEl.innerHTML =
          `<div style="display:flex;align-items:flex-start;gap:1rem;">
            <div style="flex:1;">
              <div style="font-weight:600;margin-bottom:.5rem;color:#1e293b;"><i class="fas fa-robot"></i> Réponse (${source}) :</div>
              <div id="qa-answer-text" style="color:#64748b;line-height:1.6;">${data.answer}</div>
            </div>
            <div style="background:${color};color:#fff;padding:.3rem .8rem;border-radius:15px;font-size:.8rem;font-weight:600;white-space:nowrap;">
              ${Math.round(conf*100)}% confiance
            </div>
          </div>
          ${data.answer_type === 'no_match' ? `<div style="margin-top:1rem;padding:1rem;background:rgba(245,158,11,.1);border-radius:8px;border-left:4px solid #f59e0b;"><strong>💡 Suggestion :</strong> ${data.suggestion || ''}</div>` : ''}
          <div style="margin-top:.75rem;text-align:right;">
            <button class="enrichment-btn secondary" onclick="openCorrection('${source}')"><i class="fas fa-edit"></i> Corriger cette réponse</button>
          </div>`;
        window.__lastQA__ = { question, source, answer: data.answer };
      } else {
        resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;
      }
    } catch (e) {
           resEl.innerHTML = `<div style="color:#ef4444;"><i class="fas fa-times-circle"></i> Erreur: ${e.message}</div>`;
    }
  }
  window.testQASystem = testQASystem;

  function openCorrection() {
    const corrBox = document.getElementById('qa-correction');
    const ta = document.getElementById('qa-corrected');
    const ans = (window.__lastQA__ || {}).answer || '';
    if (ta) ta.value = ans;
    corrBox.style.display = 'block';
  }
  window.openCorrection = openCorrection;

  async function sendQACorrection() {
    const ctx = window.__lastQA__ || {};
    const corrected = (document.getElementById('qa-corrected') || {}).value?.trim();
    if (!ctx.question || !corrected) { alert('Question ou correction manquante.'); return; }
    try {
      const r = await fetch(`/expert/annotation/document/{{ document.id }}/qa-feedback/`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ question: ctx.question, corrected_answer: corrected, source: ctx.source })
      });
      const data = await r.json();
      if (data.success) { notify('✅ Correction enregistrée. Merci !', 'success'); document.getElementById('qa-correction').style.display = 'none'; loadLearningStats(); }
      else { notify('❌ ' + (data.error || 'Erreur inconnue'), 'error'); }
    } catch (e) { notify('❌ ' + e.message, 'error'); }
  }
  window.sendQACorrection = sendQACorrection;

  /* =================== Apprentissage =================== */
  async function loadLearningStats() {
    try {
      const response = await fetch(`/expert/document/{{ document.id }}/learning-history/`);
      const data = await response.json();
      if (data.success) {
        document.getElementById('corrections-count').textContent = data.history.total_corrections || 0;
        document.getElementById('relations-improved').textContent = data.history.history?.filter(h => h.type.includes('relation')).length || 0;
        document.getElementById('qa-improved').textContent = data.history.history?.filter(h => h.type.includes('Q&A')).length || 0;
        document.getElementById('patterns-reused').textContent = data.history.history?.reduce((sum, h) => sum + (h.reused_count || 0), 0) || 0;
      }
    } catch (e) { console.warn('Could not load learning stats:', e); }
  }

  async function compareWithFreshAI() {
    const btn = document.querySelector('button[onclick="compareWithFreshAI()"]');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Comparaison...';
    try {
      const expertJson = enrichedEditor ? JSON.parse(enrichedEditor.getValue()) : ENRICHED;
      const response = await fetch(`/expert/document/{{ document.id }}/compare-and-learn/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ expert_json: expertJson, context: { document_title: "{{ document.title }}", doc_type: "{{ document.doc_type }}" } })
      });
      const data = await response.json();
      if (data.success) { notify(`✅ ${data.message}`, 'success'); displayComparisonResults(data.comparison); loadLearningStats(); }
      else { notify(`❌ ${data.error}`, 'error'); }
    } catch (e) { notify('❌ Erreur lors de la comparaison', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-balance-scale"></i>Comparer avec IA'; }
  }
  window.compareWithFreshAI = compareWithFreshAI;

  async function regenerateWithLearning() {
    const btn = document.querySelector('button[onclick="regenerateWithLearning()"]');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Régénération...';
    try {
      const response = await fetch(`/expert/document/{{ document.id }}/regenerate-with-learning/`, { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
      const data = await response.json();
      if (data.success) { notify(data.message, 'success'); setTimeout(() => location.reload(), 1500); }
      else { notify(data.error, 'error'); }
    } catch (e) { notify('❌ Erreur lors de la régénération', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic"></i>Régénérer +Apprentissage'; }
  }
  window.regenerateWithLearning = regenerateWithLearning;

  function viewDetailedHistory() { window.open(`/expert/document/{{ document.id }}/view-expert-deltas/`, '_blank'); }
  window.viewDetailedHistory = viewDetailedHistory;

  function displayComparisonResults(comparison) {
    const container = document.getElementById('comparison-cards-container');
    const resultsSection = document.getElementById('comparison-results');
    if (!comparison || !comparison.summary) return;
    let html = '';
    const summary = comparison.summary;

    if (summary.key_improvements?.length) {
      html += '<div style="margin-bottom:1rem">';
      summary.key_improvements.forEach(improvement => {
        html += `<div class="comparison-card"><div class="delta-header"><span class="delta-type-badge delta-type-relation_added">Amélioration détectée</span></div><div style="padding:1rem"><div class="description-text">${improvement}</div></div></div>`;
      });
      html += '</div>';
    }
    if (summary.changes_by_type) {
      html += '<div class="learning-stats">';
      Object.entries(summary.changes_by_type).forEach(([type, count]) => {
        const label = type.replace('_',' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `<div class="learning-stat"><div class="learning-stat-value">${count}</div><div class="learning-stat-label">${label}</div></div>`;
      });
      html += '</div>';
    }
    container.innerHTML = html;
    resultsSection.style.display = 'block';
  }

  /* =================== Modales =================== */
  function showModal(id){ const m = document.getElementById(id); if (m) m.classList.add('show'); }
  function hideModal(id){
    const m = document.getElementById(id); if (m) m.classList.remove('show');
    if (id === 'visual-relation-modal') { clearConnectionState(); hideRelationTypesPanel(); }
  }
  window.showModal = showModal;
  window.hideModal = hideModal;
  window.showAddQAModal = () => showModal('add-qa-modal');
  window.showAddTextModal = () => showModal('add-text-modal');

  document.addEventListener('click', e => {
    if (e.target.classList?.contains('semantic-modal')) e.target.classList.remove('show');
  });

  /* =================== Paragraphe =================== */
  // Dans la section /* =================== Paragraphe =================== */
// Remplacer tout le code de cette section par :

/* =================== Paragraphe =================== */

// Variables globales pour les relations trouvées
let foundParagraphRelations = [];

// Fonction pour analyser le paragraphe (version preview)
async function analyzeParagraph() {
  const text = (document.getElementById('free-text') || {}).value?.trim();
  const hint = (document.getElementById('free-text-hint') || {}).value?.trim();

  if (!text) {
    alert('Veuillez coller un paragraphe.');
    return;
  }

  try {
    notify('Analyse du paragraphe en cours...', 'info');

    const res = await fetch(`/expert/annotation/document/{{ document.id }}/analyze-paragraph/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ text, hint, preview_only: true })
    });

    const data = await res.json();

    if (data.success) {
      foundParagraphRelations = data.relations || [];
      displayFoundRelations(foundParagraphRelations);
      notify(`✅ ${foundParagraphRelations.length} relations trouvées`, 'success');
    } else {
      notify('❌ ' + (data.error || 'Erreur lors de l\'analyse'), 'error');
    }
  } catch (e) {
    notify('❌ ' + e.message, 'error');
  }
}

// Fonction pour afficher les relations trouvées
function displayFoundRelations(relations) {
  const previewSection = document.getElementById('paragraph-relations-preview');
  const initialActions = document.getElementById('paragraph-initial-actions');
  const countEl = document.getElementById('found-relations-count');
  const listEl = document.getElementById('found-relations-list');

  if (relations.length === 0) {
    notify('Aucune relation trouvée dans ce paragraphe', 'warning');
    return;
  }

  // Masquer les boutons initiaux et afficher l'aperçu
  initialActions.style.display = 'none';
  previewSection.style.display = 'block';

  countEl.textContent = `${relations.length} relation${relations.length > 1 ? 's' : ''} identifiée${relations.length > 1 ? 's' : ''}`;

  listEl.innerHTML = relations.map((rel, index) => `
    <div class="found-relation-item" data-index="${index}">
      <div class="found-relation-content">
        <div class="found-entity-node">${rel.source.value}</div>
        <div class="found-relation-type">${rel.type.replace(/_/g, ' ')}</div>
        <span style="color:var(--pharma-accent);font-weight:bold;">→</span>
        <div class="found-entity-node">${rel.target.value}</div>
        ${rel.description ? `<div class="found-relation-description">"${rel.description}"</div>` : ''}
      </div>
      <div class="found-relation-actions">
        <button class="found-relation-btn" onclick="editFoundRelation(${index})" title="Modifier">
          <i class="fas fa-edit"></i>
        </button>
        <button class="found-relation-btn delete" onclick="deleteFoundRelation(${index})" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `).join('');
}

// EXPOSER TOUTES LES FONCTIONS DANS L'OBJET WINDOW
window.analyzeParagraph = analyzeParagraph;

window.editFoundRelation = function(index) {
  const relation = foundParagraphRelations[index];
  if (!relation) return;

  const newDescription = prompt(
    `Modifier la description de la relation:\n${relation.source.value} → ${relation.type} → ${relation.target.value}`,
    relation.description || ''
  );

  if (newDescription !== null) {
    relation.description = newDescription.trim() || undefined;
    displayFoundRelations(foundParagraphRelations);
    notify('Description modifiée', 'success');
  }
};

window.deleteFoundRelation = function(index) {
  if (confirm('Supprimer cette relation ?')) {
    foundParagraphRelations.splice(index, 1);
    displayFoundRelations(foundParagraphRelations);
    notify('Relation supprimée', 'success');
  }
};

window.clearParagraphAnalysis = function() {
  foundParagraphRelations = [];
  document.getElementById('paragraph-relations-preview').style.display = 'none';
  document.getElementById('paragraph-initial-actions').style.display = 'flex';
  document.getElementById('free-text').value = '';
  document.getElementById('free-text-hint').value = '';
};

window.reAnalyzeParagraph = function() {
  document.getElementById('paragraph-relations-preview').style.display = 'none';
  document.getElementById('paragraph-initial-actions').style.display = 'flex';
  foundParagraphRelations = [];
  analyzeParagraph();
};

window.saveParagraphRelations = async function() {
  if (foundParagraphRelations.length === 0) {
    notify('Aucune relation à sauvegarder', 'warning');
    return;
  }

  try {
    notify('Sauvegarde des relations...', 'info');

    const res = await fetch(`/expert/annotation/document/{{ document.id }}/save-paragraph-relations/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({
        relations: foundParagraphRelations,
        source: 'paragraph_analysis'
      })
    });

    const data = await res.json();

    if (data.success) {
      notify(`✅ ${data.saved_count} relations sauvegardées`, 'success');
      hideModal('add-text-modal');
      clearParagraphAnalysis();
      setTimeout(() => location.reload(), 800);
    } else {
      notify('❌ ' + (data.error || 'Erreur lors de la sauvegarde'), 'error');
    }
  } catch (e) {
    notify('❌ ' + e.message, 'error');
  }
};

// Mettre à jour la fonction hideModal existante
const originalHideModal = window.hideModal;
window.hideModal = function(id) {
  if (id === 'add-text-modal') {
    // Nettoyer l'état du paragraphe quand on ferme la modale
    foundParagraphRelations = [];
    const previewSection = document.getElementById('paragraph-relations-preview');
    const initialActions = document.getElementById('paragraph-initial-actions');
    if (previewSection) previewSection.style.display = 'none';
    if (initialActions) initialActions.style.display = 'flex';
  }
  originalHideModal(id);
};

// Garder l'ancienne fonction pour compatibilité (maintenant elle fait juste l'analyse)
window.addFromParagraph = analyzeParagraph;

  /* ======= Layout & plein écran ======= */
  function resizeVisualBuilder(){
    const modal   = document.getElementById('visual-relation-modal');
    if(!modal || !modal.classList.contains('show')) return;

    const content = modal.querySelector('.modal-content-semantic');
    const header  = content.querySelector('.modal-header-semantic');
    const body    = content.querySelector('.modal-body-semantic');
    const builder = body.querySelector('.visual-relation-builder');
    const toolbar = builder.querySelector('.builder-toolbar');
    const summary = builder.querySelector('.relations-summary');
    const canvas  = document.getElementById('visual-canvas');

    const bodyH = content.clientHeight - header.offsetHeight;
    body.style.height = bodyH + 'px';

    const canvasH = Math.max(360, bodyH - toolbar.offsetHeight - summary.offsetHeight - 16);
    canvas.style.height = canvasH + 'px';

    // Met à jour la variable CSS pour la position du panel
    builder.style.setProperty('--vrb-summary-h', summary.offsetHeight + 'px');

    // Repositionne le panel et redessine les courbes
    centerRelationPanel();
    requestAnimationFrame(() => { try { renderConnections && renderConnections(); } catch(_){} });
  }
  window.resizeVisualBuilder = resizeVisualBuilder;

  function toggleVRBFullscreen(){
    const modal   = document.getElementById('visual-relation-modal');
    const content = modal.querySelector('.modal-content-semantic');
    const btn     = document.getElementById('vrb-fullscreen-btn');
    content.classList.toggle('fullscreen');
    if(btn){
      const isFS = content.classList.contains('fullscreen');
      btn.innerHTML = isFS ? '<i class="fas fa-compress"></i> Réduire' : '<i class="fas fa-expand"></i> Plein écran';
    }
    setTimeout(resizeVisualBuilder, 50);
  }
  window.toggleVRBFullscreen = toggleVRBFullscreen;

  window.addEventListener('resize', () => resizeVisualBuilder());
  const _oldShowVRB = window.showVisualRelationBuilder;
  window.showVisualRelationBuilder = function(){
    _oldShowVRB();
    setTimeout(resizeVisualBuilder, 150);
  };

  /* ======= Fonctions utilitaires pour le builder ======= */
  window.clearCanvas = function() {
    if (confirm('Voulez-vous vraiment effacer toutes les relations et entités du canvas?')) {
      canvasEntities = [];
      canvasRelations = [];
      document.getElementById('visual-canvas').innerHTML = '<svg class="connection-svg" id="connection-svg" preserveAspectRatio="none"><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="var(--pharma-accent)" /></marker></defs></svg>';
      updateRelationsSummary();
      notify('Canvas effacé', 'info');
    }
  };

  window.autoArrange = function() {
    if (canvasEntities.length === 0) return;

    const canvas = document.getElementById('visual-canvas');
    const width = canvas.offsetWidth;
    const height = canvas.offsetHeight;

    // Simple arrangement circulaire
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) * 0.35;
    const angleStep = (2 * Math.PI) / canvasEntities.length;

    canvasEntities.forEach((entity, index) => {
      const angle = index * angleStep;
      entity.x = centerX + radius * Math.cos(angle) - 60; // Ajustement pour centrer l'entité
      entity.y = centerY + radius * Math.sin(angle) - 25;

      const element = document.getElementById(entity.id);
      if (element) {
        element.style.left = entity.x + 'px';
        element.style.top = entity.y + 'px';
      }
    });

    renderConnections();
    notify('Entités arrangées automatiquement', 'success');
  };
})();
</script>

{% endblock %}