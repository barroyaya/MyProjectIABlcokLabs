{% extends 'client/base.html' %}
{% load static %}

{% block title %}Analyse réglementaire - {{ document.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Reuse key styles from expert JSON view for consistent look */
    .annotation-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; background: #f3f4f6; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; border: 1px solid #e2e8f0; }
    .json-container { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; padding: 1rem; box-shadow: 0 2px 10px rgba(15,23,42,.06); }
    .json-display { background: #fff; border: 2px solid #e9ecef; border-radius: 8px; padding: .75rem; font-family: 'Fira Code', monospace; font-size: .9rem; line-height: 1.5; overflow: auto; max-height: 600px; white-space: pre; }
    .json-key{color:#0451a5;font-weight:600}.json-string{color:#0a7d0a}.json-number{color:#098658;font-weight:500}.json-boolean{color:#00f;font-weight:600}.json-null{color:#00f;font-weight:600;font-style:italic}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="annotation-header">
    <div>
      <h2 class="h5 mb-1"><i class="fa-solid fa-scale-balanced me-2"></i>Analyse réglementaire (lecture seule)</h2>
      <div class="text-muted small">Document: <strong>{{ document.title }}</strong></div>
    </div>
    <div>
      <a href="{% url 'client:library:client_document_detail' document.pk %}" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-arrow-left me-1"></i>Retour</a>
    </div>
  </div>

  {# Injecte le JSON consolidé sous le même id que la vue expert #}
  {% if global_annotations_json %}
    {{ global_annotations_json|json_script:"json-data" }}
  {% else %}
    <script id="json-data" type="application/json">{}</script>
  {% endif %}

  <div class="json-container">
    <h3 class="h6 mb-3"><i class="fa-solid fa-code me-2"></i>Données d'analyse consolidées</h3>
    <pre id="json-output" class="json-display">Chargement…</pre>
  </div>

  <div class="json-container mt-4">
    <h3 class="h6 mb-3"><i class="fa-solid fa-align-left me-2"></i>Résumé réglementaire global (validé)</h3>
    <div class="p-3" style="white-space: pre-wrap; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff;">{{ global_summary|default:"Aucun résumé disponible." }}</div>
  </div>
</div>

<script>
// Simple pretty printer with spans for syntax highlighting
function syntaxHighlight(json) {
  if (typeof json != 'string') json = JSON.stringify(json, undefined, 2);
  json = json
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/("(\\u[a-zA-Z0-9]{4}|\\x[a-zA-Z0-9]{2}|\\.|[^\\"])*"\s*:)|("(\\u[a-zA-Z0-9]{4}|\\x[a-zA-Z0-9]{2}|\\.|[^\\"])*")|(\b(true|false|null)\b)|(-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
      function (match) {
        if (/^\s*"/.test(match) && /:\s*$/.test(match)) return '<span class="json-key">' + match + '</span>';
        if (/^"/.test(match)) return '<span class="json-string">' + match + '</span>';
        if (/true|false/.test(match)) return '<span class="json-boolean">' + match + '</span>';
        if (/null/.test(match)) return '<span class="json-null">' + match + '</span>';
        return '<span class="json-number">' + match + '</span>';
      });
  return json;
}

(function(){
  const el = document.getElementById('json-data');
  const out = document.getElementById('json-output');
  try {
    const data = JSON.parse(el?.textContent || '{}');
    out.innerHTML = syntaxHighlight(data);
  } catch(e){
    out.textContent = 'Erreur de parsing du JSON.';
  }
})();
</script>
{% endblock %}