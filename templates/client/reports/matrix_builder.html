{% extends 'client/base.html' %}
{% load static %}

{% block title %}Matrix Builder - RegX Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="matrix-builder">
    <div class="builder-header">
        <h1 class="builder-title">
            <i class="material-icons">auto_awesome</i>
            Matrix Report Builder
        </h1>
        <p class="builder-subtitle">
            Cr√©ez des rapports personnalis√©s avec filtres avanc√©s
        </p>
    </div>

    <div class="builder-grid">
    <div class="column-selector">
        <!-- Dynamic fields will be loaded by JavaScript -->
        <div class="selector-section">
            <div class="selector-title">
                <i class="material-icons">view_column</i>
                Tous les Champs Disponibles
                <span class="field-count">{{ all_fields|length }} champs</span>
            </div>
            
            <!-- All fields in one container -->
            <div class="unified-field-list">
                {% for field in all_fields %}
                <div class="field-item" 
                    data-field="{{ field.name }}" 
                    data-type="{{ field.type }}"
                    data-count="{{ field.data_count }}">
                    <div class="field-icon {{ field.type }}">
                        <i class="material-icons">{{ field.icon }}</i>
                    </div>
                    <div class="field-info">
                        <div class="field-name">{{ field.label }}</div>
                        <div class="field-description">{{ field.description }}</div>
                    </div>
                </div>
                {% empty %}
                <p>Aucun champ disponible</p>
                {% endfor %}
            </div>
        </div>
        
        <div class="filter-section" id="dynamic-filters">
            <div class="selector-title">
                <i class="material-icons">tune</i>
                Filtres Dynamiques
                <span class="filter-count" id="filter-count">0 filtres</span>
            </div>
            
            <!-- Time Period Filter (always visible) -->
            <div class="filter-group">
                <label>üìÖ P√©riode</label>
                <select name="period" class="filter-select">
                    <option value="">Toutes les p√©riodes</option>
                    {% for period_key, period_label in filter_options.periods %}
                    <option value="{{ period_key }}">{{ period_label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Dynamic filters will be added here by JavaScript -->
            <div id="column-specific-filters"></div>
            
            <!-- Clear Filters Button -->
            <button class="btn btn-secondary" id="clear-filters" style="display: none;">
                <i class="material-icons">clear_all</i>
                Effacer Filtres
            </button>
        </div>
    </div>
    
    <div class="matrix-preview">
        <!-- Matrix preview will be loaded by JavaScript -->
        <div class="preview-header">
            <div class="preview-title">
                <i class="material-icons">table_chart</i>
                Matrix de Donn√©es R√©elles
            </div>
            <div class="preview-actions">
                <button class="generate-button" disabled>
                    <i class="material-icons">auto_awesome</i>
                    S√©lectionnez des colonnes
                </button>
            </div>
        </div>
        
        <div class="matrix-table-container">
            <div class="empty-state">
                <i class="material-icons">view_column</i>
                <h3>Chargement des colonnes...</h3>
                <p>Les champs disponibles sont en cours de chargement</p>
            </div>
        </div>
    </div>
</div>
<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
    window.allFields = {{ all_fields|safe }};
    
    console.log('üöÄ All fields loaded from Django:', window.allFields);
    
    window.filterOptions = {{ filter_options|safe }};
    window.annotationFields = {{ all_fields|safe }}.filter(f => f.type === 'annotation');
    window.productFields = {{ all_fields|safe }}.filter(f => f.type === 'product');
    window.documentFields = {{ all_fields|safe }}.filter(f => f.type === 'document');
    
    // Debug check
    if (!window.allFields || window.allFields.length === 0) {
        console.error('‚ùå No fields loaded!');
    } else {
        console.log(`‚úÖ ${window.allFields.length} fields loaded successfully`);
    }
</script>
<script src="{% static 'js/reports.js' %}"></script>
{% endblock %}