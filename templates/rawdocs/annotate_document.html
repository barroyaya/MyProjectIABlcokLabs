{#template/annotate_document.html#}
{% extends "base.html" %}
{% load rawdocs_extras %}
{% load static %}
{% block title %}Annotation {{ document.file.name|basename }} ‚Äì RawDocs{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script type="text/javascript">
  // Variable globale pour l'ID du document
  var DOCUMENT_ID = {{ document.id }};

  // Fonction pour ajouter une annotation au contenu structur√©
  function addAnnotationToStructuredContent(annotation) {
    const structuredContent = document.querySelector('.structured-content-body');
    if (!structuredContent) return;

    const text = annotation.text || annotation.selected_text;
    const type = annotation.type || annotation.entity_type;
    const color = annotation.color || '#ffeb3b'; // couleur par d√©faut
    
    // Convertir la couleur hex en RGB pour le gradient
    const rgb = hexToRgb(color || '#ffeb3b');
    const rgbValues = rgb ? `${rgb.r},${rgb.g},${rgb.b}` : '255,235,59';

    // Convertir le texte en format HTML safe pour la recherche
    const textAsHtml = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
            
    // Cr√©er un regex qui prend en compte le format HTML
    const regexEscaped = textAsHtml.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(regexEscaped, 'g');
    
    // Cr√©er le span d'annotation
    const annotationSpan = `<span class="inline-annotation" 
                               style="--highlight-color: ${rgbValues}; 
                                      cursor: pointer;">
                            ${textAsHtml}
                            <span class="ann-label" 
                                  style="font-size: 0.7rem; 
                                         font-weight: bold; 
                                         margin-left: 4px; 
                                         padding: 2px 6px; 
                                         border-radius: 4px; 
                                         background: rgba(0,0,0,0.6); 
                                         color: #fff; 
                                         white-space: nowrap;">
                                ${type}
                            </span>
                         </span>`;
    
    // Remplacer uniquement si le texte existe et n'est pas d√©j√† dans un span d'annotation
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = structuredContent.innerHTML;
    const textNodes = [];
    
    function findTextNodes(node) {
        if (node.nodeType === 3) { // Text node
            textNodes.push(node);
        } else if (node.nodeType === 1 && !node.classList.contains('inline-annotation')) {
            for (const child of node.childNodes) {
                findTextNodes(child);
            }
        }
    }
    
    findTextNodes(tempDiv);
    
    textNodes.forEach(node => {
        const nodeContent = node.textContent;
        if (nodeContent.includes(text)) {
            const newContent = nodeContent.replace(regex, annotationSpan);
            const span = document.createElement('span');
            span.innerHTML = newContent;
            node.parentNode.replaceChild(span, node);
        }
    });
    
    structuredContent.innerHTML = tempDiv.innerHTML;
  }

  // D√©finition de la fonction ici pour s'assurer qu'elle est disponible globalement
  function annotateWithGroqAll() {
    const btn = document.getElementById('groq-annotate-all-btn');
    const loading = document.getElementById('ai-loading');
    const validateBtn = document.getElementById('validate-page-btn');
    
    if (!btn || !loading || typeof DOCUMENT_ID === 'undefined') {
        console.error('Annotation impossible : ID du document non disponible ou √©l√©ments manquants');
        showErrorMessage('√âl√©ments manquants pour l\'annotation du document');
        return;
    }

    btn.style.display = 'none';
    loading.style.display = 'flex';
    loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Annotation du document en cours...';

    fetch(`/annotation/groq/document/${DOCUMENT_ID}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mode: 'structured'
        })
    })
    .then(handleResponse)
    .then(data => {
        if (data.success) {
            showSuccessMessage(`üéâ Document annot√©! ${data.annotations_created} annotations cr√©√©es`);
            
            if (data.total_pages > 0) {
                showAlert(`${data.total_pages} pages trait√©es avec succ√®s!`, 'success', '#10b981');
            }

            // Au lieu de recharger la page, on va afficher les annotations dans le contenu structur√©
            const annotations = data.annotations || [];
            const structuredContent = document.querySelector('.structured-content-body');
            
            if (structuredContent && annotations.length > 0) {
                let htmlContent = structuredContent.innerHTML;
                
                // Pour chaque annotation
                annotations.forEach(annotation => {
                    const text = annotation.text || annotation.selected_text;
                    const type = annotation.type || annotation.entity_type;
                    const color = annotation.color || '#ffeb3b'; // couleur par d√©faut si non sp√©cifi√©e
                    
                    // Convertir le texte en format HTML safe pour la recherche
                    const textAsHtml = text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                            
                    // Cr√©er un regex qui prend en compte le format HTML
                    const regexEscaped = textAsHtml.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(regexEscaped, 'g');
                    
                    // Cr√©er le span d'annotation avec le texte original
                    const annotationSpan = `<span class="inline-annotation" 
                                               style="background-color: ${color}; 
                                                      padding: 2px 4px; 
                                                      margin: 0 1px; 
                                                      border-radius: 3px; 
                                                      cursor: pointer;">
                                            ${textAsHtml}
                                            <span class="ann-label" 
                                                  style="font-size: 0.7rem; 
                                                         font-weight: bold; 
                                                         margin-left: 4px; 
                                                         padding: 2px 6px; 
                                                         border-radius: 4px; 
                                                         background: rgba(0,0,0,0.6); 
                                                         color: #fff; 
                                                         white-space: nowrap;">
                                                ${type}
                                            </span>
                                         </span>`;
                    
                    // Remplacer uniquement si le texte existe et n'est pas d√©j√† dans un span d'annotation
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;
                    const textNodes = [];
                    
                    function findTextNodes(node) {
                        if (node.nodeType === 3) { // Text node
                            textNodes.push(node);
                        } else if (node.nodeType === 1 && !node.classList.contains('inline-annotation')) {
                            for (const child of node.childNodes) {
                                findTextNodes(child);
                            }
                        }
                    }
                    
                    findTextNodes(tempDiv);
                    
                    textNodes.forEach(node => {
                        const nodeContent = node.textContent;
                        if (nodeContent.includes(text)) {
                            const newContent = nodeContent.replace(regex, annotationSpan);
                            const span = document.createElement('span');
                            span.innerHTML = newContent;
                            node.parentNode.replaceChild(span, node);
                        }
                    });
                    
                    htmlContent = tempDiv.innerHTML;
                });
                
                // Mettre √† jour le contenu avec toutes les annotations
                structuredContent.innerHTML = htmlContent;
                
                showSuccessMessage(`${annotations.length} annotations ajout√©es au contenu structur√©`);
            } else {
                console.log('Pas de contenu structur√© ou pas d\'annotations √† afficher');
            }
        } else {
            throw new Error(data.error || 'Erreur inconnue lors de l\'annotation');
        }
    })
    .catch(error => {
        console.error('Annotation Error:', error);
        showErrorMessage(`Erreur annotation: ${error.message}`);
    })
    .finally(() => {
        btn.style.display = 'flex';
        loading.style.display = 'none';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> IA en cours...';
    });
  }

  // Fonction utilitaire pour convertir une couleur hex en RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }
</script>

<!-- Tous les styles CSS existants restent identiques -->
<style>
/* NUCLEAR OPTION: Override ALL modal conflicts */
.context-menu {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    padding: 0;
    min-width: 150px;
}

.context-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
    color: #333;
    transition: background-color 0.2s;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item.danger {
    color: #dc3545;
}

.context-menu-item.danger:hover {
    background-color: #f8d7da;
}

/* Hide context menu initially */
.context-menu.hidden {
    display: none;
}
/* Force modal to appear above EVERYTHING */
.modal {
    z-index: 999999 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
    display: none !important;
}

.modal.show {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Force backdrop to be clickable and properly positioned */
.modal-backdrop {
    z-index: 999998 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
}

/* Force modal dialog to be above backdrop and clickable */
.modal-dialog {
    z-index: 1000000 !important;
    position: relative !important;
    margin: 1.75rem auto !important;
    max-width: 500px !important;
    width: 90% !important;
    pointer-events: auto !important;
}

/* Force modal content styling */
.modal-content {
    background: white !important;
    border: none !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8) !important;
    pointer-events: auto !important;
    position: relative !important;
    z-index: 1000001 !important;
}

.modal-header {
    background: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.modal-title {
    color: #495057 !important;
    font-weight: 500 !important;
    margin: 0 !important;
}

.modal-body {
    background: white !important;
    padding: 1.5rem !important;
    color: #495057 !important;
}

.modal-footer {
    background: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0 0 0.5rem 0.5rem !important;
}

/* Force all form elements to work properly */
.modal input,
.modal select,
.modal textarea {
    background: white !important;
    border: 1px solid #ced4da !important;
    color: #495057 !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 0.25rem !important;
    width: 100% !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal input:focus,
.modal select:focus,
.modal textarea:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    outline: 0 !important;
}

.modal .form-label {
    color: #495057 !important;
    font-weight: 500 !important;
    margin-bottom: 0.5rem !important;
}

.modal .btn {
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close {
    background: transparent !important;
    border: none !important;
    color: #000 !important;
    opacity: 0.5 !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close:hover {
    opacity: 1 !important;
}

/* Remove ANY other z-index that might interfere */
.annotation-header,
.annotation-types-panel,
.page-navigation,
.text-content-card,
.annotations-list,
.learning-dashboard-widget {
    z-index: auto !important;
    position: relative !important;
}

/* Ensure the page content doesn't interfere */
.app-container,
.site-header,
body {
    z-index: auto !important;
}

/* Force click events to work */
.modal * {
    pointer-events: auto !important;
}

.modal-dialog * {
    pointer-events: auto !important;
}

.modal-content * {
    pointer-events: auto !important;
}
@keyframes highlight-pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.3); }
    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

.annotation-text-clickable:hover {
    background-color: #e7f3ff !important;
    border-radius: 3px;
    padding: 1px 3px;
}

/* Styles pour l'analyse r√©glementaire */
.regulatory-analysis-panel {
  background: linear-gradient(120deg, #f0f9ff 70%, #e0f2fe 100%);
  border: 1.5px solid var(--pharma-info);
  border-radius: var(--pharma-radius);
  margin-bottom: 2rem;
  box-shadow: var(--pharma-shadow);
  padding: 2rem;
}

.regulatory-stats {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.regulatory-stat {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  padding: 1rem 1.2rem;
  text-align: center;
  flex: 1;
  box-shadow: 0 2px 8px rgba(56,189,248,0.08);
}

.regulatory-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--pharma-info);
  display: block;
}

.regulatory-stat-label {
  font-size: 0.85rem;
  color: var(--pharma-text-soft);
  margin-top: 0.2rem;
}

.btn-regulatory {
  background: linear-gradient(90deg, var(--pharma-info), #0ea5e9);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(56,189,248,0.13);
  transition: var(--pharma-transition);
}

.btn-regulatory:hover {
  background: linear-gradient(90deg, #0ea5e9, var(--pharma-primary));
  color: #fff;
}

.btn-regulatory:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}

.regulatory-progress {
  background: var(--pharma-bg-card);
  border-radius: 8px;
  padding: 0.5rem;
  margin: 1rem 0;
}

.progress-bar-regulatory {
  background: linear-gradient(90deg, var(--pharma-info), var(--pharma-accent));
  height: 8px;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.page-regulatory-analysis {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-info);
  border-radius: var(--pharma-radius-sm);
  padding: 1.5rem;
  margin-top: 1rem;
}

.importance-score {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.3rem 1rem;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
}

.importance-score.critical {
  background: linear-gradient(90deg, #ef4444, #dc2626);
  color: #fff;
}

.importance-score.high {
  background: linear-gradient(90deg, #f59e0b, #d97706);
  color: #fff;
}

.importance-score.medium {
  background: linear-gradient(90deg, var(--pharma-info), var(--pharma-primary));
  color: #fff;
}

.importance-score.low {
  background: #e5e7eb;
  color: #6b7280;
}

.regulatory-obligations {
  margin-top: 1rem;
}

.obligation-item {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: 8px;
  padding: 0.8rem 1rem;
  margin-bottom: 0.8rem;
  border-left: 4px solid var(--pharma-warn);
}

.obligation-severity.high {
  border-left-color: var(--pharma-error);
}

.obligation-severity.medium {
  border-left-color: var(--pharma-warn);
}

.obligation-severity.low {
  border-left-color: var(--pharma-info);
}

.regulatory-loading {
  color: var(--pharma-info);
  font-weight: 500;
  margin-left: 1rem;
  display: none;
}

.key-points-list {
  margin-top: 1rem;
}

.key-point {
  background: #f0f9ff;
  border: 1px solid #e0f2fe;
  border-radius: 6px;
  padding: 0.6rem 0.8rem;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
  color: var(--pharma-text);
}

.authorities-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.8rem;
}

.authority-tag {
  background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  color: #fff;
  padding: 0.25rem 0.8rem;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 500;
}

.deadlines-list {
  margin-top: 1rem;
}

.deadline-item {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 6px;
  padding: 0.6rem 0.8rem;
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.deadline-timeframe {
  background: var(--pharma-warn);
  color: #fff;
  padding: 0.2rem 0.6rem;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
}
</style>

<!-- Styles CSS pharma existants conserv√©s identiques -->
<style>
/* Pharma color variables */
:root {
  --pharma-primary: #0ea5e9;
  --pharma-primary-dark: #0284c7;
  --pharma-accent: #10b981;
  --pharma-bg: #f8fafc;
  --pharma-bg-card: rgba(255,255,255,0.95);
  --pharma-glass: rgba(14,165,233,0.10);
  --pharma-border: #cbd5e1;
  --pharma-shadow: 0 8px 32px 0 rgba(14, 165, 233, 0.07);
  --pharma-text: #1e293b;
  --pharma-text-soft: #64748b;
  --pharma-valid: #22c55e;
  --pharma-warn: #f59e0b;
  --pharma-error: #ef4444;
  --pharma-info: #38bdf8;
  --pharma-radius: 18px;
  --pharma-radius-sm: 12px;
  --pharma-font: 'Inter', sans-serif;
  --pharma-transition: all 0.28s cubic-bezier(.4,0,.2,1);
}

/* Reset and base */
body {
  background: linear-gradient(135deg, var(--pharma-bg) 70%, #e0f2fe 100%);
  color: var(--pharma-text);
  font-family: var(--pharma-font);
}

.main-content {
  width: 100%;
  max-width: none;
  margin: auto;
}

/* Annotation header */
.annotation-header {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem 2rem;
  margin-bottom: 2.2rem;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1.5rem;
  animation: fadeInUp 0.5s;
}

.header-info h2 {
  color: var(--pharma-primary-dark);
  font-size: 1.45rem;
  font-weight: 700;
  margin-bottom: 0.3rem;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.document-meta {
  display: flex;
  gap: 1.2rem;
  font-size: 0.98rem;
  margin-top: 0.2rem;
}

.meta-item {
  color: var(--pharma-text-soft);
  gap: 0.3rem;
  display: flex;
  align-items: center;
}

.header-actions .btn-outline {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-primary);
  color: var(--pharma-primary-dark);
  border-radius: var(--pharma-radius-sm);
  font-size: 1rem;
  padding: 0.6rem 1.3rem;
  font-weight: 500;
  transition: var(--pharma-transition);
}
.header-actions .btn-outline:hover {
  background: var(--pharma-primary);
  color: #fff;
  border-color: var(--pharma-primary-dark);
  transform: translateY(-2px) scale(1.04);
}

/* Annotation Types Panel */
.annotation-types-panel {
  background: linear-gradient(120deg, #f0fdfa 70%, #bae6fd 100%);
  border: 1.5px solid var(--pharma-primary-light, #38bdf8);
  border-radius: var(--pharma-radius);
  margin-bottom: 2rem;
  box-shadow: var(--pharma-shadow);
  padding: 2rem;
}

.annotation-types-panel h3 {
  font-size: 1.2rem;
  color: var(--pharma-primary-dark);
  margin-bottom: 0.35rem;
  font-weight: 600;
}

.instructions,
.help-text {
  color: var(--pharma-text-soft);
  font-size: 0.97rem;
  opacity: 0.88;
  margin-bottom: 0.7rem;
}

.annotation-types {
  display: flex;
  flex-wrap: wrap;
  gap: 0.65rem;
  margin-bottom: 0.8rem;
}

.annotation-type-btn {
  border-radius: 999px;
  background: var(--pharma-bg-card);
  border: 2px solid var(--pharma-primary);
  color: var(--pharma-primary-dark);
  font-weight: 500;
  font-size: 1rem;
  padding: 0.45rem 1.25rem;
  box-shadow: 0 2px 10px rgba(14,165,233,0.05);
  transition: var(--pharma-transition);
  outline: none;
}
.annotation-type-btn:hover, .annotation-type-btn.active {
  background: var(--pharma-primary);
  color: #fff;
  transform: translateY(-2px) scale(1.07);
  border-color: var(--pharma-primary-dark);
  box-shadow: 0 6px 18px rgba(14,165,233,0.14);
}
.annotation-type-btn-add {
  background: linear-gradient(90deg, var(--pharma-accent), var(--pharma-primary));
  border: none;
  color: #fff;
  font-weight: 600;
  border-radius: 999px;
  font-size: 1rem;
  padding: 0.45rem 1.35rem;
  transition: var(--pharma-transition);
  box-shadow: 0 2px 12px rgba(16,185,129,0.11);
}
.annotation-type-btn-add:hover {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  transform: translateY(-1.5px) scale(1.06);
}

.current-mode {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 12px;
  padding: 0.23rem 1rem;
  font-size: 1.03rem;
  margin-left: 0.7rem;
  font-weight: 600;
}

/* Context Menu */
.context-menu {
  position: absolute;
  background: var(--pharma-bg-card);
  border: 1.5px solid var(--pharma-border);
  border-radius: 12px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.13);
  min-width: 170px;
  z-index: 10010;
  font-size: 1rem;
  padding: 0.1rem;
}
.context-menu-item {
  color: var(--pharma-text);
  padding: 9px 14px;
  background: none;
  width: 100%;
  border: none;
  border-radius: 8px;
  text-align: left;
  transition: background .18s;
}
.context-menu-item:hover { background: #e0f2fe; }
.context-menu-item.danger { color: var(--pharma-error); }
.context-menu-item.danger:hover { background: #ffe4e6; }
.context-menu.hidden { display: none; }

/* Page Navigation */
.page-navigation {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  padding: 1.5rem 2rem;
  margin-bottom: 2.1rem;
}

/* Actions Container */
.actions-container {
  margin-top: 1.5rem;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--pharma-border);
}

.action-group {
  background: var(--pharma-glass);
  border: 1px solid rgba(59, 130, 246, 0.1);
  border-radius: var(--pharma-radius-sm);
  padding: 1.2rem;
  transition: var(--pharma-transition);
}

.action-group:hover {
  border-color: rgba(59, 130, 246, 0.2);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08);
}

.group-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--pharma-primary-dark);
  margin-bottom: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.group-title::before {
  content: '';
  width: 3px;
  height: 16px;
  background: linear-gradient(to bottom, var(--pharma-primary), var(--pharma-accent));
  border-radius: 2px;
}

.buttons-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
}

/* Ajustements des boutons pour la nouvelle disposition */
.buttons-row .btn-groq,
.buttons-row .btn-validate,
.buttons-row .btn-json-page,
.buttons-row .btn-json-document,
.buttons-row .btn-view-json,
.buttons-row .btn-expert {
  font-size: 0.9rem;
  padding: 0.6rem 1.2rem;
  flex: 1;
  min-width: 140px;
  justify-content: center;
}

/* Loading indicators container */
.loading-indicators {
  grid-column: 1 / -1;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(59, 130, 246, 0.05);
  border-radius: var(--pharma-radius-sm);
  border: 1px dashed rgba(59, 130, 246, 0.2);
}

.page-controls { display: flex; align-items: center; gap: 1.5rem; }
.page-selector select {
  padding: 0.48rem 1.1rem;
  border-radius: 12px;
  border: 1.5px solid var(--pharma-primary);
  background: var(--pharma-glass);
  color: var(--pharma-primary-dark);
  font-weight: 600;
  font-size: 1rem;
  outline: none;
  transition: border .18s;
}
.page-selector select:focus {
  border-color: var(--pharma-accent);
}

.nav-btn {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 11px;
  font-size: 1rem;
  padding: 0.5rem 1.4rem;
  font-weight: 600;
  border: none;
  transition: var(--pharma-transition);
  box-shadow: 0 3px 10px rgba(14,165,233,0.11);
  outline: none;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.nav-btn:hover {
  background: var(--pharma-primary);
  color: #fff;
  transform: scale(1.04) translateY(-1px);
  text-decoration: none;
}

.nav-btn-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  padding: 0;
  font-size: 1.2rem;
  background: linear-gradient(135deg, var(--pharma-primary-dark), var(--pharma-primary));
  box-shadow: 0 4px 15px rgba(14,165,233,0.15);
  position: relative;
  overflow: hidden;
}

.nav-btn-icon:hover {
  background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-accent));
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(14,165,233,0.25);
}

.nav-btn-icon:active {
  transform: scale(0.95) translateY(0);
}

.nav-btn-icon i {
  font-size: 1.3rem;
  transition: var(--pharma-transition);
}

.nav-btn-icon:hover i {
  transform: scale(1.1);
}

/* AI, Validate, Expert Buttons */
.ai-controls {
  display: flex;
  align-items: center;
  gap: 1.1rem;
  flex-wrap: wrap;
}

.btn-groq {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-info));
  color: #fff;
  font-weight: 700;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-size: 1.04rem;
  border: none;
  box-shadow: 0 4px 18px rgba(56,189,248,0.08);
  transition: var(--pharma-transition);
}
.btn-groq:hover { background: linear-gradient(90deg, var(--pharma-info), var(--pharma-primary-dark)); }

.btn-mistral {
  background: linear-gradient(90deg, #7D4CDB, #4A3094);
  color: #fff;
  font-weight: 700;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-size: 1.04rem;
  border: none;
  box-shadow: 0 4px 18px rgba(77,76,172,0.15);
  transition: var(--pharma-transition);
  position: relative;
}
.btn-mistral:hover { background: linear-gradient(90deg, #9B6CFF, #7D4CDB); }

.mistral-loading {
  position: absolute;
  right: 10px;
  width: 15px;
  height: 15px;
  color: white;
}

.btn-validate {
  background: var(--pharma-accent);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(16,185,129,0.09);
  transition: var(--pharma-transition);
}
.btn-validate:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}
.btn-validate:hover:not(:disabled) {
  background: #059669;
}

/* NOUVEAUX STYLES POUR LES BOUTONS JSON */
.btn-json-page {
  background: linear-gradient(90deg, #10b981, #059669);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(16,185,129,0.13);
  transition: var(--pharma-transition);
}

.btn-json-page:hover {
  background: linear-gradient(90deg, #059669, #047857);
  color: #fff;
}

.btn-json-document {
  background: linear-gradient(90deg, #f59e0b, #d97706);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(245,158,11,0.13);
  transition: var(--pharma-transition);
}

.btn-json-document:hover {
  background: linear-gradient(90deg, #d97706, #b45309);
  color: #fff;
}

/* Groupement des actions JSON par paires */
.json-action-pair {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
}

/* Boutons JSON ic√¥nes stylis√©s */
.btn-view-json-page,
.btn-view-json-global {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 1.2rem;
  transition: var(--pharma-transition);
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
  position: relative;
  overflow: hidden;
}

.btn-view-json-page {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  border: 2px solid #059669;
}

.btn-view-json-page:hover {
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(16,185,129,0.25);
  text-decoration: none;
}

.btn-view-json-global {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff;
  border: 2px solid #d97706;
}

.btn-view-json-global:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  color: #fff;
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(245,158,11,0.25);
  text-decoration: none;
}

.btn-view-json-page:active,
.btn-view-json-global:active {
  transform: scale(0.95) translateY(0);
}

.btn-view-json-page i,
.btn-view-json-global i {
  font-size: 1.3rem;
  transition: var(--pharma-transition);
}

.btn-view-json-page:hover i,
.btn-view-json-global:hover i {
  transform: scale(1.1);
}

.btn-expert {
  background: linear-gradient(90deg, #6d28d9, #4c1d95 90%);
  color: #fff;
  font-weight: 700;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-size: 1.04rem;
  border: none;
  box-shadow: 0 4px 12px rgba(109,40,217,0.13);
  transition: var(--pharma-transition);
}
.btn-expert:hover { background: linear-gradient(90deg, #7c3aed, #a78bfa 80%); }

.btn-success {
  background: var(--pharma-accent);
  color: #fff !important;
  border-radius: 12px;
  font-weight: 700;
  padding: 0.65rem 1.4rem;
}

.ai-loading, .learning-progress, .regulatory-loading, .json-loading {
  color: var(--pharma-primary-dark);
  font-weight: 500;
  margin-left: 1rem;
}

.json-loading {
  color: var(--pharma-accent);
  font-weight: 500;
  margin-left: 1rem;
}

/* Text Content (Zone principale d'annotation) */
.text-content-card {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1.5px solid var(--pharma-primary-light, #38bdf8);
  margin-bottom: 2.2rem;
  padding: 2rem 2.1rem;
  animation: fadeInUp 0.6s;
}

.text-content-card h3 {
  color: var(--pharma-primary-dark);
  font-size: 1.18rem;
  font-weight: 700;
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 0.7rem;
}

.page-status {
  padding: 0.25rem 1rem;
  border-radius: 999px;
  font-size: 0.92rem;
  font-weight: 700;
  margin-left: 1.1rem;
  box-shadow: 0 2px 7px rgba(59,130,246,0.05);
}
.page-status.validated-human {
  background: #d1fae5;
  color: #047857;
}
.page-status.annotated {
  background: #bae6fd;
  color: var(--pharma-primary-dark);
}
.page-status.pending {
  background: #fef3c7;
  color: #92400e;
}

/* Text content - Enhanced for PDF-like appearance */
.text-content {
    background: #fafbfc;
    border: 1px solid var(--pharma-border);
    border-radius: 12px;
    padding: 2rem;
    line-height: 1.8;
    font-size: 1.05rem;
    color: var(--pharma-text);
    white-space: pre-wrap;
    word-wrap: break-word;
    min-height: 400px;
    width: 100%;
    max-width: 100%;
    cursor: text;
    font-family: 'Inter', 'Georgia', 'Times New Roman', serif;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    hyphens: auto;
    text-align: justify;
    text-justify: inter-word;
    letter-spacing: 0.01em;
    word-spacing: 0.05em;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 2px solid rgba(59, 130, 246, 0.1);
    transition: border-color 0.3s ease;
  }

  .text-content:hover {
    border-color: rgba(59, 130, 246, 0.2);
  }

  /* Add visual structure for better readability */
  .text-content::before {
    content: "";
    display: block;
    width: 100%;
    height: 2px;
    background: linear-gradient(to right,
      transparent,
      rgba(59, 130, 246, 0.2),
      transparent
    );
    margin-bottom: 1.5rem;
  }

  /* Enhanced paragraph spacing for PDF-like structure */
  .text-content p {
    margin-bottom: 1.2rem;
    text-indent: 1.5rem;
  }

  .text-content p:first-child {
    text-indent: 0;
  }

/* Annotations List (as cards) */
.annotations-list {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1.5px solid var(--pharma-border);
  padding: 1.8rem 2rem;
  margin-bottom: 1.8rem;
}
.annotations-list h3 {
  color: var(--pharma-primary-dark);
  font-size: 1.13rem;
  margin-bottom: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.7rem;
}

.annotation-item {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  margin-bottom: 1.1rem;
  padding: 1rem 1.1rem;
  transition: box-shadow .2s, border .2s;
  box-shadow: 0 3px 15px rgba(14,165,233,0.09);
  position: relative;
}
.annotation-item:hover {
  border-color: var(--pharma-primary-dark);
  box-shadow: 0 8px 28px rgba(14,165,233,0.14);
}

.annotation-header {
  display: flex;
  align-items: center;
  gap: 0.7rem;
  margin-bottom: 0.6rem;
}

.annotation-type {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent) 90%);
  color: #fff;
  border-radius: 999px;
  font-size: 0.97rem;
  font-weight: 600;
  padding: 0.24rem 1.05rem;
}

.annotation-confidence {
  background: #bae6fd;
  color: var(--pharma-primary-dark);
  border-radius: 9px;
  font-size: 0.88rem;
  font-weight: 600;
  padding: 0.19rem 0.7rem;
}

.delete-annotation {
  background: none;
  border: none;
  color: var(--pharma-error);
  cursor: pointer;
  padding: 0.3rem 0.7rem;
  border-radius: 7px;
  transition: background .13s;
  margin-left: auto;
}
.delete-annotation:hover { background: #ffe4e6; }

.annotation-text {
  font-style: italic;
  color: var(--pharma-primary-dark);
  font-size: 1.02rem;
  margin-bottom: 0.3rem;
}

.annotation-reasoning {
  font-size: 0.94rem;
  color: var(--pharma-accent);
  display: flex;
  align-items: center;
  gap: 0.29rem;
}

/* RLHF/AI Generated */
.ai-generated .annotation-type {
  background: linear-gradient(90deg, #f59e0b, #fbbf24 80%);
  color: #fff;
}
.rlhf-indicator {
  margin-top: 0.6rem;
  color: var(--pharma-warn);
  font-weight: 700;
  font-size: 0.98rem;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

/* Learning Dashboard Widget */
.learning-dashboard-widget {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  color: #fff;
  padding: 1.25rem 2rem;
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  margin-bottom: 2rem;
  border: none;
  font-size: 1.08rem;
}

.learning-dashboard-widget h4 { color: #fff; font-weight: 700; margin-top: 0; }

.metric {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  margin: 0.35rem 0;
}
.metric-label { font-weight: 600; opacity: 0.87; }
.metric-value { font-size: 1.07rem; font-weight: 700; }
.performance-indicator { font-size: 1.18rem; margin-left: 0.5rem; }
.learning-explanation { font-size: 0.88rem; opacity: 0.89; margin-top: 0.4rem; }

/* Validation Success */
.validation-success {
  background: linear-gradient(90deg, #10b981, #38bdf8);
  color: #fff;
  padding: 1rem 1.6rem;
  border-radius: 14px;
  box-shadow: 0 2px 18px rgba(16,185,129,0.13);
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 1.2rem;
  transition: opacity 0.5s;
}

/* Modal (boost appearance) */
.modal-content {
  background: #fff;
  border-radius: var(--pharma-radius-sm);
  box-shadow: 0 8px 40px rgba(14,165,233,0.23);
  border: none;
}
.modal-header, .modal-footer {
  background: #f1f5f9;
  border: none;
  border-radius: 12px 12px 0 0;
}
.modal-title { color: var(--pharma-primary-dark); font-weight: 600; }
.btn-close { color: var(--pharma-text-soft); }
.btn-primary {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  padding: 0.48rem 1.4rem;
  transition: var(--pharma-transition);
}
.btn-primary:hover { background: var(--pharma-primary); color: #fff; }

/* Responsive pour la nouvelle disposition */
@media (max-width: 900px) {
  .main-content { max-width: 99vw; }
  .annotation-header, .text-content-card, .annotations-list, .learning-dashboard-widget, .annotation-types-panel, .page-navigation, .regulatory-analysis-panel {
    padding: 1.1rem 0.8rem !important;
  }

  .actions-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .buttons-row {
    flex-direction: column;
  }

  .buttons-row .btn-groq,
  .buttons-row .btn-validate,
  .buttons-row .btn-expert {
    font-size: 0.9rem !important;
    padding: 0.7rem 1rem !important;
    min-width: 100%;
  }

  .json-action-pair {
    flex-direction: column;
    gap: 0.8rem;
  }

  .json-action-pair .btn-json-page,
  .json-action-pair .btn-json-document {
    font-size: 0.9rem !important;
    padding: 0.7rem 1rem !important;
    min-width: 100%;
  }

  .btn-view-json-page,
  .btn-view-json-global {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
}

@media (max-width: 700px) {
  .annotation-header, .annotation-types-panel, .text-content-card, .annotations-list, .learning-dashboard-widget, .regulatory-analysis-panel {
    flex-direction: column !important;
    gap: 1rem !important;
  }

  .page-navigation {
    flex-direction: column;
    align-items: stretch;
  }

  .page-controls {
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .header-actions { width: 100%; }
  .regulatory-stats { flex-direction: column; }

  .action-group {
    padding: 1rem;
  }

  .group-title {
    font-size: 0.85rem;
  }
}

/* Animations */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px);}
  to   { opacity: 1; transform: translateY(0);}
}

/* Styles pour le bouton d'√©dition */
.edit-annotation {
  background: none;
  border: none;
  color: var(--pharma-primary);
  cursor: pointer;
  padding: 0.3rem 0.7rem;
  border-radius: 7px;
  transition: background .13s;
  margin-right: 0.5rem;
}

.edit-annotation:hover {
  background: #e0f2fe;
  color: var(--pharma-primary-dark);
}

/* Indicateur de modification humaine */
.human-modified-indicator {
  font-size: 0.85rem;
  color: var(--pharma-accent);
  display: flex;
  align-items: center;
  gap: 0.3rem;
  margin-top: 0.5rem;
  padding: 0.3rem 0.6rem;
  background: #d1fae5;
  border-radius: 6px;
  border-left: 3px solid var(--pharma-accent);
}

/* Styles pour le modal d'√©dition */
.modal-lg {
  max-width: 800px;
}

.annotation-info-panel {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Am√©lioration des champs du formulaire d'√©dition */
#edit-selected-text {
  font-family: 'Courier New', monospace;
  border: 2px solid var(--pharma-border);
  transition: border-color 0.3s ease;
}

#edit-selected-text:focus {
  border-color: var(--pharma-primary);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

#edit-annotation-type {
  border: 2px solid var(--pharma-border);
  transition: border-color 0.3s ease;
}

#edit-annotation-type:focus {
  border-color: var(--pharma-primary);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

/* Style pour les champs de position */
#edit-start-pos, #edit-end-pos {
  background-color: #f8f9fa;
  color: #6c757d;
}

/* Am√©lioration du panel d'information */
.annotation-meta > div {
  margin-bottom: 0.5rem;
  padding-bottom: 0.3rem;
}

.annotation-meta > div:not(:last-child) {
  border-bottom: 1px solid #e9ecef;
}

/* Animation pour le modal */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out;
  transform: translate(0, -50px);
}

.modal.show .modal-dialog {
  transform: none;
}

/* Style pour les boutons du footer du modal */
.modal-footer .btn {
  min-width: 120px;
  font-weight: 600;
}

.modal-footer .btn-primary {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  border: none;
}

.modal-footer .btn-primary:hover {
  background: linear-gradient(90deg, var(--pharma-accent), var(--pharma-primary));
}

/* Prodigy-like Toolbar Styles */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  margin-bottom: 1rem;
  align-items: center;
}

.label-btn {
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.label-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.label-btn.active {
  transform: scale(1.05);
  box-shadow: 0 0 0 3px rgba(0,0,0,0.3);
  border: 2px solid #fff;
}

/* Inline annotation styles - Version am√©lior√©e */
.inline-annotation {
  display: inline;
  border-radius: 2px;
  padding: 0 1px;
  margin: 0;
  cursor: pointer;
  font-weight: normal;
  position: relative;
  transition: all 0.2s ease;
  line-height: inherit;
  font-size: inherit;
  vertical-align: baseline;
  opacity: 0.7;
  text-decoration: none;
  border-bottom: 2px solid rgba(0,0,0,0.1);
}

.inline-annotation:hover {
  opacity: 0.9;
  border-bottom: 2px solid currentColor;
  box-shadow: none;
  transform: none;
}

/* Style de base pour toutes les annotations */
.inline-annotation {
  display: inline;
  padding: 2px 4px;
  margin: 0 1px;
  border-radius: 3px;
  cursor: pointer;
  font-weight: normal;
  position: relative;
  line-height: inherit;
  white-space: normal;
  transition: all 0.2s ease;
}

/* Style sp√©cifique pour la zone de texte brut */
.text-content .inline-annotation {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  margin: 0 2px;
  border-radius: 3px;
  background-color: inherit;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  border: none;
}

.text-content .inline-annotation:hover {
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

/* Style sp√©cifique pour le contenu structur√© - Version ultra-fine */
.structured-content-body .inline-annotation {
  display: inline;
  padding: 2px 1px;
  margin: 0;
  border-radius: 2px;
  text-decoration: none;
  position: relative;
  line-height: inherit;
  vertical-align: baseline;
  background-color: rgba(37, 99, 235, 0.1) !important;
  transition: background-color 0.2s ease;
}

.structured-content-body .inline-annotation::after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  height: 100%;
  background-color: rgba(59, 130, 246, 0.1);
  transition: all 0.2s ease;
}

.structured-content-body .inline-annotation:hover {
  background-color: rgba(37, 99, 235, 0.15) !important;
}

/* Style de base pour les labels d'annotation */
.inline-annotation .ann-label {
  font-size: 0.65rem;
  font-weight: bold;
  padding: 1px 4px;
  border-radius: 3px;
  background: rgba(0,0,0,0.5);
  color: #fff;
  white-space: nowrap;
  line-height: 1;
  position: absolute;
  z-index: 10;
}

/* Style sp√©cifique pour les labels dans le texte brut */
.text-content .inline-annotation .ann-label {
  display: inline-block;
  margin: 0;
  padding: 0 4px;
  background: rgba(0,0,0,0.6);
  border-radius: 3px;
  font-size: 0.75rem;
  position: static;
  transform: none;
  vertical-align: baseline;
}

/* Style sp√©cifique pour les labels dans le contenu structur√© - Version am√©lior√©e */
.structured-content-body .inline-annotation .ann-label {
  display: none;
  position: absolute;
  bottom: -16px;
  left: 50%;
  transform: translateX(-50%) scale(0.9);
  font-size: 0.6rem;
  padding: 1px 4px;
  background: rgba(0,0,0,0.7);
  color: white;
  border-radius: 3px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: all 0.2s ease;
  z-index: 1000;
  line-height: normal;
  margin: 0;
}

.structured-content-body .inline-annotation:hover .ann-label {
  display: block;
  opacity: 1;
  transform: translateX(-50%) scale(1);
}

/* Ajuster l'espacement vertical */
.structured-content-body p + p {
  margin-top: 1em;
}

/* Am√©lioration de la lisibilit√© du contenu structur√© */
.structured-content-body {
  line-height: 1.6;
  font-size: 1rem;
  color: #1a1a1a;
  letter-spacing: normal;
  word-spacing: normal;
}

.structured-content-body p {
  margin: 0.7em 0;
}

/* Pr√©server la structure du document */
.structured-content-body .inline-annotation {
  position: relative;
  z-index: 1;
  display: inline;
  line-height: inherit;
  vertical-align: baseline;
  padding-top: 0;
  padding-bottom: 0;
}

/* Am√©lioration de la lisibilit√© du contenu structur√© */
.structured-content-body {
  line-height: 1.8;
  font-size: 1rem;
  color: #1a1a1a;
  letter-spacing: 0.01em;
}

/* Affichage du label au survol */
.inline-annotation:hover .ann-label {
  display: inline-block;
}

.structured-content-body p {
  margin-bottom: 1em;
}

/* Animation subtile au survol */
.structured-content-body .inline-annotation .ann-label {
  transition: opacity 0.2s ease;
  opacity: 0;
  transform: translateY(2px);
}

.structured-content-body .inline-annotation:hover .ann-label {
  opacity: 1;
  transform: translateY(0);
}

/* Style pour les sections du contenu structur√© */
.structured-content-body h1,
.structured-content-body h2,
.structured-content-body h3,
.structured-content-body h4 {
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  color: #2d3748;
  font-weight: 600;
}

/* Enhanced text content for better selection */
.text-content {
  user-select: text;
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
}

.content-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.tab-btn {
    background: var(--pharma-glass);
    border: 1.5px solid var(--pharma-primary);
    color: var(--pharma-primary-dark);
    border-radius: var(--pharma-radius-sm);
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: var(--pharma-transition);
    cursor: pointer;
}

.tab-btn.active,
.tab-btn:hover {
    background: var(--pharma-primary);
    color: #fff;
    border-color: var(--pharma-primary-dark);
}

.content-panel {
    animation: fadeInUp 0.3s ease;
}

.content-panel.active {
    display: block;
}

.actions {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.toggle-content-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-content-btn:hover {
    background-color: #e9ecef;
}

</style>

<!-- Annotation Header -->
<section class="annotation-header">
  <div class="header-info">
    <h2><i class="fas fa-file-pdf"></i> {{ document.file.name|basename }}</h2>
    <div class="document-meta">
      <span class="meta-item">
        <i class="fas fa-user"></i>
        {{ document.owner.username }}
      </span>
      <span class="meta-item">
        <i class="fas fa-file-alt"></i>
        Page {{ current_page.page_number }} / {{ total_pages }}
      </span>
      <span class="meta-item">
        <i class="fas fa-calendar"></i>
        {{ document.validated_at|date:"d/m/Y" }}
      </span>
    </div>
  </div>

    <div class="header-actions">
      <button class="nav-btn nav-btn-icon me-2" onclick="viewOriginalDocument({{ document.id }})" title="Voir le document original">
        <i class="fas fa-eye"></i>
      </button>
      <a href="{% url 'rawdocs:annotation_dashboard' %}" class="nav-btn nav-btn-icon" title="Retour au dashboard">
        <i class="fas fa-arrow-left"></i>
      </a>
    </div>
</section>

<!-- NOUVELLE SECTION: Analyse R√©glementaire Panel -->
<section class="regulatory-analysis-panel">
  <h3><i class="fas fa-balance-scale"></i> Analyse R√©glementaire du Document</h3>
  <p class="instructions">Analysez automatiquement le contenu r√©glementaire de chaque page et du document complet</p>

  <!-- Statistiques r√©glementaires -->
  <div class="regulatory-stats">
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.analyzed_pages }}</span>
      <span class="regulatory-stat-label">Pages analys√©es</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.completion_percentage }}%</span>
      <span class="regulatory-stat-label">Progression</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.high_importance_pages }}</span>
      <span class="regulatory-stat-label">Pages critiques</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{% if global_analysis %}{{ global_analysis.global_regulatory_score }}{% else %}0{% endif %}</span>
      <span class="regulatory-stat-label">Score global</span>
    </div>
  </div>

  <!-- Barre de progression -->
  <div class="regulatory-progress">
    <div class="progress-bar-regulatory" style="width: {{ regulatory_stats.completion_percentage }}%"></div>
  </div>

  <!-- Boutons d'action r√©glementaire -->
  <div class="regulatory-actions" style="display: flex; gap: 1rem; align-items: center;">
    <button id="analyze-page-regulatory-btn" class="btn-regulatory" onclick="analyzePageRegulatory()">
      <i class="fas fa-gavel"></i> Analyser cette Page
    </button>

    <button id="analyze-document-regulatory-btn" class="btn-regulatory" onclick="analyzeDocumentRegulatory()">
      <i class="fas fa-book-open"></i> Analyser tout le Document
    </button>

    <div id="regulatory-loading" class="regulatory-loading" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> Analyse r√©glementaire en cours...
    </div>
  </div>

  <!-- R√©sum√© global du document si disponible -->
  {% if global_analysis %}
  <div class="document-global-summary" style="margin-top: 1.5rem; padding: 1rem; background: var(--pharma-bg-card); border-radius: 8px; border: 1px solid var(--pharma-border);">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-file-contract"></i> R√©sum√© R√©glementaire Global
    </h4>
    <p style="margin-bottom: 1rem; line-height: 1.6;">{{ global_analysis.global_summary }}</p>

    {% if global_analysis.consolidated_analysis.main_regulatory_themes %}
    <div class="regulatory-themes" style="margin-top: 1rem;">
      <strong style="color: var(--pharma-primary-dark);">Th√®mes principaux:</strong>
      <ul style="margin-top: 0.5rem; padding-left: 1.2rem;">
        {% for theme in global_analysis.consolidated_analysis.main_regulatory_themes %}
        <li style="margin-bottom: 0.3rem;">{{ theme }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}
</section>

<!-- S√âPARATEUR VISUEL CLAIR -->
<div style="
  margin: 3rem 0; 
  height: 60px; 
  background: linear-gradient(135deg, rgba(14,165,233,0.1) 0%, rgba(16,185,129,0.1) 50%, rgba(14,165,233,0.1) 100%); 
  border-radius: 16px; 
  border: 2px solid rgba(14,165,233,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
">
  <div style="
    background: white; 
    padding: 8px 20px; 
    border-radius: 25px; 
    border: 1px solid rgba(14,165,233,0.3);
    box-shadow: 0 4px 12px rgba(14,165,233,0.1);
    font-weight: 600;
    color: var(--pharma-primary-dark);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  ">
    <span>‚öñÔ∏è</span>
    <span>Analyse R√©glementaire</span>
    <span style="margin: 0 8px;">‚Üí</span>
    <span>üìù</span>
    <span>Annotation</span>
  </div>
</div>

<!-- Prodigy-like Annotation Toolbar -->
<section class="annotation-types-panel">
  <h3>Types d'Annotation</h3>
  <p class="instructions">Cliquez sur un type, puis surlignez le texte dans le document</p>
  
  <div class="toolbar" id="label-toolbar">
    {% for ann_type in annotation_types %}
    <button class="label-btn" 
      data-id="{{ ann_type.id }}" 
      data-name="{{ ann_type.name }}" 
      data-color="{{ ann_type.color }}"
      style="background: {{ ann_type.color }}">
      {{ ann_type.display_name }}
    </button>
    {% endfor %}

    <button class="annotation-type-btn-add" data-bs-toggle="modal" data-bs-target="#addAnnotationTypeModal" type="button">
      <i class="fas fa-plus"></i> Add Custom Type
    </button>
    <button id="clear-annotations-btn" class="label-btn" style="background:#6b7280;color:white;">
      üßπ Clear All
    </button>
  </div>

  <!-- Modal pour ajouter un type d'annotation -->
  <div class="modal fade" id="addAnnotationTypeModal" tabindex="-1" aria-labelledby="addAnnotationTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAnnotationTypeModalLabel">Ajouter un type d'annotation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new-annotation-display-name" class="form-label">Nom d'affichage</label>
            <input type="text" class="form-control" id="new-annotation-display-name" required>
          </div>
          <div class="mb-3">
            <label for="new-annotation-name" class="form-label">Nom technique</label>
            <input type="text" class="form-control" id="new-annotation-name" readonly>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="createAnnotationType()">Cr√©er</button>
        </div>
      </div>
    </div>
  </div>

  <div id="context-menu" class="context-menu hidden">
    <button class="context-menu-item danger" onclick="deleteAnnotationTypeFromMenu()">
        <i class="fas fa-trash"></i> Delete Annotation Type
    </button>
    <button class="context-menu-item" onclick="hideContextMenu()">
        <i class="fas fa-times"></i> Cancel
    </button>
  </div>
</section>

<!-- Page Navigation avec disposition am√©lior√©e des boutons -->
<section class="page-navigation">
  <!-- Navigation des pages -->
  <div class="page-controls">
    {% if current_page.page_number > 1 %}
      <a href="?page={{ current_page.page_number|add:'-1' }}" class="nav-btn nav-btn-icon" title="Page pr√©c√©dente">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <div class="page-selector">
      <select id="page-select" onchange="goToPage(this.value)">
        {% for page in pages %}
        <option value="{{ page.page_number }}"
                {% if page.page_number == current_page.page_number %}selected{% endif %}>
          Page {{ page.page_number }}
          {% if page.is_validated_by_human %}üéì{% elif page.is_annotated %}‚úÖ{% endif %}
          {% if page.is_regulatory_analyzed %}‚öñÔ∏è{% endif %}
        </option>
        {% endfor %}
      </select>
    </div>

    {% if current_page.page_number < total_pages %}
      <a href="?page={{ current_page.page_number|add:'1' }}" class="nav-btn nav-btn-icon" title="Page suivante">
        <i class="fas fa-angle-right"></i>
      </a>
    {% endif %}
  </div>

  <!-- Actions organis√©es par cat√©gories -->
  <div class="actions-container">
    <!-- Groupe 1: Actions IA et Validation -->
    <div class="action-group">
      <h4 class="group-title">IA & Validation</h4>
          <div class="buttons-row">
            <button id="groq-annotate-btn" class="btn-groq" onclick="annotateWithGroq()">
              <i class="fas fa-rocket"></i> Annotation AI (Page)
            </button>

            <button id="groq-annotate-all-btn" class="btn-groq" onclick="annotateWithGroqAll()">
              <i class="fas fa-rocket"></i> Annotation AI (Document)
            </button>


        <button id="validate-page-btn" class="btn-validate" onclick="validatePage()"
                {% if current_page.is_validated_by_human %}disabled{% endif %}>
          <i class="fas fa-graduation-cap"></i>
          {% if current_page.is_validated_by_human %}Page Valid√©e{% else %}Validate Page{% endif %}
        </button>
      </div>
    </div>

    <!-- Groupe 2: Actions JSON -->
    <div class="action-group">
      <h4 class="group-title">Export JSON</h4>
      <div class="buttons-row">
        <div class="json-action-pair">
          <button id="generate-page-json-btn" class="btn-json-page" onclick="generatePageJson()">
            <i class="fas fa-code"></i> G√©n√©rer JSON Page
          </button>

          <a href="{% url 'rawdocs:view_page_annotation_json' current_page.id %}"
             class="btn-view-json-page" target="_blank" title="Voir le JSON de cette page">
            <i class="fas fa-file-code"></i>
          </a>
        </div>

        <div class="json-action-pair">
          <button id="generate-document-json-btn" class="btn-json-document" onclick="generateDocumentJson()">
            <i class="fas fa-file-contract"></i> G√©n√©rer JSON Global
          </button>

          <a href="{% url 'rawdocs:view_document_annotation_json' document.id %}"
             class="btn-view-json-global" target="_blank" title="Voir le JSON du document complet">
            <i class="fas fa-book-open"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Groupe 3: R√©vision Expert -->
    <div class="action-group">
      <h4 class="group-title">R√©vision Expert</h4>
      <div class="buttons-row">
        {% if not document.is_ready_for_expert %}
          <button id="submit-document-expert-btn" class="btn-expert" onclick="submitDocumentForExpert()">
            <i class="fas fa-user-graduate"></i>
            Soumission √† l'Expert
          </button>
        {% else %}
          <button class="btn btn-success" disabled>
            <i class="fas fa-check-circle"></i>
            Document Soumis ‚úì
          </button>
        {% endif %}
      </div>
    </div>

    <!-- Indicateurs de chargement -->
    <div class="loading-indicators">
      <div id="ai-loading" class="ai-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> IA en cours...
      </div>

      <div id="learning-progress" class="learning-progress" style="display: none;">
        <i class="fas fa-brain"></i> IA en apprentissage...
      </div>

      <div id="json-loading" class="json-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> G√©n√©ration JSON...
      </div>
    </div>
  </div>
</section>

<!-- Learning Dashboard Widget (identique) -->
<section class="learning-dashboard-widget" id="learning-widget" style="display: none;"></section>

<!-- NOUVELLE SECTION: Analyse R√©glementaire de la Page Courante -->
{% if current_page.is_regulatory_analyzed %}
<section class="page-regulatory-analysis">
  <h3 style="color: var(--pharma-info); margin-bottom: 1rem;">
    <i class="fas fa-gavel"></i>
    Analyse R√©glementaire - Page {{ current_page.page_number }}
    <span class="importance-score {% if current_page.regulatory_importance_score >= 90 %}critical{% elif current_page.regulatory_importance_score >= 70 %}high{% elif current_page.regulatory_importance_score >= 50 %}medium{% else %}low{% endif %}">
      <i class="fas fa-chart-line"></i>
      Score: {{ current_page.regulatory_importance_score }}/100
    </span>
  </h3>

  <!-- R√©sum√© de la page -->
  {% if page_summary %}
  <div class="page-summary" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
    <h4 style="color: var(--pharma-info); margin-bottom: 0.5rem;">
      <i class="fas fa-file-text"></i> R√©sum√© de la Page
    </h4>
    <p style="margin: 0; line-height: 1.6;">{{ page_summary }}</p>
  </div>
  {% endif %}

  <!-- Points cl√©s r√©glementaires -->
  {% if page_analysis.key_regulatory_points %}
  <div class="key-points-list">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-list-ul"></i> Points Cl√©s R√©glementaires
    </h4>
    {% for point in page_analysis.key_regulatory_points %}
    <div class="key-point">{{ point }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Obligations r√©glementaires -->
  {% if page_analysis.regulatory_obligations %}
  <div class="regulatory-obligations">
    <h4 style="color: var(--pharma-warn); margin-bottom: 0.8rem;">
      <i class="fas fa-exclamation-triangle"></i> Obligations R√©glementaires
    </h4>
    {% for obligation in page_analysis.regulatory_obligations %}
    <div class="obligation-item obligation-severity {{ obligation.severity }}">
      <strong>{{ obligation.obligation }}</strong>
      {% if obligation.authority %}
      <div style="margin-top: 0.3rem; font-size: 0.9rem; color: var(--pharma-text-soft);">
        <i class="fas fa-building"></i> {{ obligation.authority }}
      </div>
      {% endif %}
      {% if obligation.deadline %}
      <div style="margin-top: 0.3rem; font-size: 0.9rem; color: var(--pharma-warn);">
        <i class="fas fa-clock"></i> {{ obligation.deadline }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- D√©lais critiques -->
  {% if page_analysis.critical_deadlines %}
  <div class="deadlines-list">
    <h4 style="color: var(--pharma-error); margin-bottom: 0.8rem;">
      <i class="fas fa-hourglass-half"></i> D√©lais Critiques
    </h4>
    {% for deadline in page_analysis.critical_deadlines %}
    <div class="deadline-item">
      <div>
        <strong>{{ deadline.deadline }}</strong>
        {% if deadline.trigger_event %}
        <div style="font-size: 0.9rem; color: var(--pharma-text-soft);">
          D√©clencheur: {{ deadline.trigger_event }}
        </div>
        {% endif %}
      </div>
      <span class="deadline-timeframe">{{ deadline.timeframe }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Autorit√©s mentionn√©es -->
  {% if page_analysis.authorities_mentioned %}
  <div class="authorities-list">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-university"></i> Autorit√©s R√©glementaires
    </h4>
    {% for authority in page_analysis.authorities_mentioned %}
    <span class="authority-tag">{{ authority.name }}</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Documents requis -->
  {% if page_analysis.documents_required %}
  <div class="documents-required" style="margin-top: 1rem;">
    <h4 style="color: var(--pharma-accent); margin-bottom: 0.8rem;">
      <i class="fas fa-folder-open"></i> Documents Requis
    </h4>
    {% for doc in page_analysis.documents_required %}
    <div class="key-point">
      <strong>{{ doc.document }}</strong>
      {% if doc.when %} - √Ä fournir: {{ doc.when }}{% endif %}
      {% if doc.to_whom %} - √Ä: {{ doc.to_whom }}{% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</section>
{% endif %}

<!-- NOUVELLE SECTION: Contenu Structur√© pour Annotateur -->
<!-- √Ä placer apr√®s la section "page-regulatory-analysis" et avant la section "text-content-card main-content" -->

<!-- Section de Contenu Structur√© -->
<section class="structured-content-section">
    <div class="structured-content-header">
        <div class="header">
            <div class="main-info">
                <div class="icon-container">
                    <div class="icon-chip">
                        <i class="fas fa-layer-group"></i>
                    </div>
                </div>
                <div class="title-section">
                    <h3>Contenu Structur√©</h3>
                    <div class="details">
                        <span class="meta-badge info">
                            <i class="fas fa-file-alt"></i> Page {{ current_page.page_number }}
                        </span>
                        <span class="meta-badge warning">
                            <i class="fas fa-lock"></i> Non-√©ditable
                        </span>
                        <span class="meta-badge success">
                            <i class="fas fa-highlighter"></i> Annotations Activ√©es
                        </span>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button class="toggle-content-btn" onclick="toggleStructuredContent()" title="Masquer/Afficher le contenu structur√©">
                    <i class="fas fa-eye-slash"></i>
                    <span>Masquer</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Carte de Contenu Structur√© -->
    <div class="structured-content-card" id="structured-content-container">
        <div class="structured-content-body" id="structured-annotation-area" data-page-id="{{ current_page.id }}">
            {% if document.structured_html %}
                <div class="non-editable-content">
                    {{ document.structured_html|safe }}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="far fa-file"></i>
                    <p>Contenu structur√© en cours de g√©n√©ration...</p>
                    <button class="btn btn-primary" onclick="generateStructuredContent()">
                        <i class="fas fa-play"></i> G√©n√©rer maintenant
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Main Text Content avec l'√©l√©ment page-text OBLIGATOIRE -->
<section class="text-content-card main-content" style="margin-top: 3rem;">
  <h3>
    <i class="fas fa-file-text"></i>
    Page {{ current_page.page_number }} - Zone d'Annotation Principale
    {% if current_page.is_validated_by_human %}
      <span class="page-status validated-human">Valid√©e par humain</span>
    {% elif current_page.is_annotated %}
      <span class="page-status annotated">Annot√©e</span>
    {% else %}
      <span class="page-status pending">En attente</span>
    {% endif %}
    {% if current_page.is_regulatory_analyzed %}
      <span class="page-status" style="background: #e0f2fe; color: var(--pharma-info);">Analys√©e r√©glementairement</span>
    {% endif %}
  </h3>

  <!-- √âL√âMENT MANQUANT CRITIQUE POUR L'ANNOTATION -->
  <div class="text-content" id="page-text" data-page-id="{{ current_page.id }}">{{ current_page.cleaned_text }}</div>

  <!-- Extracted Text Section (votre code existant) -->
  {% if extracted_text %}
  <div class="text-card">
    <h3 class="card-title">
      <i class="fas fa-file-alt"></i> Contenu structur√© extrait
    </h3>

    <!-- Onglets pour choisir l'affichage -->
    <div class="content-tabs" style="margin-bottom: 1rem;">
      <button class="tab-btn active" onclick="showTab('structured')" id="structured-tab">
        <i class="fas fa-layer-group"></i> Vue structur√©e
      </button>
      <button class="tab-btn" onclick="showTab('text')" id="text-tab">
        <i class="fas fa-align-left"></i> Texte brut
      </button>
    </div>

    <!-- Contenu structur√© (par d√©faut) -->
    <div id="structured-content" class="content-panel active">
      {% if structured_html %}
        <div class="structured-display">
          {{ structured_html|safe }}
        </div>
      {% else %}
        <div class="fallback-message">
          <i class="fas fa-exclamation-triangle"></i>
          Le contenu structur√© n'a pas pu √™tre g√©n√©r√©. Affichage du texte brut ci-dessous.
        </div>
        <div class="text-content">
          <pre>{{ extracted_text }}</pre>
        </div>
      {% endif %}
    </div>

    <!-- Contenu texte brut (cach√© par d√©faut) -->
    <div id="text-content" class="content-panel" style="display: none;">
      <pre>{{ extracted_text }}</pre>
    </div>
  </div>
  {% endif %}
</section>

<style>

/* Styles am√©lior√©s pour la section structur√©e */
.structured-content-section {
    margin: 3rem 0;
    background: var(--pharma-bg-card);
    border-radius: var(--pharma-radius);
    box-shadow: var(--pharma-shadow);
    animation: fadeInUp 0.6s;
}

.structured-content-header {
    background: linear-gradient(135deg, var(--pharma-primary) 0%, var(--pharma-accent) 100%);
    border: none;
    border-radius: var(--pharma-radius) var(--pharma-radius) 0 0;
    padding: 2rem;
    position: relative;
    color: white;
    overflow: hidden;
}

.structured-content-header.hidden + .structured-content-card {
    display: none;
}

/* Styles communs pour les boutons d'action */
.toggle-content-btn,
.zoom-content-btn {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 10px 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Styles sp√©cifiques pour le bouton de zoom */
.zoom-content-btn {
    margin-right: 10px;
    background: rgba(255, 255, 255, 0.2);
}

.zoom-content-btn.zoomed i {
    transform: rotate(180deg);
}

.zoom-content-btn.zoomed {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
}

.toggle-content-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
}

.toggle-content-btn:active {
    transform: translateY(0);
}

.toggle-content-btn i {
    font-size: 1.1rem;
    transition: transform 0.3s ease;
}

.toggle-content-btn:hover i {
    transform: scale(1.1);
}

.toggle-content-btn.btn-show {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
}

/* Animations pour le contenu */
@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeOutUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

/* Style pour la section quand le contenu est masqu√© */
.structured-content-section.content-hidden {
    margin-bottom: 1rem;
}

.structured-content-card {
    background: var(--pharma-bg-card);
    border: 1.5px solid var(--pharma-info);
    border-top: none;
    border-radius: 0 0 var(--pharma-radius) var(--pharma-radius);
    box-shadow: var(--pharma-shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: top center;
}

.structured-content-card.zoomed {
    margin: 1rem 0;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 100;
    position: relative;
}

/* Style de la scrollbar pour le contenu zoom√© */
.structured-content-card.zoomed::-webkit-scrollbar {
    width: 8px;
}

.structured-content-card.zoomed::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
}

.structured-content-card.zoomed::-webkit-scrollbar-thumb {
    background: var(--pharma-primary);
    border-radius: 4px;
}

.structured-content-card.zoomed::-webkit-scrollbar-thumb:hover {
    background: var(--pharma-primary-dark);
}

.structured-content-body {
    padding: 2rem;
    line-height: 1.8;
    font-size: 1.05rem;
    color: var(--pharma-text);
    cursor: text;
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    position: relative;
    background: white;
    min-height: 300px;
    border: 1px solid var(--pharma-border);
    border-radius: 0 0 var(--pharma-radius) var(--pharma-radius);
}

.structured-content-body .inline-annotation {
    display: inline-block;
    padding: 2px 4px;
    margin: 0 1px;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.structured-content-body .inline-annotation:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.structured-content-body .ann-label {
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    white-space: nowrap;
}

/* Rendre le contenu non-√©ditable mais s√©lectionnable */
.non-editable-content {
    pointer-events: auto;
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
}

.non-editable-content * {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

/* Indicateur visuel pour le contenu non-√©ditable */
.structured-content-body::before {
    content: "üéØ Zone d'annotation active - S√©lectionnez du texte pour annoter";
    display: block;
    background: var(--pharma-glass);
    color: var(--pharma-primary);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    border: 2px solid var(--pharma-info);
    text-align: center;
    animation: pulseHighlight 2s infinite;
}

@keyframes pulseHighlight {
    0% { border-color: var(--pharma-info); }
    50% { border-color: var(--pharma-accent); }
    100% { border-color: var(--pharma-info); }
}

/* Styles pour la section de contenu structur√© dans l'annotateur */
.structured-content-section {
    margin-bottom: 3rem;
    animation: fadeInUp 0.6s ease-out;
}

.structured-content-header {
    position: relative;
    overflow: hidden;
    border-radius: 20px;
    padding: 24px;
    color: #fff;
    background: linear-gradient(135deg, var(--pharma-accent, #16a34a) 0%, var(--pharma-info, #38bdf8) 40%, var(--pharma-primary, #3b82f6) 100%);
    box-shadow: var(--pharma-shadow);
    margin-bottom: 20px;
    border: none;
    backdrop-filter: blur(20px);
}

.structured-content-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
        radial-gradient(circle at 20% 50%, rgba(255,255,255,.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,.06) 0%, transparent 50%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-10px) rotate(1deg); }
    66% { transform: translateY(5px) rotate(-1deg); }
}

.structured-content-header::after {
    content: '';
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    background: linear-gradient(135deg, var(--pharma-accent, #16a34a), var(--pharma-info, #38bdf8), var(--pharma-primary, #3b82f6));
    border-radius: 22px;
    z-index: -1;
    opacity: 0.3;
    filter: blur(8px);
}

.sh-content { 
    position: relative; 
    z-index: 2; 
}

.header {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: flex-start;
    margin-bottom: 16px;
}

.main-info {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    min-width: 0;
}

.icon-container { 
    position: relative; 
    flex-shrink: 0; 
}

.icon-chip {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(12px);
    border: 2px solid rgba(255,255,255,0.25);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.icon-chip::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s;
}

.icon-chip:hover::before { 
    transform: translateX(100%); 
}

.icon-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

.icon-chip i { 
    font-size: 24px; 
    color: #fff; 
    z-index: 1; 
    position: relative; 
}

.title-section { 
    min-width: 0; 
    flex: 1; 
}

.header h3 {
    margin: 0;
    font-size: 1.5rem;
    line-height: 1.2;
    font-weight: 700;
    letter-spacing: -0.02em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 6px;
    color: #fff;
}

.metadata {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 0.9rem;
    opacity: 0.95;
}

.metadata p { 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    font-weight: 500; 
    margin: 0;
}

.metadata p::before {
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    opacity: 0.8;
    font-size: 0.8rem;
}

.metadata p:first-child::before { content: '\f085'; } /* cogs */
.metadata p:nth-child(2)::before { content: '\f017'; } /* clock */
.metadata p:nth-child(3)::before { content: '\f0ad'; } /* wrench */

.actions { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    justify-content: flex-end; 
    align-items: flex-start; 
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border-radius: 12px;
    text-decoration: none;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-weight: 600;
    font-size: 0.85rem;
    backdrop-filter: blur(12px);
    transition: all 0.3s ease;
    white-space: nowrap;
    cursor: pointer;
}

.btn:hover {
    background: rgba(255,255,255,0.2);
    transform: translateY(-1px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    border-color: rgba(255,255,255,0.4);
    color: #fff;
    text-decoration: none;
}

.btn-primary { 
    background: rgba(255,255,255,0.2); 
    border-color: rgba(255,255,255,0.3); 
    position: relative; 
    overflow: hidden; 
}

.btn-primary::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s;
}

.btn-primary:hover::before { 
    transform: translateX(100%); 
}

.btn-primary:hover { 
    background: rgba(255,255,255,0.25); 
    transform: translateY(-2px); 
}

.details {
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
}

.meta-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 50px;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.3px;
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}

.meta-badge:hover { 
    background: rgba(255,255,255,0.18); 
    transform: translateY(-1px); 
}

.meta-badge i { 
    opacity: 0.9; 
    font-size: 0.75rem; 
}

.meta-badge.success { 
    background: rgba(34,197,94,0.15); 
    border-color: rgba(34,197,94,0.3); 
    color: #fff; 
}

.meta-badge.warning { 
    background: rgba(251,191,36,0.15); 
    border-color: rgba(251,191,36,0.3); 
    color: #fff; 
}

.meta-badge.info { 
    background: rgba(59,130,246,0.15); 
    border-color: rgba(59,130,246,0.3); 
    color: #fff; 
}

.structured-content-card {
    background: var(--pharma-bg-card);
    border: 1.5px solid var(--pharma-border);
    border-radius: var(--pharma-radius);
    box-shadow: var(--pharma-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.structured-content-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--pharma-accent), var(--pharma-info), var(--pharma-primary));
    border-radius: var(--pharma-radius) var(--pharma-radius) 0 0;
}

.structured-content-card:hover {
    box-shadow: 0 10px 25px -3px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.structured-content-body {
    padding: 2rem;
    user-select: text;
    -webkit-user-select: text;
    line-height: 1.6;
}

.structured-content-body * {
    pointer-events: auto;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state p {
    font-size: 1.1rem;
    margin-bottom: 20px;
}

.empty-state .btn {
    background: linear-gradient(135deg, var(--pharma-primary) 0%, var(--pharma-accent) 100%);
    border: none;
    color: #fff;
    padding: 12px 24px;
}

.empty-state .btn:hover {
    background: linear-gradient(135deg, var(--pharma-accent) 0%, var(--pharma-primary) 100%);
    color: #fff;
    transform: translateY(-2px);
}

/* Animation de collapse/expand */
.structured-content-card.collapsed .structured-content-body {
    display: none;
}

.structured-content-card.collapsed {
    margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .structured-content-header { 
        padding: 16px; 
        border-radius: 16px; 
    }
    
    .header { 
        grid-template-columns: 1fr; 
        gap: 16px; 
    }
    
    .main-info { 
        gap: 12px; 
    }
    
    .icon-chip { 
        width: 50px; 
        height: 50px; 
        border-radius: 12px; 
    }
    
    .icon-chip i { 
        font-size: 20px; 
    }
    
    .header h3 { 
        font-size: 1.25rem; 
    }
    
    .metadata { 
        flex-direction: column; 
        gap: 6px; 
    }
    
    .actions { 
        justify-content: flex-start; 
        gap: 6px; 
    }
    
    .btn { 
        padding: 8px 12px; 
        font-size: 0.8rem; 
    }
    
    .details { 
        gap: 6px; 
    }
    
    .meta-badge { 
        padding: 6px 10px; 
        font-size: 0.75rem; 
    }

    .structured-content-body {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .main-info { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 12px; 
    }
    
    .actions { 
        width: 100%; 
    }
    
    .btn { 
        flex: 1; 
        justify-content: center; 
    }
}

/* Animation de fadeIn */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// JavaScript pour la gestion du contenu structur√© dans l'annotateur

function toggleStructuredContent() {
    const container = document.getElementById('structured-content-container');
    const toggleText = document.getElementById('toggle-text');
    const icon = document.querySelector('.toggle-structured-btn i');
    
    if (container.classList.contains('collapsed')) {
        container.classList.remove('collapsed');
        toggleText.textContent = 'Masquer';
        icon.className = 'fas fa-eye';
    } else {
        container.classList.add('collapsed');
        toggleText.textContent = 'Afficher';
        icon.className = 'fas fa-eye-slash';
    }
}

function regenerateStructuredContent() {
    if (!confirm('R√©g√©n√©rer le contenu structur√© ? Cette op√©ration peut prendre quelques minutes.')) {
        return;
    }

    const documentId = {{ document.id }};
    const loading = showStructuredLoadingIndicator('R√©g√©n√©ration en cours...');

    fetch(`/structured/regenerate/${documentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideStructuredLoadingIndicator(loading);
        if (data.success) {
            showStructuredSuccess('Contenu structur√© r√©g√©n√©r√© avec succ√®s');
            // Recharger la section structured content
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        hideStructuredLoadingIndicator(loading);
        console.error('Erreur r√©g√©n√©ration:', error);
        alert('Erreur lors de la r√©g√©n√©ration du contenu structur√©');
    });
}

function generateStructuredContent() {
    if (!confirm('G√©n√©rer le contenu structur√© ? Cette op√©ration peut prendre quelques minutes.')) {
        return;
    }

    const documentId = {{ document.id }};
    const loading = showStructuredLoadingIndicator('G√©n√©ration en cours...');

    fetch(`/structured/generate/${documentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideStructuredLoadingIndicator(loading);
        if (data.success) {
            showStructuredSuccess('Contenu structur√© g√©n√©r√© avec succ√®s');
            // Remplacer le contenu de l'empty state
            const host = document.getElementById('structured-host');
            if (host && data.structured_html) {
                host.innerHTML = data.structured_html;
            }
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        hideStructuredLoadingIndicator(loading);
        console.error('Erreur g√©n√©ration:', error);
        alert('Erreur lors de la g√©n√©ration du contenu structur√©');
    });
}

function showStructuredLoadingIndicator(message) {
    const loading = document.createElement('div');
    loading.className = 'validation-success';
    loading.innerHTML = `
        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
        <div>
            <strong>${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                Veuillez patienter...
            </div>
        </div>
    `;
    loading.id = 'structured-loading-indicator';

    const section = document.querySelector('.structured-content-section');
    if (section) {
        section.parentNode.insertBefore(loading, section);
    }

    return loading;
}

function hideStructuredLoadingIndicator(loading) {
    if (loading && loading.parentNode) {
        loading.parentNode.removeChild(loading);
    }
}

function showStructuredSuccess(message) {
    const success = document.createElement('div');
    success.className = 'validation-success';
    success.innerHTML = `
        <i class="fas fa-layer-group" style="font-size: 1.5rem;"></i>
        <div>
            <strong>‚úÖ ${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                Le contenu structur√© a √©t√© mis √† jour
            </div>
        </div>
    `;

    const section = document.querySelector('.structured-content-section');
    if (section) {
        section.parentNode.insertBefore(success, section);
        setTimeout(() => success.remove(), 5000);
    }
}

// Initialiser l'√©tat collapsed par d√©faut si souhait√©
document.addEventListener('DOMContentLoaded', function() {
    // Optionnel: commencer avec la section repli√©e
    // const container = document.getElementById('structured-content-container');
    // if (container) {
    //     container.classList.add('collapsed');
    //     document.getElementById('toggle-text').textContent = 'Afficher';
    //     document.querySelector('.toggle-structured-btn i').className = 'fas fa-eye-slash';
    // }
});
</script>

<script src="{% static 'rawdocs/js/rlhf_annotation.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Combined Prodigy-like + Existing functionality JavaScript
let annotationTypeMap = {};
let selectedAnnotationType = null;
let selectedColor = null;
let currentLabel = null;
let currentEditingAnnotationId = null;
let editModal = null;
let contextMenuTarget = null;

// Fonction pour charger les annotations dans le contenu structur√©
function loadAnnotationsInStructuredContent() {
    const pageId = document.getElementById('page-text')?.dataset?.pageId;
    if (!pageId) return;

    fetch(`/annotation/page/${pageId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.annotations && data.annotations.length > 0) {
                const structuredContent = document.querySelector('.structured-content-body');
                if (structuredContent) {
                    // Pour chaque annotation, ajouter au contenu structur√©
                    data.annotations.forEach(annotation => {
                        // Pour chaque annotation, r√©cup√©rer la couleur du type d'annotation
                        let annotationType = document.querySelector(`.label-btn[data-name="${annotation.type}"]`);
                        let color = annotationType ? annotationType.dataset.color : '#ffeb3b';
                        
                        const text = annotation.selected_text;
                        const type = annotation.type;
                        
                        // Convertir le texte en format HTML safe pour la recherche
                        const textAsHtml = text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#039;');
                                
                        // Cr√©er un regex qui prend en compte le format HTML
                        const regexEscaped = textAsHtml.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(regexEscaped, 'g');
                        
                        // Convertir la couleur hex en RGB pour l'utiliser avec opacity
                        const getRGB = (hex) => {
                            const r = parseInt(hex.slice(1, 3), 16);
                            const g = parseInt(hex.slice(3, 5), 16);
                            const b = parseInt(hex.slice(5, 7), 16);
                            return `${r}, ${g}, ${b}`;
                        };
                        
                        // Cr√©er le span d'annotation avec le nouveau style
                        const annotationSpan = `<span class="inline-annotation" 
                                                   style="background-color: ${color}">
                                                ${textAsHtml}
                                                <span class="ann-label">${type}</span>
                                             </span>`;
                        
                        // Remplacer uniquement si le texte existe et n'est pas d√©j√† dans un span d'annotation
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = structuredContent.innerHTML;
                        const textNodes = [];
                        
                        function findTextNodes(node) {
                            if (node.nodeType === 3) { // Text node
                                textNodes.push(node);
                            } else if (node.nodeType === 1 && !node.classList.contains('inline-annotation')) {
                                for (const child of node.childNodes) {
                                    findTextNodes(child);
                                }
                            }
                        }
                        
                        findTextNodes(tempDiv);
                        
                        textNodes.forEach(node => {
                            const nodeContent = node.textContent;
                            if (nodeContent.includes(text)) {
                                const newContent = nodeContent.replace(regex, annotationSpan);
                                const span = document.createElement('span');
                                span.innerHTML = newContent;
                                node.parentNode.replaceChild(span, node);
                            }
                        });
                        
                        structuredContent.innerHTML = tempDiv.innerHTML;
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading annotations for structured content:', error);
        });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Build type mapping
    {% for ann_type in annotation_types %}
    annotationTypeMap['{{ ann_type.name|escapejs }}'] = {{ ann_type.id }};
    {% endfor %}

    console.log('üìã Annotation type mapping loaded:', annotationTypeMap);

    // Initialize Prodigy-like toolbar
    initializeProdigyToolbar();
    
    // Load and render existing annotations in both areas
    loadAndRenderAnnotations();
    loadAnnotationsInStructuredContent(); // Ajout de cette ligne
    
    // Initialize modals and existing functionality
    initializeModals();
    initializeExistingFunctionality();
    
    // Charger automatiquement les types d'annotation sugg√©r√©s par Mistral
    loadMistralAnnotationTypes();
});

function showTab(tabName) {
    // Hide all tab contents
    const contents = document.getElementsByClassName('content-panel');
    for (let content of contents) {
        content.style.display = 'none';
    }

    // Show the selected tab content
    document.getElementById(tabName + '-content').style.display = 'block';

    // Update active tab button
    const tabs = document.getElementsByClassName('tab-btn');
    for (let tab of tabs) {
        tab.classList.remove('active');
    }
    document.getElementById(tabName + '-tab').classList.add('active');
}

function initializeProdigyToolbar() {
    const pageEl = document.getElementById("page-text");
    const structuredArea = document.getElementById("structured-annotation-area");

    // G√©rer les boutons de type d'annotation (code existant)
    document.querySelectorAll(".label-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            // Remove active from all
            document.querySelectorAll(".label-btn").forEach(b => b.classList.remove("active"));
            
            // Skip if it's a special button
            if (btn.id === 'clear-annotations-btn' || btn.classList.contains('annotation-type-btn-add')) {
                return;
            }
            
            // Activate selected
            btn.classList.add("active");
            currentLabel = {
                id: btn.dataset.id,
                name: btn.dataset.name,
                color: btn.dataset.color
            };
            
            // Update for compatibility with existing code
            selectedAnnotationType = btn.dataset.name;
            selectedColor = btn.dataset.color;
        });
        
        // Add right-click context menu (keep existing functionality)
        if (!btn.classList.contains('annotation-type-btn-add') && btn.id !== 'clear-annotations-btn') {
            btn.addEventListener('contextmenu', handleRightClick);
        }
    });

    // Ajouter les √©v√©nements de s√©lection pour les deux zones
    if (pageEl) {
        pageEl.addEventListener("mouseup", handleTextSelection);
    }
    
    if (structuredArea) {
        structuredArea.addEventListener("mouseup", handleTextSelection);
        
        // Emp√™cher l'√©dition mais permettre la s√©lection
        structuredArea.addEventListener("keydown", function(e) {
            if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown' && 
                e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' &&
                !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
            }
        });
        
        structuredArea.addEventListener("paste", function(e) {
            e.preventDefault();
        });
    }
    
    // Clear button (code existant)
    document.getElementById("clear-annotations-btn").addEventListener("click", () => {
        if (confirm('Effacer toutes les annotations de cette page ?')) {
            clearPageAnnotations();
        }
    });
}

function loadAndRenderAnnotations() {
    const pageEl = document.getElementById("page-text");
    const pageId = pageEl.dataset.pageId;
    
    // Store the original clean text
    const originalText = `{{ current_page.cleaned_text|escapejs }}`;
    
    console.log('üîÑ Loading annotations for page:', pageId);
    
    // Load annotations from backend
    fetch(`/annotation/page/${pageId}/`)
        .then(response => response.json())
        .then(data => {
            console.log('üì• Received annotation data:', data);
            
            if (data.success && data.annotations && data.annotations.length > 0) {
                console.log(`‚úÖ Found ${data.annotations.length} annotations to render`);
                
                // Use the original text for rendering
                renderInlineAnnotations(originalText, data.annotations);
            } else {
                console.log('‚ÑπÔ∏è No annotations found, showing clean text');
                pageEl.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading annotations:', error);
            pageEl.textContent = originalText;
        });
}


function renderInlineAnnotations(originalText, annotations) {
    const pageEl = document.getElementById("page-text");
    
    if (!annotations || annotations.length === 0) {
        pageEl.textContent = originalText;
        return;
    }
    
    console.log('üé® Rendering', annotations.length, 'annotations');
    
    // Start with clean text
    let cleanText = originalText;
    let workingText = cleanText;
    
    // Sort annotations by length (longest first) to avoid overlapping issues
    const sortedAnnotations = [...annotations].sort((a, b) => b.selected_text.length - a.selected_text.length);
    
    let processedAnnotations = 0;
    
    for (let ann of sortedAnnotations) {
        const searchText = ann.selected_text.trim();
        
        // Find the text in the working text (case-insensitive)
        const searchTextLower = searchText.toLowerCase();
        const workingTextLower = workingText.toLowerCase();
        
        let startIndex = workingTextLower.indexOf(searchTextLower);
        
        if (startIndex !== -1) {
            // Get the actual text (preserving case)
            const actualText = workingText.slice(startIndex, startIndex + searchText.length);
            
            // Create the replacement HTML
            const annotationHtml = `<span class="inline-annotation" data-annotation-id="${ann.id}" style="background:${ann.color}; padding: 2px 4px; margin: 0 1px; border-radius: 3px; cursor: pointer;">${actualText}<span class="ann-label">${ann.type_display}</span></span>`;
            
            // Replace the text
            workingText = workingText.slice(0, startIndex) + annotationHtml + workingText.slice(startIndex + searchText.length);
            
            processedAnnotations++;
            console.log('‚úÖ Processed annotation:', searchText);
        } else {
            console.log('‚ùå Could not find text in document:', searchText);
        }
    }
    
    console.log(`üé® Successfully processed ${processedAnnotations}/${annotations.length} annotations`);
    
    // Set the HTML content
    pageEl.innerHTML = workingText;

    // Add click events for deletion
    pageEl.querySelectorAll('.inline-annotation').forEach(annotation => {
        annotation.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.getSelection().removeAllRanges();
            
            const annotationId = this.dataset.annotationId;
            const annotationText = this.textContent.replace(this.querySelector('.ann-label').textContent, '').trim();
            
            // Remplacer l'√©l√©ment annot√© par son texte brut
            const textNode = document.createTextNode(annotationText);
            this.parentNode.replaceChild(textNode, this);
            
            // Supprimer l'annotation de la base de donn√©es
            deleteAnnotationFromDB(annotationId);
        });
    });
    
    console.log('üé® Annotations rendered successfully');
}


function handleTextSelection() {
    const selection = window.getSelection();
    
    if (!selection.rangeCount || !selection.toString().trim()) {
        return;
    }

    // V√©rifier si on est dans une annotation existante
    const range = selection.getRangeAt(0);
    if (isWithinAnnotation(range)) {
        selection.removeAllRanges();
        return;
    }

    if (!currentLabel) {
        showSelectionAlert('Veuillez d\'abord s√©lectionner un type d\'annotation');
        return;
    }

    const selectedText = selection.toString().trim();
    
    // D√©terminer quelle zone utiliser (page-text ou structured-annotation-area)
    let targetArea = null;
    let pageId = null;
    
    // V√©rifier d'abord la zone de texte principal
    const pageTextElement = document.getElementById("page-text");
    if (pageTextElement && pageTextElement.contains(range.commonAncestorContainer)) {
        targetArea = pageTextElement;
        pageId = targetArea.dataset.pageId;
    } 
    // Puis v√©rifier la zone structur√©e
    else if (document.getElementById("structured-annotation-area") && 
             document.getElementById("structured-annotation-area").contains(range.commonAncestorContainer)) {
        targetArea = document.getElementById("structured-annotation-area");
        pageId = targetArea.dataset.pageId;
    }
    
    if (!targetArea || !pageId) {
        showSelectionAlert('Veuillez s√©lectionner du texte dans une zone d\'annotation valide');
        return;
    }

    // Reste du code existant...
    const cleanText = targetArea.textContent || targetArea.innerText;
    let startPos = cleanText.toLowerCase().indexOf(selectedText.toLowerCase());
    
    if (startPos === -1) {
        showSelectionAlert('Impossible de localiser le texte s√©lectionn√©.');
        return;
    }
    
    const endPos = startPos + selectedText.length;

    // Cr√©er l'annotation visuelle (code existant)
    const span = document.createElement("span");
    span.classList.add("inline-annotation");
    span.setAttribute("data-annotation-id", "temp-" + Date.now());
    span.style.background = currentLabel.color;
    span.style.padding = "2px 4px";
    span.style.margin = "0 1px";
    span.style.borderRadius = "3px";
    span.style.cursor = "pointer";
    span.innerHTML = selectedText + `<span class="ann-label" style="font-size: 0.7rem; font-weight: bold; margin-left: 4px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.6); color: #fff; white-space: nowrap;">${currentLabel.name}</span>`;

    addClickHandlerToTempAnnotation(span);

    try {
        range.deleteContents();
        range.insertNode(span);
    } catch (e) {
        console.error('Error inserting annotation:', e);
    }

    // Sauvegarder en base
    saveManualAnnotation({
        page_id: pageId,
        type_id: currentLabel.id,
        selected_text: selectedText,
        start_pos: startPos,
        end_pos: endPos
    });

    selection.removeAllRanges();
}

function isWithinAnnotation(range) {
    const startContainer = range.startContainer;
    const endContainer = range.endContainer;
    
    // V√©rifier si la s√©lection est dans une annotation existante
    let withinAnnotation = false;
    
    [startContainer, endContainer].forEach(container => {
        let node = container;
        while (node && node !== document.body) {
            if (node.nodeType === Node.ELEMENT_NODE && 
                node.classList && node.classList.contains('inline-annotation')) {
                withinAnnotation = true;
                break;
            }
            node = node.parentNode;
        }
    });
    
    return withinAnnotation;
}

function showSelectionAlert(message) {
    const alert = document.createElement('div');
    alert.className = 'validation-success';
    alert.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
    alert.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.body.appendChild(alert);
    
    setTimeout(() => alert.remove(), 3000);
}

// Fonction pour g√©rer le zoom du contenu structur√©
function toggleZoom() {
    const container = document.getElementById('structured-content-container');
    const btn = document.querySelector('.zoom-content-btn');
    const btnIcon = btn.querySelector('i');
    const btnText = btn.querySelector('span');
    
    if (container.classList.contains('zoomed')) {
        // D√©zoomer
        container.classList.remove('zoomed');
        container.style.transform = 'scale(1)';
        container.style.maxHeight = '';
        container.style.overflowY = '';
        btnIcon.className = 'fas fa-search-plus';
        btnText.textContent = 'Zoom';
        btn.classList.remove('zoomed');
    } else {
        // Zoomer
        container.classList.add('zoomed');
        container.style.transform = 'scale(1.1)';
        container.style.maxHeight = '80vh';
        container.style.overflowY = 'auto';
        btnIcon.className = 'fas fa-search-minus';
        btnText.textContent = 'D√©zoom';
        btn.classList.add('zoomed');
    }
}

function toggleStructuredContent() {
    const section = document.querySelector('.structured-content-section');
    const container = document.getElementById('structured-content-container');
    const btn = document.querySelector('.toggle-content-btn');
    const btnIcon = btn.querySelector('i');
    const btnText = btn.querySelector('span');
    
    if (container.style.display === 'none') {
        // Afficher le contenu
        container.style.display = 'block';
        container.style.animation = 'fadeInDown 0.3s ease-out';
        btnIcon.className = 'fas fa-eye-slash';
        btnText.textContent = 'Masquer';
        btn.classList.remove('btn-show');
        section.classList.remove('content-hidden');
    } else {
        // Masquer le contenu
        container.style.animation = 'fadeOutUp 0.3s ease-out';
        setTimeout(() => {
            container.style.display = 'none';
            section.classList.add('content-hidden');
        }, 280);
        btnIcon.className = 'fas fa-eye';
        btnText.textContent = 'Afficher';
        btn.classList.add('btn-show');
    }
}

function makeContentNonEditable() {
    const structuredArea = document.getElementById("structured-annotation-area");
    if (!structuredArea) return;
    
    // D√©sactiver tous les √©l√©ments √©ditables
    const editableElements = structuredArea.querySelectorAll('input, textarea, select, button, [contenteditable]');
    editableElements.forEach(element => {
        element.disabled = true;
        element.style.pointerEvents = 'none';
        element.style.background = '#e9ecef';
        element.style.cursor = 'not-allowed';
        if (element.hasAttribute('contenteditable')) {
            element.removeAttribute('contenteditable');
        }
    });
    
    // Emp√™cher la modification directe du texte
    structuredArea.addEventListener('input', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    });
    
    structuredArea.addEventListener('beforeinput', function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    });
}

// Appeler cette fonction apr√®s le chargement
document.addEventListener('DOMContentLoaded', function() {
    // Votre code existant...
    
    // Rendre le contenu non-√©ditable
    setTimeout(makeContentNonEditable, 100);
});

function deleteAnnotationFromDB(annotationId) {
    // Supprimer l'annotation de la base de donn√©es sans recharger la page
    fetch(`/annotation/${annotationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Annotation supprim√©e avec succ√®s:', annotationId);
        } else {
            console.error('Delete failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting annotation:', error);
    });
}

function deleteAnnotationSimple(annotationId) {
    // No confirmation, immediate delete like Prodigy
    fetch(`/annotation/${annotationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Immediately reload annotations to show updated state
            loadAndRenderAnnotations();
        } else {
            console.error('Delete failed:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting annotation:', error);
    });
}

function clearPageAnnotations() {
    const pageId = document.getElementById("page-text").dataset.pageId;
    
    // Clear all annotations for this page
    fetch(`/clear_page_annotations/${pageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Nettoyer la zone principale
            loadAndRenderAnnotations();
            
            // Nettoyer le contenu structur√©
            const structuredContent = document.querySelector('.structured-content-body');
            if (structuredContent) {
                // Sauvegarder le contenu texte original sans annotations
                const originalText = structuredContent.innerText;
                
                // Supprimer toutes les annotations
                const annotations = structuredContent.querySelectorAll('.inline-annotation');
                annotations.forEach(annotation => {
                    const textNode = document.createTextNode(annotation.textContent.replace(annotation.querySelector('.ann-label').textContent, ''));
                    annotation.parentNode.replaceChild(textNode, annotation);
                });
                
                // Normaliser les n≈ìuds de texte adjacents
                structuredContent.normalize();
            }
            
            showSuccessMessage('Toutes les annotations ont √©t√© supprim√©es');
        }
    })
    .catch(error => {
        console.error('Error clearing annotations:', error);
        showErrorMessage('Erreur lors de la suppression des annotations');
    });
}

function saveManualAnnotation(data) {
    fetch('/annotation/manual/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log('‚úÖ Annotation enregistr√©e avec succ√®s, ID:', result.annotation_id);
            
            // Trouver l'annotation temporaire et mettre √† jour son ID avec l'ID r√©el
            const tempAnnotations = document.querySelectorAll('.inline-annotation[data-annotation-id^="temp-"]');
            if (tempAnnotations.length > 0) {
                // Prendre la derni√®re annotation temporaire cr√©√©e
                const latestTemp = tempAnnotations[tempAnnotations.length - 1];
                latestTemp.dataset.annotationId = result.annotation_id;
                
                // Mettre √† jour l'indicateur visuel pour montrer que l'enregistrement est r√©ussi
                const indicator = latestTemp.querySelector('.saving-indicator');
                if (indicator) {
                    indicator.style.background = "#4CAF50"; // Vert pour indiquer le succ√®s
                    indicator.title = "Annotation enregistr√©e";
                    
                    // Faire dispara√Ætre l'indicateur apr√®s 2 secondes
                    setTimeout(() => {
                        indicator.style.opacity = "0";
                        indicator.style.transition = "opacity 0.5s ease";
                        
                        // Supprimer compl√®tement l'indicateur apr√®s la transition
                        setTimeout(() => indicator.remove(), 500);
                    }, 2000);
                }
            }
        } else {
            console.error('‚ùå Erreur lors de l\'enregistrement:', result.error);
            alert('Erreur: ' + result.error);
            
            // Si l'enregistrement a √©chou√©, supprimer l'annotation temporaire
            const tempAnnotations = document.querySelectorAll('.inline-annotation[data-annotation-id^="temp-"]');
            if (tempAnnotations.length > 0) {
                tempAnnotations[tempAnnotations.length - 1].remove();
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de la sauvegarde');
        
        // En cas d'erreur, supprimer l'annotation temporaire
        const tempAnnotations = document.querySelectorAll('.inline-annotation[data-annotation-id^="temp-"]');
        if (tempAnnotations.length > 0) {
            tempAnnotations[tempAnnotations.length - 1].remove();
        }
    });
}

function addClickHandlerToTempAnnotation(span) {
    span.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.getSelection().removeAllRanges();
        
        // Pour les annotations temporaires, supprimer simplement visuellement
        if (this.dataset.annotationId.startsWith('temp-')) {
            this.remove();
        } else {
            // R√©cup√©rer le texte sans le label
            const annotationText = this.textContent.replace(this.querySelector('.ann-label') ? this.querySelector('.ann-label').textContent : '', '').trim();
            
            // Remplacer l'√©l√©ment annot√© par son texte brut
            const textNode = document.createTextNode(annotationText);
            this.parentNode.replaceChild(textNode, this);
            
            // Supprimer l'annotation de la base de donn√©es
            deleteAnnotationFromDB(this.dataset.annotationId);
        }
    });
}

// Position calculation function for annotated text
function getTextPosition(container, node, offset) {
    let position = 0;
    const walker = document.createTreeWalker(
        container,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );

    let currentNode;
    while (currentNode = walker.nextNode()) {
        if (currentNode === node) {
            return position + offset;
        }
        position += currentNode.textContent.length;
    }
    return position;
}

function getAnnotationTypeId(typeName) {
    console.log('üîç Looking for type:', typeName);
    console.log('üìã Available types:', annotationTypeMap);

    const typeId = annotationTypeMap[typeName];
    if (!typeId) {
        console.error('‚ùå Type ID not found for:', typeName);
        console.error('Available types:', Object.keys(annotationTypeMap));
        return null;
    }

    console.log('‚úÖ Found type ID:', typeId, 'for type:', typeName);
    return typeId;
}

// Initialize existing functionality
function initializeModals() {
    const editModalElement = document.getElementById('editAnnotationModal');
    if (editModalElement) {
        editModal = new bootstrap.Modal(editModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
}

function initializeExistingFunctionality() {
    // Auto-generate technical name from display name
    const displayNameInput = document.getElementById('new-annotation-display-name');
    if (displayNameInput) {
        displayNameInput.addEventListener('input', function() {
            const displayName = this.value;
            const technicalName = displayName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            document.getElementById('new-annotation-name').value = technicalName;
        });
    }

    // Mark validated pages
    const validateBtn = document.getElementById('validate-page-btn');
    if (validateBtn?.textContent?.includes('Valid√©e')) {
        showLearningWidget({});
    }

    // Add indicators to AI-generated annotations
    document.querySelectorAll('.annotation-item').forEach(annotation => {
        if (annotation.querySelector('.annotation-reasoning')?.textContent?.includes('RLHF')) {
            annotation.classList.add('ai-generated');
            const indicator = document.createElement('div');
            indicator.className = 'rlhf-indicator';
            indicator.innerHTML = '<i class="fas fa-brain"></i> IA Apprenante';
            annotation.appendChild(indicator);
        }
    });

    // Context menu functionality
    addContextMenuToButtons();

    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });

    // Prevent default context menu on annotation buttons
    document.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('label-btn')) {
            e.preventDefault();
        }
    });
}

// ALL YOUR EXISTING FUNCTIONS - Keep everything below exactly as is:

// Regulatory Analysis Functions
function analyzePageRegulatory() {
    const btn = document.getElementById('analyze-page-regulatory-btn');
    const loading = document.getElementById('regulatory-loading');

    btn.disabled = true;
    loading.style.display = 'inline-flex';

    const pageId = document.getElementById('page-text').dataset.pageId;

    fetch(`/regulatory/analyze-page/${pageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showRegulatorySuccess(data.message, data.importance_score);
            // Clear existing annotations visually first, then reload fresh
            setTimeout(() => {
                loadAndRenderAnnotations();
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur analyse r√©glementaire:', error);
        alert('Erreur lors de l\'analyse r√©glementaire');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
    });
}

function analyzeDocumentRegulatory() {
    if (!confirm('Analyser tout le document peut prendre plusieurs minutes. Continuer ?')) {
        return;
    }

    const btn = document.getElementById('analyze-document-regulatory-btn');
    const loading = document.getElementById('regulatory-loading');

    btn.disabled = true;
    loading.style.display = 'inline-flex';
    loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse compl√®te en cours...';

    const documentId = {{ document.id }};

    fetch(`/regulatory/analyze-document/${documentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showRegulatorySuccess(data.message, data.global_score);
            setTimeout(() => location.reload(), 3000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur analyse document:', error);
        alert('Erreur lors de l\'analyse du document');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse r√©glementaire en cours...';
    });
}

function showRegulatorySuccess(message, score) {
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';
    successDiv.innerHTML = `
        <i class="fas fa-balance-scale" style="font-size: 1.5rem;"></i>
        <div>
            <strong>‚úÖ ${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">Score d'importance: ${score}/100</div>
        </div>
    `;

    const mainContent = document.querySelector('.text-content-card');
    mainContent.parentNode.insertBefore(successDiv, mainContent);

    setTimeout(() => successDiv.remove(), 5000);
}

// JSON Generation Functions
function generatePageJson() {
    const btn = document.getElementById('generate-page-json-btn');
    const loading = document.getElementById('json-loading');

    const annotationsCount = document.querySelectorAll('.inline-annotation').length;
    if (annotationsCount === 0) {
        alert('Aucune annotation trouv√©e sur cette page. Annotez d\'abord la page.');
        return;
    }

    btn.disabled = true;
    loading.style.display = 'inline-flex';

    const pageId = document.getElementById('page-text').dataset.pageId;

    fetch(`/annotation/page/${pageId}/generate-summary/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showJsonSuccess(data.message, 'page');
            setTimeout(() => {
                window.open(`/annotation/page/${pageId}/view-json/`, '_blank');
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur g√©n√©ration JSON page:', error);
        alert('Erreur lors de la g√©n√©ration du JSON');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
    });
}

function generateDocumentJson() {
    const documentId = {{ document.id }};

    if (!confirm('G√©n√©rer le JSON global et le r√©sum√© de tout le document ? Cela peut prendre quelques minutes selon la taille du document.')) {
        return;
    }

    const btn = document.getElementById('generate-document-json-btn');
    const loading = document.getElementById('json-loading');

    btn.disabled = true;
    loading.style.display = 'inline-flex';
    loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration JSON global...';

    fetch(`/annotation/document/${documentId}/generate-summary/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showJsonSuccess(data.message, 'document', data.stats);
            setTimeout(() => {
                window.open(`/annotation/document/${documentId}/view-json/`, '_blank');
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur g√©n√©ration JSON document:', error);
        alert('Erreur lors de la g√©n√©ration du JSON global');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration JSON...';
    });
}

function showJsonSuccess(message, type, stats = null) {
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';

    let statsText = '';
    if (stats) {
        statsText = `<div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">
            ${stats.total_annotations} annotations ‚Ä¢ ${stats.total_pages} pages
        </div>`;
    }

    const icon = type === 'document' ? 'fas fa-file-contract' : 'fas fa-code';

    successDiv.innerHTML = `
        <i class="${icon}" style="font-size: 1.5rem;"></i>
        <div>
            <strong>‚úÖ ${message}</strong>
            ${statsText}
        </div>
    `;

    const mainContent = document.querySelector('.text-content-card');
    mainContent.parentNode.insertBefore(successDiv, mainContent);

    setTimeout(() => successDiv.remove(), 5000);
}

// AI and Validation Functions
function validatePage() {
    const btn = document.getElementById('validate-page-btn');
    const pageId = document.getElementById('page-text').dataset.pageId;

    if (confirm('Valider cette page ? Cela confirmera que les annotations sont correctes.')) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';

        fetch(`/annotation/validate-page/${pageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const successDiv = document.createElement('div');
                successDiv.className = 'validation-success';
                successDiv.innerHTML = `
                    <i class="fas fa-graduation-cap" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>‚úÖ ${data.message}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            L'IA s'am√©liore gr√¢ce √† votre validation !
                        </div>
                    </div>
                `;

                const mainContent = document.querySelector('.text-content-card');
                mainContent.parentNode.insertBefore(successDiv, mainContent);

                if (data.ai_improved) {
                    showLearningWidget(data);
                }

                btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Page Valid√©e üéì';
                btn.disabled = true;

                setTimeout(() => successDiv.remove(), 5000);

            } else {
                alert('Erreur: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Validate Page';
            }
        })
        .catch(error => {
            console.error('Erreur validation:', error);
            alert('Erreur lors de la validation');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Validate Page';
        });
    }
}

function annotateWithGroq() {
    const btn = document.getElementById('groq-annotate-btn');
    const loading = document.getElementById('ai-loading');
    const pageId = document.getElementById('page-text').dataset.pageId;

    if (confirm('Lancer l\'annotation automatique avec IA ? Cela remplacera les annotations existantes.')) {
        btn.disabled = true;
        loading.style.display = 'inline-flex';

        fetch(`/annotation/groq/${pageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const successDiv = document.createElement('div');
                successDiv.className = 'validation-success';
                successDiv.innerHTML = `
                    <i class="fas fa-rocket" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>‚úÖ ${data.message}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            IA am√©lior√©e par l'apprentissage RLHF
                        </div>
                    </div>
                `;

                const mainContent = document.querySelector('.text-content-card');
                mainContent.parentNode.insertBefore(successDiv, mainContent);

                setTimeout(() => {
                    loadAndRenderAnnotations();
                }, 1500);

            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur annotation IA:', error);
            alert('Erreur lors de l\'annotation IA');
        })
        .finally(() => {
            btn.disabled = false;
            loading.style.display = 'none';
        });
    }
}

// Delete annotation function
function deleteAnnotation(annotationId) {
    if (!confirm('Supprimer cette annotation ?')) return;

    fetch(`/annotation/${annotationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload annotations instead of full page
            loadAndRenderAnnotations();
            
            // Also update the annotations list if it exists
            const annotationElement = document.querySelector(`[data-annotation-id="${annotationId}"]`);
            if (annotationElement) {
                annotationElement.remove();
            }
        } else {
            alert('Erreur: ' + data.error);
        }
    });
}

// Utility Functions
function goToPage(pageNumber) {
    window.location.href = `?page=${pageNumber}`;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function submitDocumentForExpert() {
    if (confirm('Soumettre ce document complet pour r√©vision expert ?')) {
        const documentId = {{ document.id }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/submit-for-expert/${documentId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}

// Modal Functions
function showAddAnnotationTypeModal() {
    document.getElementById('new-annotation-display-name').value = '';
    document.getElementById('new-annotation-name').value = '';

    const modal = new bootstrap.Modal(document.getElementById('addAnnotationTypeModal'), {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    modal.show();
}

function createAnnotationType() {
    const displayName = document.getElementById('new-annotation-display-name').value.trim();
    const name = document.getElementById('new-annotation-name').value.trim();

    if (!displayName) {
        alert('Please enter a display name');
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/create-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            display_name: displayName,
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);

            annotationTypeMap[data.annotation_type.name] = data.annotation_type.id;
            console.log('üìã Updated type mapping:', annotationTypeMap);

            addNewAnnotationButtonToAnnotateur(data.annotation_type);

            const modalElement = document.getElementById('addAnnotationTypeModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            document.getElementById('new-annotation-display-name').value = '';
            document.getElementById('new-annotation-name').value = '';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating annotation type');
    });
}

function addNewAnnotationButtonToAnnotateur(annotationType) {
    const existingButton = document.querySelector(`[data-name="${annotationType.display_name}"]`);
    if (existingButton && !existingButton.classList.contains('annotation-type-btn-add')) {
        console.log('Button already exists for type:', annotationType.display_name);
        return;
    }
    
    annotationTypeMap[annotationType.name] = annotationType.id;

    const newButton = document.createElement('button');
    newButton.className = 'label-btn';
    newButton.setAttribute('data-id', annotationType.id);
    newButton.setAttribute('data-name', annotationType.name);
    newButton.setAttribute('data-color', annotationType.color);
    newButton.style.background = annotationType.color;
    newButton.textContent = annotationType.display_name;

    // Add event listeners
    newButton.addEventListener('click', function() {
        document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
        
        if (this.id !== 'clear-annotations-btn' && !this.classList.contains('annotation-type-btn-add')) {
            this.classList.add('active');
            currentLabel = {
                id: this.dataset.id,
                name: this.dataset.name,
                color: this.dataset.color
            };
            selectedAnnotationType = this.dataset.name;
            selectedColor = this.dataset.color;
        }
    });

    newButton.addEventListener('contextmenu', handleRightClick);

    const container = document.querySelector('.toolbar');
    const addButton = document.querySelector('.annotation-type-btn-add');
    if (container && addButton) {
        container.insertBefore(newButton, addButton);
    }
}

// Learning Widget Functions
function showLearningWidget(data) {
    let widget = document.getElementById('learning-widget') || createLearningWidget();

    fetch('/learning/dashboard/')
        .then(response => response.json())
        .then(learningData => {
            const avgScore = (learningData.average_feedback_score * 100).toFixed(0);
            const {performanceLevel, performanceIcon} = getPerformanceLevel(avgScore);

            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progr√®s d'Apprentissage IA</h4>
                <div class="learning-metrics">
                    <div class="metric">
                        <span class="metric-label">Score R√©el:</span>
                        <span class="metric-value">${avgScore}%</span>
                        <span class="performance-indicator">${performanceIcon} ${performanceLevel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Validations:</span>
                        <span class="metric-value">${learningData.total_feedbacks}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Am√©lioration:</span>
                        <span class="metric-value">üìà Active</span>
                    </div>
                </div>
                <div class="learning-explanation">
                    <small><i class="fas fa-info-circle"></i> Score bas√© sur annotations correctes, erreurs et manqu√©s</small>
                </div>
            `;
            widget.style.display = 'block';
        })
        .catch(error => {
            console.error('Learning Dashboard Error:', error);
            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progr√®s d'Apprentissage</h4>
                <div class="learning-error">
                    <i class="fas fa-exclamation-triangle"></i> Donn√©es non disponibles
                </div>
            `;
        });
}

function createLearningWidget() {
    const widget = document.createElement('section');
    widget.id = 'learning-widget';
    widget.className = 'learning-dashboard-widget';
    document.querySelector('.text-content-card')?.appendChild(widget);
    return widget;
}

function getPerformanceLevel(score) {
    score = parseInt(score);
    if (score >= 90) return {performanceLevel: 'Excellent', performanceIcon: 'üèÜ'};
    if (score >= 75) return {performanceLevel: 'Bon', performanceIcon: 'üëç'};
    if (score >= 50) return {performanceLevel: 'Apprentissage', performanceIcon: 'üéì'};
    return {performanceLevel: 'N√©cessite entrainement', performanceIcon: 'üìö'};
}

// Context Menu Functions
function addContextMenuToButtons() {
    document.querySelectorAll('.label-btn').forEach(btn => {
        // Remove existing listeners to prevent duplicates
        btn.removeEventListener('contextmenu', handleRightClick);
        // Add new listener only to annotation type buttons
        if (!btn.classList.contains('annotation-type-btn-add') && btn.id !== 'clear-annotations-btn') {
            btn.addEventListener('contextmenu', handleRightClick);
        }
    });
}

function handleRightClick(e) {
    e.preventDefault();

    // Don't show context menu for special buttons
    if (e.target.classList.contains('annotation-type-btn-add') || e.target.id === 'clear-annotations-btn') {
        return;
    }

    contextMenuTarget = e.target;

    const contextMenu = document.getElementById('context-menu');

    // Position the context menu
    contextMenu.style.left = (e.pageX) + 'px';
    contextMenu.style.top = (e.pageY) + 'px';

    // Show the menu
    contextMenu.classList.remove('hidden');

    console.log('Right-clicked on:', e.target.textContent);
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.add('hidden');
    contextMenuTarget = null;
}

function deleteAnnotationTypeFromMenu() {
    if (!contextMenuTarget) {
        hideContextMenu();
        return;
    }

    const typeName = contextMenuTarget.dataset.name;
    const displayName = contextMenuTarget.textContent;

    // Confirm deletion
    if (!confirm(`Are you sure you want to delete the annotation type "${displayName}"?\n\nThis action cannot be undone.`)) {
        hideContextMenu();
        return;
    }

    console.log('Deleting annotation type:', typeName);

    // Get the annotation type ID
    const typeId = contextMenuTarget.dataset.id;
    if (!typeId) {
        alert('Error: Could not find annotation type to delete');
        hideContextMenu();
        return;
    }

    // Call backend to delete the annotation type
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/delete-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            type_id: typeId,
            type_name: typeName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);

            // Remove from mapping
            delete annotationTypeMap[typeName];
            console.log('Updated type mapping after deletion:', annotationTypeMap);

            // Remove the button from interface
            contextMenuTarget.remove();

            // Clear selection if this type was selected
            if (selectedAnnotationType === typeName) {
                selectedAnnotationType = null;
                selectedColor = null;
                currentLabel = null;
            }

            console.log('Annotation type deleted successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting annotation type: ' + error.message);
    })
    .finally(() => {
        hideContextMenu();
    });
}

// Document Viewer Function
function viewOriginalDocument(documentId) {
    if (!documentId) {
        alert('Document ID non disponible');
        return;
    }

    const documentUrl = `/documents/${documentId}/view-original/`;
    window.open(documentUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

// Text Highlighting Functions
function highlightTextInDocument(text, startPos, endPos) {
    const pageDisplay = document.getElementById('page-text');
    const originalTextContent = pageDisplay.textContent;

    clearExistingHighlights();

    try {
        pageDisplay.textContent = originalTextContent;

        let content = pageDisplay.textContent;
        let targetText = text.trim();
        let textIndex = -1;
        let foundText = targetText;

        // Strategy 1: Exact match
        textIndex = content.indexOf(targetText);

        // Strategy 2: Case insensitive
        if (textIndex === -1) {
            textIndex = content.toLowerCase().indexOf(targetText.toLowerCase());
        }

        // Strategy 3: Flexible whitespace
        if (textIndex === -1) {
            const flexiblePattern = targetText.replace(/\s+/g, '\\s+');
            const regex = new RegExp(flexiblePattern, 'i');
            const match = content.match(regex);

            if (match) {
                textIndex = content.search(regex);
                foundText = match[0];
            }
        }

        // Strategy 4: Word-by-word fuzzy matching
        if (textIndex === -1) {
            const targetWords = targetText.toLowerCase().split(/\s+/);
            const contentLower = content.toLowerCase();

            const firstWordIndex = contentLower.indexOf(targetWords[0]);
            if (firstWordIndex !== -1) {
                let currentPos = firstWordIndex;
                let matchedText = '';
                let allWordsFound = true;

                for (let word of targetWords) {
                    const wordPos = contentLower.indexOf(word, currentPos);
                    if (wordPos !== -1 && wordPos - currentPos < 100) {
                        if (!matchedText) {
                            matchedText = content.substring(firstWordIndex, wordPos + word.length);
                        } else {
                            matchedText = content.substring(firstWordIndex, wordPos + word.length);
                        }
                        currentPos = wordPos + word.length;
                    } else {
                        allWordsFound = false;
                        break;
                    }
                }

                if (allWordsFound && matchedText) {
                    textIndex = firstWordIndex;
                    foundText = matchedText;
                }
            }
        }

        // Highlight the result
        if (textIndex !== -1) {
            console.log(`Found: "${foundText}" at position ${textIndex}`);

            const beforeText = content.substring(0, textIndex);
            const highlightedText = content.substring(textIndex, textIndex + foundText.length);
            const afterText = content.substring(textIndex + foundText.length);

            pageDisplay.innerHTML =
                beforeText +
                '<span id="highlighted-annotation" style="background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; border: 2px solid #ffc107; animation: highlight-pulse 2s ease-in-out;">' +
                highlightedText +
                '</span>' +
                afterText;

            document.getElementById('highlighted-annotation').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            if (window.highlightTimeout) {
                clearTimeout(window.highlightTimeout);
            }

            window.highlightTimeout = setTimeout(() => {
                pageDisplay.textContent = originalTextContent;
            }, 5000);

        } else {
            console.log('No match found for:', targetText);
            alert('Texte non trouv√©: "' + targetText.substring(0, 50) + (targetText.length > 50 ? '...' : '') + '"');
        }
    } catch (error) {
        console.error('Error highlighting text:', error);
        pageDisplay.textContent = originalTextContent;
    }
}

function clearExistingHighlights() {
    if (window.highlightTimeout) {
        clearTimeout(window.highlightTimeout);
    }

    const existingHighlight = document.getElementById('highlighted-annotation');
    if (existingHighlight) {
        const parent = existingHighlight.parentNode;
        parent.replaceChild(document.createTextNode(existingHighlight.textContent), existingHighlight);
        parent.normalize();
    }
}

// Edit Annotation Functions
function openEditAnnotationModal(annotationId) {
    console.log('Opening edit modal for annotation:', annotationId);

    if (!editModal) {
        alert('Modal d\'√©dition non disponible');
        return;
    }

    currentEditingAnnotationId = annotationId;
    loadAnnotationDetails(annotationId);
}

function loadAnnotationDetails(annotationId) {
    showEditModalLoading(true);

    fetch(`/annotation/${annotationId}/details/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateEditModal(data.annotation);
            editModal.show();
        } else {
            alert('Erreur lors du chargement des d√©tails: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur chargement annotation:', error);
        alert('Erreur lors du chargement des d√©tails de l\'annotation');
    })
    .finally(() => {
        showEditModalLoading(false);
    });
}

function populateEditModal(annotation) {
    document.getElementById('edit-selected-text').value = annotation.selected_text || '';
    document.getElementById('edit-annotation-type').value = annotation.annotation_type.id || '';
    document.getElementById('edit-start-pos').value = annotation.start_pos || '';
    document.getElementById('edit-end-pos').value = annotation.end_pos || '';

    document.getElementById('edit-created-by').textContent = annotation.created_by || 'IA';
    document.getElementById('edit-confidence').textContent = Math.round(annotation.confidence_score || 0);
    document.getElementById('edit-ai-reasoning').textContent = annotation.ai_reasoning || 'Aucun raisonnement disponible';

    if (annotation.modified_by_human) {
        const infoPanel = document.querySelector('.annotation-info-panel');
        if (infoPanel) {
            infoPanel.style.borderLeft = '4px solid var(--pharma-accent)';
            infoPanel.style.backgroundColor = '#f0fdf4';
        }
    }

    console.log('Modal populated with annotation data');
}

function saveAnnotationChanges() {
    if (!currentEditingAnnotationId) {
        alert('Aucune annotation s√©lectionn√©e pour modification');
        return;
    }

    const selectedText = document.getElementById('edit-selected-text').value.trim();
    const annotationTypeId = document.getElementById('edit-annotation-type').value;
    const startPos = parseInt(document.getElementById('edit-start-pos').value) || 0;
    const endPos = parseInt(document.getElementById('edit-end-pos').value) || 0;

    if (!selectedText) {
        alert('Le texte s√©lectionn√© ne peut pas √™tre vide');
        return;
    }

    if (!annotationTypeId) {
        alert('Veuillez s√©lectionner un type d\'annotation');
        return;
    }

    const editData = {
        selected_text: selectedText,
        annotation_type_id: parseInt(annotationTypeId),
        start_pos: startPos,
        end_pos: endPos
    };

    const saveButton = document.querySelector('#editAnnotationModal .btn-primary');
    const originalText = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

    fetch(`/annotation/${currentEditingAnnotationId}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(editData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditSuccess(data.message);
            editModal.hide();
            updateAnnotationInList(data.annotation);
            currentEditingAnnotationId = null;
            
            // Reload inline annotations to show changes
            setTimeout(() => {
                loadAndRenderAnnotations();
            }, 500);
        } else {
            alert('Erreur lors de la sauvegarde: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde annotation:', error);
        alert('Erreur lors de la sauvegarde des modifications');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
    });
}

function updateAnnotationInList(updatedAnnotation) {
    const annotationElement = document.querySelector(`[data-annotation-id="${updatedAnnotation.id}"]`);
    if (!annotationElement) {
        console.error('Annotation element not found in list');
        return;
    }

    const typeElement = annotationElement.querySelector('.annotation-type');
    if (typeElement) {
        typeElement.textContent = updatedAnnotation.annotation_type.display_name;
        typeElement.style.background = updatedAnnotation.annotation_type.color;
    }

    const textElement = annotationElement.querySelector('.annotation-text');
    if (textElement) {
        textElement.textContent = `"${updatedAnnotation.selected_text}"`;
        textElement.onclick = function() {
            highlightTextInDocument(
                updatedAnnotation.selected_text,
                updatedAnnotation.start_pos,
                updatedAnnotation.end_pos
            );
        };
    }

    let humanIndicator = annotationElement.querySelector('.human-modified-indicator');
    if (!humanIndicator) {
        humanIndicator = document.createElement('div');
        humanIndicator.className = 'human-modified-indicator';
        annotationElement.appendChild(humanIndicator);
    }
    humanIndicator.innerHTML = '<i class="fas fa-user-edit"></i> Modifi√© par vous';

    annotationElement.style.animation = 'highlight-pulse 1s ease-in-out';
    setTimeout(() => {
        annotationElement.style.animation = '';
    }, 1000);

    console.log('Annotation updated in list');
}

function showEditSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';
    successDiv.innerHTML = `
        <i class="fas fa-edit" style="font-size: 1.5rem;"></i>
        <div>
            <strong>‚úÖ ${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                L'annotation a √©t√© mise √† jour avec vos corrections
            </div>
        </div>
    `;

    const mainContent = document.querySelector('.text-content-card');
    if (mainContent) {
        mainContent.parentNode.insertBefore(successDiv, mainContent);
        setTimeout(() => successDiv.remove(), 4000);
    }
}

function showEditModalLoading(show) {
    console.log(show ? 'Loading...' : 'Loading complete');
}

function resetEditModal() {
    document.getElementById('edit-selected-text').value = '';
    document.getElementById('edit-annotation-type').value = '';
    document.getElementById('edit-start-pos').value = '';
    document.getElementById('edit-end-pos').value = '';
    document.getElementById('edit-created-by').textContent = '-';
    document.getElementById('edit-confidence').textContent = '-';
    document.getElementById('edit-ai-reasoning').textContent = '-';

    const infoPanel = document.querySelector('.annotation-info-panel');
    if (infoPanel) {
        infoPanel.style.borderLeft = '1px solid #dee2e6';
        infoPanel.style.backgroundColor = '#f8f9fa';
    }

    currentEditingAnnotationId = null;
}

// Event listener for modal close
document.addEventListener('DOMContentLoaded', function() {
    const editModalElement = document.getElementById('editAnnotationModal');
    if (editModalElement) {
        editModalElement.addEventListener('hidden.bs.modal', function() {
            resetEditModal();
        });
    }
});

function recalculatePositions() {
    const selectedText = document.getElementById('edit-selected-text').value.trim();
    const pageText = document.getElementById('page-text').textContent;

    if (selectedText && pageText) {
        const startPos = pageText.indexOf(selectedText);
        if (startPos !== -1) {
            document.getElementById('edit-start-pos').value = startPos;
            document.getElementById('edit-end-pos').value = startPos + selectedText.length;
        }
    }
}

// Auto-recalculate positions when text changes
document.addEventListener('DOMContentLoaded', function() {
    const textArea = document.getElementById('edit-selected-text');
    if (textArea) {
        textArea.addEventListener('blur', recalculatePositions);
    }
});

/**
 * Fonction pour charger automatiquement les types d'annotation sugg√©r√©s par Mistral
 */
function loadMistralAnnotationTypes() {
    console.log("üîÑ Chargement des types d'annotation sugg√©r√©s par Mistral...");
    
    // Utiliser la variable globale DOCUMENT_ID d√©finie en haut du document
    
    // Afficher un indicateur de chargement
    var loadingDiv = document.createElement('div');
    loadingDiv.id = 'mistral-loading-indicator';
    loadingDiv.className = 'mistral-loading-indicator';
    loadingDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary"></div><span>Chargement des types d\'annotation...</span>';
    loadingDiv.style.position = 'fixed';
    loadingDiv.style.top = '10px';
    loadingDiv.style.right = '10px';
    loadingDiv.style.background = 'rgba(255,255,255,0.9)';
    loadingDiv.style.padding = '10px';
    loadingDiv.style.borderRadius = '5px';
    loadingDiv.style.zIndex = '9999';
    loadingDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    document.body.appendChild(loadingDiv);
    
    // Appeler l'API Mistral avec l'ID global
    fetch('/api/mistral/analyze_document/' + DOCUMENT_ID + '/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
            if (data.success) {
                var entityCount = data.entity_types ? data.entity_types.length : 0;
                var displayLanguage = data.displayed_language || '';
                
                console.log('‚úÖ Mistral a sugg√©r√©', entityCount, 'types d\'annotation en', displayLanguage);
                
                if (data.entity_types && data.entity_types.length > 0) {
                    // Mettre √† jour l'interface
                    updateToolbarWithMistralTypes(data.entity_types);
                    
                    // Afficher notification
                    var successDiv = document.createElement('div');
                    successDiv.className = 'validation-success';
                    successDiv.innerHTML = '<i class="fas fa-brain" style="font-size: 1.5rem;"></i>' +
                        '<div><strong>‚úÖ Types d\'annotation optimis√©s</strong>' +
                        '<div style="font-size: 0.9rem; opacity: 0.9;">' +
                        'Mistral a identifi√© ' + entityCount + ' types pertinents' + 
                        (displayLanguage ? ' <span class="badge bg-info" title="Langue d√©tect√©e automatiquement">' + displayLanguage + '</span>' : '') + 
                        '</div></div>';                var mainContent = document.querySelector('.text-content-card');
                if (mainContent) {
                    mainContent.parentNode.insertBefore(successDiv, mainContent);
                    setTimeout(function() {
                        successDiv.remove();
                    }, 5000);
                }
            }
        } else {
            console.error('Erreur lors de l\'analyse Mistral:', data.error);
        }
    })
    .catch(function(error) {
        console.error('Erreur lors de l\'appel √† l\'API Mistral:', error);
    })
    .finally(function() {
        // Supprimer l'indicateur de chargement
        var loadingIndicator = document.getElementById('mistral-loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
    });
}

/**
 * Met √† jour la barre d'outils avec les types d'annotation sugg√©r√©s
 */
function updateToolbarWithMistralTypes(entityTypes) {
    if (!entityTypes || entityTypes.length === 0) return;
    
    var toolbar = document.getElementById('label-toolbar');
    if (!toolbar) return;
    
    // Sauvegarder les boutons sp√©ciaux
    var specialButtons = [];
    toolbar.querySelectorAll('button').forEach(function(btn) {
        if (btn.classList.contains('annotation-type-btn-add') || btn.id === 'clear-annotations-btn') {
            specialButtons.push(btn.cloneNode(true));
        }
    });
    
    // Vider la barre d'outils
    toolbar.innerHTML = '';
    
    // Ajouter les nouveaux types
    entityTypes.forEach(function(type) {
        var button = document.createElement('button');
        button.className = 'label-btn';
        button.dataset.id = type.id;
        button.dataset.name = type.name;
        button.dataset.color = type.color;
        button.style.background = type.color;
        button.textContent = type.display_name;
        
        button.addEventListener('click', function() {
            document.querySelectorAll('.label-btn').forEach(function(b) {
                b.classList.remove('active');
            });
            
            button.classList.add('active');
            currentLabel = {
                id: button.dataset.id,
                name: button.dataset.name,
                color: button.dataset.color
            };
        });
        
        toolbar.appendChild(button);
        annotationTypeMap[type.name] = type.id;
    });
    
    // R√©ajouter les boutons sp√©ciaux
    specialButtons.forEach(function(btn) {
        if (btn.classList.contains('annotation-type-btn-add')) {
            btn.onclick = showAddAnnotationTypeModal;
        } else if (btn.id === 'clear-annotations-btn') {
            btn.addEventListener('click', function() {
                if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les annotations de cette page?')) {
                    clearAllAnnotations();
                }
            });
        }
        toolbar.appendChild(btn);
    });
    
    console.log('üîÑ Barre d\'outils mise √† jour avec les types d\'annotation sugg√©r√©s par Mistral');
}

console.log('Prodigy-like annotation system with full functionality loaded successfully');
</script>
{% endblock %}