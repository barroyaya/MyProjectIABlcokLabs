{#template/rawdocs/annotate_document.html#}
{% extends "base.html" %}
{% load rawdocs_extras %}
{% load static %}
{% block title %}Annotation {{ document.file.name|basename }} – RawDocs{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'rawdocs/css/rlhf_styles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Tous les styles CSS existants restent identiques -->
<style>
/* NUCLEAR OPTION: Override ALL modal conflicts */
.context-menu {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    padding: 0;
    min-width: 150px;
}

.context-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
    color: #333;
    transition: background-color 0.2s;
}

.context-menu-item:hover {
    background-color: #f8f9fa;
}

.context-menu-item.danger {
    color: #dc3545;
}

.context-menu-item.danger:hover {
    background-color: #f8d7da;
}

/* Hide context menu initially */
.context-menu.hidden {
    display: none;
}
/* Force modal to appear above EVERYTHING */
.modal {
    z-index: 999999 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
    display: none !important;
}

.modal.show {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Force backdrop to be clickable and properly positioned */
.modal-backdrop {
    z-index: 999998 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
}

/* Force modal dialog to be above backdrop and clickable */
.modal-dialog {
    z-index: 1000000 !important;
    position: relative !important;
    margin: 1.75rem auto !important;
    max-width: 500px !important;
    width: 90% !important;
    pointer-events: auto !important;
}

/* Force modal content styling */
.modal-content {
    background: white !important;
    border: none !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.8) !important;
    pointer-events: auto !important;
    position: relative !important;
    z-index: 1000001 !important;
}

.modal-header {
    background: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.modal-title {
    color: #495057 !important;
    font-weight: 500 !important;
    margin: 0 !important;
}

.modal-body {
    background: white !important;
    padding: 1.5rem !important;
    color: #495057 !important;
}

.modal-footer {
    background: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    padding: 1rem 1.5rem !important;
    border-radius: 0 0 0.5rem 0.5rem !important;
}

/* Force all form elements to work properly */
.modal input,
.modal select,
.modal textarea {
    background: white !important;
    border: 1px solid #ced4da !important;
    color: #495057 !important;
    padding: 0.375rem 0.75rem !important;
    border-radius: 0.25rem !important;
    width: 100% !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal input:focus,
.modal select:focus,
.modal textarea:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    outline: 0 !important;
}

.modal .form-label {
    color: #495057 !important;
    font-weight: 500 !important;
    margin-bottom: 0.5rem !important;
}

.modal .btn {
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close {
    background: transparent !important;
    border: none !important;
    color: #000 !important;
    opacity: 0.5 !important;
    pointer-events: auto !important;
    z-index: 1000002 !important;
    position: relative !important;
}

.modal .btn-close:hover {
    opacity: 1 !important;
}

/* Remove ANY other z-index that might interfere */
.annotation-header,
.annotation-types-panel,
.page-navigation,
.text-content-card,
.annotations-list,
.learning-dashboard-widget {
    z-index: auto !important;
    position: relative !important;
}

/* Ensure the page content doesn't interfere */
.app-container,
.site-header,
body {
    z-index: auto !important;
}

/* Force click events to work */
.modal * {
    pointer-events: auto !important;
}

.modal-dialog * {
    pointer-events: auto !important;
}

.modal-content * {
    pointer-events: auto !important;
}
@keyframes highlight-pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.3); }
    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

.annotation-text-clickable:hover {
    background-color: #e7f3ff !important;
    border-radius: 3px;
    padding: 1px 3px;
}

/* Styles pour l'analyse réglementaire */
.regulatory-analysis-panel {
  background: linear-gradient(120deg, #f0f9ff 70%, #e0f2fe 100%);
  border: 1.5px solid var(--pharma-info);
  border-radius: var(--pharma-radius);
  margin-bottom: 2rem;
  box-shadow: var(--pharma-shadow);
  padding: 2rem;
}

.regulatory-stats {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.regulatory-stat {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  padding: 1rem 1.2rem;
  text-align: center;
  flex: 1;
  box-shadow: 0 2px 8px rgba(56,189,248,0.08);
}

.regulatory-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--pharma-info);
  display: block;
}

.regulatory-stat-label {
  font-size: 0.85rem;
  color: var(--pharma-text-soft);
  margin-top: 0.2rem;
}

.btn-regulatory {
  background: linear-gradient(90deg, var(--pharma-info), #0ea5e9);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(56,189,248,0.13);
  transition: var(--pharma-transition);
}

.btn-regulatory:hover {
  background: linear-gradient(90deg, #0ea5e9, var(--pharma-primary));
  color: #fff;
}

.btn-regulatory:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}

.regulatory-progress {
  background: var(--pharma-bg-card);
  border-radius: 8px;
  padding: 0.5rem;
  margin: 1rem 0;
}

.progress-bar-regulatory {
  background: linear-gradient(90deg, var(--pharma-info), var(--pharma-accent));
  height: 8px;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.page-regulatory-analysis {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-info);
  border-radius: var(--pharma-radius-sm);
  padding: 1.5rem;
  margin-top: 1rem;
}

.importance-score {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.3rem 1rem;
  border-radius: 999px;
  font-weight: 600;
  font-size: 0.9rem;
}

.importance-score.critical {
  background: linear-gradient(90deg, #ef4444, #dc2626);
  color: #fff;
}

.importance-score.high {
  background: linear-gradient(90deg, #f59e0b, #d97706);
  color: #fff;
}

.importance-score.medium {
  background: linear-gradient(90deg, var(--pharma-info), var(--pharma-primary));
  color: #fff;
}

.importance-score.low {
  background: #e5e7eb;
  color: #6b7280;
}

.regulatory-obligations {
  margin-top: 1rem;
}

.obligation-item {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: 8px;
  padding: 0.8rem 1rem;
  margin-bottom: 0.8rem;
  border-left: 4px solid var(--pharma-warn);
}

.obligation-severity.high {
  border-left-color: var(--pharma-error);
}

.obligation-severity.medium {
  border-left-color: var(--pharma-warn);
}

.obligation-severity.low {
  border-left-color: var(--pharma-info);
}

.regulatory-loading {
  color: var(--pharma-info);
  font-weight: 500;
  margin-left: 1rem;
  display: none;
}

.key-points-list {
  margin-top: 1rem;
}

.key-point {
  background: #f0f9ff;
  border: 1px solid #e0f2fe;
  border-radius: 6px;
  padding: 0.6rem 0.8rem;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
  color: var(--pharma-text);
}

.authorities-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.8rem;
}

.authority-tag {
  background: linear-gradient(90deg, #8b5cf6, #7c3aed);
  color: #fff;
  padding: 0.25rem 0.8rem;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 500;
}

.deadlines-list {
  margin-top: 1rem;
}

.deadline-item {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 6px;
  padding: 0.6rem 0.8rem;
  margin-bottom: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.deadline-timeframe {
  background: var(--pharma-warn);
  color: #fff;
  padding: 0.2rem 0.6rem;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
}
</style>

<!-- Styles CSS pharma existants conservés identiques -->
<style>
/* Pharma color variables */
:root {
  --pharma-primary: #0ea5e9;
  --pharma-primary-dark: #0284c7;
  --pharma-accent: #10b981;
  --pharma-bg: #f8fafc;
  --pharma-bg-card: rgba(255,255,255,0.95);
  --pharma-glass: rgba(14,165,233,0.10);
  --pharma-border: #cbd5e1;
  --pharma-shadow: 0 8px 32px 0 rgba(14, 165, 233, 0.07);
  --pharma-text: #1e293b;
  --pharma-text-soft: #64748b;
  --pharma-valid: #22c55e;
  --pharma-warn: #f59e0b;
  --pharma-error: #ef4444;
  --pharma-info: #38bdf8;
  --pharma-radius: 18px;
  --pharma-radius-sm: 12px;
  --pharma-font: 'Inter', sans-serif;
  --pharma-transition: all 0.28s cubic-bezier(.4,0,.2,1);
}

/* Reset and base */
body {
  background: linear-gradient(135deg, var(--pharma-bg) 70%, #e0f2fe 100%);
  color: var(--pharma-text);
  font-family: var(--pharma-font);
}

.main-content {
  width: 100%;
  max-width: none;
  margin: auto;
}

/* Annotation header */
.annotation-header {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1px solid var(--pharma-border);
  padding: 1.5rem 2rem;
  margin-bottom: 2.2rem;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1.5rem;
  animation: fadeInUp 0.5s;
}

.header-info h2 {
  color: var(--pharma-primary-dark);
  font-size: 1.45rem;
  font-weight: 700;
  margin-bottom: 0.3rem;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.document-meta {
  display: flex;
  gap: 1.2rem;
  font-size: 0.98rem;
  margin-top: 0.2rem;
}

.meta-item {
  color: var(--pharma-text-soft);
  gap: 0.3rem;
  display: flex;
  align-items: center;
}

.header-actions .btn-outline {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-primary);
  color: var(--pharma-primary-dark);
  border-radius: var(--pharma-radius-sm);
  font-size: 1rem;
  padding: 0.6rem 1.3rem;
  font-weight: 500;
  transition: var(--pharma-transition);
}
.header-actions .btn-outline:hover {
  background: var(--pharma-primary);
  color: #fff;
  border-color: var(--pharma-primary-dark);
  transform: translateY(-2px) scale(1.04);
}

/* Annotation Types Panel */
.annotation-types-panel {
  background: linear-gradient(120deg, #f0fdfa 70%, #bae6fd 100%);
  border: 1.5px solid var(--pharma-primary-light, #38bdf8);
  border-radius: var(--pharma-radius);
  margin-bottom: 2rem;
  box-shadow: var(--pharma-shadow);
  padding: 2rem;
}

.annotation-types-panel h3 {
  font-size: 1.2rem;
  color: var(--pharma-primary-dark);
  margin-bottom: 0.35rem;
  font-weight: 600;
}

.instructions,
.help-text {
  color: var(--pharma-text-soft);
  font-size: 0.97rem;
  opacity: 0.88;
  margin-bottom: 0.7rem;
}

.annotation-types {
  display: flex;
  flex-wrap: wrap;
  gap: 0.65rem;
  margin-bottom: 0.8rem;
}

.annotation-type-btn {
  border-radius: 999px;
  background: var(--pharma-bg-card);
  border: 2px solid var(--pharma-primary);
  color: var(--pharma-primary-dark);
  font-weight: 500;
  font-size: 1rem;
  padding: 0.45rem 1.25rem;
  box-shadow: 0 2px 10px rgba(14,165,233,0.05);
  transition: var(--pharma-transition);
  outline: none;
}
.annotation-type-btn:hover, .annotation-type-btn.active {
  background: var(--pharma-primary);
  color: #fff;
  transform: translateY(-2px) scale(1.07);
  border-color: var(--pharma-primary-dark);
  box-shadow: 0 6px 18px rgba(14,165,233,0.14);
}
.annotation-type-btn-add {
  background: linear-gradient(90deg, var(--pharma-accent), var(--pharma-primary));
  border: none;
  color: #fff;
  font-weight: 600;
  border-radius: 999px;
  font-size: 1rem;
  padding: 0.45rem 1.35rem;
  transition: var(--pharma-transition);
  box-shadow: 0 2px 12px rgba(16,185,129,0.11);
}
.annotation-type-btn-add:hover {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  transform: translateY(-1.5px) scale(1.06);
}

.current-mode {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 12px;
  padding: 0.23rem 1rem;
  font-size: 1.03rem;
  margin-left: 0.7rem;
  font-weight: 600;
}

/* Context Menu */
.context-menu {
  position: absolute;
  background: var(--pharma-bg-card);
  border: 1.5px solid var(--pharma-border);
  border-radius: 12px;
  box-shadow: 0 6px 24px rgba(0,0,0,0.13);
  min-width: 170px;
  z-index: 10010;
  font-size: 1rem;
  padding: 0.1rem;
}
.context-menu-item {
  color: var(--pharma-text);
  padding: 9px 14px;
  background: none;
  width: 100%;
  border: none;
  border-radius: 8px;
  text-align: left;
  transition: background .18s;
}
.context-menu-item:hover { background: #e0f2fe; }
.context-menu-item.danger { color: var(--pharma-error); }
.context-menu-item.danger:hover { background: #ffe4e6; }
.context-menu.hidden { display: none; }

/* Page Navigation */
.page-navigation {
  background: var(--pharma-bg-card);
  border: 1px solid var(--pharma-border);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  padding: 1.5rem 2rem;
  margin-bottom: 2.1rem;
}

/* Actions Container */
.actions-container {
  margin-top: 1.5rem;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--pharma-border);
}

.action-group {
  background: var(--pharma-glass);
  border: 1px solid rgba(59, 130, 246, 0.1);
  border-radius: var(--pharma-radius-sm);
  padding: 1.2rem;
  transition: var(--pharma-transition);
}

.action-group:hover {
  border-color: rgba(59, 130, 246, 0.2);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.08);
}

.group-title {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--pharma-primary-dark);
  margin-bottom: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.group-title::before {
  content: '';
  width: 3px;
  height: 16px;
  background: linear-gradient(to bottom, var(--pharma-primary), var(--pharma-accent));
  border-radius: 2px;
}

.buttons-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.8rem;
  align-items: center;
}

/* Ajustements des boutons pour la nouvelle disposition */
.buttons-row .btn-groq,
.buttons-row .btn-validate,
.buttons-row .btn-json-page,
.buttons-row .btn-json-document,
.buttons-row .btn-view-json,
.buttons-row .btn-expert {
  font-size: 0.9rem;
  padding: 0.6rem 1.2rem;
  flex: 1;
  min-width: 140px;
  justify-content: center;
}

/* Loading indicators container */
.loading-indicators {
  grid-column: 1 / -1;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(59, 130, 246, 0.05);
  border-radius: var(--pharma-radius-sm);
  border: 1px dashed rgba(59, 130, 246, 0.2);
}

.page-controls { display: flex; align-items: center; gap: 1.5rem; }
.page-selector select {
  padding: 0.48rem 1.1rem;
  border-radius: 12px;
  border: 1.5px solid var(--pharma-primary);
  background: var(--pharma-glass);
  color: var(--pharma-primary-dark);
  font-weight: 600;
  font-size: 1rem;
  outline: none;
  transition: border .18s;
}
.page-selector select:focus {
  border-color: var(--pharma-accent);
}

.nav-btn {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 11px;
  font-size: 1rem;
  padding: 0.5rem 1.4rem;
  font-weight: 600;
  border: none;
  transition: var(--pharma-transition);
  box-shadow: 0 3px 10px rgba(14,165,233,0.11);
  outline: none;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.nav-btn:hover {
  background: var(--pharma-primary);
  color: #fff;
  transform: scale(1.04) translateY(-1px);
  text-decoration: none;
}

.nav-btn-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  padding: 0;
  font-size: 1.2rem;
  background: linear-gradient(135deg, var(--pharma-primary-dark), var(--pharma-primary));
  box-shadow: 0 4px 15px rgba(14,165,233,0.15);
  position: relative;
  overflow: hidden;
}

.nav-btn-icon:hover {
  background: linear-gradient(135deg, var(--pharma-primary), var(--pharma-accent));
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(14,165,233,0.25);
}

.nav-btn-icon:active {
  transform: scale(0.95) translateY(0);
}

.nav-btn-icon i {
  font-size: 1.3rem;
  transition: var(--pharma-transition);
}

.nav-btn-icon:hover i {
  transform: scale(1.1);
}

/* AI, Validate, Expert Buttons */
.ai-controls {
  display: flex;
  align-items: center;
  gap: 1.1rem;
  flex-wrap: wrap;
}

.btn-groq {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-info));
  color: #fff;
  font-weight: 700;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-size: 1.04rem;
  border: none;
  box-shadow: 0 4px 18px rgba(56,189,248,0.08);
  transition: var(--pharma-transition);
}
.btn-groq:hover { background: linear-gradient(90deg, var(--pharma-info), var(--pharma-primary-dark)); }

.btn-validate {
  background: var(--pharma-accent);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(16,185,129,0.09);
  transition: var(--pharma-transition);
}
.btn-validate:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
}
.btn-validate:hover:not(:disabled) {
  background: #059669;
}

/* NOUVEAUX STYLES POUR LES BOUTONS JSON */
.btn-json-page {
  background: linear-gradient(90deg, #10b981, #059669);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(16,185,129,0.13);
  transition: var(--pharma-transition);
}

.btn-json-page:hover {
  background: linear-gradient(90deg, #059669, #047857);
  color: #fff;
}

.btn-json-document {
  background: linear-gradient(90deg, #f59e0b, #d97706);
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-weight: 700;
  font-size: 1.04rem;
  box-shadow: 0 4px 12px rgba(245,158,11,0.13);
  transition: var(--pharma-transition);
}

.btn-json-document:hover {
  background: linear-gradient(90deg, #d97706, #b45309);
  color: #fff;
}

/* Groupement des actions JSON par paires */
.json-action-pair {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
}

/* Boutons JSON icônes stylisés */
.btn-view-json-page,
.btn-view-json-global {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  font-size: 1.2rem;
  transition: var(--pharma-transition);
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
  position: relative;
  overflow: hidden;
}

.btn-view-json-page {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  border: 2px solid #059669;
}

.btn-view-json-page:hover {
  background: linear-gradient(135deg, #059669, #047857);
  color: #fff;
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(16,185,129,0.25);
  text-decoration: none;
}

.btn-view-json-global {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff;
  border: 2px solid #d97706;
}

.btn-view-json-global:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  color: #fff;
  transform: scale(1.1) translateY(-2px);
  box-shadow: 0 6px 20px rgba(245,158,11,0.25);
  text-decoration: none;
}

.btn-view-json-page:active,
.btn-view-json-global:active {
  transform: scale(0.95) translateY(0);
}

.btn-view-json-page i,
.btn-view-json-global i {
  font-size: 1.3rem;
  transition: var(--pharma-transition);
}

.btn-view-json-page:hover i,
.btn-view-json-global:hover i {
  transform: scale(1.1);
}

.btn-expert {
  background: linear-gradient(90deg, #6d28d9, #4c1d95 90%);
  color: #fff;
  font-weight: 700;
  border-radius: 12px;
  padding: 0.65rem 1.4rem;
  font-size: 1.04rem;
  border: none;
  box-shadow: 0 4px 12px rgba(109,40,217,0.13);
  transition: var(--pharma-transition);
}
.btn-expert:hover { background: linear-gradient(90deg, #7c3aed, #a78bfa 80%); }

.btn-success {
  background: var(--pharma-accent);
  color: #fff !important;
  border-radius: 12px;
  font-weight: 700;
  padding: 0.65rem 1.4rem;
}

.ai-loading, .learning-progress, .regulatory-loading, .json-loading {
  color: var(--pharma-primary-dark);
  font-weight: 500;
  margin-left: 1rem;
}

.json-loading {
  color: var(--pharma-accent);
  font-weight: 500;
  margin-left: 1rem;
}

/* Text Content (Zone principale d'annotation) */
.text-content-card {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1.5px solid var(--pharma-primary-light, #38bdf8);
  margin-bottom: 2.2rem;
  padding: 2rem 2.1rem;
  animation: fadeInUp 0.6s;
}

.text-content-card h3 {
  color: var(--pharma-primary-dark);
  font-size: 1.18rem;
  font-weight: 700;
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 0.7rem;
}

.page-status {
  padding: 0.25rem 1rem;
  border-radius: 999px;
  font-size: 0.92rem;
  font-weight: 700;
  margin-left: 1.1rem;
  box-shadow: 0 2px 7px rgba(59,130,246,0.05);
}
.page-status.validated-human {
  background: #d1fae5;
  color: #047857;
}
.page-status.annotated {
  background: #bae6fd;
  color: var(--pharma-primary-dark);
}
.page-status.pending {
  background: #fef3c7;
  color: #92400e;
}

/* Text content - Enhanced for PDF-like appearance */
.text-content {
    background: #fafbfc;
    border: 1px solid var(--pharma-border);
    border-radius: 12px;
    padding: 2rem;
    line-height: 1.8;
    font-size: 1.05rem;
    color: var(--pharma-text);
    white-space: pre-wrap;
    word-wrap: break-word;
    min-height: 400px;
    width: 100%;
    max-width: 100%;
    cursor: text;
    font-family: 'Inter', 'Georgia', 'Times New Roman', serif;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    hyphens: auto;
    text-align: justify;
    text-justify: inter-word;
    letter-spacing: 0.01em;
    word-spacing: 0.05em;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 2px solid rgba(59, 130, 246, 0.1);
    transition: border-color 0.3s ease;
  }

  .text-content:hover {
    border-color: rgba(59, 130, 246, 0.2);
  }

  /* Add visual structure for better readability */
  .text-content::before {
    content: "";
    display: block;
    width: 100%;
    height: 2px;
    background: linear-gradient(to right,
      transparent,
      rgba(59, 130, 246, 0.2),
      transparent
    );
    margin-bottom: 1.5rem;
  }

  /* Enhanced paragraph spacing for PDF-like structure */
  .text-content p {
    margin-bottom: 1.2rem;
    text-indent: 1.5rem;
  }

  .text-content p:first-child {
    text-indent: 0;
  }

/* Annotations List (as cards) */
.annotations-list {
  background: var(--pharma-bg-card);
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  border: 1.5px solid var(--pharma-border);
  padding: 1.8rem 2rem;
  margin-bottom: 1.8rem;
}
.annotations-list h3 {
  color: var(--pharma-primary-dark);
  font-size: 1.13rem;
  margin-bottom: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.7rem;
}

.annotation-item {
  background: var(--pharma-glass);
  border: 1.5px solid var(--pharma-border);
  border-radius: var(--pharma-radius-sm);
  margin-bottom: 1.1rem;
  padding: 1rem 1.1rem;
  transition: box-shadow .2s, border .2s;
  box-shadow: 0 3px 15px rgba(14,165,233,0.09);
  position: relative;
}
.annotation-item:hover {
  border-color: var(--pharma-primary-dark);
  box-shadow: 0 8px 28px rgba(14,165,233,0.14);
}

.annotation-header {
  display: flex;
  align-items: center;
  gap: 0.7rem;
  margin-bottom: 0.6rem;
}

.annotation-type {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent) 90%);
  color: #fff;
  border-radius: 999px;
  font-size: 0.97rem;
  font-weight: 600;
  padding: 0.24rem 1.05rem;
}

.annotation-confidence {
  background: #bae6fd;
  color: var(--pharma-primary-dark);
  border-radius: 9px;
  font-size: 0.88rem;
  font-weight: 600;
  padding: 0.19rem 0.7rem;
}

.delete-annotation {
  background: none;
  border: none;
  color: var(--pharma-error);
  cursor: pointer;
  padding: 0.3rem 0.7rem;
  border-radius: 7px;
  transition: background .13s;
  margin-left: auto;
}
.delete-annotation:hover { background: #ffe4e6; }

.annotation-text {
  font-style: italic;
  color: var(--pharma-primary-dark);
  font-size: 1.02rem;
  margin-bottom: 0.3rem;
}

.annotation-reasoning {
  font-size: 0.94rem;
  color: var(--pharma-accent);
  display: flex;
  align-items: center;
  gap: 0.29rem;
}

/* RLHF/AI Generated */
.ai-generated .annotation-type {
  background: linear-gradient(90deg, #f59e0b, #fbbf24 80%);
  color: #fff;
}
.rlhf-indicator {
  margin-top: 0.6rem;
  color: var(--pharma-warn);
  font-weight: 700;
  font-size: 0.98rem;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

/* Learning Dashboard Widget */
.learning-dashboard-widget {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  color: #fff;
  padding: 1.25rem 2rem;
  border-radius: var(--pharma-radius);
  box-shadow: var(--pharma-shadow);
  margin-bottom: 2rem;
  border: none;
  font-size: 1.08rem;
}

.learning-dashboard-widget h4 { color: #fff; font-weight: 700; margin-top: 0; }

.metric {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  margin: 0.35rem 0;
}
.metric-label { font-weight: 600; opacity: 0.87; }
.metric-value { font-size: 1.07rem; font-weight: 700; }
.performance-indicator { font-size: 1.18rem; margin-left: 0.5rem; }
.learning-explanation { font-size: 0.88rem; opacity: 0.89; margin-top: 0.4rem; }

/* Validation Success */
.validation-success {
  background: linear-gradient(90deg, #10b981, #38bdf8);
  color: #fff;
  padding: 1rem 1.6rem;
  border-radius: 14px;
  box-shadow: 0 2px 18px rgba(16,185,129,0.13);
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 1.2rem;
  transition: opacity 0.5s;
}

/* Modal (boost appearance) */
.modal-content {
  background: #fff;
  border-radius: var(--pharma-radius-sm);
  box-shadow: 0 8px 40px rgba(14,165,233,0.23);
  border: none;
}
.modal-header, .modal-footer {
  background: #f1f5f9;
  border: none;
  border-radius: 12px 12px 0 0;
}
.modal-title { color: var(--pharma-primary-dark); font-weight: 600; }
.btn-close { color: var(--pharma-text-soft); }
.btn-primary {
  background: var(--pharma-primary-dark);
  color: #fff;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  padding: 0.48rem 1.4rem;
  transition: var(--pharma-transition);
}
.btn-primary:hover { background: var(--pharma-primary); color: #fff; }

/* Responsive pour la nouvelle disposition */
@media (max-width: 900px) {
  .main-content { max-width: 99vw; }
  .annotation-header, .text-content-card, .annotations-list, .learning-dashboard-widget, .annotation-types-panel, .page-navigation, .regulatory-analysis-panel {
    padding: 1.1rem 0.8rem !important;
  }

  .actions-container {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .buttons-row {
    flex-direction: column;
  }

  .buttons-row .btn-groq,
  .buttons-row .btn-validate,
  .buttons-row .btn-expert {
    font-size: 0.9rem !important;
    padding: 0.7rem 1rem !important;
    min-width: 100%;
  }

  .json-action-pair {
    flex-direction: column;
    gap: 0.8rem;
  }

  .json-action-pair .btn-json-page,
  .json-action-pair .btn-json-document {
    font-size: 0.9rem !important;
    padding: 0.7rem 1rem !important;
    min-width: 100%;
  }

  .btn-view-json-page,
  .btn-view-json-global {
    width: 40px;
    height: 40px;
    font-size: 1rem;
  }
}

@media (max-width: 700px) {
  .annotation-header, .annotation-types-panel, .text-content-card, .annotations-list, .learning-dashboard-widget, .regulatory-analysis-panel {
    flex-direction: column !important;
    gap: 1rem !important;
  }

  .page-navigation {
    flex-direction: column;
    align-items: stretch;
  }

  .page-controls {
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .header-actions { width: 100%; }
  .regulatory-stats { flex-direction: column; }

  .action-group {
    padding: 1rem;
  }

  .group-title {
    font-size: 0.85rem;
  }
}

/* Animations */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px);}
  to   { opacity: 1; transform: translateY(0);}
}

/* Styles pour le bouton d'édition */
.edit-annotation {
  background: none;
  border: none;
  color: var(--pharma-primary);
  cursor: pointer;
  padding: 0.3rem 0.7rem;
  border-radius: 7px;
  transition: background .13s;
  margin-right: 0.5rem;
}

.edit-annotation:hover {
  background: #e0f2fe;
  color: var(--pharma-primary-dark);
}

/* Indicateur de modification humaine */
.human-modified-indicator {
  font-size: 0.85rem;
  color: var(--pharma-accent);
  display: flex;
  align-items: center;
  gap: 0.3rem;
  margin-top: 0.5rem;
  padding: 0.3rem 0.6rem;
  background: #d1fae5;
  border-radius: 6px;
  border-left: 3px solid var(--pharma-accent);
}

/* Styles pour le modal d'édition */
.modal-lg {
  max-width: 800px;
}

.annotation-info-panel {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Amélioration des champs du formulaire d'édition */
#edit-selected-text {
  font-family: 'Courier New', monospace;
  border: 2px solid var(--pharma-border);
  transition: border-color 0.3s ease;
}

#edit-selected-text:focus {
  border-color: var(--pharma-primary);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

#edit-annotation-type {
  border: 2px solid var(--pharma-border);
  transition: border-color 0.3s ease;
}

#edit-annotation-type:focus {
  border-color: var(--pharma-primary);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

/* Style pour les champs de position */
#edit-start-pos, #edit-end-pos {
  background-color: #f8f9fa;
  color: #6c757d;
}

/* Amélioration du panel d'information */
.annotation-meta > div {
  margin-bottom: 0.5rem;
  padding-bottom: 0.3rem;
}

.annotation-meta > div:not(:last-child) {
  border-bottom: 1px solid #e9ecef;
}

/* Animation pour le modal */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out;
  transform: translate(0, -50px);
}

.modal.show .modal-dialog {
  transform: none;
}

/* Style pour les boutons du footer du modal */
.modal-footer .btn {
  min-width: 120px;
  font-weight: 600;
}

.modal-footer .btn-primary {
  background: linear-gradient(90deg, var(--pharma-primary), var(--pharma-accent));
  border: none;
}

.modal-footer .btn-primary:hover {
  background: linear-gradient(90deg, var(--pharma-accent), var(--pharma-primary));
}
</style>

<!-- Annotation Header -->
<section class="annotation-header">
  <div class="header-info">
    <h2><i class="fas fa-file-pdf"></i> {{ document.file.name|basename }}</h2>
    <div class="document-meta">
      <span class="meta-item">
        <i class="fas fa-user"></i>
        {{ document.owner.username }}
      </span>
      <span class="meta-item">
        <i class="fas fa-file-alt"></i>
        Page {{ current_page.page_number }} / {{ total_pages }}
      </span>
      <span class="meta-item">
        <i class="fas fa-calendar"></i>
        {{ document.validated_at|date:"d/m/Y" }}
      </span>
    </div>
  </div>

    <div class="header-actions">
      <button class="nav-btn nav-btn-icon me-2" onclick="viewOriginalDocument({{ document.id }})" title="Voir le document original">
        <i class="fas fa-eye"></i>
      </button>
      <a href="{% url 'rawdocs:annotation_dashboard' %}" class="nav-btn nav-btn-icon" title="Retour au dashboard">
        <i class="fas fa-arrow-left"></i>
      </a>
    </div>
</section>

<!-- NOUVELLE SECTION: Analyse Réglementaire Panel -->
<section class="regulatory-analysis-panel">
  <h3><i class="fas fa-balance-scale"></i> Analyse Réglementaire du Document</h3>
  <p class="instructions">Analysez automatiquement le contenu réglementaire de chaque page et du document complet</p>

  <!-- Statistiques réglementaires -->
  <div class="regulatory-stats">
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.analyzed_pages }}</span>
      <span class="regulatory-stat-label">Pages analysées</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.completion_percentage }}%</span>
      <span class="regulatory-stat-label">Progression</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{{ regulatory_stats.high_importance_pages }}</span>
      <span class="regulatory-stat-label">Pages critiques</span>
    </div>
    <div class="regulatory-stat">
      <span class="regulatory-stat-value">{% if global_analysis %}{{ global_analysis.global_regulatory_score }}{% else %}0{% endif %}</span>
      <span class="regulatory-stat-label">Score global</span>
    </div>
  </div>

  <!-- Barre de progression -->
  <div class="regulatory-progress">
    <div class="progress-bar-regulatory" style="width: {{ regulatory_stats.completion_percentage }}%"></div>
  </div>

  <!-- Boutons d'action réglementaire -->
  <div class="regulatory-actions" style="display: flex; gap: 1rem; align-items: center;">
    <button id="analyze-page-regulatory-btn" class="btn-regulatory" onclick="analyzePageRegulatory()">
      <i class="fas fa-gavel"></i> Analyser cette Page
    </button>

    <button id="analyze-document-regulatory-btn" class="btn-regulatory" onclick="analyzeDocumentRegulatory()">
      <i class="fas fa-book-open"></i> Analyser tout le Document
    </button>

    <div id="regulatory-loading" class="regulatory-loading" style="display: none;">
      <i class="fas fa-spinner fa-spin"></i> Analyse réglementaire en cours...
    </div>
  </div>

  <!-- Résumé global du document si disponible -->
  {% if global_analysis %}
  <div class="document-global-summary" style="margin-top: 1.5rem; padding: 1rem; background: var(--pharma-bg-card); border-radius: 8px; border: 1px solid var(--pharma-border);">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-file-contract"></i> Résumé Réglementaire Global
    </h4>
    <p style="margin-bottom: 1rem; line-height: 1.6;">{{ global_analysis.global_summary }}</p>

    {% if global_analysis.consolidated_analysis.main_regulatory_themes %}
    <div class="regulatory-themes" style="margin-top: 1rem;">
      <strong style="color: var(--pharma-primary-dark);">Thèmes principaux:</strong>
      <ul style="margin-top: 0.5rem; padding-left: 1.2rem;">
        {% for theme in global_analysis.consolidated_analysis.main_regulatory_themes %}
        <li style="margin-bottom: 0.3rem;">{{ theme }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  {% endif %}
</section>

<!-- SÉPARATEUR VISUEL CLAIR -->
<div style="
  margin: 3rem 0; 
  height: 60px; 
  background: linear-gradient(135deg, rgba(14,165,233,0.1) 0%, rgba(16,185,129,0.1) 50%, rgba(14,165,233,0.1) 100%); 
  border-radius: 16px; 
  border: 2px solid rgba(14,165,233,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
">
  <div style="
    background: white; 
    padding: 8px 20px; 
    border-radius: 25px; 
    border: 1px solid rgba(14,165,233,0.3);
    box-shadow: 0 4px 12px rgba(14,165,233,0.1);
    font-weight: 600;
    color: var(--pharma-primary-dark);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  ">
    <span>⚖️</span>
    <span>Analyse Réglementaire</span>
    <span style="margin: 0 8px;">→</span>
    <span>📝</span>
    <span>Annotation</span>
  </div>
</div>

<!-- Annotation Types Panel (identique) -->
<section class="annotation-types-panel">
  <h3>Sélectionnez un type d'entité</h3>
  <p class="instructions">Cliquez sur un type, puis surlignez le texte correspondant</p>

  <div class="annotation-types">
    {% for ann_type in annotation_types %}
    <button class="annotation-type-btn"
            data-type="{{ ann_type.name }}"
            data-color="{{ ann_type.color }}"
            style="border-color: {{ ann_type.color }}; color: {{ ann_type.color }};">
      {{ ann_type.display_name }}
    </button>
    {% endfor %}
    <button class="annotation-type-btn-add" onclick="showAddAnnotationTypeModal()" type="button">
      <i class="fas fa-plus"></i> Add Custom Type
    </button>
  </div>

  <div class="annotation-mode">
    <span class="mode-label">
      <i class="fas fa-hand-pointer"></i>
      Mode annotation activé:
    </span>
    <span id="current-mode" class="current-mode">Aucun type sélectionné</span>
  </div>

  <p class="help-text">Surlignez du texte pour créer une annotation automatiquement</p>

  <div id="context-menu" class="context-menu hidden">
    <button class="context-menu-item danger" onclick="deleteAnnotationTypeFromMenu()">
        <i class="fas fa-trash"></i> Delete Annotation Type
    </button>
    <button class="context-menu-item" onclick="hideContextMenu()">
        <i class="fas fa-times"></i> Cancel
    </button>
</div>
</section>

<!-- Page Navigation avec disposition améliorée des boutons -->
<section class="page-navigation">
  <!-- Navigation des pages -->
  <div class="page-controls">
    {% if current_page.page_number > 1 %}
      <a href="?page={{ current_page.page_number|add:'-1' }}" class="nav-btn nav-btn-icon" title="Page précédente">
        <i class="fas fa-angle-left"></i>
      </a>
    {% endif %}

    <div class="page-selector">
      <select id="page-select" onchange="goToPage(this.value)">
        {% for page in pages %}
        <option value="{{ page.page_number }}"
                {% if page.page_number == current_page.page_number %}selected{% endif %}>
          Page {{ page.page_number }}
          {% if page.is_validated_by_human %}🎓{% elif page.is_annotated %}✅{% endif %}
          {% if page.is_regulatory_analyzed %}⚖️{% endif %}
        </option>
        {% endfor %}
      </select>
    </div>

    {% if current_page.page_number < total_pages %}
      <a href="?page={{ current_page.page_number|add:'1' }}" class="nav-btn nav-btn-icon" title="Page suivante">
        <i class="fas fa-angle-right"></i>
      </a>
    {% endif %}
  </div>

  <!-- Actions organisées par catégories -->
  <div class="actions-container">
    <!-- Groupe 1: Actions IA et Validation -->
    <div class="action-group">
      <h4 class="group-title">IA & Validation</h4>
      <div class="buttons-row">
        <button id="groq-annotate-btn" class="btn-groq" onclick="annotateWithGroq()">
          <i class="fas fa-rocket"></i> Annotation AI
        </button>

        <button id="validate-page-btn" class="btn-validate" onclick="validatePage()"
                {% if current_page.is_validated_by_human %}disabled{% endif %}>
          <i class="fas fa-graduation-cap"></i>
          {% if current_page.is_validated_by_human %}Page Validée{% else %}Validate Page{% endif %}
        </button>
      </div>
    </div>

    <!-- Groupe 2: Actions JSON -->
    <div class="action-group">
      <h4 class="group-title">Export JSON</h4>
      <div class="buttons-row">
        <div class="json-action-pair">
          <button id="generate-page-json-btn" class="btn-json-page" onclick="generatePageJson()">
            <i class="fas fa-code"></i> Générer JSON Page
          </button>

          <a href="{% url 'rawdocs:view_page_annotation_json' current_page.id %}"
             class="btn-view-json-page" target="_blank" title="Voir le JSON de cette page">
            <i class="fas fa-file-code"></i>
          </a>
        </div>

        <div class="json-action-pair">
          <button id="generate-document-json-btn" class="btn-json-document" onclick="generateDocumentJson()">
            <i class="fas fa-file-contract"></i> Générer JSON Global
          </button>

          <a href="{% url 'rawdocs:view_document_annotation_json' document.id %}"
             class="btn-view-json-global" target="_blank" title="Voir le JSON du document complet">
            <i class="fas fa-book-open"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Groupe 3: Révision Expert -->
    <div class="action-group">
      <h4 class="group-title">Révision Expert</h4>
      <div class="buttons-row">
        {% if not document.is_ready_for_expert %}
          <button id="submit-document-expert-btn" class="btn-expert" onclick="submitDocumentForExpert()">
            <i class="fas fa-user-graduate"></i>
            Soumission à l'Expert
          </button>
        {% else %}
          <button class="btn btn-success" disabled>
            <i class="fas fa-check-circle"></i>
            Document Soumis ✓
          </button>
        {% endif %}
      </div>
    </div>

    <!-- Indicateurs de chargement -->
    <div class="loading-indicators">
      <div id="ai-loading" class="ai-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> IA en cours...
      </div>

      <div id="learning-progress" class="learning-progress" style="display: none;">
        <i class="fas fa-brain"></i> IA en apprentissage...
      </div>

      <div id="json-loading" class="json-loading" style="display: none;">
        <i class="fas fa-spinner fa-spin"></i> Génération JSON...
      </div>
    </div>
  </div>
</section>

<!-- Learning Dashboard Widget (identique) -->
<section class="learning-dashboard-widget" id="learning-widget" style="display: none;"></section>

<!-- NOUVELLE SECTION: Analyse Réglementaire de la Page Courante -->
{% if current_page.is_regulatory_analyzed %}
<section class="page-regulatory-analysis">
  <h3 style="color: var(--pharma-info); margin-bottom: 1rem;">
    <i class="fas fa-gavel"></i>
    Analyse Réglementaire - Page {{ current_page.page_number }}
    <span class="importance-score {% if current_page.regulatory_importance_score >= 90 %}critical{% elif current_page.regulatory_importance_score >= 70 %}high{% elif current_page.regulatory_importance_score >= 50 %}medium{% else %}low{% endif %}">
      <i class="fas fa-chart-line"></i>
      Score: {{ current_page.regulatory_importance_score }}/100
    </span>
  </h3>

  <!-- Résumé de la page -->
  {% if page_summary %}
  <div class="page-summary" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
    <h4 style="color: var(--pharma-info); margin-bottom: 0.5rem;">
      <i class="fas fa-file-text"></i> Résumé de la Page
    </h4>
    <p style="margin: 0; line-height: 1.6;">{{ page_summary }}</p>
  </div>
  {% endif %}

  <!-- Points clés réglementaires -->
  {% if page_analysis.key_regulatory_points %}
  <div class="key-points-list">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-list-ul"></i> Points Clés Réglementaires
    </h4>
    {% for point in page_analysis.key_regulatory_points %}
    <div class="key-point">{{ point }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Obligations réglementaires -->
  {% if page_analysis.regulatory_obligations %}
  <div class="regulatory-obligations">
    <h4 style="color: var(--pharma-warn); margin-bottom: 0.8rem;">
      <i class="fas fa-exclamation-triangle"></i> Obligations Réglementaires
    </h4>
    {% for obligation in page_analysis.regulatory_obligations %}
    <div class="obligation-item obligation-severity {{ obligation.severity }}">
      <strong>{{ obligation.obligation }}</strong>
      {% if obligation.authority %}
      <div style="margin-top: 0.3rem; font-size: 0.9rem; color: var(--pharma-text-soft);">
        <i class="fas fa-building"></i> {{ obligation.authority }}
      </div>
      {% endif %}
      {% if obligation.deadline %}
      <div style="margin-top: 0.3rem; font-size: 0.9rem; color: var(--pharma-warn);">
        <i class="fas fa-clock"></i> {{ obligation.deadline }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Délais critiques -->
  {% if page_analysis.critical_deadlines %}
  <div class="deadlines-list">
    <h4 style="color: var(--pharma-error); margin-bottom: 0.8rem;">
      <i class="fas fa-hourglass-half"></i> Délais Critiques
    </h4>
    {% for deadline in page_analysis.critical_deadlines %}
    <div class="deadline-item">
      <div>
        <strong>{{ deadline.deadline }}</strong>
        {% if deadline.trigger_event %}
        <div style="font-size: 0.9rem; color: var(--pharma-text-soft);">
          Déclencheur: {{ deadline.trigger_event }}
        </div>
        {% endif %}
      </div>
      <span class="deadline-timeframe">{{ deadline.timeframe }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Autorités mentionnées -->
  {% if page_analysis.authorities_mentioned %}
  <div class="authorities-list">
    <h4 style="color: var(--pharma-primary-dark); margin-bottom: 0.8rem;">
      <i class="fas fa-university"></i> Autorités Réglementaires
    </h4>
    {% for authority in page_analysis.authorities_mentioned %}
    <span class="authority-tag">{{ authority.name }}</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Documents requis -->
  {% if page_analysis.documents_required %}
  <div class="documents-required" style="margin-top: 1rem;">
    <h4 style="color: var(--pharma-accent); margin-bottom: 0.8rem;">
      <i class="fas fa-folder-open"></i> Documents Requis
    </h4>
    {% for doc in page_analysis.documents_required %}
    <div class="key-point">
      <strong>{{ doc.document }}</strong>
      {% if doc.when %} - À fournir: {{ doc.when }}{% endif %}
      {% if doc.to_whom %} - À: {{ doc.to_whom }}{% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</section>
{% endif %}

<!-- Main Text Content avec espacement -->
<section class="text-content-card main-content" style="margin-top: 3rem;">
  <h3>
    <i class="fas fa-file-text"></i>
    Page {{ current_page.page_number }}
    {% if current_page.is_validated_by_human %}
      <span class="page-status validated-human">Validée par humain</span>
    {% elif current_page.is_annotated %}
      <span class="page-status annotated">Annotée</span>
    {% else %}
      <span class="page-status pending">En attente</span>
    {% endif %}
    {% if current_page.is_regulatory_analyzed %}
      <span class="page-status" style="background: #e0f2fe; color: var(--pharma-info);">Analysée réglementairement</span>
    {% endif %}
  </h3>

  <div id="text-content" class="text-content" data-page-id="{{ current_page.id }}">
    {{ current_page.cleaned_text }}
  </div>
</section>

<!-- Annotations List (identique) -->
<section class="annotations-list">
  <h3><i class="fas fa-tags"></i> Annotations ({{ existing_annotations.count }})</h3>

  <div id="annotations-container">
    {% for annotation in existing_annotations %}
    <div class="annotation-item" data-annotation-id="{{ annotation.id }}">
      <div class="annotation-header">
        <span class="annotation-type" style="background: {{ annotation.annotation_type.color }}">
          {{ annotation.annotation_type.display_name }}
        </span>
        <span class="annotation-confidence">{{ annotation.confidence_score|floatformat:0 }}%</span>

        <!-- NOUVEAU: Bouton d'édition -->
        <button class="edit-annotation" onclick="openEditAnnotationModal({{ annotation.id }})"
                title="Modifier cette annotation">
          <i class="fas fa-edit"></i>
        </button>

        <button class="delete-annotation" onclick="deleteAnnotation({{ annotation.id }})">
          <i class="fas fa-trash"></i>
        </button>
      </div>

      <div class="annotation-text annotation-text-clickable"
        onclick="highlightTextInDocument('{{ annotation.selected_text|escapejs }}', {{ annotation.start_pos }}, {{ annotation.end_pos }})"
        style="cursor: pointer; color: var(--pharma-primary-dark); text-decoration: underline;"
        title="Cliquez pour voir dans le texte">"{{ annotation.selected_text }}"</div>

      {% if annotation.ai_reasoning %}
      <div class="annotation-reasoning">
        <i class="fas fa-lightbulb"></i> {{ annotation.ai_reasoning }}
      </div>
      {% endif %}

      <!-- NOUVEAU: Indicateur si modifié par humain -->
      {% if annotation.modified_by_human %}
      <div class="human-modified-indicator">
        <i class="fas fa-user-edit"></i> Modifié par {{ annotation.last_modified_by.username|default:"humain" }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>

<!-- Modal pour ajouter des types d'annotation (identique) -->
<div class="modal fade" id="addAnnotationTypeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Annotation Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-annotation-display-name" class="form-label">Display Name</label>
                    <input type="text" class="form-control" id="new-annotation-display-name"
                           placeholder="e.g., Product, Dosage, Method">
                </div>
                <div class="mb-3">
                    <label for="new-annotation-name" class="form-label">Technical Name (auto-generated)</label>
                    <input type="text" class="form-control" id="new-annotation-name" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAnnotationType()">
                    Create Type
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal pour éditer une annotation -->
<div class="modal fade" id="editAnnotationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Modifier l'Annotation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Texte sélectionné -->
                <div class="mb-3">
                    <label for="edit-selected-text" class="form-label">
                        <i class="fas fa-quote-right"></i> Texte Sélectionné
                    </label>
                    <textarea class="form-control" id="edit-selected-text" rows="3"
                             placeholder="Texte à annoter..."></textarea>
                    <div class="form-text">
                        Vous pouvez modifier le texte sélectionné pour corriger l'IA
                    </div>
                </div>

                <!-- Type d'annotation -->
                <div class="mb-3">
                    <label for="edit-annotation-type" class="form-label">
                        <i class="fas fa-tags"></i> Type d'Annotation
                    </label>
                    <select class="form-control" id="edit-annotation-type">
                        <option value="">Sélectionner un type...</option>
                        {% for ann_type in annotation_types %}
                        <option value="{{ ann_type.id }}" data-color="{{ ann_type.color }}">
                            {{ ann_type.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Positions (pour les utilisateurs avancés) -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-crosshairs"></i> Positions dans le texte
                    </label>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="number" class="form-control" id="edit-start-pos"
                                   placeholder="Position début" readonly>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" id="edit-end-pos"
                                   placeholder="Position fin" readonly>
                        </div>
                    </div>
                    <div class="form-text">
                        Les positions sont automatiquement calculées
                    </div>
                </div>

                <!-- Informations sur l'annotation -->
                <div class="mb-3">
                    <div class="annotation-info-panel" style="
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        padding: 1rem;
                    ">
                        <div class="annotation-meta">
                            <div><strong>Créée par:</strong> <span id="edit-created-by">-</span></div>
                            <div><strong>Confiance IA:</strong> <span id="edit-confidence">-</span>%</div>
                            <div><strong>Raisonnement IA:</strong></div>
                            <div id="edit-ai-reasoning" style="
                                font-style: italic;
                                color: #6c757d;
                                margin-top: 0.5rem;
                                padding: 0.5rem;
                                background: #e9ecef;
                                border-radius: 4px;
                            ">-</div>
                        </div>
                    </div>
                </div>

                <!-- Message d'aide -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Conseil:</strong> Modifiez le texte et/ou le type pour corriger les erreurs de l'IA.
                    Vos corrections aident l'IA à s'améliorer!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAnnotationChanges()">
                    <i class="fas fa-save"></i> Sauvegarder les Modifications
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'rawdocs/js/rlhf_annotation.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript existant + nouvelles fonctions JSON -->
<script>
// EXISTING JAVASCRIPT CODE (conservé identique)
let annotationTypeMap = {};

// Initialize the type mapping when page loads
document.addEventListener('DOMContentLoaded', function() {
    // BUILD THE TYPE MAPPING FIRST
    {% for ann_type in annotation_types %}
    annotationTypeMap['{{ ann_type.name|escapejs }}'] = {{ ann_type.id }};
    {% endfor %}

    console.log('📋 Annotation type mapping loaded:', annotationTypeMap);
});

// NOUVELLES FONCTIONS POUR L'ANALYSE RÉGLEMENTAIRE

function analyzePageRegulatory() {
    const btn = document.getElementById('analyze-page-regulatory-btn');
    const loading = document.getElementById('regulatory-loading');

    // Désactiver le bouton et afficher le loading
    btn.disabled = true;
    loading.style.display = 'inline-flex';

    const pageId = document.getElementById('text-content').dataset.pageId;

    fetch(`/regulatory/analyze-page/${pageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher le succès
            showRegulatorySuccess(data.message, data.importance_score);

            // Recharger la page pour afficher l'analyse
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur analyse réglementaire:', error);
        alert('Erreur lors de l\'analyse réglementaire');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
    });
}

function analyzeDocumentRegulatory() {
    if (!confirm('Analyser tout le document peut prendre plusieurs minutes. Continuer ?')) {
        return;
    }

    const btn = document.getElementById('analyze-document-regulatory-btn');
    const loading = document.getElementById('regulatory-loading');

    btn.disabled = true;
    loading.style.display = 'inline-flex';
    loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse complète en cours...';

    const documentId = {{ document.id }};

    fetch(`/regulatory/analyze-document/${documentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showRegulatorySuccess(data.message, data.global_score);

            // Recharger la page pour afficher l'analyse
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur analyse document:', error);
        alert('Erreur lors de l\'analyse du document');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse réglementaire en cours...';
    });
}

function showRegulatorySuccess(message, score) {
    // Créer et afficher un message de succès
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';
    successDiv.innerHTML = `
        <i class="fas fa-balance-scale" style="font-size: 1.5rem;"></i>
        <div>
            <strong>✅ ${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">Score d'importance: ${score}/100</div>
        </div>
    `;

    // Insérer avant le contenu principal
    const mainContent = document.querySelector('.text-content-card');
    mainContent.parentNode.insertBefore(successDiv, mainContent);

    // Supprimer après 5 secondes
    setTimeout(() => {
        successDiv.remove();
    }, 5000);
}

// NOUVELLES FONCTIONS POUR GÉNÉRATION JSON ET RÉSUMÉS

function generatePageJson() {
    const btn = document.getElementById('generate-page-json-btn');
    const loading = document.getElementById('json-loading');

    // Vérifier qu'il y a des annotations
    const annotationsCount = document.querySelectorAll('.annotation-item').length;
    if (annotationsCount === 0) {
        alert('Aucune annotation trouvée sur cette page. Annotez d\'abord la page.');
        return;
    }

    // Désactiver le bouton et afficher le loading
    btn.disabled = true;
    loading.style.display = 'inline-flex';

    const pageId = document.getElementById('text-content').dataset.pageId;

    fetch(`/annotation/page/${pageId}/generate-summary/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher le succès
            showJsonSuccess(data.message, 'page');

            // Optionnel : ouvrir automatiquement la vue JSON
            setTimeout(() => {
                window.open(`/annotation/page/${pageId}/view-json/`, '_blank');
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur génération JSON page:', error);
        alert('Erreur lors de la génération du JSON');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
    });
}

function generateDocumentJson() {
    // Vérifier qu'il y a des annotations dans le document
    const documentId = {{ document.id }};

    if (!confirm('Générer le JSON global et le résumé de tout le document ? Cela peut prendre quelques minutes selon la taille du document.')) {
        return;
    }

    const btn = document.getElementById('generate-document-json-btn');
    const loading = document.getElementById('json-loading');

    btn.disabled = true;
    loading.style.display = 'inline-flex';
    loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération JSON global...';

    fetch(`/annotation/document/${documentId}/generate-summary/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher le succès avec statistiques
            showJsonSuccess(data.message, 'document', data.stats);

            // Optionnel : ouvrir automatiquement la vue JSON globale
            setTimeout(() => {
                window.open(`/annotation/document/${documentId}/view-json/`, '_blank');
            }, 1000);
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur génération JSON document:', error);
        alert('Erreur lors de la génération du JSON global');
    })
    .finally(() => {
        btn.disabled = false;
        loading.style.display = 'none';
        loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération JSON...';
    });
}

function showJsonSuccess(message, type, stats = null) {
    // Créer et afficher un message de succès
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';

    let statsText = '';
    if (stats) {
        statsText = `<div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">
            ${stats.total_annotations} annotations • ${stats.total_pages} pages
        </div>`;
    }

    const icon = type === 'document' ? 'fas fa-file-contract' : 'fas fa-code';

    successDiv.innerHTML = `
        <i class="${icon}" style="font-size: 1.5rem;"></i>
        <div>
            <strong>✅ ${message}</strong>
            ${statsText}
        </div>
    `;

    // Insérer avant le contenu principal
    const mainContent = document.querySelector('.text-content-card');
    mainContent.parentNode.insertBefore(successDiv, mainContent);

    // Supprimer après 5 secondes
    setTimeout(() => {
        successDiv.remove();
    }, 5000);
}

// RESTE DU JAVASCRIPT EXISTANT (conservé identique)

let selectedAnnotationType = null;
let selectedColor = null;

// FIXED: Initialize annotation type selection
document.addEventListener('DOMContentLoaded', function() {
    // Initialize annotation type buttons
    document.querySelectorAll('.annotation-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.annotation-type-btn').forEach(b => b.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Set selected type
            selectedAnnotationType = this.dataset.type;
            selectedColor = this.dataset.color;

            // Update current mode display
            document.getElementById('current-mode').textContent = this.textContent;
            document.getElementById('current-mode').style.backgroundColor = selectedColor;
        });
    });

    // Auto-generate technical name from display name
    document.getElementById('new-annotation-display-name').addEventListener('input', function() {
        const displayName = this.value;
        const technicalName = displayName.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        document.getElementById('new-annotation-name').value = technicalName;
    });

    // Mark validated pages
    const validateBtn = document.getElementById('validate-page-btn');
    if (validateBtn?.textContent?.includes('Validée')) {
        showLearningWidget({});
    }

    // Add indicators to AI-generated annotations
    document.querySelectorAll('.annotation-item').forEach(annotation => {
        if (annotation.querySelector('.annotation-reasoning')?.textContent?.includes('RLHF')) {
            annotation.classList.add('ai-generated');
            const indicator = document.createElement('div');
            indicator.className = 'rlhf-indicator';
            indicator.innerHTML = '<i class="fas fa-brain"></i> IA Apprenante';
            annotation.appendChild(indicator);
        }
    });
});

// TOUTES LES AUTRES FONCTIONS JAVASCRIPT EXISTANTES (conservées identiques)
// Text selection for manual annotation, deletion, etc.

// Text selection for manual annotation
document.getElementById('text-content').addEventListener('mouseup', function() {
  if (!selectedAnnotationType) {
    alert('Veuillez d\'abord sélectionner un type d\'annotation');
    return;
  }

  const selection = window.getSelection();
  if (selection.toString().trim().length === 0) return;

  const range = selection.getRangeAt(0);
  const selectedText = selection.toString().trim();

  // Calculate positions
  const textContent = this.textContent;
  const startPos = getTextPosition(this, range.startContainer, range.startOffset);
  const endPos = startPos + selectedText.length;

  // Save annotation
  saveManualAnnotation({
    page_id: this.dataset.pageId,
    type_id: getAnnotationTypeId(selectedAnnotationType),
    start_pos: startPos,
    end_pos: endPos,
    selected_text: selectedText
  });

  // Clear selection
  selection.removeAllRanges();
});

function getTextPosition(container, node, offset) {
  let position = 0;
  const walker = document.createTreeWalker(
    container,
    NodeFilter.SHOW_TEXT,
    null,
    false
  );

  let currentNode;
  while (currentNode = walker.nextNode()) {
    if (currentNode === node) {
      return position + offset;
    }
    position += currentNode.textContent.length;
  }
  return position;
}

function getAnnotationTypeId(typeName) {
    console.log('🔍 Looking for type:', typeName);
    console.log('📋 Available types:', annotationTypeMap);

    const typeId = annotationTypeMap[typeName];
    if (!typeId) {
        console.error('❌ Type ID not found for:', typeName);
        console.error('Available types:', Object.keys(annotationTypeMap));
        return null;
    }

    console.log('✅ Found type ID:', typeId, 'for type:', typeName);
    return typeId;
}

function saveManualAnnotation(data) {
  fetch('{% url "rawdocs:save_manual_annotation" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // Refresh to show new annotation
    } else {
      alert('Erreur: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Erreur lors de la sauvegarde');
  });
}

function deleteAnnotation(annotationId) {
  if (!confirm('Supprimer cette annotation ?')) return;

  fetch(`{% url "rawdocs:delete_annotation" 0 %}`.replace('0', annotationId), {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Erreur: ' + data.error);
    }
  });
}

function goToPage(pageNumber) {
  window.location.href = `?page=${pageNumber}`;
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function submitDocumentForExpert() {
    if (confirm('Soumettre ce document complet pour révision expert ?')) {
        const documentId = {{ document.id }};
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/submit-for-expert/${documentId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}

// FIXED: Modal handling like expert module
function showAddAnnotationTypeModal() {
    // Clear previous values
    document.getElementById('new-annotation-display-name').value = '';
    document.getElementById('new-annotation-name').value = '';

    // Show modal with proper Bootstrap 5 method
    const modal = new bootstrap.Modal(document.getElementById('addAnnotationTypeModal'), {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    modal.show();
}

function createAnnotationType() {
    const displayName = document.getElementById('new-annotation-display-name').value.trim();
    const name = document.getElementById('new-annotation-name').value.trim();

    if (!displayName) {
        alert('Please enter a display name');
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/create-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            display_name: displayName,
            name: name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);

            // CRITICAL: Add the new type to our mapping!
            annotationTypeMap[data.annotation_type.name] = data.annotation_type.id;
            console.log('📋 Updated type mapping:', annotationTypeMap);

            // Add new button to the interface immediately
            addNewAnnotationButtonToAnnotateur(data.annotation_type);

            // Close modal properly
            const modalElement = document.getElementById('addAnnotationTypeModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }

            // Clear form
            document.getElementById('new-annotation-display-name').value = '';
            document.getElementById('new-annotation-name').value = '';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating annotation type');
    });
}

function addNewAnnotationButtonToAnnotateur(annotationType) {
    // Check if button already exists to avoid duplicates
    const existingButton = document.querySelector(`[data-type="${annotationType.name}"]`);
    if (existingButton && !existingButton.classList.contains('annotation-type-btn-add')) {
        console.log('Button already exists for type:', annotationType.name);
        return;
    }
    annotationTypeMap[annotationType.name] = annotationType.id;
    console.log('📋 Updated type mapping:', annotationTypeMap);

    // Create new button element
    const newButton = document.createElement('button');
    newButton.className = 'annotation-type-btn';
    newButton.setAttribute('data-type', annotationType.name);
    newButton.setAttribute('data-color', annotationType.color);
    newButton.style.borderColor = annotationType.color;
    newButton.style.color = annotationType.color;
    newButton.textContent = annotationType.display_name;

    // Add event listener for the new button
    newButton.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.annotation-type-btn').forEach(b => b.classList.remove('active'));

        // Add active class to clicked button
        this.classList.add('active');

        // Set selected type
        selectedAnnotationType = this.dataset.type;
        selectedColor = this.dataset.color;

        // Update current mode display
        document.getElementById('current-mode').textContent = this.textContent;
        document.getElementById('current-mode').style.backgroundColor = selectedColor;
    });

    // Add to annotation types container (before the "Add" button)
    const container = document.querySelector('.annotation-types');
    const addButton = document.querySelector('.annotation-type-btn-add');
    if (container && addButton) {
        container.insertBefore(newButton, addButton);
    }
}

// RLHF Learning functions from the existing JS
function showLearningWidget(data) {
    let widget = document.getElementById('learning-widget') || createLearningWidget();

    fetch('/learning/dashboard/')
        .then(response => response.json())
        .then(learningData => {
            const avgScore = (learningData.average_feedback_score * 100).toFixed(0);
            const {performanceLevel, performanceIcon} = getPerformanceLevel(avgScore);

            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progrès d'Apprentissage IA</h4>
                <div class="learning-metrics">
                    <div class="metric">
                        <span class="metric-label">Score Réel:</span>
                        <span class="metric-value">${avgScore}%</span>
                        <span class="performance-indicator">${performanceIcon} ${performanceLevel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Validations:</span>
                        <span class="metric-value">${learningData.total_feedbacks}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Amélioration:</span>
                        <span class="metric-value">📈 Active</span>
                    </div>
                </div>
                <div class="learning-explanation">
                    <small><i class="fas fa-info-circle"></i> Score basé sur annotations correctes, erreurs et manqués</small>
                </div>
            `;
            widget.style.display = 'block';
        })
        .catch(error => {
            console.error('Learning Dashboard Error:', error);
            widget.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Progrès d'Apprentissage</h4>
                <div class="learning-error">
                    <i class="fas fa-exclamation-triangle"></i> Données non disponibles
                </div>
            `;
        });
}

function createLearningWidget() {
    const widget = document.createElement('section');
    widget.id = 'learning-widget';
    widget.className = 'learning-dashboard-widget';
    document.querySelector('.text-content-card')?.appendChild(widget);
    return widget;
}

function getPerformanceLevel(score) {
    score = parseInt(score);
    if (score >= 90) return {performanceLevel: 'Excellent', performanceIcon: '🏆'};
    if (score >= 75) return {performanceLevel: 'Bon', performanceIcon: '👍'};
    if (score >= 50) return {performanceLevel: 'Apprentissage', performanceIcon: '🎓'};
    return {performanceLevel: 'Nécessite entrainement', performanceIcon: '📚'};
}

let contextMenuTarget = null;

// Context menu functionality
document.addEventListener('DOMContentLoaded', function() {

    // Add right-click event listeners to all annotation type buttons
    function addContextMenuToButtons() {
        document.querySelectorAll('.annotation-type-btn').forEach(btn => {
            // Remove existing listeners to prevent duplicates
            btn.removeEventListener('contextmenu', handleRightClick);
            // Add new listener
            btn.addEventListener('contextmenu', handleRightClick);
        });
    }

    // Initial setup
    addContextMenuToButtons();

    // Update the addNewAnnotationButtonToAnnotateur function to include context menu
    const originalAddFunction = window.addNewAnnotationButtonToAnnotateur;
    window.addNewAnnotationButtonToAnnotateur = function(annotationType) {
        // Call original function
        originalAddFunction(annotationType);

        // Add context menu to new button
        setTimeout(() => {
            addContextMenuToButtons();
        }, 100);
    };

    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.context-menu')) {
            hideContextMenu();
        }
    });

    // Prevent default context menu on annotation buttons
    document.addEventListener('contextmenu', function(e) {
        if (e.target.classList.contains('annotation-type-btn')) {
            e.preventDefault();
        }
    });
});

function handleRightClick(e) {
    e.preventDefault();

    // Don't show context menu for the "Add Custom Type" button
    if (e.target.classList.contains('annotation-type-btn-add')) {
        return;
    }

    contextMenuTarget = e.target;

    const contextMenu = document.getElementById('context-menu');
    const rect = e.target.getBoundingClientRect();

    // Position the context menu
    contextMenu.style.left = (e.pageX) + 'px';
    contextMenu.style.top = (e.pageY) + 'px';

    // Show the menu
    contextMenu.classList.remove('hidden');

    console.log('🖱️ Right-clicked on:', e.target.textContent);
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.add('hidden');
    contextMenuTarget = null;
}

function deleteAnnotationTypeFromMenu() {
    if (!contextMenuTarget) {
        hideContextMenu();
        return;
    }

    const typeName = contextMenuTarget.dataset.type;
    const displayName = contextMenuTarget.textContent;

    // Confirm deletion
    if (!confirm(`Are you sure you want to delete the annotation type "${displayName}"?\n\nThis action cannot be undone.`)) {
        hideContextMenu();
        return;
    }

    console.log('🗑️ Deleting annotation type:', typeName);

    // Get the annotation type ID
    const typeId = annotationTypeMap[typeName];
    if (!typeId) {
        alert('Error: Could not find annotation type to delete');
        hideContextMenu();
        return;
    }

    // Call backend to delete the annotation type
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/delete-annotation-type/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            type_id: typeId,
            type_name: typeName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);

            // Remove from mapping
            delete annotationTypeMap[typeName];
            console.log('📋 Updated type mapping after deletion:', annotationTypeMap);

            // Remove the button from interface
            contextMenuTarget.remove();

            // Clear selection if this type was selected
            if (selectedAnnotationType === typeName) {
                selectedAnnotationType = null;
                selectedColor = null;
                document.getElementById('current-mode').textContent = 'Aucun type sélectionné';
                document.getElementById('current-mode').style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            }

            console.log('✅ Annotation type deleted successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting annotation type: ' + error.message);
    })
    .finally(() => {
        hideContextMenu();
    });
}

// View original document function
function viewOriginalDocument(documentId) {
    if (!documentId) {
        alert('Document ID non disponible');
        return;
    }

    // Create the URL to view the original document - SAME AS EXPERT
    const documentUrl = `/documents/${documentId}/view-original/`;

    // Open in new window like the expert interface
    window.open(documentUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

// Highlight text in document function
function highlightTextInDocument(text, startPos, endPos) {
    const pageDisplay = document.getElementById('text-content');

    // Store the clean original text content
    const originalTextContent = pageDisplay.textContent;

    // Remove any existing highlights first
    clearExistingHighlights();

    try {
        // Reset to clean text content
        pageDisplay.textContent = originalTextContent;

        let content = pageDisplay.textContent;
        let targetText = text.trim();

        let textIndex = -1;
        let foundText = targetText;

        // BULLETPROOF SEARCH STRATEGIES - Try them all!

        // Strategy 1: Exact match
        textIndex = content.indexOf(targetText);

        // Strategy 2: Case insensitive
        if (textIndex === -1) {
            textIndex = content.toLowerCase().indexOf(targetText.toLowerCase());
        }

        // Strategy 3: Flexible whitespace (spaces, line breaks, tabs)
        if (textIndex === -1) {
            const flexiblePattern = targetText.replace(/\s+/g, '\\s+');
            const regex = new RegExp(flexiblePattern, 'i');
            const match = content.match(regex);

            if (match) {
                textIndex = content.search(regex);
                foundText = match[0];
            }
        }

        // Strategy 4: Remove ALL whitespace and punctuation for comparison
        if (textIndex === -1) {
            const cleanTarget = targetText.replace(/[\s\(\)\-\.,;:!?]/g, '').toLowerCase();
            const cleanContent = content.toLowerCase();

            // Find position by removing chars progressively
            let bestMatch = '';
            let bestIndex = -1;
            let bestLength = 0;

            for (let i = 0; i < content.length - cleanTarget.length + 1; i++) {
                for (let len = cleanTarget.length; len <= cleanTarget.length + 50; len++) {
                    if (i + len > content.length) break;

                    const candidate = content.substring(i, i + len);
                    const cleanCandidate = candidate.replace(/[\s\(\)\-\.,;:!?]/g, '').toLowerCase();

                    if (cleanCandidate === cleanTarget) {
                        bestMatch = candidate;
                        bestIndex = i;
                        bestLength = len;
                        break;
                    }
                }
                if (bestMatch) break;
            }

            if (bestMatch) {
                textIndex = bestIndex;
                foundText = bestMatch;
            }
        }

        // Strategy 5: Word-by-word fuzzy matching
        if (textIndex === -1) {
            const targetWords = targetText.toLowerCase().split(/\s+/);
            const contentLower = content.toLowerCase();

            // Find first word
            const firstWordIndex = contentLower.indexOf(targetWords[0]);
            if (firstWordIndex !== -1) {
                // Try to match subsequent words within a reasonable window
                let currentPos = firstWordIndex;
                let matchedText = '';
                let allWordsFound = true;

                for (let word of targetWords) {
                    const wordPos = contentLower.indexOf(word, currentPos);
                    if (wordPos !== -1 && wordPos - currentPos < 100) { // Within 100 chars
                        if (!matchedText) {
                            matchedText = content.substring(firstWordIndex, wordPos + word.length);
                        } else {
                            matchedText = content.substring(firstWordIndex, wordPos + word.length);
                        }
                        currentPos = wordPos + word.length;
                    } else {
                        allWordsFound = false;
                        break;
                    }
                }

                if (allWordsFound && matchedText) {
                    textIndex = firstWordIndex;
                    foundText = matchedText;
                }
            }
        }

        // Strategy 6: Character-by-character similarity matching
        if (textIndex === -1) {
            const targetLower = targetText.toLowerCase().replace(/\s+/g, ' ');
            let bestSimilarity = 0;
            let bestIndex = -1;
            let bestMatch = '';

            // Try different window sizes around the target length
            const minLen = Math.max(5, targetText.length - 10);
            const maxLen = targetText.length + 20;

            for (let i = 0; i < content.length - minLen; i++) {
                for (let len = minLen; len <= maxLen && i + len <= content.length; len++) {
                    const candidate = content.substring(i, i + len);
                    const candidateLower = candidate.toLowerCase().replace(/\s+/g, ' ');

                    // Calculate similarity (simple character overlap)
                    let similarity = 0;
                    const minLength = Math.min(targetLower.length, candidateLower.length);

                    for (let j = 0; j < minLength; j++) {
                        if (targetLower[j] === candidateLower[j]) {
                            similarity++;
                        }
                    }

                    const similarityRatio = similarity / Math.max(targetLower.length, candidateLower.length);

                    if (similarityRatio > bestSimilarity && similarityRatio > 0.7) {
                        bestSimilarity = similarityRatio;
                        bestIndex = i;
                        bestMatch = candidate;
                    }
                }
            }

            if (bestIndex !== -1) {
                textIndex = bestIndex;
                foundText = bestMatch;
            }
        }

        // Strategy 7: Last resort - partial matching
        if (textIndex === -1) {
            const words = targetText.split(/\s+/);
            for (let word of words) {
                if (word.length > 3) { // Only try meaningful words
                    const wordIndex = content.toLowerCase().indexOf(word.toLowerCase());
                    if (wordIndex !== -1) {
                        // Found at least one significant word
                        textIndex = wordIndex;
                        foundText = word;
                        console.log(`⚠️ Partial match found: "${word}" from "${targetText}"`);
                        break;
                    }
                }
            }
        }

        // HIGHLIGHT THE RESULT
        if (textIndex !== -1) {
            console.log(`✅ FOUND: "${foundText}" at position ${textIndex}`);

            // Create highlighted version
            const beforeText = content.substring(0, textIndex);
            const highlightedText = content.substring(textIndex, textIndex + foundText.length);
            const afterText = content.substring(textIndex + foundText.length);

            // Replace with highlighted version
            pageDisplay.innerHTML =
                beforeText +
                '<span id="highlighted-annotation" style="background-color: #fff3cd; padding: 2px 4px; border-radius: 3px; border: 2px solid #ffc107; animation: highlight-pulse 2s ease-in-out;">' +
                highlightedText +
                '</span>' +
                afterText;

            // Scroll to the highlighted text
            document.getElementById('highlighted-annotation').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // Clear any existing timeout
            if (window.highlightTimeout) {
                clearTimeout(window.highlightTimeout);
            }

            // Remove highlight after 5 seconds and restore clean text
            window.highlightTimeout = setTimeout(() => {
                pageDisplay.textContent = originalTextContent;
            }, 5000);

        } else {
            console.log('❌ NO MATCH FOUND with any strategy for:', targetText);
            alert('Texte non trouvé même avec recherche avancée: "' + targetText.substring(0, 50) + (targetText.length > 50 ? '...' : '') + '"');
        }
    } catch (error) {
        console.error('Error highlighting text:', error);
        pageDisplay.textContent = originalTextContent;
    }
}

function clearExistingHighlights() {
    if (window.highlightTimeout) {
        clearTimeout(window.highlightTimeout);
    }

    const existingHighlight = document.getElementById('highlighted-annotation');
    if (existingHighlight) {
        const parent = existingHighlight.parentNode;
        parent.replaceChild(document.createTextNode(existingHighlight.textContent), existingHighlight);
        parent.normalize();
    }
}

// Fonction pour valider la page avec RLHF
function validatePage() {
    const btn = document.getElementById('validate-page-btn');
    const pageId = document.getElementById('text-content').dataset.pageId;

    if (confirm('Valider cette page ? Cela confirmera que les annotations sont correctes.')) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validation...';

        fetch(`/annotation/validate-page/${pageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher le succès avec les métriques d'apprentissage
                const successDiv = document.createElement('div');
                successDiv.className = 'validation-success';
                successDiv.innerHTML = `
                    <i class="fas fa-graduation-cap" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>✅ ${data.message}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            L'IA s'améliore grâce à votre validation !
                        </div>
                    </div>
                `;

                // Insérer avant le contenu principal
                const mainContent = document.querySelector('.text-content-card');
                mainContent.parentNode.insertBefore(successDiv, mainContent);

                // Afficher le widget d'apprentissage
                if (data.ai_improved) {
                    showLearningWidget(data);
                }

                // Mettre à jour le bouton
                btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Page Validée 🎓';
                btn.disabled = true;

                // Supprimer le message après 5 secondes
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);

            } else {
                alert('Erreur: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Validate Page';
            }
        })
        .catch(error => {
            console.error('Erreur validation:', error);
            alert('Erreur lors de la validation');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-graduation-cap"></i> Validate Page';
        });
    }
}

// Fonction pour l'annotation IA avec GROQ
function annotateWithGroq() {
    const btn = document.getElementById('groq-annotate-btn');
    const loading = document.getElementById('ai-loading');
    const pageId = document.getElementById('text-content').dataset.pageId;

    if (confirm('Lancer l\'annotation automatique avec IA ? Cela remplacera les annotations existantes.')) {
        btn.disabled = true;
        loading.style.display = 'inline-flex';

        fetch(`/annotation/groq/${pageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher le succès
                const successDiv = document.createElement('div');
                successDiv.className = 'validation-success';
                successDiv.innerHTML = `
                    <i class="fas fa-rocket" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong>✅ ${data.message}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            IA améliorée par l'apprentissage RLHF
                        </div>
                    </div>
                `;

                // Insérer avant le contenu principal
                const mainContent = document.querySelector('.text-content-card');
                mainContent.parentNode.insertBefore(successDiv, mainContent);

                // Recharger pour afficher les nouvelles annotations
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur annotation IA:', error);
            alert('Erreur lors de l\'annotation IA');
        })
        .finally(() => {
            btn.disabled = false;
            loading.style.display = 'none';
        });
    }
}


// Variables globales pour l'édition
let currentEditingAnnotationId = null;
let editModal = null;

// Initialiser le modal d'édition au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le modal d'édition (s'il existe)
    const editModalElement = document.getElementById('editAnnotationModal');
    if (editModalElement) {
        editModal = new bootstrap.Modal(editModalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
});

/**
 * Ouvre le modal d'édition pour une annotation spécifique
 */
function openEditAnnotationModal(annotationId) {
    console.log('🖊️ Ouverture du modal d\'édition pour annotation:', annotationId);

    if (!editModal) {
        alert('Modal d\'édition non disponible');
        return;
    }

    // Stocker l'ID de l'annotation en cours d'édition
    currentEditingAnnotationId = annotationId;

    // Charger les détails de l'annotation
    loadAnnotationDetails(annotationId);
}

/**
 * Charge les détails d'une annotation depuis le serveur
 */
function loadAnnotationDetails(annotationId) {
    // Afficher un indicateur de chargement
    showEditModalLoading(true);

    fetch(`/annotation/${annotationId}/details/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateEditModal(data.annotation);
            editModal.show();
        } else {
            alert('Erreur lors du chargement des détails: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur chargement annotation:', error);
        alert('Erreur lors du chargement des détails de l\'annotation');
    })
    .finally(() => {
        showEditModalLoading(false);
    });
}

/**
 * Remplit le modal d'édition avec les données de l'annotation
 */
function populateEditModal(annotation) {
    // Remplir les champs du formulaire
    document.getElementById('edit-selected-text').value = annotation.selected_text || '';
    document.getElementById('edit-annotation-type').value = annotation.annotation_type.id || '';
    document.getElementById('edit-start-pos').value = annotation.start_pos || '';
    document.getElementById('edit-end-pos').value = annotation.end_pos || '';

    // Remplir les informations sur l'annotation
    document.getElementById('edit-created-by').textContent = annotation.created_by || 'IA';
    document.getElementById('edit-confidence').textContent = Math.round(annotation.confidence_score || 0);
    document.getElementById('edit-ai-reasoning').textContent = annotation.ai_reasoning || 'Aucun raisonnement disponible';

    // Mettre en surbrillance si modifié par humain
    if (annotation.modified_by_human) {
        const infoPanel = document.querySelector('.annotation-info-panel');
        if (infoPanel) {
            infoPanel.style.borderLeft = '4px solid var(--pharma-accent)';
            infoPanel.style.backgroundColor = '#f0fdf4';
        }
    }

    console.log('✅ Modal d\'édition rempli avec les données de l\'annotation');
}

/**
 * Sauvegarde les modifications de l'annotation
 */
function saveAnnotationChanges() {
    if (!currentEditingAnnotationId) {
        alert('Aucune annotation sélectionnée pour modification');
        return;
    }

    // Récupérer les valeurs du formulaire
    const selectedText = document.getElementById('edit-selected-text').value.trim();
    const annotationTypeId = document.getElementById('edit-annotation-type').value;
    const startPos = parseInt(document.getElementById('edit-start-pos').value) || 0;
    const endPos = parseInt(document.getElementById('edit-end-pos').value) || 0;

    // Validation basique
    if (!selectedText) {
        alert('Le texte sélectionné ne peut pas être vide');
        return;
    }

    if (!annotationTypeId) {
        alert('Veuillez sélectionner un type d\'annotation');
        return;
    }

    // Préparer les données à envoyer
    const editData = {
        selected_text: selectedText,
        annotation_type_id: parseInt(annotationTypeId),
        start_pos: startPos,
        end_pos: endPos
    };

    // Désactiver le bouton de sauvegarde pendant la requête
    const saveButton = document.querySelector('#editAnnotationModal .btn-primary');
    const originalText = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

    // Envoyer la requête de modification
    fetch(`/annotation/${currentEditingAnnotationId}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(editData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher le succès
            showEditSuccess(data.message);

            // Fermer le modal
            editModal.hide();

            // Mettre à jour l'affichage de l'annotation dans la liste
            updateAnnotationInList(data.annotation);

            // Réinitialiser l'ID d'édition
            currentEditingAnnotationId = null;
        } else {
            alert('Erreur lors de la sauvegarde: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur sauvegarde annotation:', error);
        alert('Erreur lors de la sauvegarde des modifications');
    })
    .finally(() => {
        // Restaurer le bouton
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
    });
}

/**
 * Met à jour l'affichage d'une annotation dans la liste après modification
 */
function updateAnnotationInList(updatedAnnotation) {
    const annotationElement = document.querySelector(`[data-annotation-id="${updatedAnnotation.id}"]`);
    if (!annotationElement) {
        console.error('Élément d\'annotation non trouvé dans la liste');
        return;
    }

    // Mettre à jour le type d'annotation
    const typeElement = annotationElement.querySelector('.annotation-type');
    if (typeElement) {
        typeElement.textContent = updatedAnnotation.annotation_type.display_name;
        typeElement.style.background = updatedAnnotation.annotation_type.color;
    }

    // Mettre à jour le texte sélectionné
    const textElement = annotationElement.querySelector('.annotation-text');
    if (textElement) {
        textElement.textContent = `"${updatedAnnotation.selected_text}"`;

        // Mettre à jour l'événement onclick avec les nouvelles positions
        textElement.onclick = function() {
            highlightTextInDocument(
                updatedAnnotation.selected_text,
                updatedAnnotation.start_pos,
                updatedAnnotation.end_pos
            );
        };
    }

    // Ajouter ou mettre à jour l'indicateur de modification humaine
    let humanIndicator = annotationElement.querySelector('.human-modified-indicator');
    if (!humanIndicator) {
        humanIndicator = document.createElement('div');
        humanIndicator.className = 'human-modified-indicator';
        annotationElement.appendChild(humanIndicator);
    }
    humanIndicator.innerHTML = '<i class="fas fa-user-edit"></i> Modifié par vous';

    // Ajouter une animation de mise à jour
    annotationElement.style.animation = 'highlight-pulse 1s ease-in-out';
    setTimeout(() => {
        annotationElement.style.animation = '';
    }, 1000);

    console.log('✅ Annotation mise à jour dans la liste');
}

/**
 * Affiche un message de succès après modification
 */
function showEditSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'validation-success';
    successDiv.innerHTML = `
        <i class="fas fa-edit" style="font-size: 1.5rem;"></i>
        <div>
            <strong>✅ ${message}</strong>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                L'annotation a été mise à jour avec vos corrections
            </div>
        </div>
    `;

    // Insérer avant le contenu principal
    const mainContent = document.querySelector('.text-content-card');
    if (mainContent) {
        mainContent.parentNode.insertBefore(successDiv, mainContent);

        // Supprimer après 4 secondes
        setTimeout(() => {
            successDiv.remove();
        }, 4000);
    }
}

/**
 * Affiche/cache l'indicateur de chargement dans le modal d'édition
 */
function showEditModalLoading(show) {
    // Cette fonction peut être utilisée pour ajouter des indicateurs de chargement
    // si nécessaire dans le futur
    console.log(show ? '⏳ Chargement...' : '✅ Chargement terminé');
}

/**
 * Réinitialise le formulaire d'édition
 */
function resetEditModal() {
    document.getElementById('edit-selected-text').value = '';
    document.getElementById('edit-annotation-type').value = '';
    document.getElementById('edit-start-pos').value = '';
    document.getElementById('edit-end-pos').value = '';
    document.getElementById('edit-created-by').textContent = '-';
    document.getElementById('edit-confidence').textContent = '-';
    document.getElementById('edit-ai-reasoning').textContent = '-';

    // Restaurer le style du panel d'information
    const infoPanel = document.querySelector('.annotation-info-panel');
    if (infoPanel) {
        infoPanel.style.borderLeft = '1px solid #dee2e6';
        infoPanel.style.backgroundColor = '#f8f9fa';
    }

    currentEditingAnnotationId = null;
}

// Événement pour réinitialiser le modal quand il se ferme
document.addEventListener('DOMContentLoaded', function() {
    const editModalElement = document.getElementById('editAnnotationModal');
    if (editModalElement) {
        editModalElement.addEventListener('hidden.bs.modal', function() {
            resetEditModal();
        });
    }
});

/**
 * Auto-calcul des positions lors de la modification du texte
 * (Fonction avancée - optionnelle)
 */
function recalculatePositions() {
    const selectedText = document.getElementById('edit-selected-text').value.trim();
    const pageText = document.getElementById('text-content').textContent;

    if (selectedText && pageText) {
        const startPos = pageText.indexOf(selectedText);
        if (startPos !== -1) {
            document.getElementById('edit-start-pos').value = startPos;
            document.getElementById('edit-end-pos').value = startPos + selectedText.length;
        }
    }
}

// Optionnel: Auto-recalcul des positions quand le texte change
document.addEventListener('DOMContentLoaded', function() {
    const textArea = document.getElementById('edit-selected-text');
    if (textArea) {
        textArea.addEventListener('blur', recalculatePositions);
    }
});

console.log('📝 Fonctions d\'édition d\'annotations chargées avec succès');
</script>
{% endblock %}